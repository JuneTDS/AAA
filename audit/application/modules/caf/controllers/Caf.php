<?php defined('BASEPATH') OR exit('No direct script access allowed');
require_once('assets/vendor/tcpdf/tcpdf.php');

require $_SERVER['DOCUMENT_ROOT'] . '/' . explode('/', $_SERVER['REQUEST_URI'])[1] . '/vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;


class Caf extends MX_Controller
{

    function __construct()
    {
        parent::__construct();

        if (!$this->loggedIn) {
            $this->session->set_userdata('requested_page', $this->uri->uri_string());
            redirect('auth/login');
        }


        // if($this->user_id != 102){
        //     $this->session->set_userdata('requested_page', $this->uri->uri_string());
        //     redirect('auth/login');
        //     // echo $this->user_id;
        // }
        
        $this->load->library(array('session','parser','encryption'));
        $this->load->library(array('zip'));
        $this->load->model('bank/bank_model');
        $this->load->model('client/client_model');
        $this->load->model('caf_model');
        $this->load->model('fs_model');
        $this->load->model('fs_notes_model');
        $this->load->model('setting/setting_model');
        $this->load->model('fs_system_model');
        $this->load->model('fs/fs_statements_model');
        $this->load->model('fs_account_category_model');
    }

    public function index($assg_id)
    {   
        // $this->meta['page_name'] = 'List of Auditor';


        $this->data['active_tab'] = $this->session->userdata('tab_active');
        $this->session->unset_userdata('tab_active');

        $this->data['assignment_id'] = $assg_id;
        $this->data['fs_company_info_id'] = $this->caf_model->getReportIdWithAssg($assg_id);
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assg_id);
        $this->data['caf_data'] = $this->caf_model->getCaf($assg_id);
        $this->data['employee_id'] = $this->caf_model->getEmployeeIdWithUserId($this->session->userdata("user_id"));

        // print_r( $this->data['caf_data']);

        //for audit progamme
        $this->data['caf_types_dropdown'] = $this->caf_model->get_caf_type_dropdown();
        $this->data['audit_programme_list'] = $this->setting_model->get_programme_list($assg_id);

        //for leadsheet
        $this->data['lvl1_leadsheet_dropdown'] = $this->caf_model->get_leadsheet_list($assg_id);

        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assg_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assg_id);

        $is_admin_manager = $this->Admin || $this->Manager?true:false;

        //for sign-off
        $this->data['sign_off_dropdown'] = $this->caf_model->get_sign_off_dropdown_list($is_admin_manager);

        $company_code =$this->data['client']->client_id;
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);


        $bc = array(array('link' => '#', 'page' => 'Current File'));
        $meta = array('page_title' => 'Current File', 'bc' => $bc, 'page_name' => 'Current File - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        //page_construct($pageName, $meta, $data, $displayToolbar = false);
        $this->page_construct('index.php', $meta, $this->data, true);
       

    }

    public function categorization_view($assg_id)
    {
        $this->data['assignment_id'] = $assg_id;
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assg_id);
        $this->data['main_account_code_list'] = $this->caf_model->get_default_main_sub_account_list('default');
        $company_code =$this->data['client']->client_id;
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);
        $this->data['show_ly_TB_btn'] = $this->caf_model->get_show_ly_TB_btn($assg_id);
        $this->data['initial_categorized'] = $this->categoriedDefaultData($assg_id, false);


        $bc = array(array('link' => '#', 'page' => 'Account Category'));
        $meta = array('page_title' => 'Account Category', 'bc' => $bc, 'page_name' => 'Mapping - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        //page_construct($pageName, $meta, $data, $displayToolbar = false);
        $this->page_construct('categorization.php', $meta, $this->data, true);
    }

    public function fs_company_info($fs_company_info_id)
    {
        
        // $company_code       = $form_data['company_code'];

        $this->data["group_type_list"]          = $this->fs_model->get_group_type();
        $this->data['currency_list']            = $this->fs_model->get_currency_list();
        $this->data["accounting_standard_list"] = $this->fs_model->get_accounting_standard_list();
        $this->data["act_applicable_list"]      = $this->fs_model->get_json_act_applicable_list();

        if(!empty($fs_company_info_id)) // edit / load existing data 
        {
            $this->data['fs_report_details']        = $this->caf_model->get_fs_company_info($fs_company_info_id); // set dropdown value

            $this->data['fs_fp_currency_details']   = $this->fs_model->get_fs_fp_currency_details($fs_company_info_id);

            $fs_company_info = $this->data['fs_report_details'];
            $fye_text = strtoupper($fs_company_info[0]['current_fye_end']);
            // print_r($fs_company_info);
            $company_code    = $fs_company_info[0]['company_code'];
            $this->data['client_signing_info'] = $this->fs_model->get_all_client_signing_info($company_code);


            $this->data['effect_of_restatement_since_dp'] = array(
                                                            $fs_company_info[0]['last_fye_begin'] => $fs_company_info[0]['last_fye_begin'],
                                                            $fs_company_info[0]['last_fye_end']   => $fs_company_info[0]['last_fye_end']
                                                        );

            // print_r($this->data['fs_fp_currency_details']);
        }
        // else // create new
        // {
        //     $fs_company_info = $this->fs_model->get_fs_company_info_by_company_code($company_code);
        //     $client_signing_info = $this->master_model->get_all_client_signing_info($company_code);

        //     if(count($fs_company_info) > 0) // if not first
        //     {
        //         $data = $this->fs_model->get_new_FYE_date($company_code);

        //         $this->data['fs_fp_currency_details'] = $this->fs_model->get_fs_fp_currency_details($data['id']);

        //         $this->data["fs_report_details"][0]['id'] = 0;
        //         $this->data["fs_report_details"]          = array($data);

        //         $this->data["fs_report_details"][0]['director_signature_1'] = $client_signing_info[0]->director_signature_1;
        //         $this->data["fs_report_details"][0]['director_signature_2'] = $client_signing_info[0]->director_signature_2;
        //     }
        //     else
        //     {
        //         $this->data["fs_report_details"] = [
        //                                             array(
        //                                                 'first_set' => 1,
        //                                                 'accounting_standard_used' => 4,
        //                                                 'director_signature_1' => $client_signing_info[0]->director_signature_1,
        //                                                 'director_signature_2' => $client_signing_info[0]->director_signature_2
        //                                             )];
        //     }

        //     // check company change name 
        //     $company_change_name = $this->db->query("SELECT tccn.company_name, tccn.new_company_name
        //                                                 FROM transaction_master tm
        //                                                 LEFT JOIN transaction_change_company_name tccn ON tccn.transaction_id = tm.id
        //                                                 WHERE tm.transaction_task_id = 12 AND tm.company_code = '" . $company_code . "' AND (tm.created_at BETWEEN '" . $this->data["fs_report_details"][0]['current_fye_begin'] . "'AND '" . $this->data["fs_report_details"][0]['current_fye_end'] . "')
        //                                                 ORDER BY tm.created_at");
        //     $company_change_name = $company_change_name->result_array();

        //     $this->data["fs_report_details"][0]['old_company_name'] = $company_change_name[0]['company_name'];
        // }

        $this->data['is_prior_year_restated_dp'] = array(
                                                        '0' => 'No',
                                                        '1' => 'Yes'
                                                    );

        $bc = array(array('link' => '#', 'page' => 'Company Info'));
        $meta = array('page_title' => 'Company Info', 'bc' => $bc, 'page_name' => 'Company Info - '.$fs_company_info[0]['company_name'].' (AUDIT '.$fye_text.')');

        $this->page_construct('fs_company_info.php', $meta, $this->data, true);
        
    }

    public function balance_sheet($caf_id, $assignment_id)
    {

        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Balance Sheet'));
        $meta = array('page_title' => 'Balance Sheet', 'bc' => $bc, 'page_name' => $this->data['caf_detail']->index_no.' Balance Sheet - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        // print_r("testing");

        $this->data['show_third_col']    = false;
        $this->data["current_fye_end"]   = $current_last_year_end['current_fye_end'];
        $this->data["last_fye_end"]      = $current_last_year_end['last_fye_end'];
        $this->data['caf_id']            = $caf_id;
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }
        
        // if($group_company == 'group')
        // {
        //     $this->data['is_group'] = true;
        // }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 35,
                            'value'        => 20,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 8,
                            'variance'        => 8

                        );

        }
        /* END OF Setting for column width */

        // if($group_company == 'company')
        // {
        //     $this->data['is_group'] = false;
        // }
        // else
        // {
        //     $this->data['is_group'] = true;
        // }

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $this->data['show_third_col']   = true;

                $this->data["current_fye_end"]  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $this->data["last_fye_end"]     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $this->data['last_fye_beg']     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }

        $this->data['width'] = array(
                                    'account_desc' => $col_width['account_desc'],
                                    // 'note'         => $col_width['note'],
                                    'value'        => $col_width['value'],
                                    'variance'     => $col_width['variance']
                                );
        // $this->data['group_company'] = ucfirst(strtolower($group_company));

        /* get account list for statement of financial position */
        // $this->data['fs_notes_details'] = $this->fs_notes_model->get_fs_note_details($fs_company_info_id, 2);

        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data   = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        // print_r($data_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        // print_r($data);

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        if(count($eq_liabi_title_list) == 1)  
        {
            if($eq_liabi_title_list[0] == "Equity")
            {
                $e_l_title = '';    // remove title if got equity only
            }
        }
        // print_r($data);
        $this->data['data']      = $data;
        $this->data['e_l_title'] = $e_l_title;

        // print_r($data);
        /* ------------------------ END OF Set "Equity and liabilities" title ------------------------ */

        // $this->data['data'] = $this->fs_account_category_model->get_account_with_sub_round_off($fs_company_info_id, array('M1001', 'M1002'));

        // get auto rearrange notes from fs_settings
        // $auto_rearrange_data = $this->fs_model->get_fs_settings($fs_company_info_id);
        // $on_rearrange_notes = 1;

        // if(count($auto_rearrange_data) > 0)
        // {
        //     $on_rearrange_notes = $auto_rearrange_data[0]['auto_rearrange_notes_no'];
        // }

        // $this->data['fs_notes_details_state_2'] = $this->fs_notes_model->get_fs_note_details_for_state_comp_income($fs_company_info_id, 1);
        $this->data['eq_liabi_title_list'] = $eq_liabi_title_list;
        $this->data['fs_ntfs_list'] = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        // $this->data['auto_rearrange_value'] = $on_rearrange_notes;
        // $this->data["fs_ntfs_layout_template_list"] = $this->fs_notes_model->get_ntfs_layout_template_parents($fs_company_info_id);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        $bs_assertion_dropdown = array("Existence","Completeness","Valuation","Right and Obligation");
        $pl_assertion_dropdown['-'] = "-";
        $bs_assertion_dropdown[""] = " ";

        $risk_lvl_dropdown = array("L","M","H");
        $risk_lvl_dropdown[""] = " ";

        $this->data['bs_assertion_dropdown'] =  $bs_assertion_dropdown;
        $this->data['risk_lvl_dropdown'] =  $risk_lvl_dropdown;
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);

        $this->data['line_items'] = $this->caf_model->get_bs_line_item($caf_id);


        $this->page_construct('balance_sheet.php', $meta, $this->data, true);
    }

    public function profit_loss($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Profit or loss'));
        $meta = array('page_title' => 'Profit or loss', 'bc' => $bc, 'page_name' => $this->data['caf_detail']->index_no.' Profit or loss - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        // $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        // print_r("testing");
        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 35,
                            'value'        => 20,
                            'variance'     => 0
                        );
        
        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 8,
                            'variance'        => 8

                        );

            // if($fs_company_info[0]['is_prior_year_amount_restated'])
            // {
            //     if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            //     {
            //         $col_width = array(
            //                 'account_desc' => 50,
            //                 'value'        => 15
            //             );
            //     }
            // }
        }

        $this->data['width'] = array(
                                    'account_desc' => $col_width['account_desc'],
                                    // 'note'         => $col_width['note'],
                                    'value'        => $col_width['value'],
                                    'variance'     => $col_width['variance']
                                );
         // initialise
        $this->data["current_fye_end"]  = '';
        $this->data["last_fye_end"]     = '';
        $this->data["display_restated"] = false;

        /* Don't delete this */
        // if($fs_company_info[0]['is_prior_year_amount_restated'])
        // {
        //     if(strcmp($fs_company_info[0]['effect_of_restatement_since'], $fs_company_info[0]['last_fye_begin']) == 0)
        //     {
        //         $this->data["display_restated"] = true;
        //     }
        // }
        /* Don't delete this */

        // display column(s) for years
        // print_r($fs_company_info[0]['first_set']);
        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }
        else
        {
            $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

            $this->data["current_fye_end"]  = $current_last_year_end['current_fye_end'];    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = $current_last_year_end['last_fye_end'];       // end of previous year end
        }

        /* ---------------------- get statement of detailed profit or loss data ---------------------- */

        $dpl_key = array_search("Profit or loss", array_column($fs_ntfs_list['statements'], 'document_name'));
        $dpl_ref_id = '';

        if($dpl_key || (string)$dpl_key == '0')
        {
            $dpl_account_code = $fs_ntfs_list['statements'][$dpl_key]['reference_id']; // get account code
        }

        $dpl_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $dpl_account_code);

        $dpl_data = [];

        foreach ($dpl_fca_id as $dpl_fca_id_key => $dpl_fca_id_value)
        {
            array_push($dpl_data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($dpl_fca_id_value)));
        }

        $this->data['state_detailed_pro_loss_data'] = $dpl_data;

        // seperated because this need to loop level 3
        $er_account_code = array("E0000000");
        $er_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $er_account_code);

        $this->data['schedule_operating_expense_data'] = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $er_fca_id);

        // print_r($this->data['schedule_operating_expense_data']);

        //retrieve TAX
        $temp_data = [];
        $data = [];
        $tax_account_code = array("T0000000");
        $tax_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $tax_account_code);

        foreach ($tax_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        $this->data['tax_data'] = $data;

        $temp_data = [];
        $data = [];

        $soa_account_code = array("S0000000");
        $soa_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $soa_account_code);

        foreach ($soa_fca_id as $fca_id_key => $fca_id_value) 
        {
            $temp_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value));

            if(count($temp_data[0]['child_array']) > 0)
            {
                // print_r($temp_data);

                $temp_data[0]['parent_array'][0]['group_end_this_ye_value']  = (double)$temp_data[0]['parent_array'][0]['group_end_this_ye_value'] * (-1);
                $temp_data[0]['parent_array'][0]['group_end_prev_ye_value']  = (double)$temp_data[0]['parent_array'][0]['group_end_prev_ye_value'] * (-1);

                $temp_data[0]['parent_array'][0]['total_c']      = (double)$temp_data[0]['parent_array'][0]['total_c']     * (-1);
                $temp_data[0]['parent_array'][0]['total_c_lye']  = (double)$temp_data[0]['parent_array'][0]['total_c_lye'] * (-1);

                array_push($data, $temp_data);
            }
        }

        if(count($data) > 0)
        {
            $soa_pl_list = $data;
        }
        else
        {
            $soa_pl_list = [];
        }

        $this->data['soa_pl_list'] = $soa_pl_list;

        //retrieve DIVIDEND
        $temp_data = [];
        $data = [];
        $div_account_code = array("D0000000");
        $div_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $div_account_code);

        foreach ($div_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $div_data = $data;
        }
        else
        {
            $div_data = [];
        }

        $this->data['div_data'] = $div_data;

        //retrieve RETAINED EARNINGS B/F
        $temp_data = [];
        $data = [];
        $bf_account_code = array("Q1030000");
        $bf_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $bf_account_code);

        foreach ($bf_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $bf_data = $data;
        }
        else
        {
            $bf_data = [];
        }

        $this->data['bf_data'] = $bf_data;

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $bs_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);
 
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        // print_r($data_for_revenue_reserve);
        // print_r($bs_data)
        $bs_data = $this->fs_model->operate_account_value($bs_data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)), array());
        // print_r($bs_data);

        $calculated_revenue_reserve = $this->fs_model->find_account_in_array($bs_data, array('Q1030000'));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /*------------------- CHECK LY CALCULATED REVENUE RESERVE WITH THIS YEAR RETAINED EARNINGS B/F-----------------*/
        if(isset($calculated_revenue_reserve)){
            // print_r($calculated_revenue_reserve);
            $this->data['rev_rsrv_agree'] = $this->check_retained_earning_with_bs($calculated_revenue_reserve, $bf_data);
        }
        else
        {
            // echo $calculated_revenue_reserve."here else";
            $this->data['rev_rsrv_agree'] = false;
        }

        /*------------------- END CHECK LY CALCULATED REVENUE RESERVE WITH THIS YEAR RETAINED EARNINGS B/F-----------------*/
        // print_r($bs_data);

        $this->data['fs_ntfs_list'] = $fs_ntfs_list['statements'][$dpl_key]['description_reference_id'];

        /* ---------------------- END OF get statement of detailed profit or loss data ---------------------- */
        // $this->data['line_items'] = $this->caf_model->get_bs_line_item($caf_id);
        $pl_assertion_dropdown = array("Accuracy","Classification","Completeness","Cut off", "Occurence");
        $pl_assertion_dropdown['-'] = "-";
        $pl_assertion_dropdown[""] = " ";

        $risk_lvl_dropdown = array("L","M","H");
        $risk_lvl_dropdown[""] = " ";

        $this->data['pl_assertion_dropdown'] =  $pl_assertion_dropdown;
        $this->data['risk_lvl_dropdown'] =  $risk_lvl_dropdown;

        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);

        // print_r($dpl_data);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $this->data['caf_id']  = $caf_id;
        $this->data['assignment_id']    = $assignment_id;

        $this->data['line_items'] = $this->caf_model->get_pl_line_item($caf_id);

        $this->page_construct('profit_loss.php', $meta, $this->data, true);
    }

    public function materiality($caf_id, $assignment_id)
    {

        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Materiality'));
        $meta = array('page_title' => 'Materiality', 'bc' => $bc, 'page_name' => 'C3 Materiality - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        // print_r("testing");
        $this->data["current_fye_end"]  = $current_last_year_end['current_fye_end'];
        $this->data["last_fye_end"]     = $current_last_year_end['last_fye_end'];
        $this->data['caf_id']           = $caf_id;
        $this->data['materiality_id']   = $this->caf_model->get_materiality_id($caf_id);
        $this->data['assignment_id']    = $assignment_id;

        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }

        /* END OF Setting for column width */

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $this->data['show_third_col']   = true;

                $this->data["current_fye_end"]  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $this->data["last_fye_end"]     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $this->data['last_fye_beg']     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }
        // $this->data['group_company'] = ucfirst(strtolower($group_company));

        /* get account list for statement of financial position */
        // $this->data['fs_notes_details'] = $this->fs_notes_model->get_fs_note_details($fs_company_info_id, 2);

        $nd_key = array_search("Materiality", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));

        

        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets" && $a_description != "Expenses"  && $a_description != "Cost of sales")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        // if(count($eq_liabi_title_list) == 1)  
        // {
        //     if($eq_liabi_title_list[0] == "Equity")
        //     {
        //         $e_l_title = '';    // remove title if got equity only
        //     }
        // }

        // print_r($data);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        if($data['show_data_content'])
        {
            $data = $this->calculate_equity($data);
            $this->data['benchmark_value'] = json_encode($this->retrieve_benchmark_value($data));
            $this->data['materiality_data'] = $this->caf_model->get_materiality_data($caf_id);
        }

        $this->data['eq_liabi_title_list'] = $eq_liabi_title_list;
        $this->data['fs_ntfs_list'] = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];

        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);
        // $this->data['auto_rearrange_value'] = $on_rearrange_notes;
        // $this->data["fs_ntfs_layout_template_list"] = $this->fs_notes_model->get_ntfs_layout_template_parents($fs_company_info_id);
        // $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        $this->data['benchmark_dropdown'] = $this->caf_model->get_benchmark_dropdown_list();


        $this->page_construct('materiality.php', $meta, $this->data, true);
    }

    public function materiality_v2($caf_id, $assignment_id)
    {

        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Materiality'));
        $meta = array('page_title' => 'Materiality', 'bc' => $bc, 'page_name' => 'C3 Materiality - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        // print_r("testing");
        $this->data["current_fye_end"]  = $current_last_year_end['current_fye_end'];
        $this->data["last_fye_end"]     = $current_last_year_end['last_fye_end'];
        $this->data['caf_id']           = $caf_id;
        $this->data['materiality_id']   = $this->caf_model->get_materiality_v2_id($caf_id);
        $this->data['assignment_id']    = $assignment_id;

        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }

        /* END OF Setting for column width */

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $this->data['show_third_col']   = true;

                $this->data["current_fye_end"]  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $this->data["last_fye_end"]     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $this->data['last_fye_beg']     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }
        // $this->data['group_company'] = ucfirst(strtolower($group_company));

        /* get account list for statement of financial position */
        // $this->data['fs_notes_details'] = $this->fs_notes_model->get_fs_note_details($fs_company_info_id, 2);

        $nd_key = array_search("Materiality", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));

        

        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets" && $a_description != "Expenses"  && $a_description != "Cost of sales")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        // if(count($eq_liabi_title_list) == 1)  
        // {
        //     if($eq_liabi_title_list[0] == "Equity")
        //     {
        //         $e_l_title = '';    // remove title if got equity only
        //     }
        // }

        // print_r($data);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        if($data['show_data_content'])
        {
            $data = $this->calculate_equity($data);
            
            $this->data['benchmark_value'] = json_encode($this->retrieve_benchmark_value($data));
            $this->data['materiality_data'] = $this->caf_model->get_materiality_v2_data($caf_id);
        }

        $this->data['eq_liabi_title_list'] = $eq_liabi_title_list;
        $this->data['fs_ntfs_list'] = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];

        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);
        // $this->data['auto_rearrange_value'] = $on_rearrange_notes;
        // $this->data["fs_ntfs_layout_template_list"] = $this->fs_notes_model->get_ntfs_layout_template_parents($fs_company_info_id);
        // $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        $this->data['benchmark_dropdown'] = $this->caf_model->get_benchmark_dropdown_list();


        $this->page_construct('materiality_v2.php', $meta, $this->data, true);
    }

    public function adjustment($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);
        
        $bc = array(array('link' => '#', 'page' => 'Journal Entries'));
        $meta = array('page_title' => 'Journal Entries', 'bc' => $bc, 'page_name' => 'A3 Journal Entries - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        // $this->data['adjustment_data'] = $this->caf_model->get_adjustment_data($caf_id);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);
        $this->data['caf_id'] = $caf_id;
        $this->data['assignment_id']    = $assignment_id;

        $this->page_construct('adjustment.php', $meta, $this->data, true);
    }

    public function far_bs($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Balance Sheet'));
        $meta = array('page_title' => 'Balance Sheet', 'bc' => $bc, 'page_name' => 'A5 Final analytical review - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        // print_r("testing");

        $this->data['show_third_col']   = false;
        $this->data["current_fye_end"]  = $current_last_year_end['current_fye_end'];
        $this->data["last_fye_end"]     = $current_last_year_end['last_fye_end'];
        $this->data['caf_id']           = $caf_id;
        $this->data['assignment_id']    = $assignment_id;

        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }
        
        // if($group_company == 'group')
        // {
        //     $this->data['is_group'] = true;
        // }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 40,
                            'value'        => 15,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 11,
                            'variance'        => 11

                        );

        }
        /* END OF Setting for column width */

        // if($group_company == 'company')
        // {
        //     $this->data['is_group'] = false;
        // }
        // else
        // {
        //     $this->data['is_group'] = true;
        // }

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $this->data['show_third_col']   = true;

                $this->data["current_fye_end"]  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $this->data["last_fye_end"]     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $this->data['last_fye_beg']     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }

        $this->data['width'] = array(
                                    'account_desc' => $col_width['account_desc'],
                                    // 'note'         => $col_width['note'],
                                    'value'        => $col_width['value'],
                                    'variance'     => $col_width['variance']
                                );
        // $this->data['group_company'] = ucfirst(strtolower($group_company));

        /* get account list for statement of financial position */
        // $this->data['fs_notes_details'] = $this->fs_notes_model->get_fs_note_details($fs_company_info_id, 2);

        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        // print_r($data);

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        if(count($eq_liabi_title_list) == 1)  
        {
            if($eq_liabi_title_list[0] == "Equity")
            {
                $e_l_title = '';    // remove title if got equity only
            }
        }

        $this->data['data']      = $data;
        // print_r($data);
        $this->data['e_l_title'] = $e_l_title;

        // print_r($data);
        /* ------------------------ END OF Set "Equity and liabilities" title ------------------------ */

        // $this->data['data'] = $this->fs_account_category_model->get_account_with_sub_round_off($fs_company_info_id, array('M1001', 'M1002'));

        // get auto rearrange notes from fs_settings
        // $auto_rearrange_data = $this->fs_model->get_fs_settings($fs_company_info_id);
        // $on_rearrange_notes = 1;

        // if(count($auto_rearrange_data) > 0)
        // {
        //     $on_rearrange_notes = $auto_rearrange_data[0]['auto_rearrange_notes_no'];
        // }

        // $this->data['fs_notes_details_state_2'] = $this->fs_notes_model->get_fs_note_details_for_state_comp_income($fs_company_info_id, 1);
        $this->data['eq_liabi_title_list'] = $eq_liabi_title_list;
        $this->data['fs_ntfs_list'] = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $this->data['adjustment_data'] = $this->build_adjustment_data_arr($temp_adjustment_data);

        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);

        // $this->data['auto_rearrange_value'] = $on_rearrange_notes;
        // $this->data["fs_ntfs_layout_template_list"] = $this->fs_notes_model->get_ntfs_layout_template_parents($fs_company_info_id);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);


        $this->page_construct('far_bs.php', $meta, $this->data, true);
    }

    public function far_pl($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Profit or loss'));
        $meta = array('page_title' => 'Profit or loss', 'bc' => $bc, 'page_name' => 'A5 Final analytical review - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        // $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        // print_r("testing");
        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 40,
                            'value'        => 15,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 11,
                            'variance'        => 11

                        );

        }

            // if($fs_company_info[0]['is_prior_year_amount_restated'])
            // {
            //     if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            //     {
            //         $col_width = array(
            //                 'account_desc' => 50,
            //                 'value'        => 15
            //             );
            //     }
            // }
        

        $this->data['width'] = array(
                                    'account_desc' => $col_width['account_desc'],
                                    // 'note'         => $col_width['note'],
                                    'value'        => $col_width['value'],
                                    'variance'     => $col_width['variance']
                                );
         // initialise
        $this->data["current_fye_end"]  = '';
        $this->data["last_fye_end"]     = '';
        $this->data["display_restated"] = false;

        /* Don't delete this */
        // if($fs_company_info[0]['is_prior_year_amount_restated'])
        // {
        //     if(strcmp($fs_company_info[0]['effect_of_restatement_since'], $fs_company_info[0]['last_fye_begin']) == 0)
        //     {
        //         $this->data["display_restated"] = true;
        //     }
        // }
        /* Don't delete this */

        // display column(s) for years
        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }
        else
        {
            $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

            $this->data["current_fye_end"]  = $current_last_year_end['current_fye_end'];    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = $current_last_year_end['last_fye_end'];       // end of previous year end
        }

        /* ---------------------- get statement of detailed profit or loss data ---------------------- */

        $dpl_key = array_search("Profit or loss", array_column($fs_ntfs_list['statements'], 'document_name'));
        $dpl_ref_id = '';

        if($dpl_key || (string)$dpl_key == '0')
        {
            $dpl_account_code = $fs_ntfs_list['statements'][$dpl_key]['reference_id']; // get account code
        }

        $dpl_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $dpl_account_code);

        $dpl_data = [];

        foreach ($dpl_fca_id as $dpl_fca_id_key => $dpl_fca_id_value) 
        {
            array_push($dpl_data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($dpl_fca_id_value)));
        }

        $this->data['state_detailed_pro_loss_data'] = $dpl_data;

        // seperated because this need to loop level 3
        $er_account_code = array("E0000000");
        $er_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $er_account_code);

        $this->data['schedule_operating_expense_data'] = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $er_fca_id);

        //retrieve TAX
        $temp_data = [];
        $data = [];
        $tax_account_code = array("T0000000");
        $tax_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $tax_account_code);

        foreach ($tax_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        // print_r($data);

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c']          = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_adjusted'] = (double)$value['parent_array'][0]['total_c_adjusted'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye']      = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        $this->data['tax_data'] = $data;

        $temp_data = [];
        $data = [];

        $soa_account_code = array("S0000000");
        $soa_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $soa_account_code);

        foreach ($soa_fca_id as $fca_id_key => $fca_id_value) 
        {
            $temp_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value));

            if(count($temp_data[0]['child_array']) > 0)
            {
                // print_r($temp_data);

                $temp_data[0]['parent_array'][0]['total_c']          = (double)$temp_data[0]['parent_array'][0]['total_c']     * (-1);
                $temp_data[0]['parent_array'][0]['total_c_adjusted'] = (double)$temp_data[0]['parent_array'][0]['total_c_adjusted']     * (-1);
                $temp_data[0]['parent_array'][0]['total_c_lye']      = (double)$temp_data[0]['parent_array'][0]['total_c_lye'] * (-1);

                array_push($data, $temp_data);
            }
        }

        if(count($data) > 0)
        {
            $soa_pl_list = $data;
        }
        else
        {
            $soa_pl_list = [];
        }
        $this->data['soa_pl_list'] = $soa_pl_list;
        // print_r($this->data['schedule_operating_expense_data']);

        //retrieve DIVIDEND
        $temp_data = [];
        $data = [];
        $div_account_code = array("D0000000");
        $div_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $div_account_code);

        foreach ($div_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_adjusted'] = (double)$value['parent_array'][0]['total_c_adjusted'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
            }
        }

        if(count($data) > 0)
        {
            $div_data = $data;
        }
        else
        {
            $div_data = [];
        }

        $this->data['div_data'] = $div_data;

        //retrieve RETAINED EARNINGS B/F
        $temp_data = [];
        $data = [];
        $bf_account_code = array("Q1030000");
        $bf_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $bf_account_code);

        foreach ($bf_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_adjusted'] = (double)$value['parent_array'][0]['total_c_adjusted'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $bf_data = $data;
        }
        else
        {
            $bf_data = [];
        }

        $this->data['bf_data'] = $bf_data;

        $this->data['fs_ntfs_list'] = $fs_ntfs_list['statements'][$dpl_key]['description_reference_id'];

        /* ---------------------- END OF get statement of detailed profit or loss data ---------------------- */
        // $this->data['line_items'] = $this->caf_model->get_bs_line_item($caf_id);


        // print_r($dpl_data);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $this->data['caf_id']  = $caf_id;
        $this->data['assignment_id']    = $assignment_id;

        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $this->data['adjustment_data'] = $this->build_adjustment_data_arr($temp_adjustment_data);

        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);

        $this->data['line_items'] = $this->caf_model->get_pl_line_item($caf_id);

        $this->page_construct('far_pl.php', $meta, $this->data, true);
    }

    public function audit_programme($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);
        $this->data['programme_objective_lines'] = $this->setting_model->get_objective_lines($programme_master_id);
        $this->data['programme_procedure_lines'] = $this->caf_model->get_procedure_lines($programme_master_id, $caf_id);
        $this->data['programme_content']         = $this->caf_model->get_programme_content($programme_master_id, $caf_id);
        $this->data['programme_conclusion']      = $this->caf_model->get_programme_conclusion($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme.php', $meta, $this->data, true);
    }

    public function audit_programme_yn($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);
        $this->data['programme_content']         = $this->caf_model->get_programme_content($programme_master_id, $caf_id);
        $this->data['y_n_na_dropdown']           = array('Yes', 'No', 'N/A');
        $this->data['y_n_na_dropdown'][""]       = " ";


        // print_r($this->data['programme_content']);
        // $this->data['programme_conclusion']      = $this->caf_model->get_programme_conclusion($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_yn.php', $meta, $this->data, true);
    }

    public function audit_programme_qa($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);
        $this->data['programme_question_lines']  = $this->caf_model->get_question_lines($programme_master_id, $caf_id);
 

        // print_r($this->data['programme_content']);
        // $this->data['programme_conclusion']      = $this->caf_model->get_programme_conclusion($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_qa.php', $meta, $this->data, true);
    }

    public function audit_programme_meeting($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);


        $data_meeting                            = $this->caf_model->get_meeting_master_detail($caf_id);
        if($data_meeting)
        {
            $data_meeting['meeting_datetime']        = date('d/m/Y h:s a', strtotime($data_meeting['meeting_datetime']));
        }
        $this->data['meeting_detail']            = $data_meeting;

        // echo $data. "here";
        $meeting_master_id                       = $data_meeting?$data_meeting['id']:"";

        if($meeting_master_id != "")
        {
            $this->data['meeting_attendees']         = $this->caf_model->get_meeting_attendees($meeting_master_id);
            $this->data['meeting_agenda']            = $this->caf_model->get_meeting_agenda($meeting_master_id);
            $meeting_absent                          = $this->caf_model->get_meeting_absent($meeting_master_id);

            foreach ($meeting_absent as $key => $value) {
                $meeting_absent[$key]['date_communicated'] = date('d/m/Y', strtotime($value['date_communicated']));
            }

            $this->data['meeting_absent']            = $meeting_absent;
        }
        

        // print_r($this->data['meeting_agenda']);

        // print_r($this->data['programme_content']);
        // $this->data['programme_conclusion']      = $this->caf_model->get_programme_conclusion($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_meeting.php', $meta, $this->data, true);
    }

    public function audit_programme_opinion($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);
        
        $this->data['opinion_detail']  = $this->caf_model->get_opinion_detail($caf_id);

        // print_r($this->data['opinion_detail']);

        //for dropdowns
        $this->data['opinion_dropdown'] = array(''                      => '',
                                                'Unqualified opinion'   => 'Unqualified opinion',
                                                'Qualified opinion'     => 'Qualified opinion',
                                                'Adverse opinion'       => 'Adverse opinion',
                                                'Disclaimer of opinion' => 'Disclaimer of opinion');

        $this->data['assumption_dropdown'] = array(''            => '',
                                                'Appropriate'    => 'Appropriate',
                                                'Inappropriate'  => 'Inappropriate',
                                                'Appropriate but a material uncertainty exists with adequate disclosure' => 'Appropriate but a material uncertainty exists with adequate disclosure',
                                                'Appropriate but a material uncertainty exists without adequate disclosure' => 'Appropriate but a material uncertainty exists without adequate disclosure');

        $this->data['yn_dropdown'] = array(''      => '',
                                           'Yes'   => 'Yes',
                                           'No'    => 'No');

        


        // print_r($this->data['meeting_agenda']);

        // print_r($this->data['programme_content']);
        // $this->data['programme_conclusion']      = $this->caf_model->get_programme_conclusion($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_opinion.php', $meta, $this->data, true);
    }

    public function audit_programme_currency($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);

        $this->data['currency_detail']  = $this->caf_model->get_currency_detail($caf_id);


        // dropdown
        $this->data['currency_dropdown'] = $this->caf_model->get_currency_dropdown();
        $this->data['yn_dropdown'] = array(''      => '',
                                           'Yes'   => 'Yes',
                                           'No'    => 'No');
        $this->data['hl_dropdown'] = array(''       => '',
                                           'High'   => 'High',
                                           'Low'    => 'Low');

        
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_currency.php', $meta, $this->data, true);
    }

    public function audit_programme_cdd($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);

        $this->data['cdd_detail']                = $this->caf_model->get_cdd_detail($caf_id);

        
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_cdd.php', $meta, $this->data, true);
    }

    public function audit_programme_fcm($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);
        $this->data['fcm_detail']                = $this->caf_model->get_fcm_apm_detail($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_fcm.php', $meta, $this->data, true);
    }

    public function audit_programme_apm($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);
        $this->data['apm_detail']                = $this->caf_model->get_fcm_apm_detail($caf_id);
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('user_audit_programme_apm.php', $meta, $this->data, true);
    }

    public function audit_programme_gai($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Programme'));
        $meta = array('page_title' => 'Audit Programme', 'bc' => $bc, 'page_name' => 'Audit Programme ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);

        $this->data['assignment_id']     = $assignment_id;

        $programme_master_id                     = $this->data['caf_detail']->programme_master_id;
        // echo $programme_master_id;
        $this->data['programme_master_detail']   = $this->setting_model->get_edit_programme($programme_master_id);

        $data_gai                                = $this->caf_model->get_gai_master_detail($caf_id);


        if($data_gai)
        {
            $data_gai['date']        = date('d/m/Y', strtotime($data_gai['date']));

            for ($i = 1; $i <= 10; $i++) {
                $deadline_index = "deadline".$i;
                $data_gai[$deadline_index]        = date('d/m/Y', strtotime($data_gai[$deadline_index]));
            }
        }
        
        $this->data['gai_detail']             = $data_gai;

        $gai_master_id                        = $data_gai?$data_gai['id']:"";

        if($gai_master_id != "")
        {
            $this->data['gai_team']         = $this->caf_model->get_gai_team($gai_master_id);
            $this->data['gai_component']    = $this->caf_model->get_gai_component($gai_master_id);
        }

        $this->page_construct('user_audit_programme_gai.php', $meta, $this->data, true);
    }


    public function fs_report_info($audit_caf_master_id, $assign_id)
    {
        redirect('fs/index/'. $audit_caf_master_id . '/' . $assign_id);
    }

    public function state_cash_flow($audit_caf_master_id, $assign_id)
    {
        redirect('fs/fs_statements/partial_state_cash_flow/'. $audit_caf_master_id . '/' . $assign_id);
    }



    public function levelling_table($assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Levelling Table'));
        $meta = array('page_title' => 'Levelling Table', 'bc' => $bc, 'page_name' => 'Levelling Table - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);

        $temp_header_setting = $this->levelling_table_header_setting($fs_company_info_id);

        $this->data['header'] = $temp_header_setting[0];
        $this->data['array_header_col_setting'] = $temp_header_setting[1];
        // print_r($this->data['header']);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }


        // print_r("testing");

        $show_third_col   = false;
        $current_fye_end  = $current_last_year_end['current_fye_end'];
        $last_fye_end     = $current_last_year_end['last_fye_end'];

        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end    = '';       // end of previous year end
        }
        


        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $show_third_col   = true;

                $current_fye_end  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $last_fye_end     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $last_fye_beg     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }


        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        // print_r($data);

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $adjustment_data      = $this->build_adjustment_data_arr($temp_adjustment_data);

        $fs_ntfs_list= $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        // print_r($data);
        $json_data = $this->build_json_data($data, $fs_ntfs_list, $description_reference_id_list, $current_fye_end, $adjustment_data);

        $this->data['data']    = $json_data;
        // print_r($json_data);
        
        // $fs_ntfs_list= $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $adjustment_data      = $this->build_adjustment_data_arr($temp_adjustment_data);

        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $this->data['level_dropdown']        =  array("3","4","5");

        $this->page_construct('levelling_table.php', $meta, $this->data, true);

    }

    public function audit_awp($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Working Paper'));
        $meta = array('page_title' => 'Audit Working Paper', 'bc' => $bc, 'page_name' => 'Audit Working Paper ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;

   
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('test_awp.php', $meta, $this->data, false);
    }

    public function audit_leadsheet($caf_id, $assignment_id)
    {
        $this->data['client'] = $this->caf_model->getAssignmentDetail($assignment_id);
        $this->data['caf_detail']        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($this->data['client']->FYE));
        $fye_text = strtoupper($fye_text);

        $bc = array(array('link' => '#', 'page' => 'Audit Leadsheet'));
        $meta = array('page_title' => 'Audit Leadsheet', 'bc' => $bc, 'page_name' => 'Lead Sheet ('.$this->data['caf_detail']->index_no.') - '.$this->data['client']->client_name.' (AUDIT '.$fye_text.')');

        $this->data['caf_id']            = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['assignment_id']     = $assignment_id;
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        // print_r("testing");

        $this->data['show_third_col']   = false;
        $this->data["current_fye_end"]  = $current_last_year_end['current_fye_end'];
        $this->data["last_fye_end"]     = $current_last_year_end['last_fye_end'];

        // $this->data['caf_id']           = $caf_id;
        // $this->data['assignment_id']    = $assignment_id;

        if($fs_company_info[0]['first_set'])
        {
            $this->data["current_fye_end"]  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $this->data["last_fye_end"]     = '';       // end of previous year end
        }
        
        // if($group_company == 'group')
        // {
        //     $this->data['is_group'] = true;
        // }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 40,
                            'value'        => 15,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 11,
                            'variance'        => 11

                        );

        }

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $this->data['show_third_col']   = true;

                $this->data["current_fye_end"]  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $this->data["last_fye_end"]     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $this->data['last_fye_beg']     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }

        $this->data['width'] = array(
                                    'account_desc' => $col_width['account_desc'],
                                    // 'note'         => $col_width['note'],
                                    'value'        => $col_width['value'],
                                    'variance'     => $col_width['variance']
                                );

        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($this->data['caf_detail']->leadsheet_acc_id));
        // print_r($data);
        
        // $data = $this->fs_model->operate_account_value($data, array('Q103'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */
        // print_r($data);
        $this->data['data'] = $data;

        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $this->data['adjustment_data'] = $this->build_adjustment_data_arr($temp_adjustment_data);

        $this->data['leadsheet_documentation'] = $this->caf_model->get_leadsheet_documentation($caf_id);
        $this->data['leadsheet_setup']         = $this->caf_model->get_leadsheet_setup($caf_id);


   
        
        //for adjustment
        $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);
        $this->data['types_dropdown'] = $this->caf_model->get_types_dropdown_list();
        $this->data['accounts_dropdown'] = $this->caf_model->get_accounts_dropdown_list($assignment_id);


        $this->page_construct('audit_leadsheet.php', $meta, $this->data, true);
    }

    public function read_extract_excel()
    {
        $assignment_id = $_POST['assignment_id'];
        $current_year_tb    = $_POST['current_year_tb'];
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        if($_FILES['excel_file']['name']!="")
        {
            $target_dir = "pdf/document/";

            $file = $_FILES['excel_file']['name'];
            $path = pathinfo($file);
            $filename = $path['filename'];
            $ext = $path['extension'];
            $temp_name = $_FILES['excel_file']['tmp_name'];
            $path_filename_ext = $target_dir.$filename.".".$ext;

            // echo json_encode($_FILES['excel_file']);
            move_uploaded_file($temp_name,$path_filename_ext);
        }

        // $inputFileName = 'C:/wamp64/www/financial_statement/composer_plugin/vendor/phpoffice/phpspreadsheet/samples/Reading_workbook_data/sampleData/TrialBalance.xlsx';
        $inputFileName = $_SERVER['DOCUMENT_ROOT'] . '/' . explode('/', $_SERVER['REQUEST_URI'])[1] . '/pdf/document/' . $file;

        /* Load $inputFileName to a Spreadsheet Object  */
        $spreadsheet = \PhpOffice\PhpSpreadsheet\IOFactory::load($inputFileName);

        $worksheet  = $spreadsheet->getActiveSheet();
        $highestRow = $worksheet->getHighestRow();
        $colIndex   = $worksheet->getHighestDataColumn();

        $highestCol_index = \PhpOffice\PhpSpreadsheet\Cell\Coordinate::columnIndexFromString($colIndex);

        // print_r(array($worksheet->getCellByColumnAndRow(2, 1)->getValue()));
        $row_1_col_2_val = $worksheet->getCellByColumnAndRow(2, 1)->getValue();
        $row_1_col_3_val = $worksheet->getCellByColumnAndRow(3, 1)->getValue();

        $row_1_col_2_type = $worksheet->getCellByColumnAndRow(2, 1)->getDataType();
        $row_1_col_3_type = $worksheet->getCellByColumnAndRow(3, 1)->getDataType();

        // print_r(array($row_1_col_2_type,$row_1_col_2_type));

        $starting_row = 1;

        if($row_1_col_2_type != 'f' && $row_1_col_3_type != 'f' && $row_1_col_2_type != 'n' && $row_1_col_3_type != 'n')
        {
            $starting_row = 2;
        }

        // check if the extra columns have values, if no values preceed extract /
        $allow_extract = true;

        if($highestCol_index > 2)
        {
            for ($col = 1; $col <= $highestCol_index; ++$col) 
            {
                for ($row = 1; $row <= $highestRow; ++$row) 
                {
                    if(!empty($worksheet->getCellByColumnAndRow($col, $row)->getCalculatedValue()))
                    {
                        $allow_extract = false;
                    }
                }
            }
        }
        // END OF check if the extra columns have values, if no values preceed extract /

        if($highestCol_index == 3 || $allow_extract)
        {
            // extract data from cells
            $rows = [];
            for ($row = $starting_row; $row <= $highestRow; ++$row) 
            {
                // if($row < 3)
                // {
                    $col = 1;
                    $cell = $worksheet->getCellByColumnAndRow($col, $row);

                    // // Skip empty cells
                    // while (in_array($cell->getValue(), [null, ''], true)) 
                    // {
                    //     $col++;
                    //     $cell = $worksheet->getCellByColumnAndRow($col, $row);
                    // }
                    $maxCol = 4;    // set maximum column no

                    for ( ; $col < $maxCol; ++$col) 
                    { 
                        $value = $worksheet->getCellByColumnAndRow($col, $row)->getCalculatedValue();
                        $rows[$row][$col] = $value;

                        // print_r($value);
                    }
                // }
            }

            // pass data to array for database saving later
            $trial_balance = [];
            $total_trial_balance = 0.00;

            $not_numberic_row_col = [];

            $total_row_2 = 0;
            $total_row_3 = 0;

            foreach($rows as $key=>$row)
            {
                $row_2 = empty($row[2])?0:$row[2];
                $row_2 = $row_2 + 0;

                if($highestCol_index > 2)
                {
                    $row_3 = empty($row[3])?0:$row[3];
                }
                else
                {
                    $row_3 = 0;
                }

                if(!empty($row[1]))
                {
                    $row[1] = htmlspecialchars(htmlspecialchars_decode($row[1]));
                    $row[1] = trim($row[1]);
                    // echo $row[1];
                    
                    array_push($trial_balance, array(
                        'assignment_id' => $assignment_id,
                        'description'        => $row[1],
                        // 'value'              => $this->evaluate_math_from_string(str_replace("=", "", $row[2])),
                        'value'              => $this->evaluate_math_from_string(round($row_2,2) - round($row_3,2)),
                        'order_by'           => $key,
                        'fs_company_info_id' => $fs_company_info_id
                    ));



                    $total_row_2 += round($row_2,2);
                    $total_row_3 += round($row_3,2);
                }
            }

            $total_trial_balance = round($total_row_2) - round($total_row_3);

            // print_r(array("total:", round($total_row_2), round($total_row_3), $total_trial_balance));

            if($total_trial_balance == 0.00 && count($trial_balance) > 0)
            {
                if($current_year_tb)    // trial balance for current year end
                {
                    $insert_result = $this->caf_model->insert_batch_trial_balance($trial_balance, $assignment_id);
             
                }
                else // trial balance for last year end
                {
                    $insert_result = $this->caf_model->insert_batch_LY_trial_balance($trial_balance, $assignment_id);
                }

                echo json_encode(array('status' => true, 'message' => 'Successfully saved extracted data!'));
            }
            elseif(!count($trial_balance) > 0)
            {
                echo json_encode(array('status' => false, 'message' => 'No account record is detected. Please make sure the Excel consists of account list or check uploaded excel format is same as required.'));
            }
            else
            {
                echo json_encode(array('status' => false, 'message' => 'Trial balance account is not balance! Please make sure the sum of values are equal to 0 in Excel.'));
            }
        }
        else
        {
            echo json_encode(array('status' => false, 'message' => 'Uploaded excel only accept maximum with 3 columns. Please remove other extra columns.'));
        }
    }

    public function uncategoriedData($assignment_id)
    {
        // $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $data = $this->caf_model->get_create_uncategorizedData($assignment_id);

        // $un_round_off_node = $this->db->query("SELECT * FROM audit_uncategorized_account WHERE assignment_id=" . $assignment_id . " AND type='Round_off'");
        // $un_round_off_node = $un_round_off_node->result_array();

        $round_off_node = $this->db->query("SELECT * FROM audit_categorized_account WHERE assignment_id=" . $assignment_id . " AND type='Round_off'");
        $round_off_node = $round_off_node->result_array();

        $uncategoriedData_list = [];

        // add round off node (for round off purpose)
        if(count($round_off_node) == 0)
        {
            $put_id = 1;

            if(count($data) > 0)
            {
                $put_id = count($data);
            }

            array_push($uncategoriedData_list, 
                array(
                    'id'     => 1,
                    'parent' => "#",
                    'text'   => 'Round Off - Adjustment',
                    'type'   => "Round_off",
                    'Order'  => 0,
                    'data'   => array(
                                    "value" => '',
                                    "company_end_prev_ye_value" => ''
                                )
                )
            );
        }

        if(count($data) > 0)    // load 
        {
            foreach ($data as $key => $value) 
            {
                if(empty($value['company_end_prev_ye_value']))
                {
                    $value['company_end_prev_ye_value'] = 0.00;
                }

                array_push($uncategoriedData_list, 
                    array(
                        'id'     => $value['id'],
                        'parent' => "#",
                        'text'   => $value['description'],
                        'type'   => "Leaf",
                        'Order'  => 0,
                        'data'   => array(
                                        "value" => $value['value'],
                                        "company_end_prev_ye_value" => $value['company_end_prev_ye_value']
                                    )
                    )
                );
            }
        }
        
        echo json_encode($uncategoriedData_list);
    }    

    public function categoriedDefaultData($assignment_id, $ajax=true) 
    {
        // $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $categorized_acc_list = $this->caf_model->get_categorizedData_or_default($assignment_id);

        foreach ($categorized_acc_list as $key => $value) 
        {
            if(isset($value['data']['company_end_prev_ye_value']))
            {
                $categorized_acc_list[$key]['data']['value']                     = $value['data']['value'];
                $categorized_acc_list[$key]['data']['company_end_prev_ye_value'] = $value['data']['company_end_prev_ye_value'];
            }
            
        }

        // print_r($categorized_acc_list);
        if($ajax)
        {
            echo json_encode($categorized_acc_list);
        }
        
        return json_encode($categorized_acc_list);
        
    }

    public function check_previous_update()
    {
        $form_data     = $this->input->post();

        $initial_categorized  = isset($form_data['InitialCategoriedTree'])?$form_data['InitialCategoriedTree']:array();

        // print_r($form_data);

        $assignment_id = $form_data['assignment_id'];
        $latest_tree   = $this->categoriedDefaultData($assignment_id, false);

        // print_r(array($initial_categorized, $latest_tree));

        if($initial_categorized == $latest_tree)
        {
            echo json_encode(array('status' => 'success'));
        }
        else
        {
            echo json_encode(array('status' => 'overwrite'));
        }
    }

    public function partial_sub_account_list()
    {
        $form_data = $this->input->post();
        $current_categorized_tree = $form_data['current_categorized_tree'];

        // print_r($current_categorized_tree);

        $sub_account_list = $this->caf_model->get_default_main_sub_account_list('sub'); 
        $exclude_account_code = $this->caf_model->get_fs_account_category_json(); 
        $exclude_account_code = $exclude_account_code['partial_sub_account_list'][0]['exclude_account'];    // exclude the account list from sub account list

        $sub_account_list_defined = [];


        $mapping_condition = $this->caf_model->get_audit_mapping_condition_json();

        // print_r($mapping_condition);
        $only_two_accounts      = $mapping_condition['condition']['only_two'];
        $more_than_two_accounts = $mapping_condition['condition']['more_than_two'];


        

        // print_r(count($sub_account_list));

        foreach($sub_account_list as $key => $value)
        {
            $temp = [];
            $is_used = false;
            $repeat_counter = 0;

            // if(!in_array($value['account_code'], $exclude_account_code))
            // {
                foreach($current_categorized_tree as $key => $value_1)
                {
                    // print_r(array($value_1['text'], $value_1['data']['account_code'], $value_1['data']['fs_default_acc_category_id'], $value['id'], $value_1['data']['fs_default_acc_category_id'] == $value['id']));
                    $data_value1 = array_key_exists('data', $value_1) ? $value_1['data'] : '';

                    if(isset($data_value1['account_code']))
                    {
                        if(!in_array($data_value1['account_code'], $only_two_accounts) && !in_array($data_value1['account_code'], $more_than_two_accounts))
                        {
                            // print_r(1);
                            if($data_value1 != '')
                            {
                                if($data_value1['fs_default_acc_category_id'] == $value['id'])
                                {
                                    $is_used = true;
                                }
                            }
                        }
                        else if(in_array($data_value1['account_code'], $only_two_accounts))
                        {
                            // print_r(2);
                            if($data_value1 != '')
                            {
                                if($data_value1['fs_default_acc_category_id'] == $value['id'])
                                {
                                    // $is_used = true;
                                    $repeat_counter++;
                                }

                                if($repeat_counter >= 2)
                                {
                                    $is_used = true;
                                }

                                // print_r(array($data_value1['account_code'], $repeat_counter));
                            }
                        }
                    }
                    // else
                    // {
                    //     // print_r(3);
                    //     $is_used = false;
                    // }

                   
                }

                array_push($sub_account_list_defined, array(
                    'fs_default_acc_category_id' => $value['id'],
                    'account_code' => $value['account_code'],
                    'description'  => $value['description'],
                    'is_used'      => $is_used
                ));
            // }
        }

        // foreach($sub_account_list as $key => $value)
        // {
        //     $temp = [];
        //     $is_used = false;

        //     if(!in_array($value['account_code'], $exclude_account_code))
        //     {
        //         foreach($current_categorized_tree as $key => $value_1)
        //         {
        //             // print_r($value_1);
        //             $data_value1 = array_key_exists('data', $value_1) ? $value_1['data'] : '';
        //             if($data_value1 != '')
        //             {
        //                 if(isset($data_value1['fs_default_acc_category_id']))
        //                 {
        //                     if($data_value1['fs_default_acc_category_id'] == $value['id'])
        //                     {
        //                         $is_used = true;
        //                     }
        //                 }
                        
        //             }
                    
        //         }

        //         array_push($sub_account_list_defined, array(
        //             'fs_default_acc_category_id' => $value['id'],
        //             'account_code' => $value['account_code'],
        //             'description'  => $value['description'],
        //             'is_used'      => $is_used
        //         ));
        //     }
        // }

        $this->data['sub_account_list'] = $sub_account_list_defined;

        $interface = $this->load->view('modal_template/partial_sub_account_list.php', $this->data);
    }

    /* SAVE DATA */
    public function save_categorized_uncategorized_account()
    {
        $form_data     = $this->input->post();

        $initial_categorized  = isset($form_data['InitialCategoriedTree'])?json_decode($form_data['InitialCategoriedTree'], true):array();
        $categorized          = isset($form_data['CategoriedTree'])?json_decode($form_data['CategoriedTree'], true):array();
        $uncategorized        = isset($form_data['UncategoriedTree'])?json_decode($form_data['UncategoriedTree'], true):array();

        // print_r($uncategorized);

        $assignment_id = $form_data['assignment_id'];
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

        $total_value_ty = 0;
        $total_value_ly = 0;

        foreach ($categorized as $key => $value) 
        {
            if($value['type'] != 'Branch' && $value['type'] != "Round_off")
            {
                $value_ty = round($this->revert_to_original_value($value['data']['value']), 2);
                $value_ly = round($this->revert_to_original_value($value['data']['company_end_prev_ye_value']), 2);

                $total_value_ty += $value_ty;
                $total_value_ly += $value_ly;
            }
        }

        // for uncategorized, don't save round off node
        foreach ($uncategorized as $key => $value)
        {
            if($value['type'] == "Round_off")
            {
                unset($uncategorized[$key]);
            }
        }

        $x = $this->caf_model->insert_categorized_account($initial_categorized, $categorized, $assignment_id);
        $y = $this->caf_model->insert_uncategorized_account(array_values($uncategorized), $assignment_id);
        /* END OF Add these function for financial statement(FS) system use later - 1/10/2020 */

        $e = $this->caf_model->update_next_ye_values($assignment_id, $fs_company_info_id);

        if(number_format($total_value_ty, 2) == 0 && number_format($total_value_ly, 2) == 0)
        { 
            // print_r("here");
            if($x['result'] && $y['result'])
            {
                /* Add these function for financial statement(FS) system use later - 1/10/2020 */
                // $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

                $z = $this->caf_model->insert_categorized_account_round_off($fs_company_info_id); // duplicate data for round off and save to fs_categorized_account_round_off
                $adjust_round_off = $this->fs_account_category_model->fs_adjust_round_off($fs_company_info_id);
                $b = $this->fs_system_model->insert_update_fs_state_comp_income($fs_company_info_id);

                $a = $this->fs_notes_model->update_reset_fs_ntfs($fs_company_info_id);
                $c = $this->fs_notes_model->insert_update_fs_note_details($fs_company_info_id);
                $d = $this->fs_notes_model->insert_fs_state_comp_income_fs_note_details($fs_company_info_id);

                $categoried_data = $this->categoriedDefaultData($assignment_id, false);

                /* END OF Add these function for financial statement(FS) system use later - 1/10/2020 */
                echo json_encode(array('result' => true, 'message' => 'Trial Balance categorized!', 'categoried_tree' => $categoried_data));
            }
            else
            {
                $categoried_data = $this->categoriedDefaultData($assignment_id, false);
                echo json_encode(array('result' => false, 'message' => 'Opps! Something went wrong! Please try again later.', 'categoried_tree' => $categoried_data));
            }
        }
        else
        {
            // print_r("here else");
            if(number_format($total_value_ty, 2) != 0 && number_format($total_value_ly, 2) != 0)
            {
                $categoried_data = $this->categoriedDefaultData($assignment_id, false);
                echo json_encode(array('result' => true, 'message' => 'Data is saved but total of "Current Year Value" and "Last Year Value" are not equal to 0! (' . number_format($total_value_ty, 2) . ', ' . number_format($total_value_ly, 2) . ')','categoried_tree' => $categoried_data));
            }
            elseif(number_format($total_value_ty, 2) != 0)
            {
                $categoried_data = $this->categoriedDefaultData($assignment_id, false);
                echo json_encode(array('result' => true, 'message' => 'Data is saved but total of "Current Year Value" is not equal to 0! (' . number_format($total_value_ty, 2) . ')','categoried_tree' => $categoried_data));
            }
            elseif(number_format($total_value_ly, 2) != 0)
            {
                $categoried_data = $this->categoriedDefaultData($assignment_id, false);
                echo json_encode(array('result' => true, 'message' => 'Data is saved but total of "Last Year Value" is not equal to 0! (' . number_format($total_value_ly, 2) . ')','categoried_tree' => $categoried_data));
            }
        }

        
        // $update_state_comp_income = $this->fs_statements_model->update_state_comp_income($fs_company_info_id);

        // echo json_encode($x);
    }
    /* END OF SAVE DATA */

    public function add_programme_caf()
    {
        $form_data  = $this->input->post();

        $add_programme_caf = $form_data['selected_programme'];
        $assignment_id = $form_data['assignment_id'];

        $caf_type_id = "";

        $programme_q = $this->db->query("SELECT * FROM audit_programme_master where deleted=0 and archived=0 ORDER BY programme_index");

        $programme_arr = $programme_q->result_array();

        foreach ($programme_arr as $programme_key => $programme_each) {
            if (in_array($programme_each['id'], $add_programme_caf)) {
                // if($programme_each['programme_type'] == 1)
                // {
                //     $caf_type_id = 7;
                // }
                // else if($programme_each['programme_type'] == 2)
                // {
                //     $caf_type_id = 8;
                // }
                // else if($programme_each['programme_type'] == 3)
                // {
                //     $caf_type_id = 8;
                // }
                $caf_type_id = $programme_each['programme_type'] + 6;

                $data   = array(
                        'assignment_id'       => $assignment_id,
                        'created_by'          => $this->session->userdata('user_id'),
                        'index_no'            => strtoupper($programme_each['programme_index']),
                        'name'                => $programme_each['title'],
                        'programme_master_id' => $programme_each['id'],
                        'type_id'             => $caf_type_id,  // type id 7 is audit_programme

                      );

                // print_r($data);

                $this->db->insert('audit_caf_master', $data);
            }


            
        }

        echo json_encode(array('result' => true, 'message' => 'Programme added successfully'));

    }

    public function add_awp_caf()
    {
        $form_data  = $this->input->post();


        // $add_programme_caf = $form_data['selected_programme'];
        $assignment_id = $form_data['assignment_id'];

        $caf_type_id = 16;

        $data   = array(
                        'assignment_id'       => $assignment_id,
                        'created_by'          => $this->session->userdata('user_id'),
                        'index_no'            => strtoupper($form_data['caf_index']),
                        'name'                => $form_data['caf_name'],
                        'type_id'             => $caf_type_id

                      );

                // print_r($data);

        $this->db->insert('audit_caf_master', $data);

       

        echo json_encode(array('result' => true, 'message' => 'Working paper added successfully'));

    }

    public function add_leadsheet_caf()
    {
        $form_data  = $this->input->post();

        $assignment_id = $form_data['assignment_id'];

        $caf_type_id = 17;

        $data   = array(
                        'assignment_id'       => $assignment_id,
                        'created_by'          => $this->session->userdata('user_id'),
                        'index_no'            => strtoupper($form_data['caf_index']),
                        'name'                => $form_data['caf_name'],
                        'leadsheet_acc_id'    => $form_data['leadsheet_name'],
                        'type_id'             => $caf_type_id

                      );

                // print_r($data);

        $this->db->insert('audit_caf_master', $data);

       

        echo json_encode(array('result' => true, 'message' => 'Leadsheet added successfully'));

    }

    public function get_sheet_id()
    {
        $client = $this->getClient();
 

        $service = new Google_Service_Sheets($client);
 
   
        $spreadsheet = new Google_Service_Sheets_Spreadsheet([
            'properties' => [
                'title' => 'Audit Working Paper'
            ]
        ]);
        $spreadsheet = $service->spreadsheets->create($spreadsheet, [
            'fields' => 'spreadsheetId'
        ]);

        echo json_encode(array('result' => true, 'spreadsheet_id' => $spreadsheet->spreadsheetId));
        // printf("Spreadsheet ID: %s\n", );
    
    }


    public function revert_to_original_value($number)
    {
        $number = str_replace(',', '', $number);
        $number = str_replace('(', '-', $number);
        $number = str_replace(')', '', $number);

        return (float)$number;
    }

    public function levelling_table_header_setting($fs_company_info_id)
    {


        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        

         // initialise
        $current_fye_end  = '';
        $last_fye_end     = '';
        $display_restated = false;

        /* Don't delete this */
        // if($fs_company_info[0]['is_prior_year_amount_restated'])
        // {
        //     if(strcmp($fs_company_info[0]['effect_of_restatement_since'], $fs_company_info[0]['last_fye_begin']) == 0)
        //     {
        //         $this->data["display_restated"] = true;
        //     }
        // }
        /* Don't delete this */

        // display column(s) for years
        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }
        else
        {
            $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

            $current_fye_end  = $current_last_year_end['current_fye_end'];    // this year end eg. 31/12/2019
            $last_fye_end     = $current_last_year_end['last_fye_end'];       // end of previous year end
        }


        if ($last_fye_end != '')
        {
            $header_row1 = array(array(""));
            array_push($header_row1, $current_fye_end.'<br>Unadjusted');
            array_push($header_row1, array("label" => "DR", "colspan" => 2));
            array_push($header_row1, array("label" => "CR", "colspan" => 2));
            array_push($header_row1, $current_fye_end.'<br>Adjusted');
            array_push($header_row1, $last_fye_end.'<br>Adjusted');
            array_push($header_row1, array("label" => "Variance", "colspan" => 2));

            $header_row2 = array('');
            array_push($header_row2, '$');
            array_push($header_row2, array("label" => "$", "colspan" => 2));
            array_push($header_row2, array("label" => "$", "colspan" => 2));
            array_push($header_row2, '$');
            array_push($header_row2, '$');
            array_push($header_row2, '$');
            array_push($header_row2, '%');

        }
        else
        {
            $header_row1 = array('');
            array_push($header_row1, $current_fye_end.'<br>Unadjusted');
            array_push($header_row1, array("label" => "DR", "colspan" => 2));
            array_push($header_row1, array("label" => "CR", "colspan" => 2));
            array_push($header_row1, $current_fye_end.'<br>Adjusted');

            $header_row2 = array('');
            array_push($header_row2, '$');
            array_push($header_row2, array("label" => "$", "colspan" => 2));
            array_push($header_row2, array("label" => "$", "colspan" => 2));
            array_push($header_row2, '$');
        }


        $array_header_col_setting = array();
        array_push($array_header_col_setting, 
            array("data" => "account"),
            array("data" => "this_ye_value" , "className" => "htRight"),
            array("data" => "dr_adjust_ref"),
            array("data" => "dr_adjust_value", "className" => "htRight"),
            array("data" => "cr_adjust_ref"),
            array("data" => "cr_adjust_value", "className" => "htRight"),
            array("data" => "this_ye_adjusted_value", "className" => "htRight")
        );

        if($last_fye_end != '')
        {
            array_push($array_header_col_setting, 
                array("data" => "last_ye_value", "className" => "htRight"),
                array("data" => "variance_value", "className" => "htRight"),
                array("data" => "variance_percent", "className" => "htCenter")
            );
        }

        

        return [[$header_row1, $header_row2], $array_header_col_setting];
        // return [$header_row1];
        // return $header_row1;

        // $header = array("Activities");
        // array_push($header,"Type of Job");
        // array_push($header,"FYE");

        // $array_header_col_readonly = array();
        // array_push($array_header_col_readonly, 
        //     array("data" => "Activities", "className" => "act"),
        //     array("data" => "Type of Job", "className" => "act"),
        //     array("data" => "FYE", "className" => "act")
        // );

        // $i = 1;
        // foreach($this_month_date_days as $row){
        //     $is_public_holiday = $this->holiday_model->is_public_holiday($row['date'],$emp_id);

        //     array_push($header, (string)$i);

        //     if($row[$i] == 6 || $row[$i] == 7 || $is_public_holiday){
        //         array_push($array_header_col_readonly, array(
        //             "data"      => (string)$i,
        //             "className" => "WeekEnd htRight"

        //         ));
        //     }
        //     else{
        //         array_push($array_header_col_readonly, array(
        //             "data"      => (string)$i,
        //             "className" => "htRight"
        //         ));
        //     }

        //     $i++;
        // }

        // array_push($array_header_col_readonly, 
        //     array("data" => "current", "className" => "tt htRight", "readOnly" => true),
        //     array("data" => "b/f",     "className" => "tt htRight"),
        //     array("data" => "total",   "className" => "tt htRight", "readOnly" => true)
        // );
        // array_push($header, "current", "b/f", "total");

        // return [$header, $array_header_col_readonly];
    }

    public function build_json_data($data, $fs_ntfs_list, $description_reference_id_list, $current_fye_end, $adjustment_data)
    {
        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];
        $json_row = [];

        $index = 0;
        $note_no = 0;


        $total_assets_c          = 0.00;
        $total_assets_c_adjusted = 0.00;
        $total_assets_c_end      = 0.00;
        $total_assets_c_beg      = 0.00;

        $total_equity_c          = 0.00;
        $total_equity_c_adjusted = 0.00;
        $total_equity_c_end      = 0.00;
        $total_equity_c_beg      = 0.00;

        $total_liabilities_c          = 0.00;
        $total_liabilities_c_adjusted = 0.00;
        $total_liabilities_c_end      = 0.00;
        $total_liabilities_c_beg      = 0.00;

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        if(count($eq_liabi_title_list) == 1)  
        {
            if($eq_liabi_title_list[0] == "Equity")
            {
                $e_l_title = '';    // remove title if got equity only
            }
        }

        $displayed_eq_liabi_title = false;

        /*----------------------------------------------------------Start to loop data--------------------------------------------------------*/

        $index = 0;
        
        foreach ($data as $level_1_key => $level_1) 
        {
            $hide_main_title = false;
            $level_1_description = "";

            $fs_ntfs_list_key = array_search($level_1['parent_array'][0]['account_code'], array_column($fs_ntfs_list, "account_code")); // get key

            if(!empty($fs_ntfs_list_key) || (string)$fs_ntfs_list_key == 0)
            {
                $level_1_description = $fs_ntfs_list[$fs_ntfs_list_key]['description']; // get description from fs_ntfs_list json from document name "Statement of financial position"
            }

            /* ---------------------------- Display main category (Level 1). eg. Assets, Equity and Liabilities ---------------------------- */
            if(count($level_1['child_array']) == 1)
            {
                foreach ($level_1['child_array'] as $key => $value) 
                {
                    if(empty($value['parent_array']))
                    {
                        $hide_main_title = true;
                    }
                }
            }

            if($level_1_description == "Assets" && (count($level_1['child_array']) > 0) && !$hide_main_title)
            {
                
                $temp_row = array('account'=> '<b>'.ucfirst(strtolower($level_1['parent_array'][0]['description'])).'</b>')
                ;
                // $temp_row = array(ucfirst(strtolower($level_1['parent_array'][0]['description'])));
                // $empty_row   = array();

                // if ($current_fye_end != "")
                // {
                //     array_push($temp_row, "", "", "", "", "", "", "", "", "");
                // }
                // else
                // {
                //     array_push($temp_row, "", "", "", "", "", "");
                // }
                
                array_push($json_row, $temp_row);
                // $json_row = $temp_row;


                // print_r($data);
            }

            if(($level_1_description == "Equity" || $level_1_description == "Liabilities"))
            {
                $empty_inner_item = false;

                if($level_1_description == "Equity")
                {
                    $level_1['child_array'] = array($level_1); 
                }
                elseif($level_1_description == "Liabilities")
                {
                    if(isset($level_1['child_array'][0]['parent_array']))
                    {
                        if($level_1['child_array'][0]['parent_array'] == null)
                        {
                            // $level_1['child_array'] = array(array('child_array' => $level_1['child_array']));
                            $level_1['child_array'] = [];
                            $empty_inner_item = true;
                        }
                    }
                    
                }

                if(!$displayed_eq_liabi_title && !$empty_inner_item && !empty($e_l_title))
                {
                    

                    // $temp_row = array("data" => $e_l_title, "className" => "level_1");
                    $temp_row = array();
                    $temp_row = array('account' => '<b>'.$e_l_title.'</b>');
                    // // $empty_row   = array();

                    // if ($current_fye_end != "")
                    // {
                    //     array_push($temp_row, "", "", "", "", "", "", "", "", "");
                    // }
                    // else
                    // {
                    //     array_push($temp_row, "", "", "", "", "", "");
                    // }
                    
                    array_push($json_row, $temp_row);

                    $displayed_eq_liabi_title = true;
                }
            }

            if(!empty($level_1['parent_array']))           
            {
                foreach ($level_1['child_array'] as $level_2_key => $level_2) 
                {
                    // print_r($level_2);
                
                    $temp_total_c          = 0.00;
                    $temp_total_c_adjusted = 0.00;
                    $temp_total_c_end      = 0.00;
                    $temp_total_c_beg      = 0.00;
                    

                    /* DISPLAY 1 LINE ONLY IF NO CHILD UNDER LEVEL 2 */
                    if(count($level_2['child_array']) > 0)
                    {
                        if(!empty($level_2['parent_array']))
                        {
                            // echo 
                            // '<tr>'.
                            //     '<td><strong><em>' . ucfirst(strtolower($level_2['parent_array'][0]['description'])) . '</em></strong></td>' .
                            //     '<td align="center"></td>' .
                            //     '<td style=">&nbsp;</td>' .
                            //     '<td colspan="9"></td>' .
                            // '</tr>';
                            $temp_row = array();
                            $temp_row = array('account'=> '<b><i>'.ucfirst(strtolower($level_2['parent_array'][0]['description'])).'</i></b>');
       
                            array_push($json_row, $temp_row);

                            foreach ($level_2['child_array'] as $level_3_key => $level_3)
                            {
                               
                                /* DISPLAY LEVEL 3 THAT HAS SUBCATEGORY */
                                if(!empty($level_3['parent_array']))
                                {
                                    $temp_c          = isset($level_3['parent_array'][0]['total_c'])?$level_3['parent_array'][0]['total_c']:0;
                                    $temp_c_adjusted = isset($level_3['parent_array'][0]['total_c_adjusted'])?$level_3['parent_array'][0]['total_c_adjusted']:0;
                                    $temp_c_lye      = isset($level_3['parent_array'][0]['total_c_lye'])?$level_3['parent_array'][0]['total_c_lye']:0;

                                    $temp_id         = $level_3['parent_array'][0]['id'];
                                    // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                    $temp_child_id = isset($level_3['parent_array'][0]['child_id'])?$level_3['parent_array'][0]['child_id']:"";
                                    $temp_adjustment_info = $this->get_adjustment_of_child($temp_child_id, $adjustment_data);
                                    $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                    $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                    $adjustment_for_rev_rsrve = 0.00;
                                    $adjustment_for_pl = 0.00;

                                    $variance_value  = $this->calculate_variance($temp_c_adjusted ,$temp_c_lye);

                                    // print_r($level_3['parent_array'][0]);
                                    // echo json_encode($level_3['fs_note_details']);
                                    $temp_row = array();
                                    $temp_row = array(
                                                    'account'=> ucfirst(strtolower($level_3['parent_array'][0]['description'])), 
                                                    'this_ye_value' => $this->negative_bracket($temp_c),
                                                    'this_ye_adjusted_value' => $this->negative_bracket($temp_c_adjusted)
                                                );

                                    if($level_3['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value == "")
                                    {
                                        //multiply with -1 because retained earning is opposite sign
                                        $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c);
                    
                                        if($adjustment_for_pl > 0)
                                        {
                                            $temp_row['dr_adjust_ref'] = "<b>P/L</b>";
                                            $temp_row['dr_adjust_value'] = $this->negative_bracket($adjustment_for_pl);
                                            
                                        }
                                        else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                        {
                                            $temp_row['cr_adjust_ref'] = "<b>P/L</b>";
                                            $temp_row['cr_adjust_value'] = $this->negative_bracket($adjustment_for_pl);
                                        }
                                    }

                                    if($level_3['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value != "")
                                    {
                                        $adjustment_for_rev_rsrve += $temp_adjust_value;
                                    }


                                    if($temp_adjust_value > 0)
                                    {
                                        // echo 
                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                        // echo 
                                        //     '<td align="right"></td>';
                                        $temp_row['dr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                        $temp_row['dr_adjust_value'] = $this->negative_bracket($temp_adjust_value);
                                    }
                                    else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                    {
                                        // echo 
                                        //     '<td align="right"></td>';
                                        // echo 
                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';

                                        $temp_row['cr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                        $temp_row['cr_adjust_value'] = $this->negative_bracket(abs($temp_adjust_value));
                                    }

                                    if(!empty($current_fye_end))
                                    {

                                        
                                        $temp_row['last_ye_value'] = $this->negative_bracket($temp_c_lye);
                                        $temp_row['variance_value'] = $this->negative_bracket($variance_value['dollar']);
                                        $temp_row['variance_percent'] = number_format($variance_value['percentage'], 2).'%';

                                       
                                    }
                             
                                    array_push($json_row, $temp_row);

                                    $temp_total_c          += (double)$temp_c;
                                    $temp_total_c_adjusted += (double)$temp_c_adjusted;
                                    $temp_total_c_end      += (double)$temp_c_lye;
                                    $temp_total_c_beg      += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];

                                    //loop all adjustment info 
                                    if(count($temp_adjustment_info) > 1)
                                    {
                                        foreach ($temp_adjustment_info as $info_key => $each_info) {
                                            if($info_key != 0)
                                            {
                                                $temp_adjust_value = $each_info['adjusted_value'];
                                                $temp_je_no = $each_info['type_name'].$each_info['je_no'];

                                                $temp_row = array();

                                                if($temp_adjust_value != "")
                                                {
                                                    $adjustment_for_rev_rsrve += $temp_adjust_value;
                                                }

                                                if($temp_adjust_value > 0)
                                                {
                                                    // echo 
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                                    // echo 
                                                    //     '<td align="right"></td>';
                                                    $temp_row['dr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                                    $temp_row['dr_adjust_value'] = $this->negative_bracket($temp_adjust_value);
                                                }
                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                {
                                                    // echo 
                                                    //     '<td align="right"></td>';
                                                    // echo 
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';

                                                    $temp_row['cr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                                    $temp_row['cr_adjust_value'] = $this->negative_bracket(abs($temp_adjust_value));
                                                }

                                                array_push($json_row, $temp_row);

                                                // echo '<tr>
                                                //         <td></td>
                                                //         <td></td>';
                                                // if($temp_adjust_value > 0)
                                                // {
                                                //     echo 
                                                //         '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                                //     echo 
                                                //         '<td align="right"></td>';
                                                // }
                                                // else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                // {
                                                //     echo 
                                                //         '<td align="right"></td>';
                                                //     echo 
                                                //         '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';
                                                // }
                                                // else
                                                // {
                                                //     echo 
                                                //         '<td align="right"></td>';
                                                //     echo 
                                                //         '<td align="right"></td>';
                                                // }
                                                // echo  '</tr>';
                                            }
                                        }
                                        
                                    }


                                    if($level_3['parent_array'][0]['account_code'] == 'Q1030000' && $adjustment_for_rev_rsrve != 0)
                                    {
                                        //multiply with -1 because retained earning is opposite sign
                                        $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c) - $adjustment_for_rev_rsrve;
                                        $temp_row = array();
                    
                                        if($adjustment_for_pl > 0)
                                        {
                                            $temp_row['dr_adjust_ref'] = "<b>P/L</b>";
                                            $temp_row['dr_adjust_value'] = $this->negative_bracket($adjustment_for_pl);
                                            
                                        }
                                        else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                        {
                                            $temp_row['cr_adjust_ref'] = "<b>P/L</b>";
                                            $temp_row['cr_adjust_value'] = $this->negative_bracket($adjustment_for_pl);
                                        }
                                        array_push($json_row, $temp_row);
                    
                                        // echo '<tr>
                                        //         <td></td>
                                        //         <td></td>';
                                        // if($adjustment_for_pl > 0)
                                        // {
                                        //     echo 
                                        //         '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket($adjustment_for_pl).'</td>';
                                        //     echo 
                                        //         '<td align="right"></td>';
                                        // }
                                        // else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                        // {
                                        //     echo 
                                        //     '<td align="right"></td>';

                                        //     echo 
                                        //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket(abs($adjustment_for_pl)).'</td>';
                                        // }
                                        // echo  '</tr>';
                                    }

                                    $index++;
                                }

                                /* DISPLAY LEVEL 3 WITHOUT SUBCATEGORY UNDER IT */
                                elseif($level_1_description == "Liabilities" || $level_1_description == "Assets")
                                {
                                    $temp_id         = $level_3['child_array']['id'];
                                    $temp_adjustment_info = isset($adjustment_data[$temp_id][0])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                    $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][0]['type_name'].$adjustment_data[$temp_id][0]['je_no']:"";

                                    $variance_value = $this->calculate_variance($level_3['child_array']['adjusted_value'],$level_3['child_array']['company_end_prev_ye_value']);

                                    $temp_row = array();
                                    $temp_row = array(
                                                    'account'=> $level_3['child_array']['description'], 
                                                    'this_ye_value' => $this->negative_bracket($level_3['child_array']['value']),
                                                    'this_ye_adjusted_value' => $this->negative_bracket($level_3['child_array']['adjusted_value'])
                                                );

                                    if($temp_adjustment_info > 0)
                                    {
                                        // echo 
                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                        // echo 
                                        //     '<td align="right"></td>';
                                        $temp_row['dr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                        $temp_row['dr_adjust_value'] = $this->negative_bracket($temp_adjust_value);
                                    }
                                    else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                    {
                                        // echo 
                                        //     '<td align="right"></td>';
                                        // echo 
                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';

                                        $temp_row['cr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                        $temp_row['cr_adjust_value'] = $this->negative_bracket(abs($temp_adjustment_info));
                                    }

                                    if(!empty($current_fye_end))
                                    {

                                        
                                        $temp_row['last_ye_value'] = $this->negative_bracket($level_3['child_array']['company_end_prev_ye_value']);
                                        $temp_row['variance_value'] = $this->negative_bracket($variance_value['dollar']);
                                        $temp_row['variance_percent'] = number_format($variance_value['percentage'], 2).'%';

                                       
                                    }

                                    array_push($json_row, $temp_row);
                              


                                    $temp_total_c         += (double)$level_3['child_array']['value'];
                                    $temp_total_c_adjusted  += (double)$level_3['child_array']['adjusted_value'];
                                    $temp_total_c_end     += (double)$level_3['child_array']['company_end_prev_ye_value'];
                                    $temp_total_c_beg     += (double)$level_3['child_array']['company_beg_prev_ye_value'];
                                        
                                    // echo '</tr>';

                                    //loop all adjustment info

                                    if(isset($adjustment_data[$temp_id]) && count($adjustment_data[$temp_id]) > 1)
                                    {
                                        foreach ($temp_adjustment_info as $info_key => $each_info) {
                                            if($info_key != 0)
                                            {
                                                $temp_adjust_value = $each_info['adjusted_value'];
                                                $temp_je_no = $each_info['type_name'].$each_info['je_no'];

                                                $temp_row = array();

                                                if($temp_adjust_value != "")
                                                {
                                                    $adjustment_for_rev_rsrve += $temp_adjust_value;
                                                }

                                                if($temp_adjust_value > 0)
                                                {
                                                    // echo 
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                                    // echo 
                                                    //     '<td align="right"></td>';
                                                    $temp_row['dr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                                    $temp_row['dr_adjust_value'] = $this->negative_bracket($temp_adjust_value);
                                                }
                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                {
                                                    // echo 
                                                    //     '<td align="right"></td>';
                                                    // echo 
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';

                                                    $temp_row['cr_adjust_ref'] = "<b>".$temp_je_no."</b>";
                                                    $temp_row['cr_adjust_value'] = $this->negative_bracket(abs($temp_adjust_value));
                                                }

                                                array_push($json_row, $temp_row);

                            
                                            }
                                        }
                                        
                                    }

                                    $index++;
                                }
                                /* END OF DISPLAY LEVEL 3 WITHOUT SUBCATEGORY UNDER IT */
                            }

                            /* DISPLAY TOTAL FOR EACH CATEGORY  */
                            $total          = $temp_total_c;
                            $total_adjusted = $temp_total_c_adjusted;
                            $total_end  = $temp_total_c_end;
                            $total_beg  = $temp_total_c_beg;

                            /* CALCULATE TOTAL ASSETS, TOTAL EQUITY, LIABILITIES - COMPANY */
                            if($level_1_description == "Assets")    // NON-CURRENT ASSETS || CURRENT ASSETS
                            {
                                $total_assets_c          += $total;
                                $total_assets_c_adjusted += $total_adjusted;
                                $total_assets_c_end      += $total_end;
                                $total_assets_c_beg      += $total_beg;
                            }
                            elseif($level_1_description == "Equity") // EQUITY
                            {
                                $total_equity_c          += $total;
                                $total_equity_c_adjusted += $total_adjusted;
                                $total_equity_c_end      += $total_end;
                                $total_equity_c_beg      += $total_beg;
                            }
                            elseif($level_1_description == "Liabilities") // NON-CURRENT LIABILITIES || CURRENT LIABILITIES
                            {
                                $total_liabilities_c           += $total;
                                $total_liabilities_c_adjusted  += $total_adjusted;
                                $total_liabilities_c_end       += $total_end;
                                $total_liabilities_c_beg       += $total_beg;
                            }
                            /* END OF CALCULATE TOTAL ASSETS, TOTAL EQUITY, LIABILITIES */
                            
                            $variance_value = $this->calculate_variance($total_adjusted,$total_end);

                            // echo 
                            // '<tr>' . 
                            //     '<td></td>' . 
                            //     '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                            //         '<span id="' . $display_class_ye . '_subtotal_'. $level_2['parent_array'][0]['id'] .'">' . 
                            //             negative_bracket($total) . 
                            //         '</span>' . 
                            //     '</td>';
                                
                            // echo 
                            //     '<td align="right"></td>';
                            // echo 
                            //     '<td align="right"></td>';

                            // echo 
                            //     '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                            //         '<span>' . 
                            //             negative_bracket($total_adjusted) . 
                            //         '</span>' . 
                            //     '</td>';

                            //     if(!empty($last_fye_end))
                            //     {
                            //         echo 
                            //         '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                            //             '<span id="' . $display_class_lye_end . '_subtotal_'. $level_2['parent_array'][0]['id'] .'">' . 
                            //                 negative_bracket($total_end) . 
                            //             '</span>' . 
                            //         '</td>';

                            //         if($show_third_col)
                            //         {
                            //             echo 
                            //             '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                            //                 '<span id="' . $display_class_lye_beg . '_subtotal_'. $level_2['parent_array'][0]['id'] .'">' . 
                            //                     negative_bracket($total_beg) . 
                            //                 '</span>' . 
                            //             '</td>';
                            //         }

                            //         echo '<td align="right">'.negative_bracket($variance_value['dollar']).'</td>';
                            //         echo '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';

                    
                            //     }

                                
                                
                            // echo '</tr>';
                            /* END OF DISPLAY TOTAL FOR EACH CATEGORY */

                            $temp_row = array();
                            $temp_row = array(
                                            'this_ye_value' => "~".$this->negative_bracket($total),
                                            'this_ye_adjusted_value' => "~".$this->negative_bracket($total_adjusted)
                                        );
                            if(!empty($current_fye_end))
                            {

                                $temp_row['last_ye_value']    = "~".$this->negative_bracket($total_end);
                                $temp_row['variance_value']   = $this->negative_bracket($variance_value['dollar']);
                                $temp_row['variance_percent'] = number_format($variance_value['percentage'], 2).'%';
                               
                            }
                            array_push($json_row, $temp_row);

                        }
                    }
                }
            }

            /* DISPLAY TOTAL ASSETS */
            if($level_1_description == "Assets" && (count($level_1['child_array']) > 0) && !$hide_main_title)
            {
                

                $total_assets          = 0.00;
                $total_assets_adjusted = 0.00;
                $total_assets_end      = 0.00;
                $total_assets_beg      = 0.00;

        
                $total_assets     = $total_assets_c;
                $total_assets_adjusted = $total_assets_c_adjusted;
                $total_assets_end = $total_assets_c_end;
                $total_assets_beg = $total_assets_c_beg;


                $variance_value = $this->calculate_variance($total_assets_adjusted,$total_assets_end);

                $temp_row = array();
                $temp_row = array(
                                'account'       => '<b>Total assets</b>',
                                'this_ye_value' => "=".$this->negative_bracket($total_assets),
                                'this_ye_adjusted_value' => "=".$this->negative_bracket($total_assets_adjusted)
                            );
                if(!empty($current_fye_end))
                {

                    $temp_row['last_ye_value']    = "=".$this->negative_bracket($total_assets_end);
                    $temp_row['variance_value']   = $this->negative_bracket($variance_value['dollar']);
                    $temp_row['variance_percent'] = number_format($variance_value['percentage'], 2).'%';
                   
                }
                array_push($json_row, $temp_row);
                
            }
            /* END OF DISPLAY TOTAL ASSETS */

            /* DISPLAY TOTAL LIABILITES */
            if($level_1_description == "Liabilities" && (count($level_1['child_array']) > 0) && !$hide_main_title)
            {
                if(in_array("Liabilities", $eq_liabi_title_list))
                {
                    $total_liabilities            = 0.00;
                    $total_liabilities_adjusted   = 0.00;
                    $total_liabilities_end        = 0.00;
                    $total_liabilities_beg        = 0.00;

        
                    $total_liabilities          = $total_liabilities_c;
                    $total_liabilities_adjusted = $total_liabilities_c_adjusted;
                    $total_liabilities_end      = $total_liabilities_c_end;
                    $total_liabilities_beg      = $total_liabilities_c_beg;

                    $variance_value = $this->calculate_variance($total_liabilities_adjusted,$total_liabilities_end);

                    $temp_row = array();
                    $temp_row = array(
                                    'account'       => '<b>Total liabilities</b>',
                                    'this_ye_value' => "~".$this->negative_bracket($total_liabilities),
                                    'this_ye_adjusted_value' => "~".$this->negative_bracket($total_liabilities_adjusted)
                                );
                    if(!empty($current_fye_end))
                    {

                        $temp_row['last_ye_value']    = "~".$this->negative_bracket($total_liabilities_end);
                        $temp_row['variance_value']   = $this->negative_bracket($variance_value['dollar']);
                        $temp_row['variance_percent'] = number_format($variance_value['percentage'], 2).'%';
                       
                    }
                    array_push($json_row, $temp_row);

                    $temp_row = array();
                    array_push($json_row, $temp_row);
                }
            }
            /* END OF DISPLAY TOTAL LIABILITES */

            /* DISPLAY TOTAL EQUITY & LIABILITIES */
            elseif($level_1_key == count($data) - 1)
            {
                if(count($eq_liabi_title_list) > 1)
                {
                    $total_equity_liabilities           = 0.00;
                    $total_equity_liabilities_adjusted  = 0.00;
                    $total_equity_liabilities_end       = 0.00;
                    $total_equity_liabilities_beg       = 0.00;

                
                    $total_equity_liabilities           = $total_equity_c   + $total_liabilities_c;
                    $total_equity_liabilities_adjusted  = $total_equity_c_adjusted  + $total_liabilities_c_adjusted;
                    $total_equity_liabilities_end       = $total_equity_c_end + $total_liabilities_c_end;
                    $total_equity_liabilities_beg       = $total_equity_c_beg + $total_liabilities_c_beg;

                    $variance_value = $this->calculate_variance($total_equity_liabilities_adjusted,$total_equity_liabilities_end);
                
                    $temp_row = array();
                    $temp_row = array(
                                    'account'       => '<b>Total equity and liabilities</b>',
                                    'this_ye_value' => "=".$this->negative_bracket($total_equity_liabilities),
                                    'this_ye_adjusted_value' => "=".$this->negative_bracket($total_equity_liabilities_adjusted)
                                );
                    if(!empty($current_fye_end))
                    {

                        $temp_row['last_ye_value']    = "=".$this->negative_bracket($total_equity_liabilities_end);
                        $temp_row['variance_value']   = $this->negative_bracket($variance_value['dollar']);
                        $temp_row['variance_percent'] = number_format($variance_value['percentage'], 2).'%';
                       
                    }
                    array_push($json_row, $temp_row);
    
                }

                
            }
            /* END OF DISPLAY TOTAL LIABILITES, TOTAL EQUITY & LIABILITIES */

            /* BREAK LINE */
            if($level_1_key < (count($data[0]) - 1) && (count($level_1['child_array']) > 0) && !$hide_main_title)
            {
                $temp_row = array();
                array_push($json_row, $temp_row);
            }
            /* END OF BREAK LINE */
                                    

            
           

        }

        return $json_row;
                        
    }


    public function write_address($street_name, $unit_no1, $unit_no2, $building_name, $postal_code, $type)
    {
        $unit = '';
        $unit_building_name = '';

        $comma = '';

        if($type == "normal")
        {
            $br = '';
        }
        elseif($type == "letter")
        {
            $br = ' <br/>';
        }
        elseif($type == "letter with comma")
        {
            $br = ' <br/>';
            $comma = ',';
        }
        elseif($type == "comma")
        {
            $br = '';
        }

        // Add unit
        if(!empty($unit_no1) && !empty($unit_no2))
        {
            $unit = '#' . $unit_no1 . '-' . $unit_no2 . $comma;
        }

        // Add building
        if(!empty($building_name) && !empty($unit))
        {
            $unit_building_name = $unit . ' ' . $building_name . $comma;
        }
        elseif(!empty($unit))
        {
            $unit_building_name = $unit;
        }
        elseif(!empty($building_name))
        {
            $unit_building_name = $building_name . $comma;
        }
        //print_r($street_name . $br . $unit_building_name . $br . 'Singapore ' . $postal_code);
        if(!empty($unit))
        {
            $address = $street_name . $comma . $br . $unit_building_name . $br . 'Singapore ' . $postal_code;
        }
        elseif(!empty($building_name))
        {
            $address = $street_name . $comma . $br . $building_name . $comma . $br . 'Singapore ' . $postal_code;
        }
        else
        {
            $address = $street_name . $comma . $br . 'Singapore ' . $postal_code;
        }
        return $address;
    }

    public function write_header($firm_id, $use_own_header)
    {
        $query = $this->db->query("select firm.*, firm_email.email, firm_telephone.telephone, firm_fax.fax from firm 
                                                JOIN firm_email ON firm_email.firm_id = firm.id AND firm_email.primary_email = 1 
                                                JOIN firm_telephone ON firm_telephone.firm_id = firm.id AND firm_telephone.primary_telephone = 1 
                                                JOIN firm_fax ON firm_fax.firm_id = firm.id AND firm_fax.primary_fax = 1
                                                where firm.id = '".$firm_id."'");
        $query = $query->result_array();

        // Calling getimagesize() function 
        list($width, $height, $type, $attr) = getimagesize("uploads/logo/" . $query[0]["file_name"]); 

        $different_w_h = (float)$width - (float)$height;

        if((float)$width > (float)$height && $different_w_h > 100)
        {
            //before width is 25, height is 73.75
            $td_width = 25;
            $td_height = 73.75;
        }
        else
        {
            $td_width = 15;
            $td_height = 83.75;
        }

        if(!$use_own_header){
            if(!empty($query[0]["file_name"]))
            {
                $img = '<img src="uploads/logo/'. $query[0]["file_name"] .'" height="55" />';
            }
            else
            {
                $img = '';
            }
        }

        if(!$use_own_header)
        {
            $header_content = '<table style="width: 100%; border-collapse: collapse; height: 60px; font-family: arial, helvetica, sans-serif; font-size: 10pt;" border="0">
                    <tbody>
                    <tr style="height: 60px;">
                        <td style="text-align: left; height: 60px; padding: 5%;" width="'.$td_width.'%" align="center">
                            <table style="border-collapse: collapse; width: 100%;" border="0">
                            <tbody>
                            <tr>
                            <td style="text-align: left; height: 60px;" align="center"><p>'. $img .'  </p></td>
                            </tr>
                            </tbody>
                            </table>
                        </td>
                        <td style="text-align: left;" width="1.25%">&nbsp;</td>
                        <td style="height: 60px;" width="'.$td_height.'%"><span style="font-size: 18pt;">'.$query[0]["name"].'</span><br /><span style="font-size: 8pt; text-align: left;">UEN: '. $query[0]["registration_no"] .'<br />Address: '. $query[0]["street_name"] .', #'. $query[0]["unit_no1"] .'-'.$query[0]["unit_no2"].' '. $query[0]["building_name"] .', Singapore '. $query[0]["postal_code"] .'<br />Tel: '. $query[0]["telephone"] .' &nbsp; Fax: '. $query[0]["fax"] .'&nbsp;</span></td>
                    </tr>
                    </tbody>
                    </table>';
        }
        else
        {
            $header_content = '<table style="width: 100%; border-collapse: collapse; height: 60px; font-family: arial, helvetica, sans-serif; font-size: 10pt;" border="0">
                                <tbody>
                                <tr style="height: 80px;"><td style="height: 60px;"></td></tr>
                                </tbody>
                               </table>';
        }

        return $header_content;
    }

    public function evaluate_math_from_string($formula) // to calculate total value for the cell from excel
    {
        $total_in_cell = 0.00;

        $numbers = preg_split('/[-+*=\/\|]=?/', $formula);

        if(preg_match_all('/[-+*=\/\|]=?/', $formula, $operators) !== FALSE){

            $total_in_cell = floatval($numbers[0]);

            foreach($operators[0] as $key=>$operator)
            {
                $key = $key + 0;
                switch($operator){
                    case '+':
                        $total_in_cell = $total_in_cell + (float)$numbers[$key+1];
                        break;
                    case '-':
                        $total_in_cell = $total_in_cell - (float)$numbers[$key+1];
                        break;
                    case '*':
                        $total_in_cell = $total_in_cell * (float)$numbers[$key+1];
                        break;
                    case '/':
                        $total_in_cell = $total_in_cell / (float)$numbers[$key+1];
                        break;
                }
            }
        }
        return $total_in_cell;
    }

    public function partial_edit_account_code_list()
    {
        $form_data = $this->input->post();
        $current_categorized_tree = $form_data['current_categorized_tree'];
        $selected_acc_code = isset($form_data['selected_acc_code'])?$form_data['selected_acc_code']:'';

        // print_r($current_categorized_tree);

        $sub_account_list = $this->caf_model->get_default_main_sub_account_list('sub'); 
        // $exclude_account_code = $this->fs_account_category_model->get_fs_account_category_json(); 
        // $exclude_account_code = $exclude_account_code['partial_sub_account_list'][0]['exclude_account'];    // exclude the account list from sub 
        $sub_account_list_defined = [];

        $mapping_condition = $this->caf_model->get_audit_mapping_condition_json();

        // print_r($mapping_condition);
        $only_two_accounts      = $mapping_condition['condition']['only_two'];
        $more_than_two_accounts = $mapping_condition['condition']['more_than_two'];


        

        // print_r(count($sub_account_list));

        foreach($sub_account_list as $key => $value)
        {
            $temp = [];
            $is_used = false;
            $repeat_counter = 0;

            // if(!in_array($value['account_code'], $exclude_account_code))
            // {
                foreach($current_categorized_tree as $key => $value_1)
                {
                    // print_r(array($value_1['text'], $value_1['data']['account_code'], $value_1['data']['fs_default_acc_category_id'], $value['id'], $value_1['data']['fs_default_acc_category_id'] == $value['id']));
                    $data_value1 = array_key_exists('data', $value_1) ? $value_1['data'] : '';

                    
                    if(!in_array($data_value1['account_code'], $only_two_accounts) && !in_array($data_value1['account_code'], $more_than_two_accounts))
                    {
                        // print_r(1);
                        if($data_value1 != '')
                        {
                            if($data_value1['fs_default_acc_category_id'] == $value['id'])
                            {
                                $is_used = true;
                            }
                        }
                    }
                    else if(in_array($data_value1['account_code'], $only_two_accounts))
                    {
                        // print_r(2);
                        if($data_value1 != '')
                        {
                            if($data_value1['fs_default_acc_category_id'] == $value['id'])
                            {
                                // $is_used = true;
                                $repeat_counter++;
                            }

                            if($repeat_counter >= 2)
                            {
                                $is_used = true;
                            }

                            // print_r(array($data_value1['account_code'], $repeat_counter));
                        }
                    }
                    // else
                    // {
                    //     // print_r(3);
                    //     $is_used = false;
                    // }

                   
                }

                array_push($sub_account_list_defined, array(
                    'fs_default_acc_category_id' => $value['id'],
                    'account_code' => $value['account_code'],
                    'description'  => $value['description'],
                    'is_used'      => $is_used
                ));
            // }
        }

        $this->data['sub_account_list'] = $sub_account_list_defined;
        $this->data['selected_acc_code'] = $selected_acc_code;

        $interface = $this->load->view('modal_template/partial_edit_account_code_list.php', $this->data);
    }

    public function get_trial_balance_template_excel()
    {
        $array_link = [];
        
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link, $protocol . $_SERVER['SERVER_NAME'] . '/audit/Document Templates/Excel/Trial balance - template.xlsx');

        echo json_encode(array("status" => 1, "link" => $array_link));
    }

    public function save_balance_sheet()
    {
        $form_data = $this->input->post();

        $caf_id = $form_data['caf_id'];
        $ids = $form_data['line_item_id'];
        $risk_text = $form_data['risk_text'];
        $bs_assertion = $form_data['bs_assertion'];
        $risk_level = $form_data['risk_level'];
        $response = $form_data['response'];

        $line_items_arr = $this->build_line_items_arr($ids, $risk_text, $bs_assertion, $caf_id, $risk_level, $response);

        foreach ($line_items_arr as $key => $each_line) {
            
            $result = $this->caf_model->insert_line_items($each_line);
            
        }


        $data = array('status'=>'success');

        echo json_encode($data);

    }

    public function save_profit_loss()
    {
        $form_data = $this->input->post();

        $caf_id = $form_data['caf_id'];
        $ids = $form_data['line_item_id'];
        $risk_text = $form_data['risk_text'];
        $pl_assertion = $form_data['pl_assertion'];
        $risk_level = $form_data['risk_level'];
        $response = $form_data['response'];


        $line_items_arr = $this->build_line_items_arr($ids, $risk_text, $pl_assertion, $caf_id, $risk_level, $response);

        foreach ($line_items_arr as $key => $each_line) {
            
            $result = $this->caf_model->insert_pl_line_items($each_line);
            
        }

        $data = array('status'=>'success');

        echo json_encode($data);

    }

    public function save_materiality()
    {
        $form_data = $this->input->post();

        // print_r($form_data);
        $result = $this->caf_model->insert_materiality($form_data);

        $data = array('status'=>'success', 'id'=>$result);

        echo json_encode($data);

    }

    public function save_materiality_v2()
    {
        $form_data = $this->input->post();
        unset($form_data['performance_materiality_percentage']);
        $form_data['understand_on_materiality'] = str_replace("'", '&#39;', $form_data['understand_on_materiality']);
        $form_data['benchmark_source_description'] = str_replace("'", '&#39;', $form_data['benchmark_source_description']);
        $form_data['reason_for_percentage'] = str_replace("'", '&#39;', $form_data['reason_for_percentage']);
        $form_data['support_for_risk'] = str_replace("'", '&#39;', $form_data['support_for_risk']);
        // print_r($form_data);
        $result = $this->caf_model->insert_materiality_v2($form_data);

        $data = array('status'=>'success', 'id'=>$result);

        echo json_encode($data);

    }

    public function save_adjustment()
    {
        $form_data = $this->input->post();
        $check_total = 0.00;

        $adjustment_info_arr = $this->build_adjustment_info($form_data['adjustment_info_id'], $form_data['account_id'], $form_data['adjustment_value'], $form_data['reference']);

        foreach ($adjustment_info_arr as $key => $each_info) {
            $check_total = bcadd($check_total, $each_info['adjust_value'], 2);
            // print_r(expression)
        }

        // print_r($form_data);
        // print_r($check_total);

        if($check_total == 0)
        {
            $master_data['id'] = $form_data['adjustment_master_id'];
            $master_data['caf_id'] = $form_data['caf_id'];
            $master_data['type'] = $form_data['adjustment_type'];
            $master_data['je_no'] = $form_data['je_no'];
            $master_data['narration'] = $form_data['narration'];

            $arr_deleted_info  = isset($form_data['arr_deleted_info'])?$form_data['arr_deleted_info']:array();

            // print_r($master_data);
            //need
            $master_id = $this->caf_model->insert_adjustment_master($master_data);

            foreach ($adjustment_info_arr as $key => $each_info) {
                $adjustment_info_arr[$key]['adjustment_master_id'] = $master_id;
            }


            // print_r($adjustment_info_arr);
            foreach ($adjustment_info_arr as $key => $each_line) {    

                $result = $this->caf_model->insert_adjustment_info($each_line);

            }

            $this->caf_model->delete_adjustment_info($arr_deleted_info);

            if($master_data['type'] != 8) // 8 is SOUE
            {
                // $this->caf_model->update_adjusted_value($form_data['account_id'], $master_data['caf_id']);
                $fs_company_info = $this->caf_model->update_adjusted_value($master_data['caf_id']);
                $fs_company_info_id = $fs_company_info['fs_company_info_id'];
                $assignment_id      = $fs_company_info['assignment_id'];

                if($fs_company_info_id)
                {
                    $e = $this->caf_model->update_next_ye_values($assignment_id, $fs_company_info_id);
                    $z = $this->caf_model->insert_categorized_account_round_off($fs_company_info_id); // duplicate data for round off and save to fs_categorized_account_round_off
                    $adjust_round_off = $this->fs_account_category_model->fs_adjust_round_off($fs_company_info_id);
                }
               
            }

            $data = array('status'=>'success');

            echo json_encode($data);
        }
        else
        {
            $data = array('status'=>'error', 'message'=>'Something went wrong when passing the value, please try again.');

            echo json_encode($data);
        }       
    }

    public function save_programme_input()
    {
        $form_data = $this->input->post();

        // print_r($form_data);

        foreach ($form_data['option'] as $key => $each_line) {
            $temp_arr['id'] = $each_line['procedure_caf_id'];
            $temp_arr['audit_procedure_id']  = $key;
            $temp_arr['caf_id']  = $form_data['caf_id'];
            $temp_arr['yn_value'] = $each_line['yn'];
            $temp_arr['comment'] = $each_line['comment'];
            
            $result = $this->caf_model->insert_audit_procedure_caf_input($temp_arr);

        }

        $dropdown_data['id'] = $form_data['conclusion_id'];
        $dropdown_data['caf_id'] = $form_data['caf_id'];
        $dropdown_data['planning_conclusion'] = $form_data['planning_conclusion'];
        $dropdown_data['conclusion'] = $form_data['conclusion'];

        $result = $this->caf_model->insert_programme_dropdown($dropdown_data);

        // $data = array('status'=>'success', 'id'=>$result);

        echo json_encode($result);

    }

    public function save_programme_yn_input()
    {
        $form_data = $this->input->post();

        // print_r($form_data);

        foreach ($form_data['option'] as $key => $each_line) {

            if($each_line['yn'] == "")
            {
                $each_line['yn'] = null;
            }
            $temp_arr['id'] = $each_line['yn_caf_id'];
            $temp_arr['programme_content_id']  = $key;
            $temp_arr['caf_id']  = $form_data['caf_id'];
            $temp_arr['yn_value'] = $each_line['yn'];
            $temp_arr['remark'] = $each_line['remark'];

            // print_r($temp_arr);
            
            $result = $this->caf_model->insert_audit_programme_yn_caf_input($temp_arr);

        }

        // $dropdown_data['id'] = $form_data['conclusion_id'];
        // $dropdown_data['caf_id'] = $form_data['caf_id'];
        // $dropdown_data['planning_conclusion'] = $form_data['planning_conclusion'];
        // $dropdown_data['conclusion'] = $form_data['conclusion'];

        // $result = $this->caf_model->insert_programme_dropdown($dropdown_data);

        // $data = array('status'=>'success', 'id'=>$result);

        echo json_encode($result);

    }

    public function save_programme_qa_input()
    {
        $form_data = $this->input->post();

        // print_r($form_data);

        foreach ($form_data['option'] as $key => $each_line) {

           
            $temp_arr['id']                     = $each_line['qa_caf_id'];
            $temp_arr['programme_question_id']  = $key;
            $temp_arr['caf_id']      = $form_data['caf_id'];
            $temp_arr['answer_text'] = $each_line['answer'];

            // print_r($temp_arr);
        
            $result = $this->caf_model->insert_audit_programme_qa_caf_input($temp_arr);

        }

        // $dropdown_data['id'] = $form_data['conclusion_id'];
        // $dropdown_data['caf_id'] = $form_data['caf_id'];
        // $dropdown_data['planning_conclusion'] = $form_data['planning_conclusion'];
        // $dropdown_data['conclusion'] = $form_data['conclusion'];

        // $result = $this->caf_model->insert_programme_dropdown($dropdown_data);

        // $data = array('status'=>'success', 'id'=>$result);

        echo json_encode($result);

    }

    public function save_programme_meeting_input()
    {
        $form_data = $this->input->post();

        // print_r($form_data);
        $meeting_datetime = "";

        // $date_of_report = date('Y-m-d', strtotime($form_data['date_of_report']));
        if(isset($form_data['meeting_datetime'])  && $form_data['meeting_datetime'] != "")
        {
            // echo $form_data['meeting_datetime'];
            $date = DateTime::createFromFormat('d/m/Y H:i a', $form_data['meeting_datetime']);

            $meeting_datetime = $date->format('Y-m-d H:i:s');
        }

        // $meeting_datetime = date('Y-m-d H:i:s', strtotime($form_data['meeting_datetime']));

        // print_r($meeting_datetime);

        $data = array(
            'id'               => $form_data['master_id'],
            'caf_id'           => $form_data['caf_id'],
            'meeting_datetime' => $meeting_datetime,
            'location'         => $form_data['meeting_location'],
            'absent_flag'      => (isset($form_data['absent_flag'])?$form_data['absent_flag']:0)
        );

        $meeting_master_id = $this->caf_model->submit_audit_programme_meeting_master($data);
        // $meeting_master_id = "";
        // echo $meeting_datetime;

        $temp_arr = [];

        foreach ($form_data['attendees_id'] as $key => $each_line) {

            $temp_arr['id']                     = $each_line;
            $temp_arr['meeting_master_id']      = $meeting_master_id;
            $temp_arr['attendees_name']         = $form_data['attendees_name'][$key];
            $temp_arr['attendees_designation']            = $form_data['designation'][$key];

            // print_r($temp_arr);
            if(array_filter($temp_arr)) {
                // print_r($temp_arr);
                $result = $this->caf_model->insert_audit_programme_meeting_attendees($temp_arr);
            }

            

        }

        $temp_arr = [];

        foreach ($form_data['agenda_id'] as $key => $each_line) {

            $temp_arr['id']                     = $each_line;
            $temp_arr['meeting_master_id']      = $meeting_master_id;
            $temp_arr['agenda_text']            = $form_data['agenda_text'][$key];
            $temp_arr['minutes_of_meeting']     = $form_data['minutes_of_meeting'][$key];

            if(array_filter($temp_arr)) {
                // print_r($temp_arr);
                $result = $this->caf_model->insert_audit_programme_meeting_agenda($temp_arr);
            }
            

        }

        $temp_arr = [];

        foreach ($form_data['absent_id'] as $key => $each_line) {
            $date_communicated = date('Y-m-d', strtotime($form_data['date_communicated'][$key]));

            $temp_arr['id']                     = $each_line;
            $temp_arr['meeting_master_id']      = $meeting_master_id;
            $temp_arr['absent_name']            = $form_data['absent_name'][$key];
            $temp_arr['engagement_role']        = $form_data['engagement_role'][$key];
            $temp_arr['absent_subject']         = $form_data['absent_subject'][$key];
            $temp_arr['date_communicated']      = $date_communicated;

            

            if(array_filter($temp_arr)) {
                // print_r($temp_arr);
                $result = $this->caf_model->insert_audit_programme_meeting_absent($temp_arr);
            }

           

        }

        $arr_deleted_attendees  = isset($form_data['arr_deleted_attendees'])?$form_data['arr_deleted_attendees']:array();
        $this->caf_model->delete_meeting_attendees($arr_deleted_attendees);

        $arr_deleted_agenda     = isset($form_data['arr_deleted_agenda'])?$form_data['arr_deleted_agenda']:array();
        $this->caf_model->delete_meeting_agenda($arr_deleted_agenda);

        $arr_deleted_absent     = isset($form_data['arr_deleted_absent'])?$form_data['arr_deleted_absent']:array();
        $this->caf_model->delete_meeting_absent($arr_deleted_absent);

        // $dropdown_data['id'] = $form_data['conclusion_id'];
        // $dropdown_data['caf_id'] = $form_data['caf_id'];
        // $dropdown_data['planning_conclusion'] = $form_data['planning_conclusion'];
        // $dropdown_data['conclusion'] = $form_data['conclusion'];

        // $result = $this->caf_model->insert_programme_dropdown($dropdown_data);

        // $data = array('status'=>'success', 'id'=>$result);

        echo json_encode($result);

    }

    public function save_programme_opinion_input()
    {
        $form_data = $this->input->post();

        // print_r($form_data);
        $date_of_report = "";

        // $date_of_report = date('Y-m-d', strtotime($form_data['date_of_report']));
        if(isset($form_data['date_of_report'])  && $form_data['date_of_report'] != "")
        {
            $date = DateTime::createFromFormat('d/m/Y', $form_data['date_of_report']);

            $date_of_report = $date->format('Y-m-d');
        }
        

        $data = array(
            'id'                     => $form_data['master_id'],
            'caf_id'                 => $form_data['caf_id'],
            'date_of_report'         => $date_of_report,
            'fs_opinion'             => $form_data['fs_opinion'],
            'fs_opinion_modified'    => $form_data['fs_opinion_modified'],
            'concern_assumption'     => $form_data['concern_assumption'],
            'concern_desc'           => $form_data['concern_desc'],
            'emphasis_required'      => $form_data['emphasis_required'],
            'emphasis_desc'          => $form_data['emphasis_desc'],
            'key_audit_required'     => $form_data['key_audit_required'],
            'key_audit_desc'         => $form_data['key_audit_desc'],
            'other_matters_required' => $form_data['other_matters_required'],
            'other_matters_desc'     => $form_data['other_matters_desc'],
            'audit_opinion'          => $form_data['audit_opinion'],
            'audit_opinion_modified' => $form_data['audit_opinion_modified']

        );

        $result = $this->caf_model->submit_audit_programme_opinion_input($data);
  

        echo json_encode($result);

    }

    public function save_programme_currency_input()
    {
        $form_data = $this->input->post();

        // print_r($form_data);

        $result = $this->caf_model->submit_audit_programme_currency_input($form_data);
  

        echo json_encode($result);

    }

    public function save_programme_cdd_input()
    {
        $form_data = $this->input->post();

        $temp_s1_input = array();
        $temp_s2_input = array();
        foreach ($form_data as $key => $value) {

            if(strpos($key, 's1_') !== false)
            {
                $temp_s1_input[$key] = $value;
            }

            if(strpos($key, 's2_') !== false)
            {
                $temp_s2_input[$key] = $value;
            }
        }

        $data['s1_input']  = json_encode($temp_s1_input);
        $data['s2_input']  = json_encode($temp_s2_input);
        $data['id']        = $form_data['id'];
        $data['caf_id']    = $form_data['caf_id'];
        $data['s3_reason'] = $form_data['s3_reason'];
        $data['s4_reason'] = $form_data['s4_reason'];


        // print_r($form_data);
        $result = $this->caf_model->submit_audit_programme_cdd_input($data);

        echo json_encode($result);
    }

    public function save_programme_fcm_apm_input()
    {
        $form_data = $this->input->post();

        $result = $this->caf_model->submit_audit_programme_fcm_apm_input($form_data);

        echo json_encode($result);

    }

    public function save_programme_gai_input()
    {
        $form_data = $this->input->post();

        $doc_date = "";

        // $date_of_report = date('Y-m-d', strtotime($form_data['date_of_report']));
        if(isset($form_data['doc_date'])  && $form_data['doc_date'] != "")
        {
            // echo $form_data['meeting_datetime'];
            $date = DateTime::createFromFormat('d/m/Y', $form_data['doc_date']);

            $doc_date = $date->format('Y-m-d');
        }

        for ($i = 1; $i <= 10; $i++) {
            $deadline_index = "deadline".$i;
            if(isset($form_data[$deadline_index])  && $form_data[$deadline_index] != "")
            {
                // echo $form_data['meeting_datetime'];
                $date = DateTime::createFromFormat('d/m/Y', $form_data[$deadline_index]);

                $form_data[$deadline_index] = $date->format('Y-m-d');
            }


        }

        $data = array(
            'id'               => $form_data['master_id'],
            'caf_id'           => $form_data['caf_id'],
            'date'             => $doc_date,
            'deadline1'        => $form_data['deadline1'],
            'deadline2'        => $form_data['deadline2'],
            'deadline3'        => $form_data['deadline3'],
            'deadline4'        => $form_data['deadline4'],
            'deadline5'        => $form_data['deadline5'],
            'deadline6'        => $form_data['deadline6'],
            'deadline7'        => $form_data['deadline7'],
            'deadline8'        => $form_data['deadline8'],
            'deadline9'        => $form_data['deadline9'],
            'deadline10'       => $form_data['deadline10'],
        );

        $gai_master_id = $this->caf_model->submit_audit_programme_gai_master($data);

        $temp_arr = [];

        foreach ($form_data['member_id'] as $key => $each_line) {

            $temp_arr['id']                     = $each_line;
            $temp_arr['gai_master_id']          = $gai_master_id;
            $temp_arr['member_name']            = $form_data['member_name'][$key];
            $temp_arr['member_designation']     = $form_data['member_designation'][$key];
            $temp_arr['member_contact']         = $form_data['member_contact'][$key];
            $temp_arr['member_designation']     = $form_data['member_designation'][$key];
            $temp_arr['member_email']           = $form_data['member_email'][$key];
            $temp_arr['fixed']                  = $form_data['fixed'][$key];

            // print_r($temp_arr);
            if(array_filter($temp_arr)) {
                // print_r($temp_arr);
                $result = $this->caf_model->insert_audit_programme_gai_team($temp_arr);
            }
        }

        $temp_arr = [];

        foreach ($form_data['component_id'] as $key => $each_line) {

            $temp_arr['id']                      = $each_line;
            $temp_arr['gai_master_id']           = $gai_master_id;
            $temp_arr['component_name']          = $form_data['component_name'][$key];
            $temp_arr['component_relationship']  = $form_data['component_relationship'][$key];
            $temp_arr['component_auditor']       = $form_data['component_auditor'][$key];
            $temp_arr['component_email']         = $form_data['component_email'][$key];
            $temp_arr['overall_materiality']     = $form_data['overall_materiality'][$key];
            $temp_arr['performance_materiality'] = $form_data['performance_materiality'][$key];
            $temp_arr['clearly_trivial']         = $form_data['clearly_trivial'][$key];

            // print_r($temp_arr);
            if(array_filter($temp_arr)) {
                // print_r($temp_arr);
                $result = $this->caf_model->insert_audit_programme_gai_component($temp_arr);
            }
        }

        $arr_deleted_component  = isset($form_data['arr_deleted_component'])?$form_data['arr_deleted_component']:array();
        $this->caf_model->delete_gai_component($arr_deleted_component);

        $arr_deleted_team     = isset($form_data['arr_deleted_team'])?$form_data['arr_deleted_team']:array();
        $this->caf_model->delete_gai_team($arr_deleted_team);


        echo json_encode($result);

        // print_r($form_data);
    }

    public function save_awp()
    {
        $form_data = file_get_contents('php://input');
        // print_r(json_decode($form_data));
    }

    public function save_leadsheet_doc($caf_id, $assg_id)
    {
        $documentation_data = file_get_contents('php://input');

        $data['caf_id']  = $caf_id;
        $data['documentation']  = $documentation_data;


        $result = $this->caf_model->submit_audit_leadsheet_documentation($data);

        echo json_encode($result);

    }

    public function submit_fs_company_info()
    {
        $form_data           = $this->input->post();

        $fs_company_info_id  = $form_data['fs_company_info_id'];
        $company_change_name = $form_data["change_com_name_checkbox"];
        $pre_company_name    = '';

        if($company_change_name)    // if company has old name
        {
            $pre_company_name = $form_data["prev_com_name"];
        }
        else
        {
            $pre_company_name = '';
        }

        // set id as 0 if director_signature is null
        if(isset($form_data['director_signature_2']) && !is_null($form_data['director_signature_2']))
        {
        
            $director_signature_2 = $form_data['director_signature_2'];

        }
        else
        {
            $director_signature_2 = 0;
        }
        
        $fs_company_info = array(
            'id'                    => $fs_company_info_id,
            'firm_id'               => $form_data['firm_id'],
            'company_code'          => $form_data["company_code"],
            'company_liquidated'    => $form_data["company_liquidated"],
            'old_company_name'      => $pre_company_name,
            'date_of_resolution_for_change_of_name' => $form_data["date_resol_change_com_name"],
            'first_set'             => $form_data["first_set_checkbox"],
            'last_fye_begin'        => $form_data['last_fye_begin'],
            'last_fye_end'          => $form_data['last_fye_end'],
            'current_fye_begin'     => $form_data['current_fye_begin'],
            'current_fye_end'       => $form_data['current_fye_end'],
            'report_date'           => $form_data['report_date'],
            'is_audited'            => $form_data['is_audited_checkbox'],
            'group_type'            => $form_data['group_type'],
            'is_group_consolidated' => $form_data['is_group_consolidated'],
            'director_signature_1'     => $form_data['director_signature_1'],
            'director_signature_2'     => $director_signature_2,
            'accounting_standard_used' => $form_data['accounting_standard_used'],
            'act_applicable_type'      => $form_data['act_applicable_type']
            // 'is_prior_year_amount_restated'=> $form_data['is_prior_year_amount_restated'],
            // 'effect_of_restatement_since'  => $form_data['effect_of_restatement_since']
        );

        // print_r($fs_company_info);

        $fs_fp_currency_info = array(
            'id'                          => $form_data['fs_fp_currency_id'],
            'fs_company_info_id'          => $fs_company_info_id,
            'last_year_fc_currency_id'    => $form_data['last_year_fc_currency_id'],
            'current_year_fc_currency_id' => $form_data['current_year_fc_currency_id'],
            'reason_of_changing_fc'       => $form_data['reason_of_changing_fc'],
            'last_year_pc_currency_id'    => $form_data['last_year_pc_currency_id'],
            'current_year_pc_currency_id' => $form_data['current_year_pc_currency_id'],
            'reason_changing_fc_pc'       => $form_data['reason_changing_fc_pc']
        );
        // print_r($form_data);

        $final_document_status = [];
        $final_document_status['is_create_report'] = true;
        $final_document_status['changed_final_document_type'] = false;

        if(empty($pre_company_name) || (!empty($pre_company_name) && !empty($form_data["date_resol_change_com_name"])))
        {
            // update "Statement Comprehensive Income" (profit/loss before after tax's description) if group type is changed
            if(!empty($fs_company_info_id))
            {
                $final_document_status['is_create_report'] = false;
                
                $result = $this->fs_system_model->insert_update_fs_state_comp_income($fs_company_info_id);

                if($fs_company_info['first_set'])
                {
                    $this->fs_system_model->delete_state_changes_in_equity_with_prior($fs_company_info_id, $fs_company_info['group_type']); // remove prior year data from "statement of changes in equity"
                }

                /* ----------------- Check if accounting standard is changed or not ----------------- */ 
                $fs_company_info_from_db = $this->fs_model->get_fs_company_info($fs_company_info_id);

                // check which document is using from db (1. Normal FRS, 2. Small FRS - Audited, 3. Small FRS - Non Audited)
                if($fs_company_info_from_db[0]['accounting_standard_used'] == 4)
                {
                    if($fs_company_info_from_db[0]['is_audited'])
                    {
                        $final_report_type_db = 2;
                    }
                    else
                    {
                        $final_report_type_db = 3;
                    }
                }
                else
                {
                    $final_report_type_db = 1;
                }

                // check current selected document 
                 if($fs_company_info['accounting_standard_used'] == 4)
                {
                    if($fs_company_info['is_audited'])
                    {
                        $final_report_type = 2;
                    }
                    else
                    {
                        $final_report_type = 3;
                    }
                }
                else
                {
                    $final_report_type = 1;
                }

                if($final_report_type != $final_report_type_db)
                {
                    $final_document_status['changed_final_document_type'] = true;
                }
                /* ----------------- END OF Check if accounting standard is changed or not ----------------- */ 
            }

            $fs_company_info_id = $this->fs_model->save_fs_company_info($fs_company_info);

            if(empty($fs_fp_currency_info['fs_company_info_id']))
            {
                $fs_fp_currency_info['fs_company_info_id'] = $fs_company_info_id;
            }

            $fs_fp_currency = $this->fs_model->save_fs_fp_currency_info($fs_fp_currency_info);

            $fs_company_info['id'] = $fs_company_info_id;

            $this->fs_notes_model->get_insert_update_ntfs_layout_template($fs_company_info_id, $final_document_status); // to change tick or untick for group accounting
            $this->fs_notes_model->update_related_notes($fs_company_info_id, $final_document_status);

            echo json_encode(array('result' => true, 'errormsg' => '', 'fs_company_info' => $fs_company_info));
        }
        else
        {
            if(!empty($pre_company_name) && empty($form_data["date_resol_change_com_name"]))
            {
                echo json_encode(array('result' => false, 'errormsg' => 'Something went wrong. Please try again later.', 'popup_msg' => '"Date of resolution for change of name" cannot be empty!'));
            }
            else
            {
                echo json_encode(array('result' => false, 'errormsg' => 'Something went wrong. Please try again later.', 'popup_msg' => ''));
            }
        }
    }

    public function get_adjustment_data()
    {
       
        $form_data = $this->input->post();

        $caf_id = $form_data['caf_id'];
        

        $data = $this->caf_model->get_adjustment_data($caf_id);

        echo json_encode($data);
    }


    public function get_je_no()
    {
        $form_data = $this->input->post();

        $caf_id = $form_data['caf_id'];
        $type   = $form_data['type'];

        $je_no = $this->caf_model->get_je_no($caf_id, $type);

        echo json_encode($je_no);

    }

    public function update_caf_line()
    {
        $form_data = $this->input->post();

        $this->db->where('id', $form_data['selected_caf_id']);
        $result = $this->db->update('audit_caf_master', array('index_no' => strtoupper($form_data['edited_index']), 'name' => $form_data['edited_name']));

        echo json_encode($result);
    }

    public function update_leadsheet_setup_flag()
    {
        $form_data = $this->input->post();

        $this->db->select('*');
        $this->db->from('audit_leadsheet_setup');
        $this->db->where('caf_id', $form_data['caf_id']);
        
        $q = $this->db->get();

        if ($q->num_rows() > 0) 
        {
            $this->db->where('caf_id', $form_data['caf_id']);
            $result = $this->db->update('audit_leadsheet_setup', array($form_data['field'] => $form_data['flag']));

            
        }
        else
        {
            $this->db->insert('audit_leadsheet_setup', array('caf_id' => $form_data['caf_id'], $form_data['field'] => $form_data['flag']));
            $result = $this->db->insert_id();
        }

        // $this->db->where('id', $form_data['caf_id']);
        // $result = $this->db->update('audit_leadsheet_setup', array($form_data['field'] => $form_data['flag']));

        echo json_encode($result);
    }

    public function build_adjustment_data_arr($raw_adjustment_data)
    {
        $adjustment_arr = array();

        foreach ($raw_adjustment_data as $master_key => $each_master) {
            foreach ($each_master['adjustment_info'] as $child_key => $each_info) {
                $each_info['je_no'] = $each_master['je_no'];
                $each_info['type'] = $each_master['type'];
                if($each_master['type'] == 6)
                {
                    $each_info['type_name'] = "AJE";
                }
                else if($each_master['type'] == 7)
                {
                    $each_info['type_name'] = "RJE";
                }
                else if($each_master['type'] == 9)
                {
                    $each_info['type_name'] = "CLA";
                }
  

                if(!isset($adjustment_arr[$each_info['categorized_account_id']]))
                {
                    $adjustment_arr[$each_info['categorized_account_id']] = array();
                }
                if($each_master['type'] != 8){
                    array_push($adjustment_arr[$each_info['categorized_account_id']], $each_info);
                }
            }
        }

        return $adjustment_arr;
    }

    // public function build_adjustment_info($ids, $categorized_account_id, $adjust_value, $reference, $adjustment_master_id)
    public function build_adjustment_info($ids, $categorized_account_id, $adjust_value, $reference)
    {
        $temp_arr = array();


        foreach ($categorized_account_id as $key => $each_categorized_account_id) {
        
            array_push(
                $temp_arr, array(
                    'id'                        => $ids[$key],
                    'categorized_account_id'    => $each_categorized_account_id,
                    // 'adjustment_master_id'      => $adjustment_master_id,
                    'adjust_value'              => $adjust_value[$key],
                    'reference'                 => $reference[$key]
                )
            );
        }

        return $temp_arr;
    }

    public function build_line_items_arr($ids, $risk_text, $bs_assertion,
                                         $caf_id, $risk_level, $response)
    {
        $temp_arr = array();

        // print_r($bs_assertion);

        foreach ($risk_text as $account_id => $each_account_row) 
        {
            
            foreach ($each_account_row as $key => $each_line_item) {
            
                array_push(
                    $temp_arr, array(
                        'categorized_account_id'    => $account_id,
                        'caf_id'                    => $caf_id,
                        'risk_text'                 => $each_line_item,
                        'id'                        => $ids[$account_id][$key],
                        'assertion'                 => $bs_assertion[$account_id][$key],
                        'risk_level'                => $risk_level[$account_id][$key],
                        'response'                  => $response[$account_id][$key]
                    )
                );
            }
            

        }

        return $temp_arr;

    }

    public function delete_bs_line_item()
    {
        $form_data = $this->input->post();
        $delete_line_arr = $form_data['line_item_ids'];

        foreach ($delete_line_arr as $key => $id) {
            $data["deleted"] = 1;

            $this->db->update("audit_bs_line_item", $data, array('id'=>$id));
        }

        echo json_encode(array("Status" => 1));
    }

    public function delete_pl_line_item()
    {
        $form_data = $this->input->post();
        $delete_line_arr = $form_data['line_item_ids'];

        foreach ($delete_line_arr as $key => $id) {
            $data["deleted"] = 1;

            $this->db->update("audit_pl_line_item", $data, array('id'=>$id));
        }

        echo json_encode(array("Status" => 1));
    }

    public function delete_adjustment_master()
    {
        $form_data = $this->input->post();
        $delete_item_arr = $form_data['selected_adjustment_master'];

        foreach ($delete_item_arr as $key => $id) {
            $data["deleted"] = 1;

            $this->db->update("audit_adjustment_master", $data, array('id'=>$id));

            $q = $this->db->query("SELECT caf_id FROM audit_adjustment_master WHERE id =".$id);
            $caf_id = $q->result_array();
            $caf_id = $caf_id[0]['caf_id'];

            // print_r($child_account_id);

        }
        $this->caf_model->update_adjusted_value($caf_id);

        echo json_encode(array("Status" => 1));
    }

    public function delete_caf_line()
    {
        $form_data = $this->input->post();
        $delete_line_arr = $form_data['caf_ids'];

        foreach ($delete_line_arr as $key => $id) {
            $data["deleted"] = 1;

            $this->db->update("audit_caf_master", $data, array('id'=>$id));
        }

        echo json_encode(array("Status" => 1));
    }

    public function negative_bracket($number)
    {
        if($number == 0)
        {
          return "-";
        }
        elseif($number < 0)
        {
          return "(" . number_format(abs($number),2) . ")";
        }
        else
        {
          return number_format($number,2);
        }
    }

    public function calculate_variance($current_yr, $last_yr)
    {
        $variance_arr = array();

        $variance_arr['dollar'] = $current_yr - $last_yr;

        if($last_yr == 0 || $last_yr == "" || $last_yr == null)
        {
            $variance_arr['percentage'] = 100;
        }
        else
        {
            $variance_arr['percentage'] = ($variance_arr['dollar']/$last_yr)*100;
        }

        return $variance_arr;
    }

    function convert_string_to_number($number)
    {
        if($number == "-")
        {
            return 0;
        }
        elseif($number == "")
        {
            return 0;
        }
        else
        {
            return str_replace('(', "", str_replace(')', "", str_replace(',', "", $number)));
        }
    }

    public function check_avail_caf_index()
    {
        $form_data = $this->input->post();
        // print_r($form_data);
        $index = $form_data['index'];
        $assg_id = $form_data['assg_id'];
        $result = $this->caf_model->check_caf_index_existance($index, $assg_id);
        echo json_encode($result);
    }

    public function get_leadsheet_list()
    {
        $form_data = $this->input->post();

        $assignment_id = $form_data['assignment_id'];
        $parent_id = $form_data['parent_id'];

        // print_r(array($assignment_id, $parent_id));

        $result = $this->caf_model->get_leadsheet_list($assignment_id, $parent_id);

        echo json_encode($result);
    }

    public function export_balancesheet_pdf($caf_id, $assignment_id)
    {
        $array_link = [];

        $fs_company_info_id    = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

        // create new PDF document
        $obj_pdf= new NO_MARGIN_PDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = $caf_detail->index_no." - Balance Sheet";
        $obj_pdf->SetTitle($title);

        $working_paper_header = $this->write_working_paper_header($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetHeaderMargin(0);
        // $obj_pdf->SetFooterMargin(15);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(12, 33, 10);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 9);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('L');


        // retrieving data
        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        $show_third_col  = false;
        $current_fye_end = $current_last_year_end['current_fye_end'];
        $last_fye_end    = $current_last_year_end['last_fye_end'];

        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 37,
                            'value'        => 20
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 9,
                            'variance'        => 8

                        );

        }
        /* END OF Setting for column width */

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $how_third_col   = true;

                $current_fye_end  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $last_fye_end     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $last_fye_beg     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }

        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

       $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
        }

        // print_r($data);

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        if(count($eq_liabi_title_list) == 1)  
        {
            if($eq_liabi_title_list[0] == "Equity")
            {
                $e_l_title = '';    // remove title if got equity only
            }
        }


         $fs_ntfs_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];

        $bs_assertion_dropdown =  array("Existence","Completeness","Valuation","Right and Obligation");
        $pl_assertion_dropdown['-'] = "-";
        $bs_assertion_dropdown[''] = " ";
        $risk_lvl_dropdown =  array("L","M","H");
        $risk_lvl_dropdown[''] = " ";

         $line_items = $this->caf_model->get_bs_line_item($caf_id);
         //end of retrieving data

        $content = '';
        
        $content .= '<table cellpadding="1" style="width: 100%; color:black;">
                     <thead>
                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;">&nbsp;</th>
                            <th style="width:'.$col_width['value'].'%;text-align: center;">';
                        
                                if($show_third_col)
                                {
                                    $content .= '<br/>';
                                } 
                                $content .= $current_fye_end ."<br/>". "Unadjusted"; 
                         
        $content .=         '</th>';



                        
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<th style="width:'.$col_width['value'].'%;text-align: center;">';
                                    if($show_third_col)
                                    {
                                        $content .= 'Restated<br/>';
                                    }
                                    $content .= $last_fye_end."<br/>". "Final"; 
                                $content .= '</th>';

                                if($show_third_col)
                                {
                                    $content .= '<th style="width: ' . $col_width['value'] . '%; text-align: center;">Restated<br/>' . $last_fye_beg . '</th>';
                                }

                                $content .= '<th style="colspan=2 width:'.($col_width['variance']*2).'%;text-align: center;"><br/>Variance</th>';
                            }
                        
        $content .=        '<th style="width:5%;text-align: center;"></th>
                            <th style="width:10%;text-align: center;"></th>
                            <th style="width:10%;text-align: center;"></th>
                            <th style="width:5%;text-align: center;"></th>
                            <th style="width:13%;text-align: center;"></th>
                        </tr>

                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;"></th>
                            <th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">$</th>';

                        
                            if(!empty($last_fye_end))
                            {
                                $content .= '<th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">$</th>';

                                if($show_third_col)
                                {
                                    $content .= '<th style="text-align: center; border-top: 1px solid #000;">$</th>';
                                }

                                $content .= '<th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">$</th>
                                            <th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">%</th>';
                            }
                        
        $content .=        '<th style="width:5%;text-align: center;">Ref</th>
                            <th style="width:10%;text-align: center;">Risk</th>
                            <th style="width:10%;text-align: center;">Assertion</th>
                            <th style="width:5%;text-align: center;">Risk Level</th>
                            <th style="width:13%;text-align: center;">Response</th>
                        </tr>
                    </thead>
                    <tbody>';

                        $index = 0;
                        $ref_index = 1;
                        $note_no = 0;


                        $total_assets_c          = 0.00;
                        $total_assets_c_end      = 0.00;
                        $total_assets_c_beg      = 0.00;

                        $total_equity_c          = 0.00;
                        $total_equity_c_end      = 0.00;
                        $total_equity_c_beg      = 0.00;

                        $total_liabilities_c     = 0.00;
                        $total_liabilities_c_end = 0.00;
                        $total_liabilities_c_beg = 0.00;
                        

                        $displayed_eq_liabi_title = false;

                        foreach ($data as $level_1_key => $level_1) 
                        {
                            $hide_main_title = false;
                            $level_1_description = "";

                            $fs_ntfs_list_key = array_search($level_1['parent_array'][0]['account_code'], array_column($fs_ntfs_list, "account_code")); // get key

                            if(!empty($fs_ntfs_list_key) || (string)$fs_ntfs_list_key == 0)
                            {
                                $level_1_description = $fs_ntfs_list[$fs_ntfs_list_key]['description']; // get description from fs_ntfs_list json from document name "Statement of financial position"
                            }

                            /* ---------------------------- Display main category (Level 1). eg. Assets, Equity and Liabilities ---------------------------- */
                            if(count($level_1['child_array']) == 1)
                            {
                                foreach ($level_1['child_array'] as $key => $value) 
                                {
                                    if(empty($value['parent_array']))
                                    {
                                        $hide_main_title = true;
                                    }
                                }
                            }

                            if($level_1_description == "Assets" && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                $content .=
                                '<tr>'.
                                    '<td style="width:'.$col_width['account_desc'].'%;"><strong>' . ucfirst(strtolower($level_1['parent_array'][0]['description'])) . '</strong></td>' .
                                    '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                '</tr>';

                                // print_r($data);
                            }

                            if(($level_1_description == "Equity" || $level_1_description == "Liabilities"))
                            {
                                $empty_inner_item = false;

                                if($level_1_description == "Equity")
                                {
                                    $level_1['child_array'] = array($level_1); 
                                }
                                elseif($level_1_description == "Liabilities")
                                {
                                    if(isset($level_1['child_array'][0]['parent_array']))
                                    {
                                        if($level_1['child_array'][0]['parent_array'] == null)
                                        {
                                            // $level_1['child_array'] = array(array('child_array' => $level_1['child_array']));
                                            $level_1['child_array'] = [];
                                            $empty_inner_item = true;
                                        }
                                    }
                                    
                                }

                                if(!$displayed_eq_liabi_title && !$empty_inner_item && !empty($e_l_title))
                                {
                                    $content .= 
                                    '<tr>'.
                                        '<td style="width:'.$col_width['account_desc'].'%;"><strong>' . $e_l_title . '</strong></td>' .
                                        '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                    '</tr>';

                                    $displayed_eq_liabi_title = true;
                                }
                            }

                            /* ---------------------------- END OF Display main category (Level 1). eg. Assets, Equity and Liabilities ---------------------------- */

                            // print_r($level_1['child_array']);

                            if(!empty($level_1['parent_array']))
                            // {
                            //  echo 
                            //  '<tr>'.
                            //      '<td><strong><em>' . ucfirst(strtolower($level_1['child_array'][0]['description'])) . '</em></strong></td>' .
                            //      '<td align="center"></td>' .
                            //      '<td style="width: 0.5%;">&nbsp;</td>' .
                            //      '<td colspan="3"></td>' .
                            //  '</tr>';
                            // }
                            // else
                            {
                                foreach ($level_1['child_array'] as $level_2_key => $level_2) 
                                {
                                    // print_r($level_2);
                                
                                    $temp_total_c     = 0.00;
                                    $temp_total_c_end = 0.00;
                                    $temp_total_c_beg = 0.00;
                                    

                                    /* DISPLAY 1 LINE ONLY IF NO CHILD UNDER LEVEL 2 */
                                    if(count($level_2['child_array']) > 0)
                                    {
                                        if(!empty($level_2['parent_array']))
                                        {
                                            $content .= 
                                            '<tr>'.
                                                '<td style="width:'.$col_width['account_desc'].'%;"><strong><em>' . ucfirst(strtolower($level_2['parent_array'][0]['description'])) . '</em></strong></td>' .
                                                '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                            '</tr>';

                                            // print_r($level_2['child_array']);

                                            foreach ($level_2['child_array'] as $level_3_key => $level_3)
                                            {
                                                // echo '</br></br>';

                                                /* DISPLAY LEVEL 3 THAT HAS SUBCATEGORY */
                                                if(!empty($level_3['parent_array']) && $level_1_description != "Equity")
                                                {

                                                    $content .= 
                                                    '<tr>'.
                                                        '<td style="width:'.$col_width['account_desc'].'%;"><u><em>' . ucfirst(strtolower($level_3['parent_array'][0]['description'])) . '</em></u></td>' .
                                                        '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                                    '</tr>';

                                                    foreach ($level_3['child_array'] as $level_4_key => $level_4)
                                                    {

                                                        if(!empty($level_4['parent_array']))
                                                        {


                                                            $temp_c = isset($level_4['parent_array'][0]['total_c'])?$level_4['parent_array'][0]['total_c']:0;
                                                            $temp_c_lye = isset($level_4['parent_array'][0]['total_c_lye'])?$level_4['parent_array'][0]['total_c_lye']:0;
                                                            $variance_value = $this->calculate_variance($temp_c,$temp_c_lye);

                                                            // print_r($variance_value);
                                                            // echo json_encode($level_3['fs_note_details']);
                                                            if($temp_c || $temp_c_lye)
                                                            {
                                                                $content .= 
                                                                '<tr>' .
                                                                '<td style="width:'.$col_width['account_desc'].'%;">' .
                                                                    // hidden fields
                                                                    $level_4['parent_array'][0]['description'] . 
                                                                '</td>';


                                                                if($level_4['parent_array'][0]['account_code'] == 'Q1030000')
                                                                {
                                                                    // print_r($level_3['parent_array'][0]);
                                                                }

                                                                $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c) . '</td>';
                                                                
                                                                if(!empty($last_fye_end))
                                                                {

                                                                    $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_lye) . '</td>';
                                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                             
                                                                }

                                                                
                                                                $content .= '<td style="width:5%;text-align: center;">'.$ref_index.'</td>
                                                                    <td style="width:10%;text-align: left;">'.(isset($line_items[$level_4['parent_array'][0]['id']][0])?$line_items[$level_4['parent_array'][0]['id']][0]['risk_text']:"").'</td>
                                                                    <td style="width:10%;text-align:center;">'.$bs_assertion_dropdown[isset($line_items[$level_4['parent_array'][0]['id']][0])?$line_items[$level_4['parent_array'][0]['id']][0]['assertion']:"0"].'</td>
                                                                    <td style="width:5%;text-align:center;">'.$risk_lvl_dropdown[isset($line_items[$level_4['parent_array'][0]['id']][0])?$line_items[$level_4['parent_array'][0]['id']][0]['risk_level']:"0"].'</td>
                                                                    <td style="width:13%;text-align:left;">'.(isset($line_items[$level_4['parent_array'][0]['id']][0])?$line_items[$level_4['parent_array'][0]['id']][0]['response']:"").'</td>';

                                                                $temp_total_c     += (double)$temp_c;
                                                                $temp_total_c_end += (double)$temp_c_lye;
                                                                $temp_total_c_beg += (double)$level_4['parent_array'][0]['company_beg_prev_ye_value'];
                                                                // }
                                                                $content .= '</tr>';
                                                                $ref_index++;

                                                                //loop line item other than first row
                                                                if(isset($line_items[$level_4['parent_array'][0]['id']])){
                                                                    if(count($line_items[$level_4['parent_array'][0]['id']]) > 1)
                                                                    {
                                                                        foreach ($line_items[$level_4['parent_array'][0]['id']] as $key => $each_line) 
                                                                        {
                                                                            if($key > 0)
                                                                            {


                                                                                $content .=  '<tr class="rows-for-'.$level_4['parent_array'][0]['id'].'">' .
                                                                                          '<td  style="width:'.$col_width['account_desc'].'%;"></td>';

                                                                                $content .= '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                                    
                                                                                    if(!empty($last_fye_end))
                                                                                    {

                                                                                        $content .= 
                                                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                                    
                                                                                        if($show_third_col)
                                                                                        {
                                                                                            $content .= 
                                                                                            '<td align="right"></td>';
                                                                                        }

                                                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="right"></td>';
                                                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="center"></td>';
                                                                                    }

                                                                                    
                                                                                    $content .= '<td style="width:5%;text-align: center;">'.$ref_index.'</td>
                                                                                      <td style="width:10%;text-align: left;">'.$each_line['risk_text'].'</td>
                                                                                      <td style="width:10%;text-align: center;">'.$bs_assertion_dropdown[$each_line['assertion']].'</td>
                                                                                      <td style="width:5%;text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                                      <td style="width:13%;text-align: left;">'.$each_line['response'].'</td>';

                                                                                    // $temp_total_c      += (double)$level_3['parent_array'][0]['total_c'];
                                                                                    // $temp_total_c_end += (double)$level_3['parent_array'][0]['total_c_lye'];
                                                                                    // $temp_total_c_beg += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];
                                                                                    // }
                                                                                $content .= '</tr>';
                                                                                $ref_index++;
                                                                            }

                                                                            

                                                                        }
                                                                    }
                                                                    $index++;
                                                                }
                                                            }
                                                        }
                                                                /* DISPLAY LEVEL 3 WITHOUT SUBCATEGORY UNDER IT */
                                                        elseif($level_1_description == "Liabilities" || $level_1_description == "Assets")
                                                        {
                                                            $variance_value = $this->calculate_variance($level_4['child_array']['value'],$level_4['child_array']['company_end_prev_ye_value']);

                                                            if($level_4['child_array']['value'] || $level_4['child_array']['company_end_prev_ye_value'])
                                                            {
                                                                $content .= 
                                                                '<tr>'.
                                                                    '<td style="width:'.$col_width['account_desc'].'%;">' . 

                                                                        $level_4['child_array']['description'] . 
                                                                    '</td>';
                                                        
                                                                
                                                                    $content .= 
                                                                    '<td align="right" style="width:'.$col_width['value'].'%;">' .  $this->negative_bracket($level_4['child_array']['value']) . '</td>';

                                                                    if(!empty($last_fye_end))
                                                                    {
                                                                        // echo 
                                                                        // '<td align="right">' . 
                                                                        //  '<input type="number" class="form-control ' . $display_class_lye_end . '_values_under_' . $level_2['parent_array']['id'] . ' ' . $display_class_lye_end . '_account_code_' . $level_2['parent_array']['account_code'] . '" name="' . $FP_lye_end_value_name . '[' . $index . ']" style="text-align:right;" value="' . $level_3['child_array']['company_end_prev_ye_value'] . '" onchange="FP_calculation('. $level_2['parent_array']['id'] .', \'' . $display_class_lye_end. '\', \'' . $level_2['parent_array']['account_code'] . '\', \'' . "company" . '\')" min="0" pattern="[0-9]" onkeypress="return !(event.charCode == 46)" step="1">' . 
                                                                        // '</td>';

                                                                        $content .=
                                                                            '<td align="right" style="width:'.$col_width['value'].'%;">' . $this->negative_bracket($level_4['child_array']['company_end_prev_ye_value']) . '</td>';
                                                                        $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                                        $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>';

                                                                    }

                                                                    
                                                                    $content .= '<td style="text-align: center;width:5%;">'.$ref_index.'</td>
                                                                      <td style="text-align: left;width:10%;">'.(isset($line_items[$level_4['child_array']['id']][0])?$line_items[$level_4['child_array']['id']][0]['risk_text']:"").'</td>
                                                                      <td style="text-align: center;width:10%;">'.$bs_assertion_dropdown[isset($line_items[$level_4['child_array']['id']][0])?$line_items[$level_4['child_array']['id']][0]['assertion']:"0"].'</td>
                                                                      <td style="text-align: center;width:5%;">'.$risk_lvl_dropdown[isset($line_items[$level_4['child_array']['id']][0])?$line_items[$level_4['child_array']['id']][0]['risk_level']:"0"].'</td>
                                                                      <td style="text-align: left;width:13%;">'.(isset($line_items[$level_4['child_array']['id']][0])?$line_items[$level_4['child_array']['id']][0]['response']:"").'</td>';
                                                                    

                                                                    $temp_total_c     += (double)$level_4['child_array']['value'];
                                                                    $temp_total_c_end += (double)$level_4['child_array']['company_end_prev_ye_value'];
                                                                    $temp_total_c_beg += (double)$level_4['child_array']['company_beg_prev_ye_value'];
                                                                    
                                                                    $content .= '</tr>';
                                                                    $ref_index++;

                                                                //loop line item other than first row

                                                                if(isset($line_items[$level_4['child_array']['id']]) && count($line_items[$level_4['child_array']['id']]) > 1)
                                                                {
                                                                    foreach ($line_items[$level_4['child_array']['id']] as $key => $each_line) 
                                                                    {
                                                                        if($key > 0)
                                                                        {


                                                                            $content .=  '<tr>' .
                                                                                      '<td></td>';

                                                                            $content .= '<td align="right"></td>';
                                                                                
                                                                                if(!empty($last_fye_end))
                                                                                {

                                                                                    $content .= 
                                                                                    '<td align="right"></td>';
                                                                                
                                                                                    if($show_third_col)
                                                                                    {
                                                                                        $content .= 
                                                                                        '<td align="right"></td>';
                                                                                        $content .= '<td align="right"></td>';
                                                                                        $content .= '<td align="center"></td>';
                                                                                    }
                                                                                }

                                                                                
                                                                                $content .= '<td style="text-align: center;"></td>
                                                                                      <td style="text-align: center;"></td>
                                                                                  <td style="text-align: center;">'.$ref_index.'</td>
                                                                                  <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                                                  <td style="text-align: center;">'.$bs_assertion_dropdown[$each_line['assertion']].'</td>
                                                                                  <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                                  <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                                                // $temp_total_c      += (double)$level_3['parent_array'][0]['total_c'];
                                                                                // $temp_total_c_end += (double)$level_3['parent_array'][0]['total_c_lye'];
                                                                                // $temp_total_c_beg += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];
                                                                                // }
                                                                            $content .= '</tr>';

                                                                            $ref_index++;

                                                                        }
                                                                    }
                                                                }


                                                                $index++;
                                                            }
                                                        }
                                                        /* END OF DISPLAY LEVEL 3 WITHOUT SUBCATEGORY UNDER IT */
                                                        
                                                    }

                                                    $temp_c          = isset($level_3['parent_array'][0]['total_c'])?$level_3['parent_array'][0]['total_c']:0;
                                                    $temp_c_lye      = isset($level_3['parent_array'][0]['total_c_lye'])?$level_3['parent_array'][0]['total_c_lye']:0;
                                                    // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                                    $variance_value  = $this->calculate_variance($temp_c ,$temp_c_lye);

                                                    if($temp_c || $temp_c_lye)
                                                    {
                                                        $content .= 
                                                        '<tr>' . 
                                                            '<td style="width:'.$col_width['account_desc'].'%;"></td>' . 
                                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                                '<span>' . 
                                                                    $this->negative_bracket($temp_c) . 
                                                                '</span>' . 
                                                            '</td>';
                                 
                                                        if(!empty($last_fye_end))
                                                        {
                                                            $content .= 
                                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                                '<span>' . 
                                                                    $this->negative_bracket($temp_c_lye) . 
                                                                '</span>' . 
                                                            '</td>';

                                                            if($show_third_col)
                                                            {
                                                                $content .= 
                                                                '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                                    '<span>' . 
                                                                        $this->negative_bracket($total_beg) . 
                                                                    '</span>' . 
                                                                '</td>';
                                                                
                                                            }

                                                            $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                            $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>';
                                                        }
                                                            
                                                            
                                                        $content .= '</tr>';
                                                    }

                                                    // $content .= '<tr><td colspan="5"></std></tr>';
                                                }
                                                /* END OF DISPLAY LEVEL 3 THAT HAS SUBCATEGORY */
                                                elseif(!empty($level_3['parent_array']) && $level_1_description == "Equity")
                                                {
                                                    if(!empty($level_3['parent_array']))
                                                    {


                                                        $temp_c = isset($level_3['parent_array'][0]['total_c'])?$level_3['parent_array'][0]['total_c']:0;
                                                        $temp_c_lye = isset($level_3['parent_array'][0]['total_c_lye'])?$level_3['parent_array'][0]['total_c_lye']:0;
                                                        $variance_value = $this->calculate_variance($temp_c,$temp_c_lye);

                                                        // print_r($variance_value);
                                                        // echo json_encode($level_3['fs_note_details']);
                                                        if($temp_c || $temp_c_lye)
                                                        {

                                                            $content .= 
                                                            '<tr>' .
                                                            '<td style="width:'.$col_width['account_desc'].'%;">' .
                                                                // hidden fields
                                                                $level_3['parent_array'][0]['description'] . 
                                                            '</td>';


                                                            if($level_3['parent_array'][0]['account_code'] == 'Q1030000')
                                                            {
                                                                // print_r($level_3['parent_array'][0]);
                                                            }

                                                            $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c) . '</td>';
                                                            
                                                            if(!empty($last_fye_end))
                                                            {

                                                                $content .= 
                                                                '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_lye) . '</td>';
                                                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                         
                                                            }

                                                            
                                                            $content .= '<td style="width:5%;text-align: center;">'.$ref_index.'</td>
                                                                <td style="width:10%;text-align: left;">'.(isset($line_items[$level_3['parent_array'][0]['id']][0])?$line_items[$level_3['parent_array'][0]['id']][0]['risk_text']:"").'</td>
                                                                <td style="width:10%;text-align:center;">'.$bs_assertion_dropdown[isset($line_items[$level_3['parent_array'][0]['id']][0])?$line_items[$level_3['parent_array'][0]['id']][0]['assertion']:"0"].'</td>
                                                                <td style="width:5%;text-align:center;">'.$risk_lvl_dropdown[isset($line_items[$level_3['parent_array'][0]['id']][0])?$line_items[$level_3['parent_array'][0]['id']][0]['risk_level']:"0"].'</td>
                                                                <td style="width:13%;text-align:left;">'.(isset($line_items[$level_3['parent_array'][0]['id']][0])?$line_items[$level_3['parent_array'][0]['id']][0]['response']:"").'</td>';

                                                            $temp_total_c     += (double)$temp_c;
                                                            $temp_total_c_end += (double)$temp_c_lye;
                                                            $temp_total_c_beg += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];
                                                            // }
                                                            $content .= '</tr>';
                                                            $ref_index++;

                                                            //loop line item other than first row
                                                            if(isset($line_items[$level_3['parent_array'][0]['id']])){
                                                                if(count($line_items[$level_3['parent_array'][0]['id']]) > 1)
                                                                {
                                                                    foreach ($line_items[$level_3['parent_array'][0]['id']] as $key => $each_line) 
                                                                    {
                                                                        if($key > 0)
                                                                        {


                                                                            $content .=  '<tr class="rows-for-'.$level_3['parent_array'][0]['id'].'">' .
                                                                                      '<td  style="width:'.$col_width['account_desc'].'%;"></td>';

                                                                            $content .= '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                                
                                                                                if(!empty($last_fye_end))
                                                                                {

                                                                                    $content .= 
                                                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                                
                                                                                    if($show_third_col)
                                                                                    {
                                                                                        $content .= 
                                                                                        '<td align="right"></td>';
                                                                                    }

                                                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right"></td>';
                                                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center"></td>';
                                                                                }

                                                                                
                                                                                $content .= '<td style="width:5%;text-align: center;">'.$ref_index.'</td>
                                                                                  <td style="width:10%;text-align: left;">'.$each_line['risk_text'].'</td>
                                                                                  <td style="width:10%;text-align: center;">'.$bs_assertion_dropdown[$each_line['assertion']].'</td>
                                                                                  <td style="width:5%;text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                                  <td style="width:13%;text-align: left;">'.$each_line['response'].'</td>';

                                                                                // $temp_total_c      += (double)$level_3['parent_array'][0]['total_c'];
                                                                                // $temp_total_c_end += (double)$level_3['parent_array'][0]['total_c_lye'];
                                                                                // $temp_total_c_beg += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];
                                                                                // }
                                                                            $content .= '</tr>';
                                                                            $ref_index++;
                                                                        }

                                                                        

                                                                    }
                                                                }
                                                                $index++;
                                                            }
                                                        }
                                                    }
                                                }


                                                
                                            }
                                            
                                            /* DISPLAY TOTAL FOR EACH CATEGORY  */
                                            $total      = $temp_total_c;
                                            $total_end  = $temp_total_c_end;
                                            $total_beg  = $temp_total_c_beg;

                                            /* CALCULATE TOTAL ASSETS, TOTAL EQUITY, LIABILITIES - COMPANY */
                                            if($level_1_description == "Assets")    // NON-CURRENT ASSETS || CURRENT ASSETS
                                            {
                                                $total_assets_c     += $total;
                                                $total_assets_c_end += $total_end;
                                                $total_assets_c_beg += $total_beg;
                                            }
                                            elseif($level_1_description == "Equity") // EQUITY
                                            {
                                                $total_equity_c     += $total;
                                                $total_equity_c_end += $total_end;
                                                $total_equity_c_beg += $total_beg;
                                            }
                                            elseif($level_1_description == "Liabilities") // NON-CURRENT LIABILITIES || CURRENT LIABILITIES
                                            {
                                                $total_liabilities_c     += $total;
                                                $total_liabilities_c_end += $total_end;
                                                $total_liabilities_c_beg += $total_beg;
                                            }
                                            /* END OF CALCULATE TOTAL ASSETS, TOTAL EQUITY, LIABILITIES */
                                            
                                            $variance_value = $this->calculate_variance($total,$total_end);

                                            if($total || $total_end)
                                            {

                                                $content .= 
                                                    '<tr>' . 
                                                        '<td></td>' . 
                                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                            '<span>' . 
                                                                $this->negative_bracket($total) . 
                                                            '</span>' . 
                                                        '</td>';

                                                    if(!empty($last_fye_end))
                                                    {
                                                        $content .= 
                                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                            '<span>' . 
                                                                $this->negative_bracket($total_end) . 
                                                            '</span>' . 
                                                        '</td>';

                                                        if($show_third_col)
                                                        {
                                                            $content .= 
                                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                                '<span>' . 
                                                                    $this->negative_bracket($total_beg) . 
                                                                '</span>' . 
                                                            '</td>';
                                                            
                                                        }

                                                        $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                        $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                                    }
                                                    
                                                    
                                                $content .= '</tr>';
                                                /* END OF DISPLAY TOTAL FOR EACH CATEGORY */
                                            }
                                        }
                                    }
                                }
                            }


                            
                            /* DISPLAY TOTAL ASSETS */
                            if($level_1_description == "Assets" && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                

                                $total_assets     = 0.00;
                                $total_assets_end = 0.00;
                                $total_assets_beg = 0.00;

                        
                                $total_assets     = $total_assets_c;
                                $total_assets_end = $total_assets_c_end;
                                $total_assets_beg = $total_assets_c_beg;


                                $variance_value = $this->calculate_variance($total_assets,$total_assets_end);

                                if($total_assets || $total_assets_end)
                                {

                                    $content .= 
                                    '<tr>' . 
                                        '<td style=""><strong>Total assets</strong></td>' . 
                                        '<td style="border-bottom:2px double black;" align="right">' . 
                                            '<span>' . $this->negative_bracket($total_assets) . '</span>'.
                                            // '<div style="border: 1px solid black;line-height: 1px;">&nbsp;</div>'.
                                            
                                        '</td>';

                                        if(!empty($last_fye_end))
                                        {
                                            $content .= 
                                            '<td style="border-bottom:2px double black;" align="right">' . 
                                                '<span>' . $this->negative_bracket($total_assets_end) . '</span>' . 
                                                // '<br/><div style="border: 1px solid black;line-height: 1px;">&nbsp;</div>'.
                                            '</td>';

                                            if($show_third_col)
                                            {
                                                $content .= 
                                                '<td align="right" style="border-bottom:2px double black;">' . 
                                                    '<span>' . $this->negative_bracket($total_assets_beg) . '</span>' . 
                                                '</td>';
                                                
                                            }

                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                        }
                                        
                                        $content .= '<td colspan="5"></td>';
                                    $content .= '</tr>';
                                }
                                
                            }
                            /* END OF DISPLAY TOTAL ASSETS */

                            /* DISPLAY TOTAL LIABILITES */
                            if($level_1_description == "Liabilities" && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                if(in_array("Liabilities", $eq_liabi_title_list))
                                {
                                    $total_liabilities     = 0.00;
                                    $total_liabilities_end = 0.00;
                                    $total_liabilities_beg = 0.00;

                        
                                    $total_liabilities     = $total_liabilities_c;
                                    $total_liabilities_end = $total_liabilities_c_end;
                                    $total_liabilities_beg = $total_liabilities_c_beg;

                                    $variance_value = $this->calculate_variance($total_liabilities,$total_liabilities_end);

                                    if($total_liabilities || $total_liabilities_end)
                                    {
                                    

                                        $content .= 
                                        '<tr>' .  
                                            '<td><strong>Total liabilities</strong></td>' . 
                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                '<span>' . $this->negative_bracket($total_liabilities) . '</span>' .
                                            '</td>';

                                            if(!empty($last_fye_end))
                                            {
                                                $content .= 
                                                '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                    '<span>' . $this->negative_bracket($total_liabilities_end) . '</span>' .
                                                '</td>';

                                                if($show_third_col)
                                                {
                                                    $content .= 
                                                    '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                        '<span>' . $this->negative_bracket($total_liabilities_beg) . '</span>' . 
                                                    '</td>';
                                                    
                                                }

                                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                            }

                                            
                                        $content .= '</tr>';

                                        $content .= 
                                        '<tr>' . 
                                            '<td colspan="10">&nbsp;</td>' . 
                                        '</tr>';
                                    }
                                }
                            }
                            /* END OF DISPLAY TOTAL LIABILITES */

                            /* DISPLAY TOTAL EQUITY & LIABILITIES */
                            elseif($level_1_key == count($data) - 1)
                            {
                                if(count($eq_liabi_title_list) > 1)
                                {
                                    $total_equity_liabilities     = 0.00;
                                    $total_equity_liabilities_end = 0.00;
                                    $total_equity_liabilities_beg = 0.00;

                                
                                    $total_equity_liabilities     = $total_equity_c     + $total_liabilities_c;
                                    $total_equity_liabilities_end = $total_equity_c_end + $total_liabilities_c_end;
                                    $total_equity_liabilities_beg = $total_equity_c_beg + $total_liabilities_c_beg;

                                    $variance_value = $this->calculate_variance($total_equity_liabilities,$total_equity_liabilities_end);
                                
                                    if($total_equity_liabilities || $total_equity_liabilities_end)
                                    {
                                        $content .= 
                                        '<tr>' . 
                                            '<td><strong>Total equity and liabilities</strong></td>' . 
                                            '<td align="right" style="border-bottom: 2px double black;">' . 
                                                '<span>' . $this->negative_bracket($total_equity_liabilities) . '</span>' . 
                                            '</td>';
                                            if(!empty($last_fye_end))
                                            {
                                                $content .= 
                                                '<td align="right" style="border-bottom: 2px double black;">' . 
                                                    '<span>' .$this->negative_bracket($total_equity_liabilities_end) . '</span>' . 
                                                '</td>';

                                                if($show_third_col)
                                                {
                                                    $content .= 
                                                    '<td align="right" style="border-bottom: 2px double black;">' . 
                                                        '<span>' . $this->negative_bracket($total_equity_liabilities_beg) . '</span>' .
                                                    '</td>';
                                                }

                                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                            }

                                            
                                        $content .= '</tr>';
                                    }
                                }

                                
                            }
                            /* END OF DISPLAY TOTAL LIABILITES, TOTAL EQUITY & LIABILITIES */

                            /* BREAK LINE */
                            if($level_1_key < (count($data[0]) - 1) && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                $content .= 
                                '<tr>' . 
                                    '<td colspan="10">&nbsp;</td>' . 
                                '</tr>';
                            }
                            /* END OF BREAK LINE */
                        }
                    
        $content .= '</tbody>
                    </table>';
        // print_r($content);

       

        $obj_pdf->writeHTML($content, true, false, false, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C6_BS_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C6_BS_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/C6_BS_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');
        
        echo json_encode(array("link" => $array_link));

        // define some HTML content with style

    }

    public function export_profitloss_pdf($caf_id, $assignment_id)
    {
        $array_link = [];

        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

          // create new PDF document
        $obj_pdf= new NO_MARGIN_PDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "C6 - Profit or loss";
        $obj_pdf->SetTitle($title);


         $working_paper_header = $this->write_working_paper_header($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(12, 33, 10);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 9);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('L');
        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

         // initialise
        $current_fye_end = '';
        $last_fye_end    = '';
        $display_restated = false;

        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 37,
                            'value'        => 20
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 23,
                            'value'        => 9,
                            'variance'        => 8

                        );

        }
        /* END OF Setting for column width */

        /* Don't delete this */
        // if($fs_company_info[0]['is_prior_year_amount_restated'])
        // {
        //     if(strcmp($fs_company_info[0]['effect_of_restatement_since'], $fs_company_info[0]['last_fye_begin']) == 0)
        //     {
        //         $this->data["display_restated"] = true;
        //     }
        // }
        /* Don't delete this */

        // display column(s) for years
        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }
        else
        {
            $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

            $current_fye_end  = $current_last_year_end['current_fye_end'];    // this year end eg. 31/12/2019
            $last_fye_end     = $current_last_year_end['last_fye_end'];       // end of previous year end
        }

        /* ---------------------- get statement of detailed profit or loss data ---------------------- */

        $dpl_key = array_search("Profit or loss", array_column($fs_ntfs_list['statements'], 'document_name'));
        $dpl_ref_id = '';

        if($dpl_key || (string)$dpl_key == '0')
        {
            $dpl_account_code = $fs_ntfs_list['statements'][$dpl_key]['reference_id']; // get account code
        }

        $dpl_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $dpl_account_code);

        $dpl_data = [];

        foreach ($dpl_fca_id as $dpl_fca_id_key => $dpl_fca_id_value) 
        {
            array_push($dpl_data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($dpl_fca_id_value)));
        }

        $state_detailed_pro_loss_data = $dpl_data;

        // seperated because this need to loop level 3
        $er_account_code = array("E0000000");
        $er_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $er_account_code);

        $schedule_operating_expense_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $er_fca_id);

        //retrieve TAX
        $temp_data = [];
        $data = [];
        $tax_account_code = array("T0000000");
        $tax_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $tax_account_code);

        foreach ($tax_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        $tax_data = $data;

        $temp_data = [];
        $data = [];

        $soa_account_code = array("S0000000");
        $soa_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $soa_account_code);

        foreach ($soa_fca_id as $fca_id_key => $fca_id_value) 
        {
            $temp_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value));

            if(count($temp_data[0]['child_array']) > 0)
            {
                // print_r($temp_data);

                $temp_data[0]['parent_array'][0]['group_end_this_ye_value']  = (double)$temp_data[0]['parent_array'][0]['group_end_this_ye_value'] * (-1);
                $temp_data[0]['parent_array'][0]['group_end_prev_ye_value']  = (double)$temp_data[0]['parent_array'][0]['group_end_prev_ye_value'] * (-1);

                $temp_data[0]['parent_array'][0]['total_c']      = (double)$temp_data[0]['parent_array'][0]['total_c']     * (-1);
                $temp_data[0]['parent_array'][0]['total_c_lye']  = (double)$temp_data[0]['parent_array'][0]['total_c_lye'] * (-1);

                array_push($data, $temp_data);
            }
        }

        if(count($data) > 0)
        {
            $soa_pl_list = $data;
        }
        else
        {
            $soa_pl_list = [];
        }
        $soa_pl_lists = $soa_pl_list;

        //retrieve DIVIDEND
        $temp_data = [];
        $data = [];
        $div_account_code = array("D0000000");
        $div_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $div_account_code);

        foreach ($div_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $div_data = $data;
        }
        else
        {
            $div_data = [];
        }

        //retrieve RETAINED EARNINGS B/F
        $temp_data = [];
        $data = [];
        $bf_account_code = array("Q1030000");
        $bf_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $bf_account_code);

        foreach ($bf_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $bf_data = $data;
        }
        else
        {
            $bf_data = [];
        }

        $fs_ntfs_list = $fs_ntfs_list['statements'][$dpl_key]['description_reference_id'];

        $pl_assertion_dropdown =  array("Accuracy","Classification","Completeness","Cut off", "Occurence");
        $pl_assertion_dropdown['-'] = "-";
        $pl_assertion_dropdown[''] = " ";

        $risk_lvl_dropdown =  array("L","M","H");
        $risk_lvl_dropdown[''] = " ";

        $line_items = $this->caf_model->get_pl_line_item($caf_id);
        //end of retrieving data

        $content = '';
        
        $content .= '<table  cellpadding="1" style="width: 100%; color:black;">
                     <thead>
                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;">&nbsp;</th>
                            <th style="width:'.$col_width['value'].'%;text-align: center;">';
                        
                                if($display_restated)
                                {
                                    $content .= '</br>';
                                } 
                                $content .= $current_fye_end ."<br/>". "Unadjusted"; 
                         
        $content .=         '</th>';

                        
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<th style="width:'.$col_width['value'].'%;text-align: center;">';
                                    if($display_restated)
                                    {
                                        $content .= 'Restated</br>';
                                    }
                                    $content .= $last_fye_end."<br/>". "Final"; 
                                $content .= '</th>';
                                $content .= '<th style="colspan=2 width:'.($col_width['variance']*2).'%;text-align: center;"><br/>Variance</th>';

                                if($display_restated)
                                {
                                    $content .= '<th style="width: ' . $col_width['value'] . '%; text-align: center;">Restated</br>' . $last_fye_beg . '</th>';
                                }
                            }
                        
        $content .=        '<th style="width:5%;text-align: center;"></th>
                            <th style="width:10%;text-align: center;"></th>
                            <th style="width:10%;text-align: center;"></th>
                            <th style="width:5%;text-align: center;"></th>
                            <th style="width:13%;text-align: center;"></th>
                        </tr>

                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;"></th>
                            <th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">$</th>';

                        
                            if(!empty($last_fye_end))
                            {
                                $content .= '<th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">$</th>
                                            <th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">$</th>
                                            <th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">%</th>';

                                if($display_restated)
                                {
                                    $content .= '<th style="text-align: center; border-top: 1px solid #000;">$</th>';
                                }
                            }
                        
        $content .=        '<th style="width:5%;text-align: center;">Ref</th>
                            <th style="width:10%;text-align: center;">Risk</th>
                            <th style="width:10%;text-align: center;">Assertion</th>
                            <th style="width:5%;text-align: center;">Risk Level</th>
                            <th style="width:13%;text-align: center;">Response</th>
                        </tr>
                    </thead>
                    <tbody>';

                    $ref_index = 1;

                    $total = [];
                    $total_revenue_current          = 0.00; // (+) ** M1003
                    $total_revenue_current_ly       = 0.00; // (+) ** M1003
                    $total_cost_of_sale_current     = 0.00; // (-) ** M1004
                    $total_cost_of_sale_current_ly  = 0.00; // (-) ** M1004
                    $total_other_income             = 0.00; //     ** M1005
                    $total_other_income_ly          = 0.00; //     ** M1005

                    $total_ly = [];

                    $revenue_exist          = false;
                    $cost_of_sales_exist    = false;

                    $counter = 0;

                    $temp_total_ly      = 0.00;

                    $closing_inventories_ac = "";
                    $closing_inventories_key = array_search("Closing inventories", array_column($fs_ntfs_list, "description")); // get key

                    if(!empty($closing_inventories_key) || (string)$closing_inventories_key == 0)
                    {
                        $closing_inventories_ac = $fs_ntfs_list[$closing_inventories_key]['account_code'];  // get description from fs_ntfs_list json from document name "Statement of detailed profit or loss"
                    }

                    foreach($state_detailed_pro_loss_data as $key => $main_category)
                    {
                        $add_less_display = "";
                        $main_account_description = "";
                        $main_account_code = $main_category[0]['parent_array'][0]['account_code'];
                        
                        /* Settings */
                        // check using this account code > take the default description > do checking using description (list take from json)
                        $fs_ntfs_list_key = array_search($main_account_code, array_column($fs_ntfs_list, "account_code"));  // get key

                        if(!empty($fs_ntfs_list_key) || (string)$fs_ntfs_list_key == 0)
                        {
                            $main_account_description = $fs_ntfs_list[$fs_ntfs_list_key]['description'];    // get description from fs_ntfs_list json from document name "Statement of detailed profit or loss"
                        }

                       if($main_account_description == "Revenue")   // revenue
                        {
                            if($main_category[0]['parent_array'][0]['description'] == "Revenue" )
                            {
                                foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                                {
                                    if(isset($child_array['parent_array']))
                                    {
                                        if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                        {
                                            $revenue_exist = true;
                                        }

                                    }
                                    elseif ( $child_array['child_array'] != null) {
                                        $revenue_exist = true;
                                    }


                                }
                                // $revenue_exist = true;
                            }
                            // $revenue_exist = true;
                            
                        }
                        elseif($main_account_description == "Cost of Sales")    // cost of sale
                        {
                            if($main_category[0]['parent_array'][0]['description'] == "Cost of Sales" )
                            {
                                foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                                {
                                    if(isset($child_array['parent_array']))
                                    {
                                        if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                        {
                                            $cost_of_sales_exist = true;
                                            $add_less_display    = "Less: ";

                                        }

                                    }
                                    elseif ( $child_array['child_array'] != null) {
                                        $cost_of_sales_exist = true;
                                        $add_less_display    = "Less: ";

                                    }


                                }
                                                                }
                            // $cost_of_sales_exist = true;
                            // $add_less_display     = "Less: ";
                            
                        }
                        elseif($main_account_description == "Income")   // other income
                        {
                            $add_less_display = "Add: ";
                        }
                        /* END OF Settings */

                        /* ------------------- If NO SUB under main category ------------------- */
                        if(count($main_category[0]['child_array']) == 0)
                        {
                            $c_lye_value = 0.00;

                            if(!empty($main_category[0]['parent_array'][0]['company_end_prev_ye_value']))
                            {
                                if($main_account_description == "Revenue" || $main_account_description == "Income")
                                {
                                    $c_lye_value = $main_category[0]['parent_array'][0]['company_end_prev_ye_value'] * (-1);
                                }
                                else
                                {
                                    $c_lye_value = $main_category[0]['parent_array'][0]['company_end_prev_ye_value'];
                                }
                            }

                            if(ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) == "Revenue")
                            {
                            
                                $content .= '<tr>' . 
                                    '<td style="width:'.$col_width['account_desc'].'%;"><strong>' . $add_less_display . ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) . '</strong></td>' . 
                                    '<td style="width:'.$col_width['value'].'%;text-align:right; border-bottom:1px solid black;"> - </td>';

                                    if(!empty($last_fye_end))
                                    {
                                        $content .= '<td align="right" style="width:'.$col_width['value'].'%;border-bottom:1px solid black;">' . 
                                                // '<input type="hidden" name="SDPL_parent_fs_categorized_account_id['. $counter .']" value="'. $main_category[0]['parent_array'][0]['account_code'] .'">' .
                                                // '<input type="hidden" name="SDPL_sub_fs_categorized_account_id['. $counter .']" value="'. $main_category[0]['parent_array'][0]['id'] .'">' .
                                                // '<input type="text" name="SDPL_company_end_prev_year_value[' . $counter . ']" class="form-control SDPL_all_values SDPL_values_under_' . $main_category['parent_array'][0]['id'] . '" style="text-align: right;" value="' . $c_lye_value . '" onchange="calculation('. $main_category['parent_array'][0]['id'] .')">' .
                                                $this->negative_bracket($c_lye_value) . 
                                            '</td>';
                                    }
                                $content .= '</tr>';

                                $content .= '<tr>' .
                                                '<td></td>' .
                                                '<td style="width:'.$col_width['value'].'%;text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                    '<span>' . $this->negative_bracket(0) . '</span>' .
                                                '</td>';

                                                if(!empty($last_fye_end))
                                                {
                                                    $content .= '<td style="width:'.$col_width['value'].'%;text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' . 
                                                            // '<span id="SDPL_subtotal_'. $main_category['parent_array'][0]['id'] .'">' . negative_bracket($temp_total_ly) . '</span>' . 
                                                            '<span>' . $this->negative_bracket(0) . '</span>' . 
                                                        '</td>';
                                                    $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket(0).'</td>';
                                                    $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format(0,2).'%</td>';  
                                                }
                        
                                    
                                $content .= '</tr>';
                            }

                            

                            // total up 
                            $temp_total    = 0.00;
                            $temp_total_ly = $c_lye_value;
                            $counter ++;
                        }
                        /* ------------------- END OF If NO SUB under main category ------------------- */

                        /* If there are subs under main category */
                        else
                        {
                            $temp_total = 0.00;
                            $temp_total_ly = 0.00;

                            $check_existance = false;

                            foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                            {
                                if(isset($child_array['parent_array']))
                                {
                                    if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                    {
                                        $check_existance = true;
                                    }

                                }
                                elseif ( $child_array['child_array'] != null) {
                                    $check_existance = true;
                                }


                            }


                            if($check_existance || ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) == "Revenue")
                            {
                                $content .= '<tr>' . 
                                        '<td style="width:'.$col_width['account_desc'].'%;" ><strong>' . $add_less_display . ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) . '</strong></td>' .
                                        '<td style="width:'.$col_width['value'].'%;" ></td>';
                                        if(!empty($last_fye_end))
                                        {
                                            $content .= '<td style="width:'.$col_width['value'].'%;"></td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;"></td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;"></td>';
                                        }
                                $content .= '<td style="width:59%;" colspan="5"></td>';
                                $content .= '</tr>';
                            }

                            foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                            {
                                if(isset($child_array['parent_array']))
                                {
                                    if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                    {
                                        if($main_account_description == "Revenue" || $main_account_description == "Income")
                                        {
                                            $temp_value     = $child_array['parent_array'][0]['total_c'] * (-1);
                                            $temp_value_ly  = $child_array['parent_array'][0]['total_c_lye'] * (-1);
                                        }
                                        else
                                        {
                                            $temp_value     = $child_array['parent_array'][0]['total_c'];
                                            $temp_value_ly  = $child_array['parent_array'][0]['total_c_lye'];
                                        }

                                        /* ------ Add in Display "Less:" for Closing inventories ------ */
                                        if($child_array['parent_array'][0]['account_code'] == $closing_inventories_ac)
                                        {
                                            $child_array['parent_array'][0]['description'] = $add_less_display . $child_array['parent_array'][0]['description'];
                                        }
                                        /* ------ END OF Add in Display "Less:" for Closing inventories ------ */

                                        $variance_value = $this->calculate_variance($temp_value, $temp_value_ly);

                                        if($temp_value || $temp_value_ly)
                                        {
                                            // Display child with subcategory. 
                                            $content .= '<tr>' . 
                                                    '<td style="width:'.$col_width['account_desc'].'%;">' . $child_array['parent_array'][0]['description'] . '</td>' .
                                                    '<td style="width:'.$col_width['value'].'%;text-align:right;">'. $this->negative_bracket($temp_value) .'</td>';
                                                    if(!empty($last_fye_end))
                                                    {
                                                        $content .= '<td style="width:'.$col_width['value'].'%;text-align:right;">' . $this->negative_bracket($temp_value_ly).'</td>';
                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                                    }

                                            $content .= '<td style="width:5%;text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                  <td style="width:10%;text-align: left;">'.(isset($line_items[$child_array['parent_array'][0]['id']][0])?$line_items[$child_array['parent_array'][0]['id']][0]['risk_text']:"").'</td>
                                                  <td style="width:10%;text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$child_array['parent_array'][0]['id']][0])?$line_items[$child_array['parent_array'][0]['id']][0]['assertion']:"0")].'</td>
                                                  <td style="width:5%;text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$child_array['parent_array'][0]['id']][0])?$line_items[$child_array['parent_array'][0]['id']][0]['risk_level']:"0")].'</td>
                                                  <td style="width:13%;text-align: left;">'.(isset($line_items[$child_array['parent_array'][0]['id']][0])?$line_items[$child_array['parent_array'][0]['id']][0]['response']:"").'</td>';      
                                            $content .= '</tr>';

                                            $ref_index++;

                                            //loop line item other than first row
                                            if(isset($line_items[$child_array['parent_array'][0]['id']])){
                                                if(count($line_items[$child_array['parent_array'][0]['id']]) > 1)
                                                {
                                                    foreach ($line_items[$child_array['parent_array'][0]['id']] as $key => $each_line) 
                                                    {
                                                        if($key > 0)
                                                        {


                                                            $content .=  '<tr>' .
                                                                      '<td></td>';

                                                            $content .= '<td align="right"></td>';
                                                                
                                                                if(!empty($last_fye_end))
                                                                {

                                                                    $content .= 
                                                                    '<td align="right"></td>';
                                                                    $content .= '<td align="right"></td>';
                                                                    $content .= '<td align="center"></td>';
                                                                }

                                                                $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                                  <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                                  <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                                  <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                  <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                                // }
                                                            $content .= '</tr>';
                                                            $ref_index++;
                                                        }
                                                    }
                                                }
                                            }

                                            // total up 
                                            $temp_total    += $temp_value;
                                            $temp_total_ly += $temp_value_ly;

                                            $counter++;
                                        }
                                    }
                                }
                                elseif($child_array['child_array'] != null)
                                {
                                    if($main_account_description == "Revenue" || $main_account_description == "Income")
                                    {
                                        $temp_value = $child_array['child_array']['value'] * (-1);
                                        $temp_value_ly = $child_array['child_array']['company_end_prev_ye_value'] * (-1);
                                    }
                                    else
                                    {
                                        $temp_value = $child_array['child_array']['value'];
                                        $temp_value_ly = $child_array['child_array']['company_end_prev_ye_value'];
                                    }

                                    // Display child without subcategory. 
                                    $variance_value = $this->calculate_variance($temp_value, $temp_value_ly);
                                    $temp_id = $child_array['child_array']['id'];

                                    if($temp_value || $temp_value_ly)
                                    {
                                        $content .= '<tr>' . 
                                                        '<td style="width:'.$col_width['account_desc'].'%;">' . $child_array['child_array']['description'] . '</td>' .
                                                        '<td style="text-align:right;width:'.$col_width['value'].'%;">'. $this->negative_bracket($temp_value) .'</td>';

                                                if(!empty($last_fye_end))
                                                {
                                                    $content .= '<td style="text-align:right;width:'.$col_width['value'].'%;">' . 
                        
                                                        $this->negative_bracket($temp_value_ly);
                                                    $content .= '</td>';
                                                    $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                    $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>'; 


                                                }
                                             
                                        $content .= '<td style="text-align: center;width:5%;" class="ref_no">'.$ref_index.'</td>
                                                  <td style="text-align: left;width:10%;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                                  <td style="text-align: center;width:10%;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                                  <td style="text-align: center;width:5%;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                                  <td style="text-align: left;width:13%;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';      
                                        $content .= '</tr>';

                                        $ref_index++;

                                        //loop line item other than first row
                                        if(isset($line_items[$temp_id])){
                                            if(count($line_items[$temp_id]) > 1)
                                            {
                                                foreach ($line_items[$temp_id] as $key => $each_line) 
                                                {
                                                    if($key > 0)
                                                    {


                                                        $content .=  '<tr>' .
                                                                  '<td></td>';

                                                        $content .= '<td align="right"></td>';
                                                            
                                                            if(!empty($last_fye_end))
                                                            {

                                                                $content .= 
                                                                '<td align="right"></td>';
                                                                $content .= '<td align="right"></td>';
                                                                $content .= '<td align="center"></td>';
                                                            
                                                            
                                                            }

                                                            $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                              <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                              <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                              <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                              <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                            // }
                                                        $content .= '</tr>';

                                                        $ref_index++;
                                                    }
                                                }
                                            }
                                        }


                                        // total up 
                                        $temp_total    += $temp_value;
                                        $temp_total_ly += $temp_value_ly;

                                        $counter ++;
                                    }
                                }
                            
                            }

                            // show total for the category
                            if($check_existance || ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) == "Revenue")
                            {
                                $variance_value = $this->calculate_variance($temp_total, $temp_total_ly);
                                if($temp_total || $temp_total_ly)
                                {
                                    $content .= '<tr>' .
                                            '<td></td>' .
                                            '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                // '<input type="hidden" name="current_fye_end['. $key .']" value="'. $current_fye_end .'">' .
                                                // '<input type="hidden" name="category_total['. $key .']" value="'. $temp_total .'">' .
                                                // '<input type="hidden" name="categorized_account_id['. $key .']" value="'. $main_category['parent_array'][0]['id'] .'">' .
                                                '<span>' . $this->negative_bracket($temp_total) . '</span>' .
                                            '</td>';

                                            if(!empty($last_fye_end))
                                            {
                                                $content .= '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' . 
                                                        // '<span id="SDPL_subtotal_'. $main_category['parent_array'][0]['id'] .'">' . negative_bracket($temp_total_ly) . '</span>' . 
                                                        '<span>' . $this->negative_bracket($temp_total_ly) . '</span>' . 
                                                    '</td>';
                                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';   
                                            }
                    
                                    $content .= '<td colspan="5"></td>';   
                                    $content .= '</tr>';
                                }
                            }

                        }
                        /* END OF If there are subs under main category */

                        if(isset($main_category['child_array']))
                        {
                            if($main_account_description == "Income" || (count($main_category['child_array']) == 0))
                            {
                                $content .= '<tr><td colspan="0">&nbsp;</td></tr>';
                            }
                        }
                        

                        if($main_account_description == "Revenue")
                        {
                            $total_revenue_current    = $temp_total;
                            $total_revenue_current_ly = $temp_total_ly;
                        }
                        elseif($main_account_description == "Cost of Sales")
                        {
                            $total_cost_of_sale_current    = $temp_total;
                            $total_cost_of_sale_current_ly = $temp_total_ly;
                        }
                        elseif($main_account_description == "Income")
                        {
                            $total_other_income    = $temp_total;
                            $total_other_income_ly = $temp_total_ly;
                        }

                        /* CALCULATE AND DISPLAY GROSS PROFIT */
                        if($main_account_description == "Cost of Sales" && ($revenue_exist || $cost_of_sales_exist))
                        {
                            $gross_profit    = $total_revenue_current - $total_cost_of_sale_current;
                            $gross_profit_ly = $total_revenue_current_ly - $total_cost_of_sale_current_ly;

                            $variance_value = $this->calculate_variance($gross_profit, $gross_profit_ly);

                            if($gross_profit || $gross_profit_ly)
                            {
                                $content .= '<tr>'.
                                        '<td><em>Gross Profit</em></td>' . 
                                        '<td style="text-align:right; border-bottom:1px solid black;">'. 
                                                // '<input type="hidden" name="gross_profit" value="' . $gross_profit . '" >' .
                                                $this->negative_bracket($gross_profit) .
                                            '</td>';
                                            if(!empty($last_fye_end))
                                            {
                                                $content .= '<td style="text-align:right; border-bottom:1px solid black;">'. 
                                                        // '<input type="hidden" name="gross_profit_ly" value="' . $gross_profit_ly . '" >' .
                                                        '<span>' . $this->negative_bracket($gross_profit_ly) . '</span>' .
                                                    '</td>';
                                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                                            }

                                $content .= '<td colspan="5"></td>';    
                                $content .= '</tr>';

                                $content .= '<tr>' . 
                                        '<td>&nbsp;</td>'.
                                        '<td>&nbsp;</td>';
                                        if(!empty($last_fye_end))
                                        {
                                            $content .= '<td>&nbsp;</td>';
                                        }
                                $content .= '</tr>';
                            }
                        }
                        /* END OF CALCULATE AND DISPLAY GROSS PROFIT */
                    }

                     /* DISPLAY OPERATING EXPENSES */
                     $content .= '<tr>' . 
                                    '<td>&nbsp;</td>'.
                                    '<td>&nbsp;</td>';
                                    if(!empty($last_fye_end))
                                    {
                                        $content .= '<td>&nbsp;</td>';
                                    }
                    $content .= '</tr>';
                    $content .= '<tr>' .
                            '<td style="text-align:left;"><strong>Less: Operating expenses</strong></td>' . 
                            '<td class="total_operating_expenses"></td>';
                            if(!empty($last_fye_end))
                            {
                                $content .= '<td></td>';
                            }
                    $content .= '</tr>';

                    foreach($schedule_operating_expense_data[0]['child_array'] as $key => $value)
                    {
                        // print_r($value);

                        $temp_total     = 0.00;
                        $temp_total_ly  = 0.00;

                        if(isset($value['parent_array']))
                        {
                            if(count($value['parent_array']) > 0)
                            {
                                $content .= 
                                    '<tr>' . 
                                        '<td><i>' . $value['parent_array'][0]['description'] . '</i></td>' .    // Description in Level 2
                                        '<td colspan="2"></td>' .
                                    '</tr>';

                                foreach ($value['child_array'] as $key2 => $details_data) 
                                {
                                    // print_r($details_data);


                                    if(isset($details_data['parent_array'])){
                                        if(count($details_data['parent_array']) > 0)
                                        {
                                            if(!isset($details_data['child_array'][0]['parent_array']))
                                            {
                                                if(isset($details_data['parent_array'][0]['total_c']))
                                                {
                                                    $temp_total     += $this->convert_string_to_number($details_data['parent_array'][0]['total_c']);
                                                    $temp_total_ly  += $this->convert_string_to_number($details_data['parent_array'][0]['total_c_lye']);
                                                }
                                                $temp_total_c = isset($details_data['parent_array'][0]['total_c'])?$details_data['parent_array'][0]['total_c']:0 ;
                                                $temp_total_c_lye = isset($details_data['parent_array'][0]['total_c'])?$details_data['parent_array'][0]['total_c_lye']:0 ;

                                                // echo 
                                                //  '<tr>' . 
                                                //      '<td>' . $details_data['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c']) . '</td>';
                                                $variance_value = $this->calculate_variance($temp_total_c, $temp_total_c_lye);
                                                $temp_id = $details_data['parent_array'][0]['id'];

                                                if($temp_total_c || $temp_total_c_lye)
                                                {
                                                    $content .= 
                                                        '<tr>' . 
                                                            '<td style="width:'.$col_width['account_desc'].'%;">' . $details_data['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                            '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($temp_total_c) . '</td>';

                                                    if(!empty($last_fye_end))
                                                    {
                                                        // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c_lye']) . '</td>';

                                                        $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($temp_total_c_lye) . '</td>';
                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                                                    }

                                                        
                                                    $content .= '<td style="width:5%;text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                          <td style="width:10%;text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                                          <td style="width:10%;text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                                          <td style="width:5%;text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                                          <td style="width:13%;text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';      
                                                    $content .= '</tr>';

                                                    $ref_index++;

                                                    //loop line item other than first row
                                                    if(isset($line_items[$temp_id])){
                                                        if(count($line_items[$temp_id]) > 1)
                                                        {
                                                            foreach ($line_items[$temp_id] as $key => $each_line) 
                                                            {
                                                                if($key > 0)
                                                                {


                                                                    $content .=  '<tr>' .
                                                                              '<td></td>';

                                                                    $content .= '<td align="right"></td>';
                                                                        
                                                                        if(!empty($last_fye_end))
                                                                        {

                                                                            $content .= 
                                                                            '<td align="right"></td>';
                                                                            $content .= '<td align="right"></td>';
                                                                            $content .= '<td align="center"></td>';
                                                                
                                                                        }

                                                                        
                                                                        $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                                          <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                                          <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                                          <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                          <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                                        // }
                                                                    $content .= '</tr>';

                                                                    $ref_index++;
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                            else
                                            {
                                                $content .= 
                                                    '<tr>' . 
                                                        '<td><b>' . $details_data['parent_array'][0]['description'] . ':</b></td>' .    // Description in level 3 (have sub)
                                                        '<td colspan="8"></td>
                                                    </tr>';
                                            }
                                            foreach ($details_data['child_array'] as $key3 => $details_data_child) 
                                            {
                                                if(isset($details_data_child['parent_array']) && count($details_data_child['parent_array']) > 0)
                                                {
                                                    if(isset($details_data_child['parent_array'][0]['total_c']))
                                                    {
                                                        $temp_total     += $this->convert_string_to_number($details_data_child['parent_array'][0]['total_c']);
                                                        $temp_total_ly  += $this->convert_string_to_number($details_data_child['parent_array'][0]['total_c_lye']);
                                                    }

                                                    $temp_total_c = isset($details_data_child['parent_array'][0]['total_c'])?$details_data_child['parent_array'][0]['total_c']:0 ;
                                                    $temp_total_c_lye = isset($details_data_child['parent_array'][0]['total_c'])?$details_data_child['parent_array'][0]['total_c_lye']:0 ;

                                                    // echo 
                                                    //  '<tr>' . 
                                                    //      '<td>' . $details_data['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                    //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c']) . '</td>';
                                                    $variance_value = $this->calculate_variance($temp_total_c, $temp_total_c_lye);
                                                    $temp_id = $details_data_child['parent_array'][0]['id'];

                                                    if($temp_total_c || $temp_total_c_lye)
                                                    {
                                                        $content .= 
                                                            '<tr class="rows-for-'.$temp_id.'">' .
                                                                '<input type="hidden" name="PL_audit_categorized_account_id[]" class="PL_audit_categorized_account_id" value="'. $temp_id.'">'. 
                                                                '<td>- ' . $details_data_child['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                                '<td style="text-align: right;">' . $this->negative_bracket($temp_total_c) . '</td>';

                                                        if(!empty($last_fye_end))
                                                        {
                                                            // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c_lye']) . '</td>';

                                                            $content .= '<td style="text-align: right;">' . $this->negative_bracket($temp_total_c_lye) . '</td>';
                                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                                                        }

                                                             
                                                        $content .= '<td style="width:5%;text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                              <td style="width:10%;text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                                              <td style="width:10%;text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                                              <td style="width:5%;text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                                              <td style="width:13%;text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';      
                                                        $content .= '</tr>';

                                                        $ref_index++;

                                                        // loop line item other than first row
                                                        if(isset($line_items[$temp_id])){
                                                            if(count($line_items[$temp_id]) > 1)
                                                            {
                                                                foreach ($line_items[$temp_id] as $key => $each_line) 
                                                                {
                                                                    if($key > 0)
                                                                    {


                                                                        $content .=  '<tr>' .
                                                                                  '<td></td>';

                                                                        $content .= '<td align="right"></td>';
                                                                            
                                                                            if(!empty($last_fye_end))
                                                                            {

                                                                                $content .= 
                                                                                '<td align="right"></td>';
                                                                                $content .= '<td align="right"></td>';
                                                                                $content .= '<td align="center"></td>';
                                                                    
                                                                            }

                                                                            
                                                                            $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                                              <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                                              <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                                              <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                              <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                                            // }
                                                                        $content .= '</tr>';

                                                                        $ref_index++;
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                                
                                            }

                                        }
                                    }
                                    else
                                    {
                                        $temp_total     += $this->convert_string_to_number($details_data['child_array']['value']);
                                        $temp_total_ly  += $this->convert_string_to_number($details_data['child_array']['company_end_prev_ye_value']);

                                        // echo 
                                        //  '<tr>' . 
                                        //      '<td>' . $details_data['child_array']['description'] . '</td>' .    // Description in level 3 (no sub)
                                        //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['child_array']['value']) . '</td>';
                                        $variance_value = $this->calculate_variance($details_data['child_array']['value'], $details_data['child_array']['company_end_prev_ye_value']);
                                        $temp_id = $details_data['child_array']['id'];

                                        if($details_data['child_array']['value'] || $details_data['child_array']['company_end_prev_ye_value'])
                                        {

                                            $content .= 
                                                '<tr>' . 
                                                    '<td style="width:'.$col_width['account_desc'].'%;">' . $details_data['child_array']['description'] . '</td>' .    // Description in level 3 (no sub)
                                                    '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($details_data['child_array']['value']) . '</td>';

                                            if(!empty($last_fye_end))
                                            {
                                                // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['child_array']['company_end_prev_ye_value']) . '</td>';

                                                $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($details_data['child_array']['company_end_prev_ye_value']) . '</td>';
                                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';    
                                            }

                                            
                                            $content .= '<td style="width:5%;text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                  <td style="width:10%;text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                                  <td style="width:10%;text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                                  <td style="width:5%;text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                                  <td style="width:13%;text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';      
                                            $content .= '</tr>';  

                                            $ref_index++;

                                            //loop line item other than first row
                                            if(isset($line_items[$temp_id])){
                                                if(count($line_items[$temp_id]) > 1)
                                                {
                                                    foreach ($line_items[$temp_id] as $key => $each_line) 
                                                    {
                                                        if($key > 0)
                                                        {


                                                            $content .=  '<tr>' .
                                                                      '<td></td>';

                                                            $content .= '<td align="right"></td>';
                                                                
                                                                if(!empty($last_fye_end))
                                                                {

                                                                    $content .= 
                                                                    '<td align="right"></td>';
                                                                    $content .= '<td align="right"></td>';
                                                                    $content .= '<td align="center"></td>';
                                                                
                                                        
                                                                }

                                                                
                                                                $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                                  <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                                  <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                                  <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                  <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                                // }
                                                            $content .= '</tr>';

                                                            $ref_index++;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    // echo 
                                    //  '<tr>' . 
                                    //      '<td>' . $details_data['description'] . '</td>' .
                                    //      '<td style="text-align:right; ">'. negative_bracket($details_data['value']) .'</td>';

                                    // if(!empty($last_fye_end))
                                    // {
                                    //  echo '<td style="text-align:right;">' . negative_bracket($details_data['company_end_prev_ye_value']) . '</td>';

                                    //  $index++;   // for item in sub category.
                                    // }

                                    // echo '</tr>';
                                }

                                /* ---------------------- show total for the category ---------------------- */
                                // if(count($details['data']) > 0)
                                // {
                                    $variance_value = $this->calculate_variance($temp_total, $temp_total_ly);

                                    if($temp_total || $temp_total_ly)
                                    {
                                        $content .= 
                                            '<tr>' .
                                                '<td></td>' .
                                                '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                    '<span>' . $this->negative_bracket($temp_total) . '</span>' .
                                                '</td>';

                                        if(!empty($last_fye_end))
                                        {
                                            $content .= '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' . 
                                                    '<span>' . $this->negative_bracket($temp_total_ly) . '</span>' . 
                                                '</td>';
                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                                        }

                                             
                                        $content .= '</tr>';
                                    }
                                

                                array_push($total, $temp_total);
                                array_push($total_ly, $temp_total_ly);
                                /* ---------------------- END OF show total for the category ---------------------- */
                            }
                        }
                        else 
                        {
                            $temp_total     += $this->convert_string_to_number($value['child_array']['value']);
                            $temp_total_ly  += $this->convert_string_to_number($value['child_array']['company_end_prev_ye_value']);

                            $content .= '<tr>' . 
                                            '<td colspan="10">&nbsp;</td>' . 
                                        '</tr>';

                            // echo 
                            //  '<tr>' . 
                            //      '<td>' . $value['child_array']['description'] . '</td>' .   // Description in Level 2 (without child)
                            //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($value['child_array']['value']) . '</td>';
                            $variance_value = $this->calculate_variance($value['child_array']['value'], $value['child_array']['company_end_prev_ye_value']);
                            $temp_id = $value['child_array']['id'];

                            if($$value['child_array']['value'] || $value['child_array']['company_end_prev_ye_value'])
                            {

                              
                                $content .= 
                                    '<tr>' . 
                                        '<td style="width:'.$col_width['account_desc'].'%;">' . $value['child_array']['description'] . '</td>' .   // Description in Level 2 (without child)
                                        '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($value['child_array']['value']) . '</td>';

                                if(!empty($last_fye_end))
                                {
                                    // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($value['child_array']['company_end_prev_ye_value']) . '</td>';

                                    $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($value['child_array']['company_end_prev_ye_value']) . '</td>';
                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                                }

                                $content .= '<td style="text-align: center;width:5%;" class="ref_no">'.$ref_index.'</td>
                                                  <td style="text-align: left;width:10%;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                                  <td style="text-align: center;width:10%;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                                  <td style="text-align: center;width:5%;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                                  <td style="text-align: left;width:13%;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';          
                                $content .= '</tr>';

                                $ref_index++;

                                //loop line item other than first row
                                if(isset($line_items[$temp_id])){
                                    if(count($line_items[$temp_id]) > 1)
                                    {
                                        foreach ($line_items[$temp_id] as $key => $each_line) 
                                        {
                                            if($key > 0)
                                            {


                                                $content .=  '<tr>' .
                                                          '<td></td>';

                                                $content .= '<td align="right"></td>';
                                                    
                                                    if(!empty($last_fye_end))
                                                    {

                                                        $content .= 
                                                        '<td align="right"></td>';
                                                        $content .= '<td align="right"></td>';
                                                        $content .= '<td align="center"></td>';
                                                    
                                            
                                                    }

                                                    
                                                    $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                      <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                      <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                      <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                      <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                    // }
                                                $content .= '</tr>';

                                                $ref_index++;
                                            }
                                        }
                                    }
                                }
                            }

                            array_push($total, $temp_total);
                            array_push($total_ly, $temp_total_ly);
                        }

                        
                    }

                    // calculate overall total
                    $total_operating_expenses_current = 0.00;
                    $total_operating_expenses_ly = 0.00;
                    
                    foreach($total as $counter => $each_num)
                    {
                        $total_operating_expenses_current += $each_num;
                    }

                    foreach($total_ly as $counter => $each_num)
                    {
                        $total_operating_expenses_ly += $each_num;
                    }

                    $variance_value = $this->calculate_variance($total_operating_expenses_current, $total_operating_expenses_ly);
                    $content .= '<tr>' .
                            '<td>Total operating expenses</td>' .
                            '<td style="text-align:right; border-top:1px solid black;border-bottom:1px solid black;">' . 
                                '<span>' . $this->negative_bracket($total_operating_expenses_current) . '</span>'.
                            '</td>';

                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<td style="text-align:right; border-top:1px solid black;border-bottom:1px solid black;">' . 
                                    '<span>' . $this->negative_bracket($total_operating_expenses_ly) . '</span>'.
                                '</td>';
                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';   
                            }
                       
                    $content .= '</tr>';
                    /* END OF DISPLAY OPERATING EXPENSES */

                    /* CALCULATE AND DISPLAY PROFIT BEFORE TAX */
                    $profit_before_tax = ($total_revenue_current - $total_cost_of_sale_current) + $total_other_income - $total_operating_expenses_current;
                    $profit_before_tax_ly = ($total_revenue_current_ly - $total_cost_of_sale_current_ly) + $total_other_income_ly - $total_operating_expenses_ly;

                    $variance_value = $this->calculate_variance($profit_before_tax, $profit_before_tax_ly);
                    $content .= 
                    '<tr>' .
                        '<td style="text-align:left;">Profit before tax</td>' . 
                        '<td style="text-align:right; border-top:1px solid black;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($profit_before_tax) . 
                        '</td>';
                        if(!empty($last_fye_end))
                        {
                            $content .= '<td style="text-align:right; border-top:1px solid black;">' . 
                                    // '<input type="hidden" name="profit_of_the_year_ly" value="'. $profit_of_the_year_ly .'">' .
                                    '<span>' . $this->negative_bracket($profit_before_tax_ly) . '</span>' .  
                                '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                        }
                        
                    $content .= '</tr>';

                    /* END OF CALCULATE AND DISPLAY PROFIT BEFORE TAX */

                    // TAXATION 
                    $total_additional_company_ye    = 0.00;
                    $total_additional_company_lye   = 0.00;

                    foreach($tax_data[0] as $key => $value)
                    {
                        $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c'], $value['parent_array'][0]['total_c_lye']);
                        $temp_id = $value['parent_array'][0]['id'];

                        if($value['parent_array'][0]['total_c'] || $value['parent_array'][0]['total_c_lye'])
                        {

                            $content .= 
                            '<tr>'.
                                '<td>'. $value['parent_array'][0]['description'] . '</td>'; 
                            
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                // '<td align="right" class="taxation_company_ye">' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                '</td>' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                                '</td>';
                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                            }
                            else
                            {
                                $content .= 
                                // '<td align="right" class="taxation_company_ye">' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                '</td>';
     
                            }

                            
                             
                            $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                  <td style="text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                  <td style="text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                  <td style="text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                  <td style="text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';    
                            $content .= '</tr>';

                            $ref_index++;

                            //loop line item other than first row
                            if(isset($line_items[$temp_id])){
                                if(count($line_items[$temp_id]) > 1)
                                {
                                    foreach ($line_items[$temp_id] as $key => $each_line) 
                                    {
                                        if($key > 0)
                                        {


                                            $content .=  '<tr>' .
                                                      '<td></td>';

                                            $content .= '<td align="right"></td>';
                                                
                                                if(!empty($last_fye_end))
                                                {

                                                    $content .= 
                                                    '<td align="right"></td>';
                                                    $content .= '<td align="right"></td>';
                                                    $content .= '<td align="center"></td>';
                                    
                                                }

                                                
                                                $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                  <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                  <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                  <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                  <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                // }
                                            $content .= '</tr>';

                                            $ref_index++;
                                        }
                                    }
                                }
                            }
                        }
                        $total_additional_company_ye    += (double)$value['parent_array'][0]['total_c'];
                        $total_additional_company_lye   += (double)$value['parent_array'][0]['total_c_lye'];
                    }
    
                 // END OF TAXATION 

                // SHARE OF ASSOCIATES PROFIT OR LOSS
                    $total_soa_pl_company_ye    = 0.00;
                    $total_soa_pl_company_lye   = 0.00;

                    if(isset($soa_pl_list[0])){
                        foreach($soa_pl_list[0] as $key => $value)
                        {
                            $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c'], $value['parent_array'][0]['total_c_lye']);
                            $temp_id = $value['parent_array'][0]['id'];

                            if($value['parent_array'][0]['total_c'] || $value['parent_array'][0]['total_c_lye'])
                            {
                                $content .= 
                                '<tr>'.
                                    '<td>'. $value['parent_array'][0]['description'] . '</td>';


                                if(!empty($last_fye_end))
                                {
                                    $content .= 
                                    '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                    '</td>' . 
                                    '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                                    '</td>';
                                }
                                else
                                {
                                    $content .= 
                                    '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                    '</td>';
                          
                                    // $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                    // $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                }

                                
                                 
                                $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                  <td style="text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                  <td style="text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                  <td style="text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                  <td style="text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';  
                                $content .= '</tr>';

                                $ref_index++;
                                //loop line item other than first row
                                if(isset($line_items[$temp_id])){
                                    if(count($line_items[$temp_id]) > 1)
                                    {
                                        foreach ($line_items[$temp_id] as $key => $each_line) 
                                        {
                                            if($key > 0)
                                            {


                                                $content .=  '<tr>' .
                                                          '<td></td>';

                                                $content .= '<td align="right"></td>';
                                                    
                                                    if(!empty($last_fye_end))
                                                    {

                                                        $content .= 
                                                        '<td align="right"></td>';
                                                        $content .= '<td align="right"></td>';
                                                        $content .= '<td align="center"></td>';
                                                    
                                                
                                                    }

                                                    
                                                    $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                      <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                      <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                      <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                      <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                    // }
                                                $content .= '</tr>';

                                                $ref_index++;
                                            }
                                        }
                                    }
                                }
                            }

                    
                            $total_soa_pl_company_ye    += (double)$value['parent_array'][0]['total_c'];
                            $total_soa_pl_company_lye   += (double)$value['parent_array'][0]['total_c_lye'];
                        }
                    }
                 // END OF SHARE OF ASSOCIATES PROFIT OR LOSS

                 // CALCULATE PROFIT AFTER TAX
                    $profit_after_tax = $profit_before_tax + $total_additional_company_ye + $total_soa_pl_company_ye;
                    $profit_after_tax_ly = $profit_before_tax_ly + $total_additional_company_lye + $total_soa_pl_company_lye;

                    $variance_value = $this->calculate_variance($profit_after_tax, $profit_after_tax_ly);
                    $content .= 
                    '<tr>' .
                        '<td style="text-align:left;">Profit after tax</td>' . 
                        '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($profit_after_tax) . 
                        '</td>';
                        if(!empty($last_fye_end))
                        {
                            $content .= '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                                    // '<input type="hidden" name="profit_of_the_year_ly" value="'. $profit_of_the_year_ly .'">' .
                                    '<span>' . $this->negative_bracket($profit_after_tax_ly) . '</span>' .  
                                '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                        }
                         
                    $content .= '</tr>';

                    $content .= '<tr><td colspan="15">&nbsp;</td></tr>';
                // END OF CALCULATE PROFIT AFTER TAX

                // DIVIDEND 
                    $total_dividend_company_ye  = 0.00;
                    $total_dividend_company_lye     = 0.00;

                    $check_div_existance = false;

                    // print_r($div_data);
                    if(count($div_data)) {
                        foreach ($div_data[0] as $key2 => $child_array) 
                        {
                            if(isset($child_array['parent_array']))
                            {
                                if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                {
                                    $check_div_existance = true;
                                }

                            }
                            elseif ( $child_array['child_array'] != null) {
                                $check_div_existance = true;
                            }


                        }
                    }

                    if($check_div_existance)
                    {

                        foreach($div_data[0] as $key => $value)
                        {
                            $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c'], $value['parent_array'][0]['total_c_lye']);
                            $temp_id = $value['parent_array'][0]['id'];

                            if($value['parent_array'][0]['total_c'] || $value['parent_array'][0]['total_c_lye'])
                            {

                                $content .= 
                                '<tr class="rows-for-'.$temp_id.'">'.
                                    '<input type="hidden" name="PL_audit_categorized_account_id[]" class="PL_audit_categorized_account_id" value="'. $temp_id.'">'.
                                    '<td>'. $value['parent_array'][0]['description'] . '</td>'; 
                                
                                if(!empty($last_fye_end))
                                {
                                    $content .= 
                                    // '<td align="right" class="taxation_company_ye">' . 
                                    '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                    '</td>' . 
                                    '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                                    '</td>';
                                    $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                    $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                                }
                                else
                                {
                                    $content .= 
                                    // '<td align="right" class="taxation_company_ye">' . 
                                    '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                    '</td>';
                                }

                                
                                 
                                $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                          <td style="text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_text']:"").'</td>
                                          <td style="text-align: center;">'.$pl_assertion_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['assertion']:"0")].'</td>
                                          <td style="text-align: center;">'.$risk_lvl_dropdown[(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['risk_level']:"0")].'</td>
                                          <td style="text-align: left;">'.(isset($line_items[$temp_id][0])?$line_items[$temp_id][0]['response']:"").'</td>';  
                                $content .= '</tr>';

                                //loop line item other than first row
                                if(isset($line_items[$temp_id])){
                                    if(count($line_items[$temp_id]) > 1)
                                    {
                                        foreach ($line_items[$temp_id] as $key => $each_line) 
                                        {
                                            if($key > 0)
                                            {


                                                $content .=  '<tr class="rows-for-'.$temp_id.'">' .
                                                          '<td></td>';

                                                $content .= '<td align="right"></td>';
                                                    
                                                    if(!empty($last_fye_end))
                                                    {

                                                        $content .= 
                                                        '<td align="right"></td>';
                                                        $content .= '<td align="right"></td>';
                                                        $content .= '<td align="center"></td>';
                                        
                                                    }

                                                    
                                                    $content .= '<td style="text-align: center;" class="ref_no">'.$ref_index.'</td>
                                                                  <td style="text-align: left;">'.$each_line['risk_text'].'</td>
                                                                  <td style="text-align: center;">'.$pl_assertion_dropdown[$each_line['assertion']].'</td>
                                                                  <td style="text-align: center;">'.$risk_lvl_dropdown[$each_line['risk_level']].'</td>
                                                                  <td style="text-align: left;">'.$each_line['response'].'</td>';

                                                    // }
                                                $content .= '</tr>';
                                            }
                                        }
                                    }
                                }
                            }
                        
                            $total_dividend_company_ye  += (double)$value['parent_array'][0]['total_c'];
                            // echo $total_dividend_company_ye;
                            $total_dividend_company_lye     += (double)$value['parent_array'][0]['total_c_lye'];
                        }
                    }
    
                 // END OF DIVIDEND 

                // RETAINED EARNINGS B/F 
                    $total_bf_company_ye    = 0.00;
                    $total_bf_company_lye   = 0.00;

                    foreach($bf_data[0] as $key => $value)
                    {
                        $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c'], $value['parent_array'][0]['total_c_lye']);
                        $temp_id = $value['parent_array'][0]['id'];

                        if($value['parent_array'][0]['total_c'] || $value['parent_array'][0]['total_c_lye'])
                        {

                            $content .= 
                            '<tr class="rows-for-'.$temp_id.'">'.
                                '<input type="hidden" name="PL_audit_categorized_account_id[]" class="PL_audit_categorized_account_id" value="'. $temp_id.'">'.
                                '<td>Retained earnings b/f</td>'; 
                            
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                // '<td align="right" class="taxation_company_ye">' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                '</td>' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                                '</td>';
                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                            }
                            else
                            {
                                $content .= 
                                // '<td align="right" class="taxation_company_ye">' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                '</td>';
                            }

                
                            $content .= '</tr>';
                        }

                                
                        $total_bf_company_ye    += (double)$value['parent_array'][0]['total_c'];
                        $total_bf_company_lye   += (double)$value['parent_array'][0]['total_c_lye'];
                    }
    
                 // END OF RETAINED EARNINGS B/F 


                // CALCULATE RETAINED EARNINGS C/F 
                    $retained_earning_cf = $profit_after_tax + $total_dividend_company_ye + $total_bf_company_ye;
                    $retained_earning_cf_ly = $profit_after_tax_ly + $total_dividend_company_lye + $total_bf_company_lye;

                    $variance_value = $this->calculate_variance($retained_earning_cf, $retained_earning_cf_ly);
                    $content .= 
                    '<tr>' .
                        '<td style="text-align:left;">Retained earnings c/f</td>' . 
                        '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($retained_earning_cf) . 
                        '</td>';
                        if(!empty($last_fye_end))
                        {
                            $content .= '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                                    // '<input type="hidden" name="profit_of_the_year_ly" value="'. $profit_of_the_year_ly .'">' .
                                    '<span class="profit_of_the_year_ly">' . $this->negative_bracket($retained_earning_cf_ly) . '</span>' .  
                                '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';   
                        }
                       
                    $content .= '</tr>';
                    
                // END OF CALCULATE RETAINED EARNINGS C/F 

        $content .= '</tbody>
                    </table>';

        // print_r($content);

        $obj_pdf->writeHTML($content, true, false, false, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C6_PL_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C6_PL_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);                
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/C6_PL_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));         

    }

    public function export_materiality_pdf($caf_id, $assignment_id)
    {
        $array_link = [];

        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "C3 - Materialtity";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 25, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();


        $nd_key = array_search("Materiality", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        // print_r($data);
        

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));

        

        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */


        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets" && $a_description != "Expenses"  && $a_description != "Cost of sales")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }
            }
        }


        $data = $this->calculate_equity($data);
        $benchmark_value = json_encode($this->retrieve_benchmark_value($data));
        $materiality_data = $this->caf_model->get_materiality_data($caf_id);

        // $this->data['eq_liabi_title_list'] = $eq_liabi_title_list;
        $fs_ntfs_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        // $this->data['auto_rearrange_value'] = $on_rearrange_notes;
        // $this->data["fs_ntfs_layout_template_list"] = $this->fs_notes_model->get_ntfs_layout_template_parents($fs_company_info_id);
        $show_data_content = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        $benchmark_dropdown = $this->caf_model->get_benchmark_dropdown_list();
         //end of retrieving data

        $initial_benchmark_value = isset($materiality_data['initial_benchmark_value'])?$materiality_data['initial_benchmark_value']:'';
        $final_benchmark_value = isset($materiality_data['final_benchmark_value'])?$materiality_data['final_benchmark_value']:'';
        $percent_used = isset($materiality_data['percent_used'])?$materiality_data['percent_used']:'';

        // print_r("bodo");

        $content = '';

        $content .= '<style type="text/css">

                    .table-borderless > tbody > tr > td,
                    .table-borderless > tbody > tr > th,
                    .table-borderless > tfoot > tr > td,
                    .table-borderless > tfoot > tr > th,
                    .table-borderless > thead > tr > td,
                    .table-borderless > thead > tr > th 
                    {
                        border: none;
                    }

                    .bordered 
                    {
                        border:1px solid black;
                    }

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                    }


                    </style>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 95%; color:black" border="0">
    
                    <tr>
                        <td colspan="4">
                            <h4 style="color:black;"><b>DETERMINING OVERALL MATERIALITY</b></h4>
                        </td>
                    </tr>

                    <tr>
                        <td class="bordered custom-header" width="37%">Benchmark</td>
                        <td class="bordered custom-header"width="19%">Initial value of benchmark</td>
                        <td class="bordered custom-header" width="19%">Final value of benchmark</td>
                        <td class="bordered custom-header" width="19%">% used</td>
                    </tr>
                    <tr>
                        <td class="bordered" width="37%">'.
                            $benchmark_dropdown[(isset($materiality_data['benchmark'])?$materiality_data['benchmark']:'')].
                        '</td>
                        <td class="bordered" id="initial_benchmark_val" width="19%" align="right">'.
                            $this->negative_bracket(isset($materiality_data['initial_benchmark_value'])?$materiality_data['initial_benchmark_value']:'').
                        '</td>
                  
                        <td class="bordered" width="19%" align="right">'.
                            $this->negative_bracket(isset($materiality_data['final_benchmark_value'])?$materiality_data['final_benchmark_value']:'').
                        '</td>
                        <td class="bordered" width="19%"  align="center">'.
                            (isset($materiality_data['percent_used'])?$materiality_data['percent_used']:'').
                       '</td>               
                    </tr>
                    <tr>
                        <td colspan="4">&nbsp;</td>
                    </tr>
                    <tr>
                        <td width="37%"></td>
                        <td class="bordered custom-header"width="19%">Prior period materiality</td>
                        <td class="bordered custom-header" width="19%">Initial assessment</td>
                        <td class="bordered custom-header" width="19%">Final assessment</td>
                    
                    </tr>
                    <tr>
                        <td width="37%">Selected overall materiality ($)</td>
                        <td class="bordered" width="19%"  align="right">'.
                            $this->negative_bracket(isset($materiality_data['prior_period_materiality'])?$materiality_data['prior_period_materiality']:'').
                        '</td>
                        <td class="bordered text-right initial_assessment" width="19%" align="right">'.
                            $this->calculate_assessment($initial_benchmark_value, $percent_used).
                        '</td>
                        <td class="bordered" width="19%" align="right">'.
                            $this->calculate_assessment($final_benchmark_value, $percent_used).
                        '</td>
                    </tr>
                    
                    <tr>
                        <td colspan="4">&nbsp;</td>
                    </tr>

                    <tr>
                        <td colspan="4">Document justification for selection of benchmark and selected manually percentage:</td>
                    </tr>
                    <tr>
                        <td class="bordered" colspan="4" style="height:40px;">'.
                                (isset($materiality_data['justification_text'])?$materiality_data['justification_text']:'').
                        '</td>
                
                    </tr>
                    <tr>

                        <td colspan="4">&nbsp;</td>
                
                    </tr>

                    <tr>
                        <td colspan="4">
                            <h4 style="color:black;"><b>DETERMINING CLEARLY TRIVAL THRESHOLD</b></h4>
                        </td>
                    </tr>

                    <tr>
                        <td colspan="3"></td>
                        <td class="bordered custom-header" width="19%">Amount</td>
                    
                    </tr>

                    <tr>
                        <td colspan="3">Clearly trival threshold percentage (%)</td>
                        <td class="bordered custom-header" width="19%">5%</td>
                    
                    </tr>

                    <tr>
                        <td colspan="3">Calculated clearly trival threshold ($)</td>
                        <td class="bordered" width="19%" align="right">'.$this->negative_bracket(isset($materiality_data['trival_threshold'])?$materiality_data['trival_threshold']:'').'</td>
                    
                    </tr>
                    <p>&nbsp;</p>
                    <tr>
                        <td colspan="4">Based on the anticipated results, I am satisfied that the above figure represents an appropriate initial overall materiality.</td>
                    </tr>
                    <p>&nbsp;</p>
                    <tr>
                        <td colspan="2">Partner: &nbsp;  _________________________________________</td>
                        <td colspan="2">Date:____________________________</td>
                    </tr>
                    <p>&nbsp;</p>
                    <tr>
                        <td colspan="2">Reviewer:  ________________________________________</td>
                        <td colspan="2">Date:____________________________</td>
                    </tr>
                    <p>&nbsp;</p>
                    <tr>
                        <td colspan="2">Preparer:  _________________________________________</td>
                        <td colspan="2">Date:____________________________</td>
                    </tr>
            
                </table>';


       

        $obj_pdf->writeHTML($content, true, false, false, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C3_Materiality_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C3_Materiality_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);   
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/C3_Materiality_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));

    }

    public function export_materiality_v2_pdf($caf_id, $assignment_id)
    {
        $array_link = [];

        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "C3 - Materialtity";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 30, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();


        $nd_key = array_search("Materiality", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        // print_r($data);
        

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));

        

        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */


        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets" && $a_description != "Expenses"  && $a_description != "Cost of sales")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }
            }
        }


        $data = $this->calculate_equity($data);
        $benchmark_value = json_encode($this->retrieve_benchmark_value($data));
        $materiality_data = $this->caf_model->get_materiality_v2_data($caf_id);

        // $this->data['eq_liabi_title_list'] = $eq_liabi_title_list;
        $fs_ntfs_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        // $this->data['auto_rearrange_value'] = $on_rearrange_notes;
        // $this->data["fs_ntfs_layout_template_list"] = $this->fs_notes_model->get_ntfs_layout_template_parents($fs_company_info_id);
        $show_data_content = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        $benchmark_dropdown = $this->caf_model->get_benchmark_dropdown_list();
         //end of retrieving data

        $initial_benchmark_value = isset($materiality_data['initial_benchmark_value'])?$materiality_data['initial_benchmark_value']:'';
        $final_benchmark_value = isset($materiality_data['final_benchmark_value'])?$materiality_data['final_benchmark_value']:'';
        $percent_used = isset($materiality_data['percent_used'])?$materiality_data['percent_used']:'';

        // print_r("bodo");

        $content = '';

        $content .= '<style type="text/css">

                    .table-borderless > tbody > tr > td,
                    .table-borderless > tbody > tr > th,
                    .table-borderless > tfoot > tr > td,
                    .table-borderless > tfoot > tr > th,
                    .table-borderless > thead > tr > td,
                    .table-borderless > thead > tr > th 
                    {
                        border: none;
                    }

                    .bordered 
                    {
                        border:1px solid black;
                    }

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                    }

                    .text-center
                    {
                        text-align:center;
                    }

                    .text-right
                    {
                        text-align:right;
                    }

                    .text-left
                    {
                        text-align:left;
                    }

                    .formula-table > tbody > tr > td
                    {
                        text-align: center;
                    }

                    .materiality-matrix-table > tbody > tr > td
                    {
                        border: 1px solid black;
                        text-align: center;
                    }

                    .border-top
                    {
                        border-top: 1px solid black;
                    }

                    .border-left
                    {
                        border-left: 1px solid black;
                    }

                    .border-right
                    {
                        border-right: 1px solid black;
                    }

                    .border-bottom
                    {
                        border-bottom: 1px solid black;
                    }

                    .border-all
                    {
                        border: 1px solid black;
                    }

                    .checkmark
                    {
                         text-align:center;
                         font-family:dejavusans;
                         font-size:11 px;
                    }


                    </style>';
            
            $content .= '<table style="border-collapse: collapse;color:black; width: 89.5%;" ><tbody>
    
                <tr>
                    <td colspan="6">
                        <b>A. Computation of Materiality</b>
                    </td>
                </tr>

                <tr>
                    <td width="3.5%"></td>
                    <td width="3.5%" valign="top">1</td>
                    <td width="93%" colspan="4">Understand the Audit Committee&#39;s, Directors and/or Management&#39;s Views on Materiality
                        <br/>
                    </td>
                </tr>
                <tr>
                    <td width="3.5%"></td>
                    <td width="3.5%" valign="top"></td>
                    <td width="93%" colspan="4" class="bordered">'.(isset($materiality_data['understand_on_materiality'])?$materiality_data['understand_on_materiality']:'').'
                        <br/>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td valign="top">2</td>
                    <td colspan="4">Identify the Materiality Benchmark
                        <br/>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td valign="top" width="5%">(i)</td>
                    <td colspan="2" width="68%">Select the most relevant materiality benchmark:
                        <br/>
                    </td>
                    <td class="text-center" width="20%" style="border-bottom: 1px solid black;">
                        Measurement Percentage
                    </td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td width="5%"></td>
                    <td width="63%">
                        <b>Income from continuing operations: </b>
                    </td>
                    <td width="20%"></td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==1?'&#10003;':'').'</td>
                    <td>
                        - Private company
                    </td>
                    <td class="text-center" >5% - 15%</td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==2?'&#10003;':'').'</td>
                    <td>
                        - Public company
                    </td>
                    <td class="text-center" >5% - 10%</td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td ></td>
                    <td>
                        <b>Normalised income from continuing operations: </b>
                    </td>
                    <td></td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==3?'&#10003;':'').'</td>
                    <td>
                        - Private company
                    </td>
                    <td class="text-center" >5% - 15%</td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==4?'&#10003;':'').'</td>
                    <td>
                        - Public company
                    </td>
                    <td class="text-center" >5% - 10%</td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td></td>
                    <td>
                        <b>Total revenue</b>
                    </td>
                    <td></td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==5?'&#10003;':'').'</td>
                    <td>
                        - Private company
                    </td>
                    <td class="text-center" >1% - 10%</td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==6?'&#10003;':'').'</td>
                    <td>
                        - Public company
                    </td>
                    <td class="text-center" >1% - 5%</td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==7?'&#10003;':'').'</td>
                    <td>
                        <b>Total assets</b>
                    </td>
                    <td class="text-center" >0.5% - 5%</td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==8?'&#10003;':'').'</td>
                    <td>
                        <b>Net assets or equity</b>
                    </td>
                    <td class="text-center" >1% - 10%</td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==9?'&#10003;':'').'</td>
                    <td>
                        <b>Total expenditure</b>
                    </td>
                    <td class="text-center" >1% - 10%</td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="border-all checkmark">'.(isset($materiality_data['benchmark'])&&$materiality_data['benchmark']==10?'&#10003;':'').'</td>
                    <td>
                        <b>Other (specify benchmark and percentage):</b>
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td valign="top">(ii)</td>
                    <td colspan="3">Indicate benchmark amount (monetary value)
                        <br/>
                    </td>
                </tr>

                <tr>
                    <td colspan="3"></td>
                    <td colspan="2">
                        <table width="100%;" >
                            <tbody>
                                <tr>
                                    <td rowspan="3" class="text-center border-all" width="35%" valign="middle">&nbsp;<br/>'.$this->negative_bracket(isset($materiality_data['initial_benchmark_value'])?$materiality_data['initial_benchmark_value']:'').'</td>
                                    <td class="text-center">&nbsp;</td>
                                </tr>
                                <tr>
                                    
                                    <td class="text-center" width="50%">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="text-center">&nbsp;</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td valign="top">(iii)</td>
                    <td colspan="3">
                        Indicate the source of the benchmark:
                        <br>
                    </td>
                    
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_source'])&&$materiality_data['benchmark_source']==1?'&#10003;':'').'</td>
                    <td colspan="2">
                        Prior year financial statements
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_source'])&&$materiality_data['benchmark_source']==2?'&#10003;':'').'</td>
                    <td colspan="2">
                        Current year projection (indicate date below)
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_source'])&&$materiality_data['benchmark_source']==3?'&#10003;':'').'</td>
                    <td colspan="2">
                        Computation (show below)
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_source'])&&$materiality_data['benchmark_source']==4?'&#10003;':'').'</td>
                    <td colspan="2">
                        Other (describe below)
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td valign="top"></td>
                    <td colspan="4" class="bordered">'.(isset($materiality_data['benchmark_source_description'])?$materiality_data['benchmark_source_description']:'').'
                        <br/>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td valign="top">(iv)</td>
                    <td colspan="3">
                        Indicate the reason for the benchmark selection (check one):
                        <br>
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==1?'&#10003;':'').'</td>
                    <td colspan="2">
                        For-profit company operating under normal circumstances
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==2?'&#10003;':'').'</td>
                    <td colspan="2">
                        Companies with volatile income
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==3?'&#10003;':'').'</td>
                    <td colspan="2">
                        Companies operating at breakeven level
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==4?'&#10003;':'').'</td>
                    <td colspan="2">
                        Companies reporting losses
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==5?'&#10003;':'').'</td>
                    <td colspan="2">
                        Buy-sell agreements
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==6?'&#10003;':'').'</td>
                    <td colspan="2">
                        Organisations that do not report earnings, e.g. not-for-profit ang governmant entities
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==7?'&#10003;':'').'</td>
                    <td colspan="2">
                        Cost-plus entities
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td class="text-center border-all checkmark">'.(isset($materiality_data['benchmark_reason'])&&$materiality_data['benchmark_reason']==8?'&#10003;':'').'</td>
                    <td colspan="2">
                        Other
                    </td>
                </tr>
                <tr>
                    <td><br pagebreak="true" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td valign="top">3</td>
                    <td colspan="4">
                        Determine the Measurement Percentage
                        <br>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td valign="top">(i)</td>
                    <td colspan="3">For the identified benchmark, select the most relevant materiality measurement percentage:
                        <br>
                    </td>
                </tr>
                <tr>
                    <td colspan="3"></td>
                    <td colspan="2"><table width="100%;" >
                            <tbody>
                                <tr>
                                    <td rowspan="3" class="text-center border-all" width="35%" valign="middle">&nbsp;<br/>'.(isset($materiality_data['materiality_measurement_percentage'])?$materiality_data['materiality_measurement_percentage']:'').'%</td>
                                    <td class="text-center">&nbsp;</td>
                                </tr>
                                <tr>
                                    
                                    <td class="text-center" width="50%">&nbsp;</td>
                                </tr>
                                <tr>
                                    <td class="text-center">&nbsp;</td>
                                </tr>
                            </tbody>
                        </table></td>
                    <td></td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td valign="top">(ii)</td>
                    <td colspan="3">Indicate the reason for percentage:
                        <br>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4" class="bordered">'.(isset($materiality_data['reason_for_percentage'])?$materiality_data['reason_for_percentage']:'').'<br/></td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td valign="top">4</td>
                    <td colspan="4">
                        Calculate Materiality
                        <br>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4">
                        <table class="formula-table" width="100%;">
                            <tr>
                                <td width="25%;" class="text-center">Benchmark Amount <i>(from Step 2ii)</i></td>
                                <td width="5%;"></td>
                                <td width="20%;" class="text-center">Measurement Percentage<br/><i>(from Step 3i)</i><br/></td>
                                <td width="5%;"></td>
                                <td width="25%;" class="text-center">Materiality<br/>Amount</td>
                                <td width="2.5%;"></td>
                                <td width="17.5%;" class="text-center">Rounding</td>
                            </tr>
                            <tr style="line-height: 32px">
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-left" width="10%;">$</td>
                                            <td class="text-right" width="90%;">'.$this->negative_bracket(isset($materiality_data['initial_benchmark_value'])?$materiality_data['initial_benchmark_value']:'').'</td>
                                        </tr>
                                    </table>
                                </td>
                                <td class="text-center">x</td>
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-center" width="100%;">'.(isset($materiality_data['materiality_measurement_percentage'])?$materiality_data['materiality_measurement_percentage']:'').'%</td>
                                        </tr>
                                    </table>
                                </td>
                                <td class="text-center">=</td>
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-left" width="10%;">$</td>
                                            <td class="text-right" width="90%;">'.$this->negative_bracket(isset($materiality_data['initial_benchmark_value'])&&isset($materiality_data['materiality_measurement_percentage'])?$materiality_data['initial_benchmark_value']*($materiality_data['materiality_measurement_percentage'])/100:'').'</td>
                                        </tr>
                                    </table>
                                </td>
                                <td>&nbsp;</td>
                                
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-right" width="100%;">'.$this->negative_bracket($this->roundUpToNearestMultiple(isset($materiality_data['initial_benchmark_value'])&&isset($materiality_data['materiality_measurement_percentage'])?$materiality_data['initial_benchmark_value']*($materiality_data['materiality_measurement_percentage'])/100:'')).'</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>';

                $materiality_str = $this->negative_bracket($this->roundUpToNearestMultiple(isset($materiality_data['initial_benchmark_value'])&&isset($materiality_data['materiality_measurement_percentage'])?$materiality_data['initial_benchmark_value']*($materiality_data['materiality_measurement_percentage'])/100:''));
                if($materiality_data['editable_materiality'])
                {
                    $materiality_str = $this->negative_bracket($this->roundUpToNearestMultiple(isset($materiality_data['editable_materiality'])?$materiality_data['editable_materiality']:''));
                }

                $materiality_number = $this->roundUpToNearestMultiple(isset($materiality_data['initial_benchmark_value'])&&isset($materiality_data['materiality_measurement_percentage'])?$materiality_data['initial_benchmark_value']*($materiality_data['materiality_measurement_percentage'])/100:'');
                if($materiality_data['editable_materiality'])
                {
                    $materiality_number = $this->roundUpToNearestMultiple(isset($materiality_data['editable_materiality'])?$materiality_data['editable_materiality']:'');

                }

        $content .= '<tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td colspan="6">
                        <b>B. Computation of Performance Materiality</b>
                        <br/>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td colspan="5">
                        <table width="100%;">
                            <tbody>
                                <tr>
                                    <td width="5%;">1</td>
                                    <td width="30%;">Determine the Materiality</td>
                                    <td width="15%;">&nbsp;</td>
                                    <td width="5%;">2</td>
                                    <td width="45%;">Engagement risk category</td>

                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td class="border-all text-center" rowspan="3">&nbsp;<br/>'.$materiality_str.'</td>
                                    <td>&nbsp;</td>
                                    <td class="border-all checkmark">'.(isset($materiality_data['engagement_risk'])&&$materiality_data['engagement_risk']==1?'&#10003;':'').'</td>
                                    <td>&nbsp;Low Risk</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td class="border-all checkmark">'.(isset($materiality_data['engagement_risk'])&&$materiality_data['engagement_risk']==2?'&#10003;':'').'</td>
                                    <td>&nbsp;Medium Risk</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td class="border-all checkmark">'.(isset($materiality_data['engagement_risk'])&&$materiality_data['engagement_risk']==3?'&#10003;':'').'</td>
                                    <td>&nbsp;High Risk</td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                    <td>&nbsp;</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4">Include support for Step 2
                        <br>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4" class="bordered">'.(isset($materiality_data['support_for_risk'])?$materiality_data['support_for_risk']:'').'
                        <br/>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <br pagebreak="true" />
                <tr>
                    <td></td>
                    <td valign="top">3</td>
                    <td colspan="4">
                        Determine the Performance Materiality Percentage
                        <br>
                    </td>
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4">
                        <table class="materiality-matrix-table" width="60%;">
                            <tr>
                                <td colspan="2" class="text-center"><b>Performance Materiality Matrix</b></td>
                            </tr>
                            <tr>
                                <td colspan="2" class="text-center">&nbsp;</td>
                            </tr>
                            <tbody>
                                <tr>
                                    <td class="text-center bordered">Engagement Risk <br/> Category <br/> (from Step 2)</td>
                                    <td class="text-center bordered">Performance Materiality <br/> as a % of Materiality</td>
                                </tr>
                                <tr>
                                    <td class="text-center bordered">
                                        <table width="100%;" >
                                            <tbody>
                                                <tr>
                                                    <td class="text-center" colspan="3">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-center border-all checkmark" width="20%">'.(isset($materiality_data['engagement_risk'])&&$materiality_data['engagement_risk']==1?'&#10003;':'').'</td>
                                                    <td class="text-center" width="10%">&nbsp;</td>
                                                    <td width="70%">Low</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-center" colspan="3">&nbsp;</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                    <td class="text-center bordered">&nbsp;<br/> 85% </td>
                                </tr>
                                <tr>
                                    <td class="text-center bordered">
                                        <table width="100%;" >
                                            <tbody>
                                                <tr>
                                                    <td class="text-center" colspan="3">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-center border-all checkmark" width="20%">'.(isset($materiality_data['engagement_risk'])&&$materiality_data['engagement_risk']==2?'&#10003;':'').'</td>
                                                    <td class="text-center" width="10%">&nbsp;</td>
                                                    <td width="70%">Medium</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-center" colspan="3">&nbsp;</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                    <td class="text-center bordered">&nbsp;<br/>80% </td>
                                </tr>
                                <tr>
                                    <td class="text-center bordered">
                                        <table width="100%;" >
                                            <tbody>
                                                <tr>
                                                    <td class="text-center" colspan="3">&nbsp;</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-center border-all checkmark" width="20%">'.(isset($materiality_data['engagement_risk'])&&$materiality_data['engagement_risk']==3?'&#10003;':'').'</td>
                                                    <td class="text-center" width="10%">&nbsp;</td>
                                                    <td width="70%">High</td>
                                                </tr>
                                                <tr>
                                                    <td class="text-center" colspan="3">&nbsp;</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                    <td class="text-center bordered">&nbsp;<br/>70%</td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td valign="top">4</td>
                    <td colspan="4">
                        Calculate Performance Materiality
                        <br>
                    </td>
                </tr>';

        if(isset($materiality_data['engagement_risk']))
        {
            switch ($materiality_data['engagement_risk']) {
                case '1':
                    $materiality_measurement_percentage = 85;
                    break;
                case '2':
                    $materiality_measurement_percentage = 80;
                    break;
                case '3':
                    $materiality_measurement_percentage = 70;
                    break;
                default:
                    $materiality_measurement_percentage = "";
                    break;
            }
            
        }
        else
        {
            $materiality_measurement_percentage = "";
        }


        $content .= '<tr>
                    <td></td>
                    <td></td>
                    <td colspan="4">
                        <table class="formula-table" width="100%;">
                            <tbody>
                                <tr>
                                    <td width="29%;" class="text-center">Performance Materiality %<br/> <i>(from Step 3)</i></td>
                                    <td width="4%;"></td>
                                    <td width="20%;" class="text-center">Materiality <br/> <i>(from Step 1)</i><br/></td>
                                    <td width="4%;"></td>
                                    <td width="25%;" class="text-center">Performance Materiality</td>
                                    <td width="2.5%;" ></td>
                                    <td width="15.5%;" class="text-center">Rounding</td>
                                </tr>
                                <tr style="line-height: 32px">
                                    <td class="bordered">
                                        <table cellpadding="2">
                                            <tr>
                                                <td class="text-center" width="100%;">'.$materiality_measurement_percentage.'%</td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td class="text-center">x</td>
                                    <td class="bordered">
                                        <table cellpadding="2">
                                            <tr>
                                                <td class="text-right" width="100%;">'.$materiality_str.'</td>
                                            </tr>
                                        </table></td>
                                    <td class="text-center">=</td>
                                    <td class="bordered">
                                        <table cellpadding="2">
                                            <tr>
                                                <td class="text-left" width="10%;">$</td>
                                                <td class="text-right" width="90%;">'.$this->negative_bracket(isset($materiality_number)&&isset($materiality_measurement_percentage)?$materiality_number*($materiality_measurement_percentage)/100:'').'</td>
                                            </tr>
                                        </table>
                                    </td>
                                    <td>&nbsp;</td>
                                    <td class="bordered">
                                        <table cellpadding="2">
                                            <tr>
                                                <td class="text-right" width="100%;">'.$this->negative_bracket($this->roundUpToNearestMultiple(isset($materiality_number)&&isset($materiality_measurement_percentage)?$materiality_number*($materiality_measurement_percentage)/100:'')).'</td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td colspan="6">
                        <b>C. Determination of CTT scope</b>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4">Clearly Trivial Treshold (CTT)
                        <br>
                    </td>
                </tr>
                <tr>
                    <td colspan="2"></td>
                    <td width="15%;">Basis: </td>
                    <td colspan="2" style="border-bottom: 1px solid black;">
                        '.(isset($materiality_data['ctt_basis_percentage'])?$materiality_data['ctt_basis_percentage']:'').'% of Materiality
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>
                <tr>
                    <td></td>
                    <td></td>
                    <td colspan="4" width="93%;">
                        <table class="formula-table" width="100%;">
                            <tr>
                                <td width="25%;" class="text-center">Applicable %</td>
                                <td width="5%;"></td>
                                <td width="20%;" class="text-center">Applicable Basis</td>
                                <td width="5%;"></td>
                                <td width="25%;" class="text-center">CTT<br/>Scope<br/></td>
                                <td width="2.5%;"></td>
                                <td width="17.5%;" class="text-center">Rounding</td>
                            </tr>
                            <tr style="line-height: 32px">
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-center" width="100%;">'.(isset($materiality_data['ctt_basis_percentage'])?$materiality_data['ctt_basis_percentage']:'').'%</td>
                                        </tr>
                                    </table>
                                </td>
                                <td class="text-center">x</td>
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-left" width="15%;">$</td>
                                            <td class="text-right" width="85%;">'.$materiality_str.'</td>
                                        </tr>
                                    </table>
                                </td>
                                <td class="text-center">=</td>
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-left" width="10%;">$</td>
                                            <td class="text-right" width="90%;">'.$this->negative_bracket(isset($materiality_number)&&isset($materiality_data['ctt_basis_percentage'])?$materiality_number*($materiality_data['ctt_basis_percentage'])/100:'').'</td>
                                        </tr>
                                    </table>
                                </td>
                                <td>&nbsp;</td>
                                <td class="bordered">
                                    <table cellpadding="2">
                                        <tr>
                                            <td class="text-right" width="100%;">'.$this->negative_bracket($this->roundUpToNearestMultiple(isset($materiality_number)&&isset($materiality_data['ctt_basis_percentage'])?$materiality_number*($materiality_data['ctt_basis_percentage'])/100:'')).'</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
                <tr>
                    <td colspan="6">&nbsp;</td>                 
                </tr>';

            if($materiality_data['benchmark']==5 || $materiality_data['benchmark']==6)
            {

                $revenue_scale = '<style type="text/css">

                        .bordered 
                        {
                            border:1px solid black;
                        }

                        .border-top
                        {
                            border-top: 1px solid black;
                        }

                        .border-left
                        {
                            border-left: 1px solid black;
                        }

                        .border-right
                        {
                            border-right: 1px solid black;
                        }

                        .border-bottom
                        {
                            border-bottom: 1px solid black;
                        }

                        .border-all
                        {
                            border: 1px solid black;
                        }

                        .text-center
                        {
                            text-align:center;
                        }

                        .text-right
                        {
                            text-align:right;
                        }

                        .text-left
                        {
                            text-align:left;
                        }


                        </style>
                    <table style="border-collapse: collapse;color:black; width: 89.5%;" ><tbody>
                    <tr>
                        <td style="width: 1.2%;" ></td>   
                        <td class="text-center" style="border: 1px solid black; width: 98.4%;" ><b>Revenue Sliding Scale - Materiality Factor</b></td>              
                    </tr>
                    <tr>
                        <td width="100%">&nbsp;</td>   
                                         
                    </tr>
                    <tr>
                        <td class="text-center" colspan="2" width="60%">
                            <table width="100%;" style="margin:0;margin-right: 20px;border-collapse: collapse;">
                                <tbody>
                                    <tr>
                                        <th>&nbsp;</th>
                                        <th colspan="4" class="text-center border-all"><b>Privately-Held Entities</b></th>
                                        
                                    </tr>
                                    <tr class="bordered">
                                        <th class="text-center border-top border-left border-right" ><b>Revenue</b></th>
                                        <th colspan="2" class="text-center"><b>Factor to apply</b></th>
                                        <th colspan="2" class="text-center border-right"><b>Percentage to apply</b></th>
                                
                                    </tr>
                                    <tr class="border-all">
                                        <th class="text-center border-bottom border-left border-right"><b>Up to:</b></th>
                                        <th class="border-bottom text-center"><b>Between</b></th>
                                        <th class="border-bottom text-center"><b>And</b></th>
                                        <th class="border-bottom text-center"><b>Between</b></th>
                                        <th class="border-right border-bottom"><b>And</b></th>
                                    </tr>
                                    <tr>
                                        <td class="bordered text-right">500,000</td>
                                        <td class="border-bottom text-right">0.096</td>
                                        <td class="border-bottom text-right">0.100</td>
                                        <td class="border-bottom text-right">9.6%</td>
                                        <td class="border-bottom border-right text-right">10.0%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">600,000</td>
                                        <td class="border-bottom text-right">0.092</td>
                                        <td class="border-bottom text-right">0.096</td>
                                        <td class="border-bottom text-right">9.2%</td>
                                        <td class="border-bottom border-right text-right">9.6%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">700,000</td>
                                        <td class="border-bottom text-right">0.088</td>
                                        <td class="border-bottom text-right">0.092</td>
                                        <td class="border-bottom text-right">8.8%</td>
                                        <td class="border-bottom border-right text-right">9.2%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">800,000</td>
                                        <td class="border-bottom text-right">0.084</td>
                                        <td class="border-bottom text-right">0.088</td>
                                        <td class="border-bottom text-right">8.4%</td>
                                        <td class="border-bottom border-right text-right">8.8%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">900,000</td>
                                        <td class="border-bottom text-right">0.080</td>
                                        <td class="border-bottom text-right">0.084</td>
                                        <td class="border-bottom text-right">8.0%</td>
                                        <td class="border-bottom border-right text-right">8.4%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">1,000,000</td>
                                        <td class="border-bottom text-right">0.077</td>
                                        <td class="border-bottom text-right">0.080</td>
                                        <td class="border-bottom text-right">7.7%</td>
                                        <td class="border-bottom border-right text-right">8.0%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">2,000,000</td>
                                        <td class="border-bottom text-right">0.074</td>
                                        <td class="border-bottom text-right">0.077</td>
                                        <td class="border-bottom text-right">7.4%</td>
                                        <td class="border-bottom border-right text-right">7.7%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">6,000,000</td>
                                        <td class="border-bottom text-right">0.071</td>
                                        <td class="border-bottom text-right">0.074</td>
                                        <td class="border-bottom text-right">7.1%</td>
                                        <td class="border-bottom border-right text-right">7.4%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">10,000,000</td>
                                        <td class="border-bottom text-right">0.069</td>
                                        <td class="border-bottom text-right">0.071</td>
                                        <td class="border-bottom text-right">6.9%</td>
                                        <td class="border-bottom border-right text-right">7.1%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom bordered text-right">15,000,000</td>
                                        <td class="border-bottom text-right">0.067</td>
                                        <td class="border-bottom text-right">0.069</td>
                                        <td class="border-bottom text-right">6.7%</td>
                                        <td class="border-bottom border-right text-right">6.9%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">30,000,000</td>
                                        <td class="border-bottom text-right">0.065</td>
                                        <td class="border-bottom text-right">0.067</td>
                                        <td class="border-bottom text-right">6.5%</td>
                                        <td class="border-bottom border-right text-right">6.7%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">50,000,000</td>
                                        <td class="border-bottom text-right">0.063</td>
                                        <td class="border-bottom text-right">0.065</td>
                                        <td class="border-bottom text-right">6.3%</td>
                                        <td class="border-bottom border-right text-right">6.5%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">100,000,000</td>
                                        <td class="border-bottom text-right">0.062</td>
                                        <td class="border-bottom text-right">0.063</td>
                                        <td class="border-bottom text-right">6.2%</td>
                                        <td class="border-bottom border-right text-right">6.3%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">300,000,000</td>
                                        <td class="border-bottom text-right">0.061</td>
                                        <td class="border-bottom text-right">0.062</td>
                                        <td class="border-bottom text-right">6.1%</td>
                                        <td class="border-bottom border-right text-right">6.2%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="bordered text-right">1,000,000,000</td>
                                        <td class="border-bottom text-right">0.060</td>
                                        <td class="border-bottom text-right">0.061</td>
                                        <td class="border-bottom text-right">6.0%</td>
                                        <td class="border-bottom border-right text-right">6.1%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>                   
                        <td class="text-center" width="40%">
                            <table width="100%;" style="margin-left: 20px;border-collapse: collapse;">
                                <tbody>
                                    <tr>
                                        <th colspan="4" class="text-center border-all"><b>Privately-Held Entities & Public-Interest Entities</b></th>
                                    </tr>
                                    <tr>
                                        <th colspan="2" class="text-center border-left"><b>Factor to apply</b></th>
                                        <th colspan="2" class="text-center border-right"><b>Percentage to apply</b></th>
                                
                                    </tr>
                                    <tr>
                                        <th class="border-bottom border-left text-center"><b>Between</b></th>
                                        <th class="border-bottom text-center"><b>And</b></th>
                                        <th class="border-bottom text-center"><b>Between</b></th>
                                        <th class="border-bottom text-center border-right"><b>And</b></th>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.046</td>
                                        <td class="border-bottom text-right">0.050</td>
                                        <td class="border-bottom text-right">4.6%</td>
                                        <td class="border-bottom border-right text-right">5.0%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.042</td>
                                        <td class="border-bottom text-right">0.046</td>
                                        <td class="border-bottom text-right">4.2%</td>
                                        <td class="border-bottom border-right text-right">4.6%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.038</td>
                                        <td class="border-bottom text-right">0.042</td>
                                        <td class="border-bottom text-right">3.8%</td>
                                        <td class="border-bottom border-right text-right">4.2%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.034</td>
                                        <td class="border-bottom text-right">0.038</td>
                                        <td class="border-bottom text-right">3.4%</td>
                                        <td class="border-bottom border-right text-right">3.8%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.030</td>
                                        <td class="border-bottom text-right">0.034</td>
                                        <td class="border-bottom text-right">3.0%</td>
                                        <td class="border-bottom border-right text-right">3.4%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.027</td>
                                        <td class="border-bottom text-right">0.030</td>
                                        <td class="border-bottom text-right">2.7%</td>
                                        <td class="border-bottom border-right text-right">3.0%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.024</td>
                                        <td class="border-bottom text-right">0.027</td>
                                        <td class="border-bottom text-right">2.4%</td>
                                        <td class="border-bottom border-right text-right">2.7%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.021</td>
                                        <td class="border-bottom text-right">0.024</td>
                                        <td class="border-bottom text-right">2.1%</td>
                                        <td class="border-bottom border-right text-right">2.4%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.019</td>
                                        <td class="border-bottom text-right">0.021</td>
                                        <td class="border-bottom text-right">1.9%</td>
                                        <td class="border-bottom border-right text-right">2.1%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.017</td>
                                        <td class="border-bottom text-right">0.019</td>
                                        <td class="border-bottom text-right">1.7%</td>
                                        <td class="border-bottom border-right text-right">1.9%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.015</td>
                                        <td class="border-bottom text-right">0.017</td>
                                        <td class="border-bottom text-right">1.5%</td>
                                        <td class="border-bottom border-right text-right">1.7%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.013</td>
                                        <td class="border-bottom text-right">0.015</td>
                                        <td class="border-bottom text-right">1.3%</td>
                                        <td class="border-bottom border-right text-right">1.5%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.012</td>
                                        <td class="border-bottom text-right">0.013</td>
                                        <td class="border-bottom text-right">1.2%</td>
                                        <td class="border-bottom border-right text-right">1.3%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.011</td>
                                        <td class="border-bottom text-right">0.012</td>
                                        <td class="border-bottom text-right">1.1%</td>
                                        <td class="border-bottom border-right text-right">1.2%</td>
                                    </tr>
                                    <tr class="border-all">
                                        <td class="border-bottom border-left text-right">0.010</td>
                                        <td class="border-bottom text-right">0.011</td>
                                        <td class="border-bottom text-right">1.0%</td>
                                        <td class="border-bottom border-right text-right">1.1%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </td>                   
                    </tr>
                    </tbody></table>';
                }


        $content .= '</tbody></table>';


        $obj_pdf->writeHTML($content, true, false, false, false, '');

        // print_r($materiality_data['benchmark_reason']);

        if($materiality_data['benchmark']==5 || $materiality_data['benchmark']==6)
        {
            $obj_pdf->AddPage('L');

            $obj_pdf->writeHTML($revenue_scale, true, false, false, false, '');
        }



        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C3_Materiality_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C3_Materiality_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);
 
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/C3_Materiality_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));

    }

    public function export_adjustment_pdf($caf_id, $assignment_id)
    {
        
        $form_data = $this->input->post();

        // retrieving data
        $fs_company_info_id    = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

        $types_dropdown = $this->caf_model->get_types_dropdown_list();

        $adjustment_type = $form_data['type'];
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $caf_detail->name = preg_replace("/\([^)]+\)/","", $types_dropdown[$adjustment_type]);

        $array_link = [];

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "A3 - Journal Entries";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        // $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 10);
        $obj_pdf->SetAutoPageBreak(TRUE, 58);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        
     


        // $this->data['adjustment_data'] = $this->caf_model->get_adjustment_data($caf_id);
        // $this->data['show_data_content'] = $this->fs_model->is_saved_fs_categorized_account($assignment_id);
        $adjustment_data = $this->caf_model->get_adjustment_data($caf_id);
   
        // print_r($adjustment_data);
        $content  = "";

        $content  .= "<style>
                        .bordered 
                        {
                            border-bottom:1px solid black;
                        }

                        .custom-header
                        {
                            background-color: #446687;
                            color: white;
                            text-align: center;
                        }



                    </style>";

        $content .= '<table class="table table-borderless adjustment_display" style="border-collapse: collapse; margin: 2%; width: 100%; color:black">
                
                        <tr >
                            <td class="bordered custom-header" width="6%"></td>
                            <td class="bordered custom-header" width="43%" style="valign: middle">Description</td>
                            <td class="bordered custom-header" width="15%">DR<br>$</td>
                            <td class="bordered custom-header" width="15%">CR<br>$</td>
                            <td class="bordered custom-header" width="15%" style="valign: middle">Reference</td>
                        </tr>
                        <tr>
                            <td width="6%"></td>
                            <td width="88%" colspan="4"></td>
                        </tr>';

        // $content .=  '<tbody id="adjustment_display_body">';

            // print_r($adjustment_data);
            for ($i = 0; $i < count($adjustment_data); $i++) {

                  if($adjustment_data[$i]['type'] == $adjustment_type)
                  {
                      $content .= '<tr nobr="true"><td colspan="10" width="100%"><table class="table table-borderless adjustment_display" style="border-collapse: collapse; margin: 2%; width: 100%; color:black">';

                      for ($j = 0; $j <  count($adjustment_data[$i]['adjustment_info']); $j++) {
                          // console.log(adjustment_data[i]['adjustment_info'][j]);
                          $adjustment_info = $adjustment_data[$i]['adjustment_info'][$j];
                          if($j == 0)
                          {
                            $je_no = $adjustment_data[$i]['je_no'];
                          }
                          else
                          {
                            $je_no = "";
                          }

                          if($adjustment_info['adjust_value'] >= 0)
                          {
                              $content  .=   '<tr class="no_bottom">
                                                <td width="6%">'.$je_no.'</td>
                                                <td width="43%" colspan="2">'.$adjustment_info['description'].'</td>
                                                <td width="15%" align="right">'.number_format($adjustment_info['adjust_value'],2).'</td>
                                                <td width="15%" align="right"></td>
                                                <td width="15%" align="center">'.$adjustment_info['reference'].'</td>
                                              </tr>';
                          }
                          else if($adjustment_info['adjust_value'] < 0)
                          {
                              $content  .=   '<tr class="no_bottom">
                                                <td width="6%">'.$je_no.'</td>
                                                <td width="5%">&nbsp;</td>
                                                <td width="38%">'.$adjustment_info['description'].'</td>
                                                <td width="15%" align="right"></td>
                                                <td width="15%" align="right">'.number_format(abs($adjustment_info['adjust_value']),2).'</td>
                                                <td width="15%" align="center">'.$adjustment_info['reference'].'</td>
                                              </tr>';
                          }
                          
                      }
                      
                      $content  .=   '<tr>
                                        <td class="bordered" width="6%"></td>
                                        <td class="bordered" width="88%" colspan="4">('.$adjustment_data[$i]['narration'].')<br/></td>
                                      </tr>';

                        $content  .=   '<tr>
                                            <td width="6%"></td>
                                            <td width="88%" colspan="4"></td>
                                      </tr>';

                        $content .= '</table></td></tr>';


                  }
                  
              }
        // $signature_content ='<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>
        //                         <tr><td colspan="3"><p><span style="font-family: "Calibri"; font-size: 11pt;">Approved by director:</span></p></td></tr>
        //                         <p>&nbsp;</p>
        //                         <tr><td></td></tr>
        //                         <tr><td colspan="3"></td></tr>
        //                         <tr><td colspan="2" style="border-bottom:1px solid black;"></td></tr>
        //                         <tr><td colspan="2"><br/>Name: </td></tr>';
        
        // $content .= $signature_content;                         
        $content .=       '</table>';

        

        // print_r($content);s
 
       

        $obj_pdf->writeHTML($content, true, false, false, false, '');
        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/A3_Adjustment_'.str_replace('.', '', $caf_id.'_'.preg_replace('/[^A-Za-z0-9\-]/', '', $client->client_name)).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/A3_Adjustment_'.str_replace('.', '', $caf_id.'_'.preg_replace('/[^A-Za-z0-9\-]/', '', $client->client_name)).'.pdf',0644);
        
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/A3_Adjustment_'.str_replace('.', '', $caf_id.'_'.preg_replace('/[^A-Za-z0-9\-]/', '', $client->client_name)).'.pdf');

        echo json_encode(array("link" => $array_link));

        // define some HTML content with style
    }

    public function export_farbs_pdf($caf_id, $assignment_id)
    {
        $array_link = [];

        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

        // create new PDF document
        $obj_pdf= new NO_MARGIN_PDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "A5 - Final Balance Sheet";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(10, 33, 10);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 9);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('L');

        
        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

        $show_third_col  = false;
        $current_fye_end = $current_last_year_end['current_fye_end'];
        $last_fye_end    = $current_last_year_end['last_fye_end'];

        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 40,
                            'value'        => 15,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 20,
                            'value'        => 12.8,
                            'variance'        => 8

                        );

        }
        /* END OF Setting for column width */

        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $how_third_col   = true;

                $current_fye_end  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $last_fye_end     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $last_fye_beg     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }

        $nd_key = array_search("Balance sheet", array_column($fs_ntfs_list['statements'], 'document_name'));
        $nd_ref_id = '';
        $description_reference_id_list = [];

        if($nd_key || (string)$nd_key == '0')
        {
            $nd_account_code = $fs_ntfs_list['statements'][$nd_key]['reference_id']; // get account code

            $description_reference_id_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];
        }

        $fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $nd_account_code);
        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_id);

        // print_r($data);

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

       $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            // $total_for_revenue_reserve['total_c']       += $rr_value['parent_array'][0]['total_c'];
            // $total_for_revenue_reserve['total_c_lye']   += $rr_value['parent_array'][0]['total_c_lye'];
            // $total_for_revenue_reserve['total_g']       += $rr_value['parent_array'][0]['total_g'];
            // $total_for_revenue_reserve['total_g_lye']   += $rr_value['parent_array'][0]['total_g_lye'];

            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
        }

        // print_r($data);

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */

        /* ------------------------ Set "Equity and liabilities" title ------------------------ */
        $e_l_title      = '';
        $eq_liabi_title_list = [];

        foreach ($data as $key => $value) 
        {
            // print_r($value);
            $a_description = '';
            $a_key = array_search($value['parent_array'][0]['account_code'], array_column($description_reference_id_list, "account_code"));

            if($a_key || (string)$a_key == '0')
            {
                $a_description = $description_reference_id_list[$a_key]['description'];
            }

            if($a_description != "Assets")
            {
                $hide_title = true;

                $data[$key] = $this->fs_model->change_sign_in_account(array($value))[0];   // Change sign (+/-)

                foreach($value['child_array'] as $child_key => $child_value)
                {
                    if(!empty($child_value['parent_array']))
                    {
                        $hide_title = false;
                    }
                }

                if(!empty($value['child_array']) && !$hide_title) 
                {
                    if(empty($e_l_title))
                    {
                        $e_l_title = $value['parent_array'][0]['description'];
                    }
                    else
                    {
                        $e_l_title .= ' and ' . $value['parent_array'][0]['description'];
                    }

                    array_push($eq_liabi_title_list, $a_description);    // for checking later
                }
            }
        }

        if(count($eq_liabi_title_list) == 1)  
        {
            if($eq_liabi_title_list[0] == "Equity")
            {
                $e_l_title = '';    // remove title if got equity only
            }
        }


        $fs_ntfs_list = $fs_ntfs_list['statements'][$nd_key]['description_reference_id'];

        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $adjustment_data = $this->build_adjustment_data_arr($temp_adjustment_data);


         //end of retrieving data

        $content = '';
        
        $content .= '<table cellpadding="1" style="width: 100%; color:black;" >
                     <thead>
                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;">&nbsp;</th>
                            <th style="width:'.$col_width['value'].'%;text-align: center;">';
                        
                                if($show_third_col)
                                {
                                    $content .= '<br/>';
                                } 
                                $content .= $current_fye_end ."<br/>". "Unadjusted"; 
                         
        $content .=         '</th>';
        $content .=         '<th style="width:'.($col_width['value']*2).'%;text-align: center;" colspan="2">';
                        
                                if($show_third_col)
                                {
                                    $content .= '</br>';
                                } 
                                $content .= "&nbsp;<br/>". "Adjustment"; 
                         
        $content .=         '</th>
                             <th style="width:'.$col_width['value'].'%;text-align: center;">';
                        
                                if($show_third_col)
                                {
                                    $content .= '<br/>';
                                } 
                                $content .= $current_fye_end ."<br/>". "Final

                            </th>"; 

                        
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<th style="width:'.$col_width['value'].'%;text-align: center;">';
                                    if($show_third_col)
                                    {
                                        $content .= 'Restated</br>';
                                    }
                                    $content .= $last_fye_end."<br/>". "Final"; 
                                $content .= '</th>';

                                if($show_third_col)
                                {
                                    $content .= '<th style="width: ' . $col_width['value'] . '%; text-align: center;">Restated</br>' . $last_fye_beg . '</th>';
                                }

                                $content .= '<th style="colspan=2 width:'.($col_width['variance']*2).'%;text-align: center;"><br/>Variance</th>';
                            }
                        
        $content .=     '</tr>

                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;"></th>
                            <th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">&nbsp;<br/>$</th>
                            <th style="width:'.$col_width['value'].'%; text-align: center; border-top: 1px solid #000;">DR<br/>$</th>
                            <th style="width:'.$col_width['value'].'%; text-align: center; border-top: 1px solid #000;">CR<br/>$</th>
                            <th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">&nbsp;<br/>$</th>';

                        
                            if(!empty($last_fye_end))
                            {
                                $content .= '<th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">&nbsp;<br/>$</th>';

                                if($show_third_col)
                                {
                                    $content .= '<th style="text-align: center; border-top: 1px solid #000;">&nbsp;<br/>$</th>';
                                }

                                $content .= '<th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">&nbsp;<br/>$</th>
                                            <th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">&nbsp;<br/>%</th>';
                            }
                        
        $content .=     '</tr>
                    </thead>
                    <tbody>';

                        $index = 0;
                        $note_no = 0;


                        $total_assets_c          = 0.00;
                        $total_assets_c_adjusted = 0.00;
                        $total_assets_c_end      = 0.00;
                        $total_assets_c_beg      = 0.00;

                        $total_equity_c          = 0.00;
                        $total_equity_c_adjusted = 0.00;
                        $total_equity_c_end      = 0.00;
                        $total_equity_c_beg      = 0.00;

                        $total_liabilities_c          = 0.00;
                        $total_liabilities_c_adjusted = 0.00;
                        $total_liabilities_c_end      = 0.00;
                        $total_liabilities_c_beg      = 0.00;


                        $displayed_eq_liabi_title = false;

                        foreach ($data as $level_1_key => $level_1) 
                        {
                            $hide_main_title = false;
                            $level_1_description = "";

                            $fs_ntfs_list_key = array_search($level_1['parent_array'][0]['account_code'], array_column($fs_ntfs_list, "account_code")); // get key

                            if(!empty($fs_ntfs_list_key) || (string)$fs_ntfs_list_key == 0)
                            {
                                $level_1_description = $fs_ntfs_list[$fs_ntfs_list_key]['description']; // get description from fs_ntfs_list json from document name "Statement of financial position"
                            }

                            /* ---------------------------- Display main category (Level 1). eg. Assets, Equity and Liabilities ---------------------------- */
                            if(count($level_1['child_array']) == 1)
                            {
                                foreach ($level_1['child_array'] as $key => $value) 
                                {
                                    if(empty($value['parent_array']))
                                    {
                                        $hide_main_title = true;
                                    }
                                }
                            }

                            if($level_1_description == "Assets" && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                $content .=
                                '<tr>'.
                                    '<td style="width:'.$col_width['account_desc'].'%;"><strong>' . ucfirst(strtolower($level_1['parent_array'][0]['description'])) . '</strong></td>' .
                                    '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                '</tr>';

                                // print_r($data);
                            }

                            if(($level_1_description == "Equity" || $level_1_description == "Liabilities"))
                            {
                                $empty_inner_item = false;

                                if($level_1_description == "Equity")
                                {
                                    $level_1['child_array'] = array($level_1); 
                                }
                                elseif($level_1_description == "Liabilities")
                                {
                                    if(isset($level_1['child_array'][0]['parent_array']))
                                    {
                                        if($level_1['child_array'][0]['parent_array'] == null)
                                        {
                                            // $level_1['child_array'] = array(array('child_array' => $level_1['child_array']));
                                            $level_1['child_array'] = [];
                                            $empty_inner_item = true;
                                        }
                                    }
                                    
                                }

                                if(!$displayed_eq_liabi_title && !$empty_inner_item && !empty($e_l_title))
                                {
                                    $content .= 
                                    '<tr>'.
                                        '<td style="width:'.$col_width['account_desc'].'%;"><strong>' . $e_l_title . '</strong></td>' .
                                        '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                    '</tr>';

                                    $displayed_eq_liabi_title = true;
                                }
                            }

                            /* ---------------------------- END OF Display main category (Level 1). eg. Assets, Equity and Liabilities ---------------------------- */

                            // print_r($level_1['child_array']);

                            if(!empty($level_1['parent_array']))
                            // {
                            //  echo 
                            //  '<tr>'.
                            //      '<td><strong><em>' . ucfirst(strtolower($level_1['child_array'][0]['description'])) . '</em></strong></td>' .
                            //      '<td align="center"></td>' .
                            //      '<td style="width: 0.5%;">&nbsp;</td>' .
                            //      '<td colspan="3"></td>' .
                            //  '</tr>';
                            // }
                            // else
                            {
                                foreach ($level_1['child_array'] as $level_2_key => $level_2) 
                                {
                                    // print_r($level_2);
                                
                                    $temp_total_c          = 0.00;
                                    $temp_total_c_adjusted = 0.00;
                                    $temp_total_c_end      = 0.00;
                                    $temp_total_c_beg      = 0.00;
                                    

                                    /* DISPLAY 1 LINE ONLY IF NO CHILD UNDER LEVEL 2 */
                                    if(count($level_2['child_array']) > 0)
                                    {
                                        if(!empty($level_2['parent_array']))
                                        {
                                            $content .= 
                                            '<tr>'.
                                                '<td style="width:'.$col_width['account_desc'].'%;"><strong><em>' . ucfirst(strtolower($level_2['parent_array'][0]['description'])) . '</em></strong></td>' .
                                                '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                            '</tr>';

                                            // print_r($level_2['child_array']);

                                            foreach ($level_2['child_array'] as $level_3_key => $level_3)
                                            {
                                                // echo '</br></br>';
                                                
                                                if(!empty($level_3['parent_array']) && $level_1_description != "Equity")
                                                {
                                                    $content .= 
                                                    '<tr>'.
                                                        '<td style="width:'.$col_width['account_desc'].'%;"><u><em>' . ucfirst(strtolower($level_3['parent_array'][0]['description'])) . '</em></u></td>' .
                                                        '<td style="width:'.(100-$col_width['account_desc']).'%;" colspan="9"></td>' .
                                                    '</tr>';
                                                    foreach ($level_3['child_array'] as $level_4_key => $level_4)
                                                    {

                                                       


                                                        /* DISPLAY LEVEL 3 THAT HAS SUBCATEGORY */
                                                        if(!empty($level_4['parent_array']))
                                                        {

                                                            $temp_c          = isset($level_4['parent_array'][0]['total_c'])?$level_4['parent_array'][0]['total_c']:0;
                                                            $temp_c_adjusted = isset($level_4['parent_array'][0]['total_c_adjusted'])?$level_4['parent_array'][0]['total_c_adjusted']:0;
                                                            $temp_c_lye      = isset($level_4['parent_array'][0]['total_c_lye'])?$level_4['parent_array'][0]['total_c_lye']:0;

                                                            $temp_id         = $level_4['parent_array'][0]['id'];
                                                            // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                                            if(isset($level_4['parent_array'][0]['child_id']))
                                                            {
                                                                $temp_adjustment_info = $this->get_adjustment_of_child($level_4['parent_array'][0]['child_id'], $adjustment_data);
                                                            }
                                                            else
                                                            {
                                                                $temp_adjustment_info = array();
                                                            }
                                                            
                                                            $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                                            $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                                            $adjustment_for_rev_rsrve = 0.00;
                                                            $adjustment_for_pl = 0.00;

                                                            $variance_value = $this->calculate_variance($temp_c_adjusted,$temp_c_lye);

                                                            // print_r($variance_value);
                                                            // echo json_encode($level_3['fs_note_details']);
                                                            $content .= 
                                                            '<tr>' .
                                                                '<td style="width:'.$col_width['account_desc'].'%;">' .
                                                                    // hidden fields
                                                                    $level_4['parent_array'][0]['description'] . 
                                                                '</td>';

                                                                $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c) . '</td>';


                                                                // FOR P/L adjustment
                                                                if($level_4['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value == "")
                                                                {
                                                                    //multiply with -1 because retained earning is opposite sign
                                                                    $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c);
                                                
                                                                    if($adjustment_for_pl > 0)
                                                                    {
                                                                        $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>';
                                                                        // $content .= 
                                                                        //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket($adjustment_for_pl).'</td>';
                                                                        $content .= 
                                                                            '<td align="right"></td>';
                                                                    }
                                                                    else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                                                    {
                                                                        $content .= 
                                                                            '<td align="right"></td>';

                                                                        // $content .= 
                                                                        //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket(abs($adjustment_for_pl)).'</td>';
                                                                        $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>';
                                                                    }
                                                                }

                                                                if($level_4['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value != "")
                                                                {
                                                                    $adjustment_for_rev_rsrve += $temp_adjust_value;
                                                                }

                                                                
                                                                // FOR revenue reserve own adjustment
                                                                if($temp_adjust_value > 0)
                                                                {
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                            <table>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                                </tr>
                                                                            </table>
                                                                        </td>';
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                }
                                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                                {
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                            <table>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                                </tr>
                                                                            </table>'.
                                                                        '</td>';
                                                                }
                                                                else if($temp_adjust_value == "" && $adjustment_for_pl == 0)
                                                                {
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                }

                                                                $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_adjusted) . '</td>';
                                                                
                                                                if(!empty($last_fye_end))
                                                                {

                                                                    $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_lye) . '</td>';
                                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                             
                                                                }
                                                                
                                                                $temp_total_c          += (double)$temp_c;
                                                                $temp_total_c_adjusted += (double)$temp_c_adjusted;
                                                                $temp_total_c_end      += (double)$temp_c_lye;
                                                                $temp_total_c_beg      += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];
                                                                // }
                                                            $content .= '</tr>';

                                                            //loop all adjustment info 
                                                            if(count($temp_adjustment_info) > 1)
                                                            {
                                                                foreach ($temp_adjustment_info as $info_key => $each_info) {
                                                                    if($info_key != 0)
                                                                    {
                                                                        $temp_adjust_value = $each_info['adjusted_value'];
                                                                        $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                                                        $content .= '<tr>
                                                                                <td></td>
                                                                                <td></td>';
                                                                        if($temp_adjust_value > 0)
                                                                        {
                                                                            $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>';
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                        }
                                                                        else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                                        {
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                            $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                                        </tr>
                                                                                    </table>'.
                                                                                '</td>';
                                                                        }
                                                                        else
                                                                        {
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                        }
                                                                        $content .=  '</tr>';
                                                                    }
                                                                }
                                                                
                                                            }

                                                            if($level_3['parent_array'][0]['account_code'] == 'Q103000' && $adjustment_for_rev_rsrve != 0)
                                                            {
                                                                //multiply with -1 because retained earning is opposite sign
                                                                $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c) - $adjustment_for_rev_rsrve;
                                            
                                                                $content .= '<tr>
                                                                        <td></td>
                                                                        <td></td>';
                                                                if($adjustment_for_pl > 0)
                                                                {
                                                                    $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>';
                                                                    // $content .= 
                                                                    //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket($adjustment_for_pl).'</td>';
                                                                    $content .= 
                                                                        '<td align="right"></td>';
                                                                }
                                                                else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                                                {
                                                                    $content .= 
                                                                    '<td align="right"></td>';

                                                                    // $content .= 
                                                                    // '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket(abs($adjustment_for_pl)).'</td>';
                                                                    $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>';
                                                                }
                                                                $content .=  '</tr>';
                                                            }
                                                    
                                                            $index++;
                                                        }
                                                        /* END OF DISPLAY LEVEL 3 THAT HAS SUBCATEGORY */

                                                        /* DISPLAY LEVEL 3 WITHOUT SUBCATEGORY UNDER IT */
                                                        elseif($level_1_description == "Liabilities" || $level_1_description == "Assets")
                                                        {
                                                            $variance_value = $this->calculate_variance($level_4['child_array']['adjusted_value'],$level_4['child_array']['company_end_prev_ye_value']);
                                                            $temp_id         = $level_4['child_array']['id'];
                                                            $temp_adjustment_info = isset($adjustment_data[$temp_id][0])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                                            $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][0]['type_name'].$adjustment_data[$temp_id][0]['je_no']:"";


                                                            $content .= 
                                                            '<tr>'.
                                                                '<td style="width:'.$col_width['account_desc'].'%;">' . 

                                                                    $level_4['child_array']['description'] . 
                                                                '</td>';
                                                    
                                                            
                                                                $content .= 
                                                                '<td align="right" style="width:'.$col_width['value'].'%;">' .  $this->negative_bracket($level_4['child_array']['value']) . '</td>';

                                                                if($temp_adjustment_info > 0)
                                                                {
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                            <table>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                                                </tr>
                                                                            </table>
                                                                        </td>';
                                                                    $content .= 
                                                                        '<td align="right" style="width:'.$col_width['value'].'%;"></td>';
                                                                }
                                                                else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                                                {
                                                                    $content .= 
                                                                        '<td align="right" style="width:'.$col_width['value'].'%;"></td>';

                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                            <table>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                                                </tr>
                                                                            </table>'.
                                                                        '</td>';
                                                                }
                                                                else
                                                                {
                                                                    $content .= 
                                                                        '<td align="right" style="width:'.$col_width['value'].'%;"></td>';
                                                                    $content .= 
                                                                        '<td align="right" style="width:'.$col_width['value'].'%;"></td>';
                                                                }

                                                                $content .= 
                                                                '<td align="right" style="width:'.$col_width['value'].'%;">' .  $this->negative_bracket($level_4['child_array']['adjusted_value']) . '</td>';

                                                                if(!empty($last_fye_end))
                                                                {
                                                                    // echo 
                                                                    // '<td align="right">' . 
                                                                    //  '<input type="number" class="form-control ' . $display_class_lye_end . '_values_under_' . $level_2['parent_array']['id'] . ' ' . $display_class_lye_end . '_account_code_' . $level_2['parent_array']['account_code'] . '" name="' . $FP_lye_end_value_name . '[' . $index . ']" style="text-align:right;" value="' . $level_3['child_array']['company_end_prev_ye_value'] . '" onchange="FP_calculation('. $level_2['parent_array']['id'] .', \'' . $display_class_lye_end. '\', \'' . $level_2['parent_array']['account_code'] . '\', \'' . "company" . '\')" min="0" pattern="[0-9]" onkeypress="return !(event.charCode == 46)" step="1">' . 
                                                                    // '</td>';

                                                                    $content .=
                                                                        '<td align="right" style="width:'.$col_width['value'].'%;">' . $this->negative_bracket($level_4['child_array']['company_end_prev_ye_value']) . '</td>';
                                                                    $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                                    $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>';

                                                                }

                                                                $temp_total_c         += (double)$level_4['child_array']['value'];
                                                                $temp_total_c_adjusted  += (double)$level_4['child_array']['adjusted_value'];
                                                                $temp_total_c_end     += (double)$level_4['child_array']['company_end_prev_ye_value'];
                                                                $temp_total_c_beg     += (double)$level_4['child_array']['company_beg_prev_ye_value'];
                                                                
                                                            $content .= '</tr>';

                                                            //loop all adjustment info 
                                                            if(isset($adjustment_data[$temp_id]) && count($adjustment_data[$temp_id]) > 1)
                                                            {
                                                                foreach ($adjustment_data[$temp_id] as $info_key => $each_info) {
                                                                    if($info_key != 0)
                                                                    {
                                                                        $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][$info_key]['adjust_value']:"";
                                                                        $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][$info_key]['type_name'].$adjustment_data[$temp_id][$info_key]['je_no']:"";
                                                                        $content .= '<tr>
                                                                                <td></td>
                                                                                <td></td>';
                                                                        if($temp_adjustment_info > 0)
                                                                        {
                                                                            $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                                                        </tr>
                                                                                    </table>
                                                                                </td>';
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                        }
                                                                        else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                                                        {
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                            $content .= 
                                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                    <table>
                                                                                        <tr>
                                                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                                                        </tr>
                                                                                    </table>'.
                                                                                '</td>';
                                                                        }
                                                                        else
                                                                        {
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                            $content .= 
                                                                                '<td align="right"></td>';
                                                                        }
                                                                        $content .=  '</tr>';
                                                                    }
                                                                }
                                                                
                                                            }

                                                            $index++;
                                                        }
                                                        /* END OF DISPLAY LEVEL 3 WITHOUT SUBCATEGORY UNDER IT */

                                                    }

                                                    $temp_c          = isset($level_3['parent_array'][0]['total_c'])?$level_3['parent_array'][0]['total_c']:0;
                                                    $temp_c_adjusted = isset($level_3['parent_array'][0]['total_c_adjusted'])?$level_3['parent_array'][0]['total_c_adjusted']:0;
                                                    $temp_c_lye      = isset($level_3['parent_array'][0]['total_c_lye'])?$level_3['parent_array'][0]['total_c_lye']:0;
                                                    // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                                    $variance_value  = $this->calculate_variance($temp_c_adjusted ,$temp_c_lye);

                                                    $content .= 
                                                    '<tr>' . 
                                                        '<td style="width:'.$col_width['account_desc'].'%;"></td>' . 
                                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                            '<span>' . 
                                                                $this->negative_bracket($temp_c) . 
                                                            '</span>' . 
                                                        '</td>
                                                        <td style="width:'.$col_width['value'].'%;"></td>
                                                        <td style="width:'.$col_width['value'].'%;"></td>
                                                        '.
                                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                            '<span>' . 
                                                                $this->negative_bracket($temp_c_adjusted) . 
                                                            '</span>' . 
                                                        '</td>';

                                                    if(!empty($last_fye_end))
                                                    {
                                                        $content .= 
                                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                            '<span>' . 
                                                                $this->negative_bracket($temp_c_lye) . 
                                                            '</span>' . 
                                                        '</td>';

                                                        if($show_third_col)
                                                        {
                                                            $content .= 
                                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                                '<span>' . 
                                                                    $this->negative_bracket($total_beg) . 
                                                                '</span>' . 
                                                            '</td>';
                                                            
                                                        }

                                                        $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                        $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>';
                                                    }
                                                        
                                                        
                                                    $content .= '</tr>';
                                                    // $content .= '<tr><td colspan="10"></td></tr>';
                                                }
                                                elseif(!empty($level_3['parent_array']) && $level_1_description == "Equity")
                                                {
                                                    if(!empty($level_3['parent_array']))
                                                    {
                                                        $temp_c          = isset($level_3['parent_array'][0]['total_c'])?$level_3['parent_array'][0]['total_c']:0;
                                                        $temp_c_adjusted = isset($level_3['parent_array'][0]['total_c_adjusted'])?$level_3['parent_array'][0]['total_c_adjusted']:0;
                                                        $temp_c_lye      = isset($level_3['parent_array'][0]['total_c_lye'])?$level_3['parent_array'][0]['total_c_lye']:0;

                                                        $temp_id         = $level_3['parent_array'][0]['id'];
                                                        // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                                        if(isset($level_3['parent_array'][0]['child_id']))
                                                        {
                                                            $temp_adjustment_info = $this->get_adjustment_of_child($level_3['parent_array'][0]['child_id'], $adjustment_data);
                                                        }
                                                        else
                                                        {
                                                            $temp_adjustment_info = array();
                                                        }
                                                        
                                                        $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                                        $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                                        $adjustment_for_rev_rsrve = 0.00;
                                                        $adjustment_for_pl = 0.00;

                                                        $variance_value = $this->calculate_variance($temp_c_adjusted,$temp_c_lye);

                                                        // print_r($variance_value);
                                                        // echo json_encode($level_3['fs_note_details']);
                                                        $content .= 
                                                        '<tr>' .
                                                            '<td style="width:'.$col_width['account_desc'].'%;">' .
                                                                // hidden fields
                                                                $level_3['parent_array'][0]['description'] . 
                                                            '</td>';

                                                            $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c) . '</td>';


                                                            // FOR P/L adjustment
                                                            if($level_3['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value == "")
                                                            {
                                                                //multiply with -1 because retained earning is opposite sign
                                                                $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c);
                                            
                                                                if($adjustment_for_pl > 0)
                                                                {
                                                                    $content .= 
                                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                <table>
                                                                                    <tr>
                                                                                        <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                        <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                                                    </tr>
                                                                                </table>
                                                                            </td>';
                                                                    // $content .= 
                                                                    //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket($adjustment_for_pl).'</td>';
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;"  align="right"></td>';
                                                                }
                                                                else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                                                {
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;"  align="right"></td>';

                                                                    // $content .= 
                                                                    //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket(abs($adjustment_for_pl)).'</td>';
                                                                    $content .= 
                                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                <table>
                                                                                    <tr>
                                                                                        <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                                                    </tr>
                                                                                </table>
                                                                            </td>';
                                                                }
                                                            }

                                                            if($level_3['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value != "")
                                                            {
                                                                $adjustment_for_rev_rsrve += $temp_adjust_value;
                                                            }

                                                            
                                                            // FOR revenue reserve own adjustment
                                                            if($temp_adjust_value > 0)
                                                            {
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                        <table>
                                                                            <tr>
                                                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>';
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                            }
                                                            else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                            {
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                        <table>
                                                                            <tr>
                                                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                            </tr>
                                                                        </table>'.
                                                                    '</td>';
                                                            }
                                                            else if($temp_adjust_value == "" && $adjustment_for_pl == 0)
                                                            {
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                            }

                                                            $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_adjusted) . '</td>';
                                                            
                                                            if(!empty($last_fye_end))
                                                            {

                                                                $content .= 
                                                                '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_lye) . '</td>';
                                                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                         
                                                            }
                                                            
                                                            $temp_total_c          += (double)$temp_c;
                                                            $temp_total_c_adjusted += (double)$temp_c_adjusted;
                                                            $temp_total_c_end      += (double)$temp_c_lye;
                                                            $temp_total_c_beg      += (double)$level_3['parent_array'][0]['company_beg_prev_ye_value'];
                                                            // }
                                                        $content .= '</tr>';

                                                        //loop all adjustment info 
                                                        if(count($temp_adjustment_info) > 1)
                                                        {
                                                            foreach ($temp_adjustment_info as $info_key => $each_info) {
                                                                if($info_key != 0)
                                                                {
                                                                    $temp_adjust_value = $each_info['adjusted_value'];
                                                                    $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                                                    $content .= '<tr>
                                                                            <td></td>
                                                                            <td></td>';
                                                                    if($temp_adjust_value > 0)
                                                                    {
                                                                        $content .= 
                                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                <table>
                                                                                    <tr>
                                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                        <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                                    </tr>
                                                                                </table>
                                                                            </td>';
                                                                        $content .= 
                                                                            '<td align="right"></td>';
                                                                    }
                                                                    else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                                    {
                                                                        $content .= 
                                                                            '<td align="right"></td>';
                                                                        $content .= 
                                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                <table>
                                                                                    <tr>
                                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                                    </tr>
                                                                                </table>'.
                                                                            '</td>';
                                                                    }
                                                                    else
                                                                    {
                                                                        $content .= 
                                                                            '<td align="right"></td>';
                                                                        $content .= 
                                                                            '<td align="right"></td>';
                                                                    }
                                                                    $content .=  '</tr>';
                                                                }
                                                            }
                                                            
                                                        }

                                                        if($level_3['parent_array'][0]['account_code'] == 'Q103000' && $adjustment_for_rev_rsrve != 0)
                                                        {
                                                            //multiply with -1 because retained earning is opposite sign
                                                            $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c) - $adjustment_for_rev_rsrve;
                                        
                                                            $content .= '<tr>
                                                                    <td></td>
                                                                    <td></td>';
                                                            if($adjustment_for_pl > 0)
                                                            {
                                                                $content .= 
                                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                <table>
                                                                                    <tr>
                                                                                        <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                        <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                                                    </tr>
                                                                                </table>
                                                                            </td>';
                                                                // $content .= 
                                                                //     '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket($adjustment_for_pl).'</td>';
                                                                $content .= 
                                                                    '<td align="right"></td>';
                                                            }
                                                            else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                                            {
                                                                $content .= 
                                                                '<td align="right"></td>';

                                                                // $content .= 
                                                                // '<td align="right"><span style="float:left"><strong>P/L</strong></span>'.negative_bracket(abs($adjustment_for_pl)).'</td>';
                                                                $content .= 
                                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                                <table>
                                                                                    <tr>
                                                                                        <td style="width: 40%;"><strong>P/L</strong></td>
                                                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                                                    </tr>
                                                                                </table>
                                                                            </td>';
                                                            }
                                                            $content .=  '</tr>';
                                                        }
                                                
                                                    $index++;
                                                    }
                                                }
                                            }
                                            
                                           /* DISPLAY TOTAL FOR EACH CATEGORY   */
                                            $total          = $temp_total_c;
                                            $total_adjusted = $temp_total_c_adjusted;
                                            $total_end  = $temp_total_c_end;
                                            $total_beg  = $temp_total_c_beg;

                                            /* CALCULATE TOTAL ASSETS, TOTAL EQUITY, LIABILITIES - COMPANY */
                                            if($level_1_description == "Assets")    // NON-CURRENT ASSETS || CURRENT ASSETS
                                            {
                                                $total_assets_c          += $total;
                                                $total_assets_c_adjusted += $total_adjusted;
                                                $total_assets_c_end      += $total_end;
                                                $total_assets_c_beg      += $total_beg;
                                            }
                                            elseif($level_1_description == "Equity") // EQUITY
                                            {
                                                $total_equity_c          += $total;
                                                $total_equity_c_adjusted += $total_adjusted;
                                                $total_equity_c_end      += $total_end;
                                                $total_equity_c_beg      += $total_beg;
                                            }
                                            elseif($level_1_description == "Liabilities") // NON-CURRENT LIABILITIES || CURRENT LIABILITIES
                                            {
                                                $total_liabilities_c           += $total;
                                                $total_liabilities_c_adjusted  += $total_adjusted;
                                                $total_liabilities_c_end       += $total_end;
                                                $total_liabilities_c_beg       += $total_beg;
                                            }
                                            /* END OF CALCULATE TOTAL ASSETS, TOTAL EQUITY, LIABILITIES */
                                            
                                            $variance_value = $this->calculate_variance($total_adjusted,$total_end);

                                            $content .= 
                                                '<tr>' . 
                                                    '<td style="width:'.$col_width['account_desc'].'%;"></td>' . 
                                                    '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                        '<span>' . 
                                                            $this->negative_bracket($total) . 
                                                        '</span>' . 
                                                    '</td>
                                                    <td></td>
                                                    <td></td>'.
                                                    '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                        '<span>' . 
                                                            $this->negative_bracket($total_adjusted) . 
                                                        '</span>' . 
                                                    '</td>';

                                                    if(!empty($last_fye_end))
                                                    {
                                                        $content .= 
                                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;width:'.$col_width['value'].'%;">' . 
                                                            '<span>' . 
                                                                $this->negative_bracket($total_end) . 
                                                            '</span>' . 
                                                        '</td>';

                                                        if($show_third_col)
                                                        {
                                                            $content .= 
                                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                                '<span>' . 
                                                                    $this->negative_bracket($total_beg) . 
                                                                '</span>' . 
                                                            '</td>';
                                                            
                                                        }

                                                        $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                        $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>';
                                                    }
                                                    
                                                    
                                                $content .= '</tr>';
                                                /* END OF DISPLAY TOTAL FOR EACH CATEGORY */
                                        }
                                    }
                                }
                            }


                            
                            /* DISPLAY TOTAL ASSETS */
                            if($level_1_description == "Assets" && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                

                                $total_assets          = 0.00;
                                $total_assets_adjusted = 0.00;
                                $total_assets_end      = 0.00;
                                $total_assets_beg      = 0.00;

                        
                                $total_assets     = $total_assets_c;
                                $total_assets_adjusted = $total_assets_c_adjusted;
                                $total_assets_end = $total_assets_c_end;
                                $total_assets_beg = $total_assets_c_beg;


                                $variance_value = $this->calculate_variance($total_assets_adjusted,$total_assets_end);

                                $content .= 
                                '<tr>' . 
                                    '<td style=""><strong>Total assets</strong></td>' . 
                                    '<td style="border-bottom:2px double black;" align="right">' . 
                                        '<span>' . $this->negative_bracket($total_assets) . '</span>'.
                                        // '<div style="border: 1px solid black;line-height: 1px;">&nbsp;</div>'.
                                        
                                    '</td>
                                    <td></td>
                                    <td></td>'.
                                    '<td style="border-bottom:2px double black;" align="right">' . 
                                        '<span>' . $this->negative_bracket($total_assets_adjusted) . '</span>'.
                                        // '<div style="border: 1px solid black;line-height: 1px;">&nbsp;</div>'.
                                        
                                    '</td>';

                                    if(!empty($last_fye_end))
                                    {
                                        $content .= 
                                        '<td style="border-bottom:2px double black;" align="right">' . 
                                            '<span>' . $this->negative_bracket($total_assets_end) . '</span>' . 
                                            // '<br/><div style="border: 1px solid black;line-height: 1px;">&nbsp;</div>'.
                                        '</td>';

                                        if($show_third_col)
                                        {
                                            $content .= 
                                            '<td align="right" style="border-bottom:2px double black;">' . 
                                                '<span>' . $this->negative_bracket($total_assets_beg) . '</span>' . 
                                            '</td>';
                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                        }
                                    }
                                    
                                    $content .= '<td colspan="5"></td>';
                                $content .= '</tr>';
                                
                            }
                            /* END OF DISPLAY TOTAL ASSETS */

                            /* DISPLAY TOTAL LIABILITES */
                            if($level_1_description == "Liabilities" && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                if(in_array("Liabilities", $eq_liabi_title_list))
                                {
                                    $total_liabilities            = 0.00;
                                    $total_liabilities_adjusted   = 0.00;
                                    $total_liabilities_end        = 0.00;
                                    $total_liabilities_beg        = 0.00;

                        
                                    $total_liabilities          = $total_liabilities_c;
                                    $total_liabilities_adjusted = $total_liabilities_c_adjusted;
                                    $total_liabilities_end      = $total_liabilities_c_end;
                                    $total_liabilities_beg      = $total_liabilities_c_beg;

                                    $variance_value = $this->calculate_variance($total_liabilities_adjusted,$total_liabilities_end);

                                    $content .= 
                                    '<tr>' .  
                                        '<td><strong>Total liabilities</strong></td>' . 
                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                            '<span>' . $this->negative_bracket($total_liabilities) . '</span>' .
                                        '</td>
                                        <td></td>
                                        <td></td>'.
                                        '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                            '<span>' . $this->negative_bracket($total_liabilities_adjusted) . '</span>' .
                                        '</td>';

                                        if(!empty($last_fye_end))
                                        {
                                            $content .= 
                                            '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                '<span>' . $this->negative_bracket($total_liabilities_end) . '</span>' .
                                            '</td>';

                                            if($show_third_col)
                                            {
                                                $content .= 
                                                '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                    '<span>' . $this->negative_bracket($total_liabilities_beg) . '</span>' . 
                                                '</td>';
                                                
                                            }

                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                        }
                                        
                                    $content .= '</tr>';

                                    $content .= 
                                    '<tr>' . 
                                        '<td colspan="10">&nbsp;</td>' . 
                                    '</tr>';
                                }
                            }
                            /* END OF DISPLAY TOTAL LIABILITES */

                            /* DISPLAY TOTAL EQUITY & LIABILITIES */
                            elseif($level_1_key == count($data) - 1)
                            {
                                if(count($eq_liabi_title_list) > 1)
                                {
                                    $total_equity_liabilities           = 0.00;
                                    $total_equity_liabilities_adjusted  = 0.00;
                                    $total_equity_liabilities_end       = 0.00;
                                    $total_equity_liabilities_beg       = 0.00;

                                
                                    $total_equity_liabilities           = $total_equity_c   + $total_liabilities_c;
                                    $total_equity_liabilities_adjusted  = $total_equity_c_adjusted  + $total_liabilities_c_adjusted;
                                    $total_equity_liabilities_end       = $total_equity_c_end + $total_liabilities_c_end;
                                    $total_equity_liabilities_beg       = $total_equity_c_beg + $total_liabilities_c_beg;

                                    $variance_value = $this->calculate_variance($total_equity_liabilities_adjusted,$total_equity_liabilities_end);
                                

                                    $content .= 
                                    '<tr>' . 
                                        '<td><strong>Total equity and liabilities</strong></td>' . 
                                        '<td align="right" style="border-bottom: 2px double black;">' . 
                                            '<span>' . $this->negative_bracket($total_equity_liabilities) . '</span>' . 
                                        '</td>
                                        <td></td>
                                        <td></td>'.
                                        '<td align="right" style="border-bottom: 2px double black;">' . 
                                            '<span>' . $this->negative_bracket($total_equity_liabilities_adjusted) . '</span>' . 
                                        '</td>';
                                        if(!empty($last_fye_end))
                                        {
                                            $content .= 
                                            '<td align="right" style="border-bottom: 2px double black;">' . 
                                                '<span>' .$this->negative_bracket($total_equity_liabilities_end) . '</span>' . 
                                            '</td>';

                                            if($show_third_col)
                                            {
                                                $content .= 
                                                '<td align="right" style="border-bottom: 2px double black;">' . 
                                                    '<span>' . $this->negative_bracket($total_equity_liabilities_beg) . '</span>' .
                                                '</td>';
                                                
                                            }

                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                        }

                                        
                                    $content .= '</tr>';
                                }

                                
                            }
                            /* END OF DISPLAY TOTAL LIABILITES, TOTAL EQUITY & LIABILITIES */

                            /* BREAK LINE */
                            if($level_1_key < (count($data[0]) - 1) && (count($level_1['child_array']) > 0) && !$hide_main_title)
                            {
                                $content .= 
                                '<tr>' . 
                                    '<td colspan="10">&nbsp;</td>' . 
                                '</tr>';
                            }
                            /* END OF BREAK LINE */
                        }
                    
        $content .= '</tbody>
                    </table>';
        // print_r($content);

       

        $obj_pdf->writeHTML($content, true, false, false, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/A5_FARBS_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/A5_FARBS_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/A5_FARBS_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));

        // define some HTML content with style

    }

    public function export_farpl_pdf($caf_id, $assignment_id)
    {
        $array_link = [];

        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

        // create new PDF document
        $obj_pdf= new NO_MARGIN_PDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "A5 - Final profit or loss";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(10, 33, 10);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 9);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('L');

        
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

         // initialise
        $current_fye_end = '';
        $last_fye_end    = '';
        $display_restated = false;

        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 40,
                            'value'        => 15,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 20,
                            'value'        => 12.8,
                            'variance'        => 8

                        );

        }
        /* END OF Setting for column width */

        /* Don't delete this */
        // if($fs_company_info[0]['is_prior_year_amount_restated'])
        // {
        //     if(strcmp($fs_company_info[0]['effect_of_restatement_since'], $fs_company_info[0]['last_fye_begin']) == 0)
        //     {
        //         $this->data["display_restated"] = true;
        //     }
        // }
        /* Don't delete this */

        // display column(s) for years
        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }
        else
        {
            $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);

            $current_fye_end  = $current_last_year_end['current_fye_end'];    // this year end eg. 31/12/2019
            $last_fye_end     = $current_last_year_end['last_fye_end'];       // end of previous year end
        }

        /* ---------------------- get statement of detailed profit or loss data ---------------------- */

        $dpl_key = array_search("Profit or loss", array_column($fs_ntfs_list['statements'], 'document_name'));
        $dpl_ref_id = '';

        if($dpl_key || (string)$dpl_key == '0')
        {
            $dpl_account_code = $fs_ntfs_list['statements'][$dpl_key]['reference_id']; // get account code
        }

        $dpl_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $dpl_account_code);

        $dpl_data = [];

        foreach ($dpl_fca_id as $dpl_fca_id_key => $dpl_fca_id_value) 
        {
            array_push($dpl_data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($dpl_fca_id_value)));
        }

        $state_detailed_pro_loss_data = $dpl_data;

        // seperated because this need to loop level 3
        $er_account_code = array("E0000000");
        $er_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $er_account_code);

        $schedule_operating_expense_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $er_fca_id);

        //retrieve TAX
        $temp_data = [];
        $data = [];
        $tax_account_code = array("T0000000");
        $tax_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $tax_account_code);

        foreach ($tax_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c']          = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_adjusted'] = (double)$value['parent_array'][0]['total_c_adjusted'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye']      = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        $tax_data = $data;

        $temp_data = [];
        $data = [];

        $soa_account_code = array("S0000000");
        $soa_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $soa_account_code);

        foreach ($soa_fca_id as $fca_id_key => $fca_id_value) 
        {
            $temp_data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value));

            if(count($temp_data[0]['child_array']) > 0)
            {
                // print_r($temp_data);

                $temp_data[0]['parent_array'][0]['total_c']          = (double)$temp_data[0]['parent_array'][0]['total_c']     * (-1);
                $temp_data[0]['parent_array'][0]['total_c_adjusted'] = (double)$temp_data[0]['parent_array'][0]['total_c_adjusted']     * (-1);
                $temp_data[0]['parent_array'][0]['total_c_lye']      = (double)$temp_data[0]['parent_array'][0]['total_c_lye'] * (-1);

                array_push($data, $temp_data);
            }
        }

        if(count($data) > 0)
        {
            $soa_pl_list = $data;
        }
        else
        {
            $soa_pl_list = [];
        }
        $soa_pl_lists = $soa_pl_list;

        //retrieve DIVIDEND
        $temp_data = [];
        $data = [];
        $div_account_code = array("D0000000");
        $div_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $div_account_code);

        foreach ($div_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_adjusted'] = (double)$value['parent_array'][0]['total_c_adjusted'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $div_data = $data;
        }
        else
        {
            $div_data = [];
        }

        //retrieve RETAINED EARNINGS B/F
        $temp_data = [];
        $data = [];
        $bf_account_code = array("Q1030000");
        $bf_fca_id = $this->fs_model->get_fca_id($fs_company_info_id, $bf_account_code);

        foreach ($bf_fca_id as $fca_id_key => $fca_id_value) 
        {
            array_push($data, $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($fca_id_value)));
        }

        if(isset($data[0]))
        {
            foreach($data[0] as $key => $value)
            {
                $data[0][$key]['parent_array'][0]['total_c'] = (double)$value['parent_array'][0]['total_c'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_adjusted'] = (double)$value['parent_array'][0]['total_c_adjusted'] * (-1);
                $data[0][$key]['parent_array'][0]['total_c_lye'] = (double)$value['parent_array'][0]['total_c_lye'] * (-1);
                
            }
        }

        if(count($data) > 0)
        {
            $bf_data = $data;
        }
        else
        {
            $bf_data = [];
        }


        

        $fs_ntfs_list = $fs_ntfs_list['statements'][$dpl_key]['description_reference_id'];

        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $adjustment_data = $this->build_adjustment_data_arr($temp_adjustment_data);

        //end of retrieving data

        $content = '';
        
        $content .= '<table  cellpadding="1" style="width: 100%; color:black;">
                     <thead>
                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;">&nbsp;</th>
                            <th style="width:'.$col_width['value'].'%;text-align: center;">';
                        
                                if($display_restated)
                                {
                                    $content .= '<br />';
                                } 
                                $content .= $current_fye_end ."<br/>". "Unadjusted"; 
                         
        $content .=         '</th>';
        $content .=         '<th style="width: '.($col_width['value']*2).'%; text-align: center;" colspan=2>';
                            
                                if($display_restated)
                                {
                                    $content .= '<br />';
                                } 
                                $content .= '&nbsp;<br />Adjustments';
                            
        $content .=         '</th>';

        $content .=         '<th style="width:'.$col_width['value'].'%;text-align: center;">';
                        
                                if($display_restated)
                                {
                                    $content .= '<br />';
                                } 
                                $content .= $current_fye_end ."<br />". "Final"; 
                         
        $content .=         '</th>';

                        
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<th style="width:'.$col_width['value'].'%;text-align: center;">';
                                    if($display_restated)
                                    {
                                        $content .= 'Restated<br />';
                                    }
                                    $content .= $last_fye_end."<br />". "Final"; 
                                $content .= '</th>';
                                $content .= '<th style="colspan=2 width:'.($col_width['variance']*2).'%;text-align: center;"><br />Variance</th>';

                                if($display_restated)
                                {
                                    $content .= '<th style="width: ' . $col_width['value'] . '%; text-align: center;">Restated<br />' . $last_fye_beg . '</th>';
                                }
                            }
                        
        $content .=     '</tr>

                        <tr>
                            <th style="width:'.$col_width['account_desc'].'%;"></th>
                            <th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">&nbsp;<br />$</th>
                            <th style="width:'.$col_width['value'].'%; text-align: center; border-top: 1px solid #000;">DR<br />$</th>
                            <th style="width:'.$col_width['value'].'%; text-align: center; border-top: 1px solid #000;">CR<br />$</th>
                            <th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">&nbsp;<br />$</th>';

                            if(!empty($last_fye_end))
                            {
                                $content .= '<th style="width:'.$col_width['value'].'%;text-align: center; border-top: 1px solid #000;">&nbsp;<br />$</th>
                                            <th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">&nbsp;<br />$</th>
                                            <th style="width:'.$col_width['variance'].'%;text-align: center;border-top: 1px solid #000;">&nbsp;<br />%</th>';

                                if($display_restated)
                                {
                                    $content .= '<th style="text-align: center; border-top: 1px solid #000;">&nbsp;<br />$</th>';
                                }
                            }
                        
        $content .=     '</tr>
                    </thead>
                    <tbody>';

                    $ref_index = 1;

                    $total = [];
                    $total_revenue_current               = 0.00; // (+) ** M1003
                    $total_revenue_current_adjusted      = 0.00;
                    $total_revenue_current_ly            = 0.00; // (+) ** M1003
                    $total_cost_of_sale_current          = 0.00; // (-) ** M1004
                    $total_cost_of_sale_current_adjusted = 0.00;
                    $total_cost_of_sale_current_ly       = 0.00; // (-) ** M1004
                    $total_other_income                  = 0.00; //        ** M1005
                    $total_other_income_adjusted         = 0.00; //        ** M1005
                    $total_other_income_ly               = 0.00; //        ** M1005

                    $total_adjusted = [];
                    $total_ly = [];

                    $revenue_exist          = false;
                    $cost_of_sales_exist    = false;

                    $counter = 0;

                    $temp_total_ly      = 0.00;

                    $closing_inventories_ac = "";
                    $closing_inventories_key = array_search("Closing inventories", array_column($fs_ntfs_list, "description")); // get key

                    if(!empty($closing_inventories_key) || (string)$closing_inventories_key == 0)
                    {
                        $closing_inventories_ac = $fs_ntfs_list[$closing_inventories_key]['account_code'];  // get description from fs_ntfs_list json from document name "Statement of detailed profit or loss"
                    }

                    foreach($state_detailed_pro_loss_data as $key => $main_category)
                    {
                        $add_less_display = "";
                        $main_account_description = "";
                        $main_account_code = $main_category[0]['parent_array'][0]['account_code'];
                        
                        /* Settings */
                        // check using this account code > take the default description > do checking using description (list take from json)
                        $fs_ntfs_list_key = array_search($main_account_code, array_column($fs_ntfs_list, "account_code"));  // get key

                        if(!empty($fs_ntfs_list_key) || (string)$fs_ntfs_list_key == 0)
                        {
                            $main_account_description = $fs_ntfs_list[$fs_ntfs_list_key]['description'];    // get description from fs_ntfs_list json from document name "Statement of detailed profit or loss"
                        }

                       if($main_account_description == "Revenue")   // revenue
                        {
                            if($main_category[0]['parent_array'][0]['description'] == "Revenue" )
                            {
                                foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                                {
                                    if(isset($child_array['parent_array']))
                                    {
                                        if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                        {
                                            $revenue_exist = true;
                                        }

                                    }
                                    elseif ( $child_array['child_array'] != null) {
                                        $revenue_exist = true;
                                    }


                                }
                                // $revenue_exist = true;
                            }
                            // $revenue_exist = true;
                            
                        }
                        elseif($main_account_description == "Cost of Sales")    // cost of sale
                        {
                            if($main_category[0]['parent_array'][0]['description'] == "Cost of Sales" )
                            {
                                foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                                {
                                    if(isset($child_array['parent_array']))
                                    {
                                        if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                        {
                                            $cost_of_sales_exist = true;
                                            $add_less_display    = "Less: ";

                                        }

                                    }
                                    elseif ( $child_array['child_array'] != null) {
                                        $cost_of_sales_exist = true;
                                        $add_less_display    = "Less: ";

                                    }


                                }
                            }
                            // $cost_of_sales_exist = true;
                            // $add_less_display     = "Less: ";
                            
                        }
                        elseif($main_account_description == "Income")   // other income
                        {
                            $add_less_display = "Add: ";
                        }
                        /* END OF Settings */

                        /* ------------------- If NO SUB under main category ------------------- */
                        if(count($main_category[0]['child_array']) == 0)
                        {
                            $c_lye_value = 0.00;

                            if(!empty($main_category[0]['parent_array'][0]['company_end_prev_ye_value']))
                            {
                                if($main_account_description == "Revenue" || $main_account_description == "Income")
                                {
                                    $c_lye_value = $main_category[0]['parent_array'][0]['company_end_prev_ye_value'] * (-1);
                                }
                                else
                                {
                                    $c_lye_value = $main_category[0]['parent_array'][0]['company_end_prev_ye_value'];
                                }
                            }

                            if(ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) == "Revenue")
                            {
                            
                                $content .= '<tr>' . 
                                                '<td style="width:'.$col_width['account_desc'].'%;"><em>' . $add_less_display . ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) . '</em></td>' . 
                                                '<td style="width:'.$col_width['value'].'%;text-align:right; border-bottom:1px solid black;"> - </td>
                                                <td style="width:'.$col_width['value'].'%;"></td>
                                                <td style="width:'.$col_width['value'].'%;"></td>'.

                                                '<td style="width:'.$col_width['value'].'%;text-align:right; border-bottom:1px solid black;">' .
                                                    '<span>' . $this->negative_bracket(0) . '</span>' .
                                                '</td>';

                                if(!empty($last_fye_end))
                                {
                                    $content .= '<td align="right" style="width:'.$col_width['value'].'%;border-bottom:1px solid black;">' . 
                                                    $this->negative_bracket($c_lye_value) . 
                                                '</td>';
                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket(0).'</td>';
                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format(0,2).'%</td>';  
                                }
                                $content .= '</tr>';
                                $content .= '<tr>' .
                                                '<td style="width:'.$col_width['account_desc'].'%;"></td>' .
                                                '<td style="width:'.$col_width['value'].'%;text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                    '<span>' . $this->negative_bracket(0) . '</span>' .
                                                '</td>
                                                <td style="width:'.$col_width['value'].'%;"></td>
                                                <td style="width:'.$col_width['value'].'%;"></td>'.
                                                '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                    '<span>' . $this->negative_bracket(0) . '</span>' .
                                                '</td>';

                                if(!empty($last_fye_end))
                                {
                                    $content .= '<td style="width:'.$col_width['value'].'%;text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' . 
                                            // '<span id="SDPL_subtotal_'. $main_category['parent_array'][0]['id'] .'">' . negative_bracket($temp_total_ly) . '</span>' . 
                                                    '<span>' . $this->negative_bracket(0) . '</span>' . 
                                                '</td>';
                                    $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket(0).'</td>';
                                    $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format(0,2).'%</td>';  
                                }
                        
                                    
                                $content .= '</tr>';

                                $content .= '<tr><td colspan="10"></td></tr>';
                            }

                            // $content .= '<tr>' . 
                            //         '<td style="width:'.$col_width['account_desc'].'%;"><strong>' . $add_less_display . ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) . '</strong></td>' . 
                            //         '<td style="width:'.$col_width['value'].'%;text-align:right; border-bottom:1px solid black;"> - </td>';

                            //         if(!empty($last_fye_end))
                            //         {
                            //             $content .= '<td align="right" style="width:'.$col_width['value'].'%;border-bottom:1px solid black;">' . 
                            //                     // '<input type="hidden" name="SDPL_parent_fs_categorized_account_id['. $counter .']" value="'. $main_category[0]['parent_array'][0]['account_code'] .'">' .
                            //                     // '<input type="hidden" name="SDPL_sub_fs_categorized_account_id['. $counter .']" value="'. $main_category[0]['parent_array'][0]['id'] .'">' .
                            //                     // '<input type="text" name="SDPL_company_end_prev_year_value[' . $counter . ']" class="form-control SDPL_all_values SDPL_values_under_' . $main_category['parent_array'][0]['id'] . '" style="text-align: right;" value="' . $c_lye_value . '" onchange="calculation('. $main_category['parent_array'][0]['id'] .')">' .
                            //                     $this->negative_bracket($c_lye_value) . 
                            //                 '</td>';
                            //         }
                            // $content .= '</tr>';

                            // total up 
                            $temp_total          = 0.00;
                            $temp_total_adjusted = 0.00;
                            $temp_total_ly       = $c_lye_value;
                        }
                        /* ------------------- END OF If NO SUB under main category ------------------- */

                        /* If there are subs under main category */
                        else
                        {
                            $temp_total          = 0.00;
                            $temp_total_adjusted = 0.00;
                            $temp_total_ly       = 0.00;

                            $check_existance = false;

                            foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                            {
                                if(isset($child_array['parent_array']))
                                {
                                    if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                    {
                                        $check_existance = true;
                                    }

                                }
                                elseif ( $child_array['child_array'] != null) {
                                    $check_existance = true;
                                }


                            }


                            if($check_existance || ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) == "Revenue")
                            {
                                $content .= '<tr>' . 
                                        '<td style="width:'.$col_width['account_desc'].'%;" ><strong>' . $add_less_display . ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) . '</strong></td>' .
                                        '<td style="width:'.$col_width['value'].'%;" ></td>'.
                                        '<td style="width:'.$col_width['value'].'%;" ></td>';
                                        if(!empty($last_fye_end))
                                        {
                                            $content .= '<td style="width:'.$col_width['value'].'%;"></td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;"></td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;"></td>';
                                        }
                                $content .= '</tr>';
                            }

                            foreach ($main_category[0]['child_array'] as $key2 => $child_array) 
                            {
                                if(isset($child_array['parent_array']))
                                {
                                    if($child_array['parent_array'] != null && $child_array['child_array'] != null)
                                    {
                                        if($main_account_description == "Revenue" || $main_account_description == "Income")
                                        {
                                            $temp_value          = $child_array['parent_array'][0]['total_c'] * (-1);
                                            $temp_value_adjusted = $child_array['parent_array'][0]['total_c_adjusted'] * (-1);
                                            $temp_value_ly       = $child_array['parent_array'][0]['total_c_lye'] * (-1);
                                        }
                                        else
                                        {
                                            $temp_value          = $child_array['parent_array'][0]['total_c'];
                                            $temp_value_adjusted = $child_array['parent_array'][0]['total_c_adjusted'];
                                            $temp_value_ly       = $child_array['parent_array'][0]['total_c_lye'];
                                        }

                                        /* ------ Add in Display "Less:" for Closing inventories ------ */
                                        if($child_array['parent_array'][0]['account_code'] == $closing_inventories_ac)
                                        {
                                            $child_array['parent_array'][0]['description'] = $add_less_display . $child_array['parent_array'][0]['description'];
                                        }
                                        /* ------ END OF Add in Display "Less:" for Closing inventories ------ */

                                        //for adjustment column data if has child under it
                                        $temp_id              = $child_array['parent_array'][0]['id'];
                                        $temp_adjustment_info = $this->get_adjustment_of_child($child_array['parent_array'][0]['child_id'], $adjustment_data);
                                        $temp_adjust_value    = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                        $temp_je_no           = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                        $variance_value = $this->calculate_variance($temp_value_adjusted, $temp_value_ly);
                                        // Display child with subcategory. 
                                        $content .= '<tr>' . 
                                                '<td style="width:'.$col_width['account_desc'].'%;">' . $child_array['parent_array'][0]['description'] . '</td>' .
                                                '<td style="width:'.$col_width['value'].'%;text-align:right;">'. $this->negative_bracket($temp_value) .'</td>';
                                                if($temp_adjust_value > 0)
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                    // $content .= 
                                                    //     '<td style="width:'.$col_width['value'].'%;" align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                }
                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';    
                                                    // $content .= 
                                                    //     '<td style="width:'.$col_width['value'].'%;" align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                                }
                                                else
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                }
                                        $content .= '<td style="width:'.$col_width['value'].'%;text-align:right;">'. $this->negative_bracket($temp_value_adjusted) .'</td>';
                                                if(!empty($last_fye_end))
                                                {
                                                    $content .= '<td style="width:'.$col_width['value'].'%;text-align:right;">' . $this->negative_bracket($temp_value_ly).'</td>';
                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                                }
                                        $content .= '</tr>';

                                        //loop all adjustment info 
                                        if(count($temp_adjustment_info) > 1)
                                        {
                                            foreach ($temp_adjustment_info as $info_key => $each_info) {
                                                if($info_key != 0)
                                                {
                                                    $temp_adjust_value = $each_info['adjusted_value'];
                                                    $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                                    $content .= '<tr>
                                                            <td></td>
                                                            <td></td>';
                                                    if($temp_adjust_value > 0)
                                                    {

                                                        $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                        // $content .= 
                                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                    }
                                                    else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                    {
                                                        $content .= 
                                                            '<td align="right"></td>';

                                                        $content .= 
                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                <table>
                                                                    <tr>
                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                    </tr>
                                                                </table>
                                                            </td>';
                                                        // $content .= 
                                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                                    }
                                                    else
                                                    {
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                    }
                                                    $content .=  '</tr>';
                                                }
                                            }
                                            
                                        }

                                        $ref_index++;

                                        // total up 
                                        $temp_total          += $temp_value;
                                        $temp_total_adjusted += $temp_value_adjusted;
                                        $temp_total_ly       += $temp_value_ly;


                                        $counter++;
                                    }
                                }
                                elseif($child_array['child_array'] != null)
                                {
                                    if($main_account_description == "Revenue" || $main_account_description == "Income")
                                    {
                                        $temp_value          = $child_array['child_array']['value'] * (-1);
                                        $temp_value_adjusted = $child_array['child_array']['adjusted_value'] * (-1);
                                        $temp_value_ly       = $child_array['child_array']['company_end_prev_ye_value'] * (-1);
                                    }
                                    else
                                    {
                                        $temp_value          = $child_array['child_array']['value'];
                                        $temp_value_adjusted = $child_array['child_array']['adjusted_value'];
                                        $temp_value_ly       = $child_array['child_array']['company_end_prev_ye_value'];
                                    }

                                    // Display child without subcategory. 
                                    $variance_value = $this->calculate_variance($temp_value_adjusted, $temp_value_ly);
                                    // $temp_id = $child_array['child_array']['id'];
                                    //for adjustment column data if no child under it
                                    $temp_id         = $child_array['child_array']['id'];
                                    $temp_adjustment_info = isset($adjustment_data[$temp_id][0])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                    $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][0]['type_name'].$adjustment_data[$temp_id][0]['je_no']:"";

                                    $content .= '<tr>' . 
                                                    '<td style="width:'.$col_width['account_desc'].'%;">' . $child_array['child_array']['description'] . '</td>' .
                                                    '<td style="text-align:right;width:'.$col_width['value'].'%;">'. $this->negative_bracket($temp_value) .'</td>';
                                            if($temp_adjustment_info > 0)
                                            {
                                                $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                // $content .= 
                                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjustment_info).'</td>';
                                                $content .= 
                                                    '<td align="right"></td>';
                                            }
                                            else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                            {
                                                $content .= 
                                                    '<td align="right"></td>';
                                                // $content .= 
                                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>';
                                                $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';

                                            }
                                            else
                                            {
                                                $content .= 
                                                    '<td align="right"></td>';
                                                $content .= 
                                                    '<td align="right"></td>';
                                            }
                                    $content .=      '<td style="text-align:right;">'. $this->negative_bracket($temp_value_adjusted) .'</td>';

                                            if(!empty($last_fye_end))
                                            {
                                                $content .= '<td style="text-align:right;width:'.$col_width['value'].'%;">' . 
                                                                $this->negative_bracket($temp_value_ly);
                                                $content .= '</td>';
                                                $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>'; 


                                            }
    
                                    $content .= '</tr>';

                                    //loop all adjustment info
                                    if(isset($adjustment_data[$temp_id]) && count($adjustment_data[$temp_id]) > 1)
                                    {
                                        foreach ($adjustment_data[$temp_id] as $info_key => $each_info) {
                                            if($info_key != 0)
                                            {
                                                $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][$info_key]['adjust_value']:"";
                                                $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][$info_key]['type_name'].$adjustment_data[$temp_id][$info_key]['je_no']:"";
                                                $content .= '<tr>
                                                                <td></td>
                                                                <td></td>';
                                                if($temp_adjustment_info > 0)
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                    // $content .= 
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjustment_info).'</td>';
                                                    $content .= 
                                                        '<td align="right"></td>';
                                                }
                                                else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                                {
                                                    $content .= 
                                                        '<td align="right"></td>';
                                                    // $content .= 
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';

                                                }
                                                else
                                                {
                                                    $content .= 
                                                        '<td align="right"></td>';
                                                    $content .= 
                                                        '<td align="right"></td>';
                                                }
                                                $content .=  '</tr>';
                                            }
                                        }
                                        
                                    }

                                    $ref_index++;

                                    // total up 
                                    $temp_total          += $temp_value;
                                    $temp_total_adjusted += $temp_value_adjusted;
                                    $temp_total_ly       += $temp_value_ly;

                                    $counter ++;
                                }
                            
                            }

                            // show total for the category
                            if($check_existance || ucfirst(strtolower($main_category[0]['parent_array'][0]['description'])) == "Revenue")
                            {
                                $variance_value = $this->calculate_variance($temp_total, $temp_total_ly);
                                $content .= '<tr>' .
                                            '<td></td>' .
                                            '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                '<span>' . $this->negative_bracket($temp_total) . '</span>' .
                                            '</td>'.
                                            '<td></td>
                                            <td></td>'.
                                            '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                '<span>' . $this->negative_bracket($temp_total_adjusted) . '</span>' .
                                            '</td>';

                                        if(!empty($last_fye_end))
                                        {
                                            $content .= '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' . 
                                                            '<span>' . $this->negative_bracket($temp_total_ly) . '</span>' . 
                                                        '</td>';
                                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';   
                                        }

                                $content .= '</tr>';
                            }

                        }
                        /* END OF If there are subs under main category */

                        if(isset($main_category['child_array']))
                        {
                            if($main_account_description == "Income" || (count($main_category['child_array']) == 0))
                            {
                                $content .= '<tr><td colspan="0">&nbsp;</td></tr>';
                            }
                        }
                        

                        if($main_account_description == "Revenue")
                        {
                            $total_revenue_current          = $temp_total;
                            $total_revenue_current_adjusted = $temp_total_adjusted;
                            $total_revenue_current_ly       = $temp_total_ly;
                        }
                        elseif($main_account_description == "Cost of Sales")
                        {
                            $total_cost_of_sale_current          = $temp_total;
                            $total_cost_of_sale_current_adjusted = $temp_total_adjusted;
                            $total_cost_of_sale_current_ly       = $temp_total_ly;
                        }
                        elseif($main_account_description == "Income")
                        {
                            $total_other_income          = $temp_total;
                            $total_other_income_adjusted = $temp_total_adjusted;
                            $total_other_income_ly       = $temp_total_ly;
                        }

                        /* CALCULATE AND DISPLAY GROSS PROFIT */
                        if($main_account_description == "Cost of Sales" && ($revenue_exist || $cost_of_sales_exist))
                        {
                            $gross_profit          = $total_revenue_current - $total_cost_of_sale_current;
                            $gross_profit_adjusted = $total_revenue_current_adjusted - $total_cost_of_sale_current_adjusted;
                            $gross_profit_ly       = $total_revenue_current_ly - $total_cost_of_sale_current_ly;

                            $variance_value = $this->calculate_variance($gross_profit_adjusted, $gross_profit_ly);
                            $content .= '<tr>'.
                                            '<td><em>Gross Profit</em></td>' . 
                                            '<td style="text-align:right; border-bottom:1px solid black;">'. 
                                                $this->negative_bracket($gross_profit) .
                                            '</td>'.
                                            '<td></td>
                                            <td></td>'.
                                            '<td style="text-align:right; border-bottom:1px solid black;">'. 
                                                $this->negative_bracket($gross_profit_adjusted) .
                                            '</td>';
                                    if(!empty($last_fye_end))
                                    {
                                        $content .= '<td style="text-align:right; border-bottom:1px solid black;">'. 
                                                        '<span>' . $this->negative_bracket($gross_profit_ly) . '</span>' .
                                                    '</td>';
                                        $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                        $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                                    } 
                            $content .= '</tr>';

                            $content .= '<tr>' . 
                                    '<td>&nbsp;</td>'.
                                    '<td>&nbsp;</td>';
                                    if(!empty($last_fye_end))
                                    {
                                        $content .= '<td>&nbsp;</td>';
                                    }
                            $content .= '</tr>';
                        }
                        /* END OF CALCULATE AND DISPLAY GROSS PROFIT */
                    }

                     /* DISPLAY OPERATING EXPENSES */
                    $content .= '<tr>' . 
                                    '<td>&nbsp;</td>'.
                                    '<td>&nbsp;</td>';
                                    if(!empty($last_fye_end))
                                    {
                                        $content .= '<td>&nbsp;</td>';
                                    }
                    $content .= '</tr>';
                    $content .= '<tr>' .
                            '<td style="text-align:left;"><strong>Less: Operating expenses</strong></td>' . 
                            '<td class="total_operating_expenses"></td>';
                            if(!empty($last_fye_end))
                            {
                                $content .= '<td></td>';
                            }
                    $content .= '</tr>';

                    foreach($schedule_operating_expense_data[0]['child_array'] as $key => $value)
                    {
                        // print_r($value);

                        $temp_total          = 0.00;
                        $temp_total_adjusted = 0.00;
                        $temp_total_ly       = 0.00;

                        if(isset($value['parent_array']))
                        {
                            if(count($value['parent_array']) > 0)
                            {
                                $content .= 
                                    '<tr>' . 
                                        '<td><i>' . $value['parent_array'][0]['description'] . '</i></td>' .    // Description in Level 2
                                        '<td colspan="2"></td>' .
                                    '</tr>';

                                foreach ($value['child_array'] as $key2 => $details_data) 
                                {
                                    // print_r($details_data);


                                    if(isset($details_data['parent_array'])){
                                        if(count($details_data['parent_array']) > 0)
                                        {

                                            if(!isset($details_data['child_array'][0]['parent_array']))
                                            {
                                                if(isset($details_data['parent_array'][0]['total_c']))
                                                {
                                                    $temp_total          += $this->convert_string_to_number($details_data['parent_array'][0]['total_c']);
                                                    $temp_total_adjusted += $this->convert_string_to_number($details_data['parent_array'][0]['total_c_adjusted']);
                                                    $temp_total_ly       += $this->convert_string_to_number($details_data['parent_array'][0]['total_c_lye']);
                                                }
                                                $temp_total_c          = isset($details_data['parent_array'][0]['total_c'])?$details_data['parent_array'][0]['total_c']:0 ;
                                                $temp_total_c_adjusted = isset($details_data['parent_array'][0]['total_c_adjusted'])?$details_data['parent_array'][0]['total_c_adjusted']:0 ;
                                                $temp_total_c_lye      = isset($details_data['parent_array'][0]['total_c_lye'])?$details_data['parent_array'][0]['total_c_lye']:0 ;

                                                // echo 
                                                //  '<tr>' . 
                                                //      '<td>' . $details_data['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c']) . '</td>';
                                                //for adjustment column data if has child under it
                                                $temp_id         = $details_data['parent_array'][0]['id'];
                                                if(isset($details_data['parent_array'][0]['child_id']))
                                                {
                                                    $temp_adjustment_info = $this->get_adjustment_of_child($details_data['parent_array'][0]['child_id'], $adjustment_data);
                                                }
                                                else
                                                {
                                                    $temp_adjustment_info = [];
                                                }
                                                // $temp_adjustment_info = get_adjustment_of_child($details_data['parent_array'][0]['child_id'], $adjustment_data);
                                                $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                                $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                                $variance_value = $this->calculate_variance($temp_total_c_adjusted, $temp_total_c_lye);
                                                // $temp_id = $details_data['parent_array'][0]['id'];
                                                $content .= 
                                                    '<tr>' . 
                                                        '<td style="width:'.$col_width['account_desc'].'%;">' . $details_data['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                        '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($temp_total_c) . '</td>';
                                                if($temp_adjust_value > 0)
                                                {
                                                    $content .= 
                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                <table>
                                                                    <tr>
                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                        <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                    </tr>
                                                                </table>
                                                            </td>';
                                                    // $content .=  
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                                    $content .=  
                                                        '<td align="right"></td>';
                                                }
                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                {
                                                    $content .=  
                                                        '<td align="right"></td>';

                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                    // $content .=  
                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                                }
                                                else
                                                {
                                                    $content .=  
                                                        '<td align="right"></td>';
                                                    $content .=  
                                                        '<td align="right"></td>';
                                                }
                                                $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($temp_total_c_adjusted) . '</td>';

                                                if(!empty($last_fye_end))
                                                {
                                                    // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c_lye']) . '</td>';

                                                    $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($temp_total_c_lye) . '</td>';
                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                    $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                                                }
          
                                                $content .= '</tr>';

                                                //loop all adjustment info 
                                                if(count($temp_adjustment_info) > 1)
                                                {
                                                    foreach ($temp_adjustment_info as $info_key => $each_info) {
                                                        if($info_key != 0)
                                                        {
                                                            $temp_adjust_value = $each_info['adjusted_value'];
                                                            $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                                            $content .= '<tr>
                                                                            <td></td>
                                                                            <td></td>';
                                                            if($temp_adjust_value > 0)
                                                            {
                                                                // $content .= 
                                                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                                                $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                        <table>
                                                                            <tr>
                                                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>';
                                                                $content .= 
                                                                    '<td align="right"></td>';
                                                            }
                                                            else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                            {
                                                                $content .= 
                                                                    '<td align="right"></td>';
                                                                // $content .= 
                                                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';
                                                                 $content .= 
                                                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                        <table>
                                                                            <tr>
                                                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                            </tr>
                                                                        </table>
                                                                    </td>';
                                                            }
                                                            else
                                                            {
                                                                $content .= 
                                                                    '<td align="right"></td>';
                                                                $content .= 
                                                                    '<td align="right"></td>';
                                                            }
                                                            $content .=  '</tr>';
                                                        }
                                                    }
                                                    
                                                }

                                                $ref_index++;
                                            }
                                            else
                                            {
                                                $content .= 
                                                    '<tr>' .
                                                        '<td><b>' . $details_data['parent_array'][0]['description'] . ':</b></td>' .    // Description in level 3 (have sub)
                                                        '<td colspan="8"></td>
                                                    </tr>';
                                            }

                                            foreach ($details_data['child_array'] as $key3 => $details_data_child) 
                                            {
                                                if(isset($details_data_child['parent_array']) && count($details_data_child['parent_array']) > 0)
                                                {
                                                    if(isset($details_data_child['parent_array'][0]['total_c']))
                                                    {
                                                        $temp_total          += $this->convert_string_to_number($details_data_child['parent_array'][0]['total_c']);
                                                        $temp_total_adjusted += $this->convert_string_to_number($details_data_child['parent_array'][0]['total_c_adjusted']);
                                                        $temp_total_ly       += $this->convert_string_to_number($details_data_child['parent_array'][0]['total_c_lye']);
                                                    }
                                                    $temp_total_c          = isset($details_data_child['parent_array'][0]['total_c'])?$details_data_child['parent_array'][0]['total_c']:0 ;
                                                    $temp_total_c_adjusted = isset($details_data_child['parent_array'][0]['total_c_adjusted'])?$details_data_child['parent_array'][0]['total_c_adjusted']:0 ;
                                                    $temp_total_c_lye      = isset($details_data_child['parent_array'][0]['total_c_lye'])?$details_data_child['parent_array'][0]['total_c_lye']:0 ;

                                                    // echo 
                                                    //  '<tr>' . 
                                                    //      '<td>' . $details_data['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                    //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c']) . '</td>';
                                                    //for adjustment column data if has child under it
                                                    $temp_id         = $details_data_child['parent_array'][0]['id'];
                                                    if(isset($details_data_child['parent_array'][0]['child_id']))
                                                    {
                                                        $temp_adjustment_info = $this->get_adjustment_of_child($details_data_child['parent_array'][0]['child_id'], $adjustment_data);
                                                    }
                                                    else
                                                    {
                                                        $temp_adjustment_info = [];
                                                    }
                                                    // $temp_adjustment_info = get_adjustment_of_child($details_data['parent_array'][0]['child_id'], $adjustment_data);
                                                    $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                                    $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                                    $variance_value = $this->calculate_variance($temp_total_c_adjusted, $temp_total_c_lye);
                                                    // $temp_id = $details_data['parent_array'][0]['id'];
                                                    $content .= 
                                                        '<tr>' . 
                                                            '<td style="width:'.$col_width['account_desc'].'%;">- ' . $details_data_child['parent_array'][0]['description'] . '</td>' .    // Description in level 3 (have sub)
                                                            '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($temp_total_c) . '</td>';
                                                    if($temp_adjust_value > 0)
                                                    {
                                                        $content .= 
                                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                    <table>
                                                                        <tr>
                                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                        </tr>
                                                                    </table>
                                                                </td>';
                                                        // $content .=  
                                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                                        $content .=  
                                                            '<td align="right"></td>';
                                                    }
                                                    else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                    {
                                                        $content .=  
                                                            '<td align="right"></td>';

                                                        $content .= 
                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                <table>
                                                                    <tr>
                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                    </tr>
                                                                </table>
                                                            </td>';
                                                        // $content .=  
                                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                                    }
                                                    else
                                                    {
                                                        $content .=  
                                                            '<td align="right"></td>';
                                                        $content .=  
                                                            '<td align="right"></td>';
                                                    }
                                                    $content .= 
                                                            '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($temp_total_c_adjusted) . '</td>';

                                                    if(!empty($last_fye_end))
                                                    {
                                                        // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['parent_array'][0]['total_c_lye']) . '</td>';

                                                        $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($temp_total_c_lye) . '</td>';
                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                                                    }
              
                                                    $content .= '</tr>';

                                                    //loop all adjustment info 
                                                    if(count($temp_adjustment_info) > 1)
                                                    {
                                                        foreach ($temp_adjustment_info as $info_key => $each_info) {
                                                            if($info_key != 0)
                                                            {
                                                                $temp_adjust_value = $each_info['adjusted_value'];
                                                                $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                                                $content .= '<tr>
                                                                                <td></td>
                                                                                <td></td>';
                                                                if($temp_adjust_value > 0)
                                                                {
                                                                    // $content .= 
                                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket($temp_adjust_value).'</td>';
                                                                    $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                            <table>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                                </tr>
                                                                            </table>
                                                                        </td>';
                                                                    $content .= 
                                                                        '<td align="right"></td>';
                                                                }
                                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                                {
                                                                    $content .= 
                                                                        '<td align="right"></td>';
                                                                    // $content .= 
                                                                    //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.negative_bracket(abs($temp_adjust_value)).'</td>';
                                                                     $content .= 
                                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                            <table>
                                                                                <tr>
                                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                                </tr>
                                                                            </table>
                                                                        </td>';
                                                                }
                                                                else
                                                                {
                                                                    $content .= 
                                                                        '<td align="right"></td>';
                                                                    $content .= 
                                                                        '<td align="right"></td>';
                                                                }
                                                                $content .=  '</tr>';
                                                            }
                                                        }
                                                        
                                                    }

                                                    $ref_index++;
                                                }

                                            }

                                        }
                                    }
                                    else
                                    {
                                        $temp_total          += $this->convert_string_to_number($details_data['child_array']['value']);
                                        $temp_total_adjusted += $this->convert_string_to_number($details_data['child_array']['adjusted_value']);
                                        $temp_total_ly       += $this->convert_string_to_number($details_data['child_array']['company_end_prev_ye_value']);

                                        // echo 
                                        //  '<tr>' . 
                                        //      '<td>' . $details_data['child_array']['description'] . '</td>' .    // Description in level 3 (no sub)
                                        //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['child_array']['value']) . '</td>';

                                        //for adjustment column data if no child under it
                                        $temp_id         = $details_data['child_array']['id'];
                                        $temp_adjustment_info = isset($adjustment_data[$temp_id][0])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                        $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][0]['type_name'].$adjustment_data[$temp_id][0]['je_no']:""; 

                                        $variance_value = $this->calculate_variance($details_data['child_array']['adjusted_value'], $details_data['child_array']['company_end_prev_ye_value']);
                                        // $temp_id = $details_data['child_array']['id'];

                                        $content .= 
                                            '<tr>' . 
                                                '<td style="width:'.$col_width['account_desc'].'%;">' . $details_data['child_array']['description'] . '</td>' .    // Description in level 3 (no sub)
                                                '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($details_data['child_array']['value']) . '</td>';
                                        if($temp_adjustment_info > 0)
                                        {
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjustment_info).'</td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                        {
                                            $content .= 
                                                '<td align="right"></td>';

                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>';
                                        }
                                        else
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($details_data['child_array']['adjusted_value']) . '</td>';

                                        if(!empty($last_fye_end))
                                        {
                                            // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($details_data['child_array']['company_end_prev_ye_value']) . '</td>';

                                            $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' . $this->negative_bracket($details_data['child_array']['company_end_prev_ye_value']) . '</td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';    
                                        }

      
                                        $content .= '</tr>';  

                                        //loop all adjustment info
                                        if(isset($adjustment_data[$temp_id]) && count($adjustment_data[$temp_id]) > 1)
                                        {
                                            foreach ($adjustment_data[$temp_id] as $info_key => $each_info) {
                                                if($info_key != 0)
                                                {
                                                    $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][$info_key]['adjust_value']:"";
                                                    $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][$info_key]['type_name'].$adjustment_data[$temp_id][$info_key]['je_no']:"";
                                                    $content .= '<tr>
                                                                    <td></td>
                                                                    <td></td>';
                                                    if($temp_adjustment_info > 0)
                                                    {
                                                        // $content .= 
                                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjustment_info).'</td>';
                                                        $content .= 
                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                <table>
                                                                    <tr>
                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                        <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                                    </tr>
                                                                </table>
                                                            </td>';
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                    }
                                                    else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                                    {
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                        // $content .= 
                                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>';

                                                        $content .= 
                                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                                <table>
                                                                    <tr>
                                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                                    </tr>
                                                                </table>
                                                            </td>';
                                                    }
                                                    else
                                                    {
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                        $content .= 
                                                            '<td align="right"></td>';
                                                    }
                                                    $content .=  '</tr>';
                                                }
                                            }
                                            
                                        }

                                        $ref_index++;
                                    }

                                    // echo 
                                    //  '<tr>' . 
                                    //      '<td>' . $details_data['description'] . '</td>' .
                                    //      '<td style="text-align:right; ">'. negative_bracket($details_data['value']) .'</td>';

                                    // if(!empty($last_fye_end))
                                    // {
                                    //  echo '<td style="text-align:right;">' . negative_bracket($details_data['company_end_prev_ye_value']) . '</td>';

                                    //  $index++;   // for item in sub category.
                                    // }

                                    // echo '</tr>';
                                }

                                /* ---------------------- show total for the category ---------------------- */
                                // if(count($details['data']) > 0)
                                // {
                                    $variance_value = $this->calculate_variance($temp_total_adjusted, $temp_total_ly);
                                    $content .= 
                                        '<tr>' .
                                            '<td></td>' .
                                            '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                '<span>' . $this->negative_bracket($temp_total) . '</span>' .
                                            '</td>'.
                                            '<td></td>
                                            <td></td>'.
                                            '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' .
                                                '<span>' . $this->negative_bracket($temp_total_adjusted) . '</span>' .
                                            '</td>';

                                    if(!empty($last_fye_end))
                                    {
                                        $content .= '<td style="text-align:right; border-top:1px solid black; border-bottom:1px solid black;">' . 
                                                '<span>' . $this->negative_bracket($temp_total_ly) . '</span>' . 
                                            '</td>';
                                        $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                        $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                                    }

                                         
                                    $content .= '</tr>';
                                // }
                                

                                array_push($total, $temp_total);
                                array_push($total_adjusted, $temp_total_adjusted);
                                array_push($total_ly, $temp_total_ly);
                                /* ---------------------- END OF show total for the category ---------------------- */
                            }
                        }
                        else 
                        {
                            $temp_total          += $this->convert_string_to_number($value['child_array']['value']);
                            $temp_total_adjusted += $this->convert_string_to_number($value['child_array']['adjusted_value']);
                            $temp_total_ly       += $this->convert_string_to_number($value['child_array']['company_end_prev_ye_value']);

                            $content .= '<tr>' . 
                                    '<td colspan="10">&nbsp;</td>' . 
                                '</tr>';

                            // echo 
                            //  '<tr>' . 
                            //      '<td>' . $value['child_array']['description'] . '</td>' .   // Description in Level 2 (without child)
                            //      '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($value['child_array']['value']) . '</td>';
                            $variance_value = $this->calculate_variance($value['child_array']['adjusted_value'], $value['child_array']['company_end_prev_ye_value']);
                            // $temp_id = $value['child_array']['id'];

                            //for adjustment column data if no child under it
                            $temp_id         = $value['child_array']['id'];
                            $temp_adjustment_info = isset($adjustment_data[$temp_id][0])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                            $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][0]['type_name'].$adjustment_data[$temp_id][0]['je_no']:"";

                            $content .= 
                                '<tr>' . 
                                    '<td style="width:'.$col_width['account_desc'].'%;">' . $value['child_array']['description'] . '</td>' .   // Description in Level 2 (without child)
                                    '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($value['child_array']['value']) . '</td>';
                            if($temp_adjustment_info > 0)
                            {
                                // $content .=  
                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjustment_info).'</td>';
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                        <table>
                                            <tr>
                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                            </tr>
                                        </table>
                                    </td>';
                                $content .=  
                                    '<td align="right"></td>';
                            }
                            else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                            {
                                $content .=  
                                    '<td align="right"></td>';
                                // $content .=  
                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>';
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                        <table>
                                            <tr>
                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                            </tr>
                                        </table>
                                    </td>';
                            }
                            else
                            {
                                $content .=  
                                    '<td align="right"></td>';
                                $content .=  
                                    '<td align="right"></td>';
                            }
                            $content .= 
                                    '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($value['child_array']['adjusted_value']) . '</td>';

                            if(!empty($last_fye_end))
                            {
                                // echo '<td style="border-bottom:1px solid black; text-align: right;">' . negative_bracket($value['child_array']['company_end_prev_ye_value']) . '</td>';

                                $content .= '<td style="width:'.$col_width['value'].'%;text-align: right;">' .$this->negative_bracket($value['child_array']['company_end_prev_ye_value']) . '</td>';
                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                            }
          
                            $content .= '</tr>';

                            //loop all adjustment info
                            if(isset($adjustment_data[$temp_id]) && count($adjustment_data[$temp_id]) > 1)
                            {
                                foreach ($adjustment_data[$temp_id] as $info_key => $each_info) {
                                    if($info_key != 0)
                                    {
                                        $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][$info_key]['adjust_value']:"";
                                        $temp_je_no = $temp_adjustment_info != ""?$adjustment_data[$temp_id][$info_key]['type_name'].$adjustment_data[$temp_id][$info_key]['je_no']:"";
                                        $content .= '<tr>
                                                <td></td>
                                                <td></td>';
                                        if($temp_adjustment_info > 0)
                                        {
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjustment_info).'</td>';

                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjustment_info).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        else if($temp_adjustment_info < 0 && $temp_adjustment_info != "")
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjustment_info)).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                        }
                                        else
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        $content .=  '</tr>';
                                    }
                                }
                                
                            }

                            $ref_index++;

                            array_push($total, $temp_total);
                            array_push($total_adjusted, $temp_total_adjusted);
                            array_push($total_ly, $temp_total_ly);
                        }

                        
                    }

                    // calculate overall total
                    $total_operating_expenses_current    = 0.00;
                    $total_operating_expenses_adjustment = 0.00;
                    $total_operating_expenses_ly         = 0.00;
                    
                    foreach($total as $counter => $each_num)
                    {
                        $total_operating_expenses_current += $each_num;
                    }

                    foreach($total_adjusted as $counter => $each_num)
                    {
                        $total_operating_expenses_adjustment += $each_num;
                    }

                    foreach($total_ly as $counter => $each_num)
                    {
                        $total_operating_expenses_ly += $each_num;
                    }

                    $variance_value = $this->calculate_variance($total_operating_expenses_adjustment, $total_operating_expenses_ly);
                    $content .= '<tr>' .
                            '<td>Total operating expenses</td>' .
                            '<td style="text-align:right; border-top:1px solid black;border-bottom:1px solid black;">' . 
                                '<span>' . $this->negative_bracket($total_operating_expenses_current) . '</span>'.
                            '</td>'.
                            '<td></td>
                             <td></td>'.
                            '<td style="text-align:right; border-top:1px solid black;border-bottom:1px solid black;">' . 
                                '<span>' . $this->negative_bracket($total_operating_expenses_adjustment) . '</span>'.
                            '</td>';

                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<td style="text-align:right; border-top:1px solid black;border-bottom:1px solid black;">' . 
                                    '<span>' . $this->negative_bracket($total_operating_expenses_ly) . '</span>'.
                                '</td>';
                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';   
                            }
                       
                    $content .= '</tr>';
                    /* END OF DISPLAY OPERATING EXPENSES */

                    /* CALCULATE AND DISPLAY PROFIT BEFORE TAX */
                    $profit_before_tax          = ($total_revenue_current - $total_cost_of_sale_current) + $total_other_income - $total_operating_expenses_current;
                    $profit_before_tax_adjusted = ($total_revenue_current_adjusted - $total_cost_of_sale_current_adjusted) + $total_other_income_adjusted - $total_operating_expenses_adjustment;
                    $profit_before_tax_ly       = ($total_revenue_current_ly - $total_cost_of_sale_current_ly) + $total_other_income_ly - $total_operating_expenses_ly;

                    $variance_value = $this->calculate_variance($profit_before_tax_adjusted, $profit_before_tax_ly);
                    $content .= 
                    '<tr>' .
                        '<td style="text-align:left;">Profit before tax</td>' . 
                        '<td style="text-align:right; border-top:1px solid black;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($profit_before_tax) . 
                        '</td>'.
                        '<td></td>
                         <td></td>'.
                        '<td style="text-align:right; border-top:1px solid black;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($profit_before_tax_adjusted) . 
                        '</td>';
                        if(!empty($last_fye_end))
                        {
                            $content .= '<td style="text-align:right; border-top:1px solid black;">' . 
                                    // '<input type="hidden" name="profit_of_the_year_ly" value="'. $profit_of_the_year_ly .'">' .
                                    '<span>' . $this->negative_bracket($profit_before_tax_ly) . '</span>' .  
                                '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';  
                        }
                        
                    $content .= '</tr>';

                    /* END OF CALCULATE AND DISPLAY PROFIT BEFORE TAX */

                    // TAXATION 
                    $total_additional_company_ye          = 0.00;
                    $total_additional_company_ye_adjusted = 0.00;
                    $total_additional_company_lye         = 0.00;

                    foreach($tax_data[0] as $key => $value)
                    {
                        $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c_adjusted'], $value['parent_array'][0]['total_c_lye']);

                        $temp_id = $value['parent_array'][0]['id'];
                        $temp_adjustment_info = $this->get_adjustment_of_child($value['parent_array'][0]['child_id'], $adjustment_data);
                        $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                        $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                        $content .= 
                        '<tr>'.
                            '<td>'. $value['parent_array'][0]['description'] . '</td>'; 

                        $content .= 
                            // '<td align="right" class="taxation_company_ye">' . 
                            '<td align="right">' . 
                                $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                            '</td>';
                        if($temp_adjust_value > 0)
                        {
                            // $content .= 
                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';


                            $content .= 
                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                    <table>
                                        <tr>
                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                        </tr>
                                    </table>
                                </td>';
                            $content .= 
                                '<td align="right"></td>';
                        }
                        else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                        {
                            $content .= 
                                '<td align="right"></td>';
                            // $content .= 
                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                $content .= 
                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                    <table>
                                        <tr>
                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                        </tr>
                                    </table>
                                </td>';
                        }
                        else
                        {
                            $content .= 
                                '<td align="right"></td>';
                            $content .= 
                                '<td align="right"></td>';
                        }
                        $content .= '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c_adjusted']) . 
                                    '</td>';
                        
                        if(!empty($last_fye_end))
                        {
                            $content .=                            
                            '<td align="right">' . 
                                $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                            '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                        }
                        // else
                        // {
                        //     $content .= 
                        //     // '<td align="right" class="taxation_company_ye">' . 
                        //     '<td align="right" colspan="4">' . 
                        //         $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                        //     '</td>'.
                        //     '<td align="right">' . 
                        //         $this->negative_bracket($value['parent_array'][0]['total_c_adjusted']) . 
                        //     '</td>';
 
                        // }
 
                        $content .= '</tr>';

                        //loop all adjustment info 
                        if(count($temp_adjustment_info) > 1)
                        {
                            foreach ($temp_adjustment_info as $info_key => $each_info) {
                                if($info_key != 0)
                                {
                                    $temp_adjust_value = $each_info['adjusted_value'];
                                    $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                    $content .= '<tr>
                                                    <td></td>
                                                    <td></td>';
                                    if($temp_adjust_value > 0)
                                    {
                                        // $content .= 
                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                        $content .= 
                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                <table>
                                                    <tr>
                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                        <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                    </tr>
                                                </table>
                                            </td>';
                                        $content .= 
                                            '<td align="right"></td>';
                                    }
                                    else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                    {
                                        $content .= 
                                            '<td align="right"></td>';
                                        // $content .= 
                                        //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                        $content .= 
                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                <table>
                                                    <tr>
                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                    </tr>
                                                </table>
                                            </td>';
                                    }
                                    else
                                    {
                                        $content .= 
                                            '<td align="right"></td>';
                                        $content .= 
                                            '<td align="right"></td>';
                                    }
                                    $content .=  '</tr>';
                                }
                            }
                            
                        }

                        $ref_index++;
                    
                        $total_additional_company_ye          += (double)$value['parent_array'][0]['total_c'];
                        $total_additional_company_ye_adjusted += (double)$value['parent_array'][0]['total_c_adjusted'];
                        $total_additional_company_lye         += (double)$value['parent_array'][0]['total_c_lye'];
                    }
    
                 // END OF TAXATION 

                // SHARE OF ASSOCIATES PROFIT OR LOSS
                    $total_soa_pl_company_ye          = 0.00;
                    $total_soa_pl_company_ye_adjusted = 0.00;
                    $total_soa_pl_company_lye         = 0.00;

                    if(isset($soa_pl_list[0])){
                        foreach($soa_pl_list[0] as $key => $value)
                        {
                            $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c'], $value['parent_array'][0]['total_c_lye']);

                            $temp_id         = $value['parent_array'][0]['id'];
                            $temp_adjustment_info = $this->get_adjustment_of_child($value['parent_array'][0]['child_id'], $adjustment_data);
                            $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                            $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                            $content .= 
                            '<tr>'.
                                '<td>'. $value['parent_array'][0]['description'] . '</td>';
                            $content .= 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                '</td>';

                            if($temp_adjust_value > 0)
                            {
                                // $content .= 
                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                        <table>
                                            <tr>
                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                            </tr>
                                        </table>
                                    </td>';
                                $content .= 
                                    '<td align="right"></td>';
                            }
                            else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                            {
                                $content .= 
                                    '<td align="right"></td>';
                                // $content .= 
                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                $content .= 
                                            '<td style="width:'.$col_width['value'].'%;" align="right">
                                                <table>
                                                    <tr>
                                                        <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                    </tr>
                                                </table>
                                            </td>';
                            }
                            else
                            {
                                $content .= 
                                    '<td align="right"></td>';
                                $content .= 
                                    '<td align="right"></td>';
                            }

                            $content .= '<td align="right">' . 
                                            $this->negative_bracket($value['parent_array'][0]['total_c_adjusted']) . 
                                        '</td>' ;


                            if(!empty($last_fye_end))
                            {
                                $content .=
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                                '</td>';
                                $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                            }
                            // else
                            // {
                            //     $content .= 
                            //     '<td align="right" colspan="2">' . 
                            //         $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                            //     '</td>'.
                            //     '<td align="right">' . 
                            //         $this->negative_bracket($value['parent_array'][0]['total_c_adjusted']) . 
                            //     '</td>';
                                
                            // }

                            $content .= '</tr>';

                            //loop all adjustment info 
                            if(count($temp_adjustment_info) > 1)
                            {
                                foreach ($temp_adjustment_info as $info_key => $each_info) {
                                    if($info_key != 0)
                                    {
                                        $temp_adjust_value = $each_info['adjusted_value'];
                                        $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                        $content .= '<tr>
                                                <td></td>
                                                <td></td>';
                                        if($temp_adjust_value > 0)
                                        {
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                        }
                                        else
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        $content .=  '</tr>';
                                    }
                                }
                                
                            }

                            $ref_index++;

                            $total_soa_pl_company_ye          += (double)$value['parent_array'][0]['total_c'];
                            $total_soa_pl_company_ye_adjusted += (double)$value['parent_array'][0]['total_c_adjusted'];
                            $total_soa_pl_company_lye         += (double)$value['parent_array'][0]['total_c_lye'];
                        }
                    }
                 // END OF SHARE OF ASSOCIATES PROFIT OR LOSS

                 // CALCULATE PROFIT AFTER TAX
                    $profit_after_tax          = $profit_before_tax + $total_additional_company_ye + $total_soa_pl_company_ye;
                    $profit_after_tax_adjusted = $profit_before_tax_adjusted + $total_additional_company_ye_adjusted + $total_soa_pl_company_ye_adjusted;
                    $profit_after_tax_ly       = $profit_before_tax_ly + $total_additional_company_lye + $total_soa_pl_company_lye;

                    $variance_value = $this->calculate_variance($profit_after_tax_adjusted, $profit_after_tax_ly);
                    $content .= 
                    '<tr>' .
                        '<td style="text-align:left;">Profit after tax</td>' . 
                        '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($profit_after_tax) . 
                        '</td>'.
                        '<td></td>
                         <td></td>'.
                        '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($profit_after_tax_adjusted) . 
                        '</td>';
                        if(!empty($last_fye_end))
                        {
                            $content .= '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                                    // '<input type="hidden" name="profit_of_the_year_ly" value="'. $profit_of_the_year_ly .'">' .
                                    '<span>' . $this->negative_bracket($profit_after_tax_ly) . '</span>' .  
                                '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                        }
                         
                    $content .= '</tr>';

                    $content .= '<tr><td colspan="15">&nbsp;</td></tr>';
                // END OF CALCULATE PROFIT AFTER TAX

                    // DIVIDEND 
                    $total_dividend_company_ye          = 0.00;
                    $total_dividend_company_ye_adjusted = 0.00;
                    $total_dividend_company_lye         = 0.00;
                    
                    if (count($div_data))
                    {

                        foreach($div_data[0] as $key => $value)
                        {
                            $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c_adjusted'], $value['parent_array'][0]['total_c_lye']);

                            $temp_id = $value['parent_array'][0]['id'];
                            $temp_adjustment_info = $this->get_adjustment_of_child($value['parent_array'][0]['child_id'], $adjustment_data);
                            $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                            $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                            $content .= 
                            '<tr>'.
                                '<td>'. $value['parent_array'][0]['description'] . '</td>'; 

                            $content .= 
                                // '<td align="right" class="taxation_company_ye">' . 
                                '<td align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                                '</td>';
                            if($temp_adjust_value > 0)
                            {
                                // $content .= 
                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';


                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                        <table>
                                            <tr>
                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                            </tr>
                                        </table>
                                    </td>';
                                $content .= 
                                    '<td align="right"></td>';
                            }
                            else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                            {
                                $content .= 
                                    '<td align="right"></td>';
                                // $content .= 
                                //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                    $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right">
                                        <table>
                                            <tr>
                                                <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                            </tr>
                                        </table>
                                    </td>';
                            }
                            else
                            {
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                            }
                            $content .= '<td align="right">' . 
                                            $this->negative_bracket($value['parent_array'][0]['total_c_adjusted']) . 
                                        '</td>';
                            
                            if(!empty($last_fye_end))
                            {
                                $content .=                            
                                '<td style="width:'.$col_width['value'].'%;" align="right">' . 
                                    $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                                '</td>';
                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                            }
                            
    
                            $content .= '</tr>';

                            //loop all adjustment info 
                            if(count($temp_adjustment_info) > 1)
                            {
                                foreach ($temp_adjustment_info as $info_key => $each_info) {
                                    if($info_key != 0)
                                    {
                                        $temp_adjust_value = $each_info['adjusted_value'];
                                        $temp_je_no = $each_info['type_name'].$each_info['je_no'];
                                        $content .= '<tr>
                                                        <td></td>
                                                        <td></td>';
                                        if($temp_adjust_value > 0)
                                        {
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket($temp_adjust_value).'</td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            // $content .= 
                                            //     '<td align="right"><span style="float:left"><strong>'.$temp_je_no.'</strong></span>'.$this->negative_bracket(abs($temp_adjust_value)).'</td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                        }
                                        else
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        $content .=  '</tr>';
                                    }
                                }
                                
                            }

                            $ref_index++;
                        
                            $total_dividend_company_ye          += (double)$value['parent_array'][0]['total_c'];
                            $total_dividend_company_ye_adjusted += (double)$value['parent_array'][0]['total_c_adjusted'];
                            $total_dividend_company_lye         += (double)$value['parent_array'][0]['total_c_lye'];
                        }
                    }
    
                    // END OF DIVIDEND 

                    // RETAINED EARNINGS B/F 
                    $total_bf_company_ye          = 0.00;
                    $total_bf_company_ye_adjusted = 0.00;
                    $total_bf_company_lye         = 0.00;

                    foreach($bf_data[0] as $key => $value)
                    {
                        $variance_value = $this->calculate_variance($value['parent_array'][0]['total_c_adjusted'], $value['parent_array'][0]['total_c_lye']);

                        $temp_id = $value['parent_array'][0]['id'];
                       

                        $content .= 
                        '<tr>'.
                            '<td>Retained earnings b/f</td>'; 

                        $content .= 
                            // '<td align="right" class="taxation_company_ye">' . 
                            '<td align="right">' . 
                                $this->negative_bracket($value['parent_array'][0]['total_c']) . 
                            '</td>';
                  
                        $content .= 
                            '<td align="right"></td>';
                        $content .= 
                            '<td align="right"></td>';
                        
                        $content .= '<td align="right">' . 
                                        $this->negative_bracket($value['parent_array'][0]['total_c_adjusted']) . 
                                    '</td>';
                        
                        if(!empty($last_fye_end))
                        {
                            $content .=                            
                            '<td align="right">' . 
                                $this->negative_bracket($value['parent_array'][0]['total_c_lye']) .
                            '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                        }
                        
 
                        $content .= '</tr>';


                        $ref_index++;
                    
                        $total_bf_company_ye          += (double)$value['parent_array'][0]['total_c'];
                        $total_bf_company_ye_adjusted += (double)$value['parent_array'][0]['total_c_adjusted'];
                        $total_bf_company_lye         += (double)$value['parent_array'][0]['total_c_lye'];
                    }
    
                    // END OF RETAINED EARNINGS B/F 

                     // CALCULATE RETAINED EARNINGS C/F 
                    $retained_earning_cf           = $profit_after_tax + $total_dividend_company_ye + $total_bf_company_ye;
                    $retained_earning_cf_adjusted  = $profit_after_tax_adjusted + $total_dividend_company_ye_adjusted + $total_bf_company_ye_adjusted;
                    $retained_earning_cf_ly        = $profit_after_tax_ly + $total_dividend_company_lye + $total_bf_company_lye;

                    $variance_value = $this->calculate_variance($retained_earning_cf_adjusted, $retained_earning_cf_ly);
                    $content .= 
                    '<tr>' .
                        '<td style="text-align:left;">Retained earnings c/f</td>' . 
                        '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($retained_earning_cf) . 
                        '</td>'.
                        '<td></td>
                         <td></td>'.
                        '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                            // '<input type="hidden" name="profit_of_the_year" value="'. $profit_of_the_year .'">' .
                            $this->negative_bracket($retained_earning_cf_adjusted) . 
                        '</td>';
                        if(!empty($last_fye_end))
                        {
                            $content .= '<td style="text-align:right; border-top:1px solid black;border-bottom-style: double; border-bottom-width: 2px;">' . 
                                    // '<input type="hidden" name="profit_of_the_year_ly" value="'. $profit_of_the_year_ly .'">' .
                                    '<span>' . $this->negative_bracket($retained_earning_cf_ly) . '</span>' .  
                                '</td>';
                            $content .= '<td align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                            $content .= '<td align="center">'.number_format($variance_value['percentage'], 2).'%</td>'; 
                        }
                         
                    $content .= '</tr>';
                    // END OF CALCULATE RETAINED EARNINGS C/F 


        $content .= '</tbody>
                    </table>';

        // echo $content;

        $obj_pdf->writeHTML($content, true, false, false, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C6_PL_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/C6_PL_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/C6_PL_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));  
           
    }

    public function export_programme_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);


        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);
        $programme_objective_lines = $this->setting_model->get_objective_lines($programme_master_id);
        $programme_procedure_lines = $this->caf_model->get_procedure_lines($programme_master_id, $caf_id);
        $programme_content         = $this->caf_model->get_programme_content($programme_master_id, $caf_id);
        $programme_conclusion      = $this->caf_model->get_programme_conclusion($caf_id);

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 20);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">

                    .table-borderless > tbody > tr > td,
                    .table-borderless > tbody > tr > th,
                    .table-borderless > tfoot > tr > td,
                    .table-borderless > tfoot > tr > th,
                    .table-borderless > thead > tr > td,
                    .table-borderless > thead > tr > th 
                    {
                        border: none;
                    }

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
                        font-style: italic;
                        font-weight: bold; 
                    }

                    .checkmark
                    {
                         text-align:center;
                         font-family:dejavusans;
                         font-size:12px;
                    }

                    .gray-bg
                    {
                        background-color:#F9F9F9;
                    }

                    .header_table
                    {
                        font-size: 12px;
                    }


                    </style>';

        $content .= '<table class="table header_table" style="border-collapse: collapse;width: 95%; color:black">
                        <tr>
                            <td colspan="3"><b>AUDIT PROGRAMME - '.(isset($programme_master_detail->title)?strtoupper($programme_master_detail->title):'').'</b>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="3">
                                <p style="color:black;font-size: 10px;"><b><u>SUMMARY SHEET</u></b></p>
                            </td>
                        </tr>
                        <tr>
                            <td width="5%;">
                                <p style="color:black;font-size: 10px;"><b>I.</b></p>
                            </td>
                            <td width="95%;" colspan="2">
                                <p style="color:black;font-size: 10px;"><b>AUDIT OBJECTIVES</b></p>
                            </td>
                        </tr>
                    </table>

                    <table class="table" cellpadding="4" style="border-collapse: collapse;width: 95%; color:black">

                        <tr>
                            <td width="75%;" colspan="2">
                            </td>
                            <td class="text-center custom-header" width="19%;">
                                Assertions
                            </td>
                        </tr>';

        if($programme_objective_lines)
        {
            foreach($programme_objective_lines as $key => $line)
            {
                $content .= '<tr>';
                    $content .= '<td width="5%;" class="text-left">'.($key + 1).'. </td>';
                    $content .= '<td width="70%;" style="text-align:left;">'.$line->objective_text.'</td>';
                    $content .= '<td width="19%;" style="text-align:center;border:1px solid black;">'
                            .$line->assertion_text.
                                '</td>';
                $content .= '</tr>';
            }
        }


        $content .= '</table>
                     <br pagebreak="true" />';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">
                        <tr>
                            <td width="5%;">
                                <p style="color:black;font-size: 10px;"><b>II.</b></p>
                            </td>
                            <td width="89%;" colspan="4">
                                <p style="color:black;font-size: 10px;"><b>AUDIT PROCEDURE DESIGN CONSIDERATIONS</b></p>
                            </td>
                        </tr>
                    </table>
                    <table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">

                        <tr>
                            <td width="60%;" colspan="2">
                            </td>
                            <td class="text-center custom-header" width="7%;">
                                Yes
                            </td>
                             <td class="text-center custom-header" width="7%;">
                                No
                            </td>
                             <td class="text-center custom-header" width="20%;">
                                Comments
                            </td>
                        </tr>
                        <tr>
                            <td width="5%;">
                            </td>
                            <td width="55%;">
                                For risks indentified perform the audit procedures.
                            </td>
                            <td class="text-center black-bg" width="7%;">
                            
                            </td>
                             <td class="text-center black-bg" width="7%;">
                            
                            </td>
                             <td class="text-center bordered-cell"  width="20%;">
                                
                            </td>
                        </tr>
                        <tr>
                            <td colspan="5">
                                <br>
                            </td>
                        </tr>';

        if($programme_procedure_lines)
        {
            // print_r($programme_procedure_lines);
            foreach($programme_procedure_lines as $key => $line)
            {
                
                if(isset($line->yn_value))
                {
                    $yes_checked = $line->yn_value==1?"&#10003;":"";
                    $no_checked  = $line->yn_value==0?"&#10003;":"";
                }
                else
                {
                    $yes_checked = "";
                    $no_checked  = "";
                }

                $content .= '<tr>';
                    
                    $content .= '<td width="5%;"></td>';
                    $content .= '<td width="55%;" style="text-align:left;">'.$line->step_text.'</td>';
                    $content .= '<td class="text-center bordered-cell checkmark" width="7%;">
                            '.$yes_checked.'
                          </td>
                          <td class="text-center bordered-cell checkmark" width="7%;">
                            '.$no_checked.'
                          </td>
                          <td class="text-center bordered-cell" width="20%;">'.(isset($line->comment)?$line->comment:"").'</td>';
                $content .= '</tr>';

                if(isset($line->child_text) && count($line->child_text) > 0)
                {
                    $content .= '<tr>
                            <td></td>
                            <td class="gray-bg" colspan="4">
                                <ul>';
                    foreach ($line->child_text as $child_key => $each_child) 
                    {
                        $content .= '<li><i>'.$each_child.'</i></li>';
                    }

                    $content .= '</ul>
                            </td>
                         </tr>';
                }

                $content .= '<br/>';
            }
        }

        $content .= '</table>';

        $content .= '<br/>
                    <table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 95%; color:black" nobr="true">
                        <tr>
                            <td width="5%;">
                                <p style="color:black;font-size: 10px;"><b>III.</b></p>
                            </td>
                            <td width="86%;" colspan="2">
                                <p style="color:black;font-size: 10px;"><b>PLANNING CONCLUSION</b></p>
                            </td>
                        </tr>
                        <br/>
                        <tr>
                            <td>
                            </td>';

                        if(isset($programme_conclusion['pc_yes_selected']))
                        {
                            if($programme_conclusion['pc_yes_selected'] == "selected")
                            {
                                $planning_conclusion_input = "satisfied";
                            }
                            
                        }

                        if(isset($programme_conclusion['pc_no_selected']))
                        {
                            if($programme_conclusion['pc_no_selected'] == "selected")
                            {
                                $planning_conclusion_input = "not satisfied";
                            }
                            
                        }
        $content .=         '<td class="text-left" colspan="2">I am '.$planning_conclusion_input.' from the planned tests, sufficient appropriate evidence can be obtained to neet the audit objectives.
                            </td>
                        
                        </tr>
                        <br/><br/>
                        <tr>
                            <td></td>
                            <td width="58%">Prepared by: &nbsp;  ____________________________________</td>
                            <td width="32%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
                            <td></td>
                            <td width="58%">Reviewed by:   _____________________________________</td>
                            <td width="32%">Date:_______________________</td>
                        </tr>
                    </table>
                    <br pagebreak="true" />';

        $content .= '<table class="table header_table" style="border-collapse: collapse;width: 95%; color:black">
                        <tr>
                            <td colspan="3"><b>AUDIT PROGRAMME - '.(isset($programme_master_detail->title)?strtoupper($programme_master_detail->title):'').'</b>
                            </td>
                        </tr>
                    </table>
                    <p>&nbsp;</p>';

        $content .= '<table class="table table-borderless"  cellpadding="4" style="border-collapse: collapse; width: 95%; color:black">';

        if($programme_content)
        {
            $l1_index = 'A';
            foreach($programme_content as $l1_key => $level_1)
            {
                $content .= '<tr class="content_main_line">';
                    $content .= '<td width="9%;" class="text-left">'.$l1_index.'. </td>';
                    $content .= '<td width="85%;" style="text-align:left;">'.$level_1['text'].'</td>';
                $content .= '</tr>';

                $l1_index++;

                $l2_index = 1;
                if(count($level_1['child']) > 0)
                {
                    foreach ($level_1['child'] as $l2_key => $level_2) {
                        $content .= '<tr>';
                            $content .= '<td width="9%;" class="text-left">'.$l2_index.' </td>';
                            $content .= '<td width="85%;" style="text-align:left;">'.$level_2['text'].'</td>';
                        $content .= '</tr>';

                        $l2_index++;

                        $l3_index = 'a';
                        if(count($level_2['child']) > 0)
                        {
                            $content .= '<tr>';
                                    $content .= '<td width="9%;" class="text-left"></td>';
                                    $content .= '<td width="85%;" style="text-align:left;padding:0;">';
                                    $content .=    '<table class="table table-borderless" cellpadding="4" width="100%;" >'; 
                            foreach ($level_2['child'] as $l3_key => $level_3) {
                                 
                                $content .=    '<tr>
                                            <td class="borderless text-center" width="9%;">('.$l3_index.')
                                                
                                            </td>
                                            <td class="borderless text-left" width="84%;">'
                                                .$level_3['text'].
                                            '</td>
                                        </tr>';
                                

                                $l3_index++;

                                $l4_index = 1;
                                if(count($level_3['child']) > 0)
                                {
                                    $content .= '<tr>';
                                            $content .= '<td width="9%;" class="text-left"></td>';
                                            $content .= '<td width="85%;" style="text-align:left;padding:0;"><table class="table table-borderless" cellpadding="4" style="width:100%;" >';
                                                       
                                    foreach ($level_3['child'] as $l4_key => $level_4) {
                                         
                                        $content .= '<tr>
                                                    <td class="borderless text-center" style="width:9%;">('.strtolower($this->numberToRomanRepresentation($l4_index)).')
                                                        
                                                    </td>
                                                    <td class="borderless text-left" style="width:84%;">'
                                                        .$level_4['text'].
                                                    '</td>
                                                </tr>';
                                        

                                        $l4_index++;
                                    }

                                    $content .=    '</table>
                                            </td>';
                                    $content .= '</tr>';

                                }
                            }

                            $content .=    '</table>
                                          </td>';
                            $content .= '</tr>';
                        }
                    }
                }
            }
        }

        $content .= '</table>
                     <br pagebreak="true" />';

        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">
                        <tr>
                            <td width="5%;">
                                <p style="color:black;font-size: 10px;"><b>IV.</b></p>
                            </td>
                            <td width="89%;">
                                <p style="color:black;font-size: 10px;"><b>CONCLUSION</b></p>
                            </td>
                        </tr>

                        <tr>
                            <td>
                                1.
                            </td>
                            <td class="text-left">There are no exceptions in our response to the risks identified.</td>
                        
                        </tr>

                        <tr>
                            <td>
                                2.
                            </td>
                            <td class="text-left">The work has been performed as planned and the findings and results have been adequately documented.</td>
                        
                        </tr>

                        <tr>
                            <td>
                                3.
                            </td>
                            <td class="text-left">There are no additional comments to be included in the letter of representation or letter of comment. Where applicable, the planned extend of reliance on internal controls in this area remains appropriate.</td>
                        
                        </tr>

                        <tr>
                            <td>
                                4.
                            </td>
                            <td class="text-left">All necessary information has been obtained for the presentation and disclosure in the financial statements.</td>
                        
                        </tr>

                        <tr>
                            <td>
                                5.
                            </td>
                            <td class="text-left">Misstatements identified (other than those deemed to be clearly trivial) have been recorded.</td>
                        
                        </tr>

                        <tr>
                            <td>
                                6.
                            </td>
                            <td class="text-left">Initial materiality and/or risk assessment need not be revised in view of the audit evidence obtained.</td>
                        
                        </tr>';

                    if(isset($programme_conclusion['c_yes_selected']))
                    {
                        if($programme_conclusion['c_yes_selected'] == "selected")
                        {
                            $conclusion_input = "has been";
                        }
                        
                    }

                    if(isset($programme_conclusion['c_no_selected']))
                    {
                        if($programme_conclusion['c_no_selected'] == "selected")
                        {
                            $conclusion_input = "has not been";
                        }
                        
                    }

    $content .=         '<tr>
                            <td style="vertical-align:middle;">
                                7.
                            </td>
                            <td class="text-left">Sufficient appropriate evidence '.$conclusion_input.' obtained to support the audit objectives.</td>
                        
                        </tr>
                        
                        <br/><br/>
                        <tr>
                            <td></td>
                            <td width="58%">Prepared by: &nbsp;  _____________________________________</td>
                            <td width="32%">Date:______________________</td>

                        </tr>
                        <br/>
                         <tr>
                            <td></td>
                            <td width="58%">Reviewed by:  _____________________________________</td>
                            <td width="32%">Date:______________________</td>
                        </tr>
                        
                    </table>';

        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_yn_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);


        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);
        $programme_content         = $this->caf_model->get_programme_content($programme_master_id, $caf_id);
        $y_n_na_dropdown           = array('Yes', 'No', 'N/A');
        $y_n_na_dropdown[""]       = "";

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">

                    .table-borderless > tbody > tr > td,
                    .table-borderless > tbody > tr > th,
                    .table-borderless > tfoot > tr > td,
                    .table-borderless > tfoot > tr > th,
                    .table-borderless > thead > tr > td,
                    .table-borderless > thead > tr > th 
                    {
                        /* border: none;*/
                        border: 1px solid black;
                    }

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
                        font-style: italic;
                        font-weight: bold; 
                    }

                    .first_level .y_n_td,
                    .first_level .review_td
                    {
                        border-top: 1px solid black;
                    }

                    .text-center
                    {
                        text-align:center;
                    }

                    .header_table
                    {
                        font-size: 12px;
                    }

                    </style>';

        $content .= '<table class="table header_table" style="border-collapse: collapse;width: 95%; color:black" border="0">
                        <tr>
                            <td colspan="3" style="font-size: 12px;"><b>AUDIT PROGRAMME - '.(isset($programme_master_detail->title)?strtoupper($programme_master_detail->title):'').'</b>
                            </td>
                        </tr>
                    </table>

                    <table class="table" cellpadding="4" style="border-collapse: collapse;width: 95%; color:black">

                        <thead>
                            <tr>
                                <td width="100%;" colspan="6"></td> 
                            </tr>
                            <tr>
                                
                                <th width="64%;" colspan="4"></th>
                                <th width="13%;" class="custom-header">
                                    Y/N/NA
                                </th>
                                <th width="17%;" class="custom-header">
                                    Remark
                                </th>

                            </tr>
                        </thead>';



        if($programme_content)
        {
            $l1_index = '1';
            foreach($programme_content as $l1_key => $level_1)
            {
                

                $content .= '<tr class="group-'.$level_1['id'].' first_level">';
                    $content .= '<td width="6%;" class="text-left">'.$l1_index.'. </td>';
                    $content .= '<td width="58%;" colspan="3" style="text-align:left;">'.$level_1['text'].'</td>';
                    $content .= '<td width="13%;" style="border-left:1px solid black;border-right:1px solid black;" class="y_n_td text-center">';
                    $content .= $y_n_na_dropdown[(isset($level_1['yn_value'])?$level_1['yn_value']:"")];
                    $content .= '</td>';
                    $content .= '<td class="review_td" width="17%;" style="border-left:1px solid black;border-right:1px solid black;text-align:left;">'.(isset($level_1['remark'])?$level_1['remark']:"").'</td>';
                $content .= '</tr>';

                $l1_index++;

                $l2_index = 'a';
                if(count($level_1['child']) > 0)
                {
                    foreach ($level_1['child'] as $l2_key => $level_2) {
                        // $content .= '<tr>';
                        //     $content .= '<td width="5%;" class="text-left">'.$l2_index.' </td>';
                        //     $content .= '<td width="95%;" style="text-align:left;">'.$level_2['text'].'</td>';
                        // $content .= '</tr>';

                        $content .= '<tr class="group-'.$level_1['id'].' second_gp-'.$level_2['id'].' second_level">';
                            $content .= '<td width="6%;"></td>';
                            $content .= '<td width="6%;" class="text-left">('.$l2_index.')</td>';
                            $content .= '<td width="52%;" colspan="2" style="text-align:left;">'.$level_2['text'].'</td>';
                            $content .= '<td width="13%;" style="border-left:1px solid black;border-right:1px solid black;" class=" y_n_td text-center">';
                            $content .= $y_n_na_dropdown[(isset($level_2['yn_value'])?$level_2['yn_value']:"")];
                            $content .= '</td>';
                            $content .= '<td class="review_td" width="17%;" style="border-left:1px solid black;border-right:1px solid black;text-align:left;">'.(isset($level_2['remark'])?$level_2['remark']:"").'</td>';
                        $content .= '</tr>';

                        $l2_index++;

                        $l3_index = '1';
                        if(count($level_2['child']) > 0)
                        {
                            // $content .= '<tr>';
                            //         $content .= '<td width="5%;" class="text-left"></td>';
                            //         $content .= '<td width="95%;" style="text-align:left;padding:0;">';
                            //         $content .=    '<table class="table table-borderless" cellpadding="4" width="100%;" >'; 
                            foreach ($level_2['child'] as $l3_key => $level_3) {
                                 
                                // $content .=    '<tr>
                                //             <td class="borderless text-center" width="5%;">('.$l3_index.')
                                                
                                //             </td>
                                //             <td class="borderless text-left" width="95%;">'
                                //                 .$level_3['text'].
                                //             '</td>
                                //         </tr>';


                                $content .= '<tr class="group-'.$level_1['id'].' second_gp-'.$level_2['id'].'">';
                                    $content .= '<td width="6%;"></td>';
                                    $content .= '<td width="6%;"></td>';
                                    $content .= '<td width="6%;" class="text-left">('.strtolower($this->numberToRomanRepresentation($l3_index)).')</td>';
                                    $content .= '<td width="46%;" style="text-align:left;">'.$level_3['text'].'</td>';
                                    $content .= '<td width="13%;"  style="border-left:1px solid black;border-right:1px solid black;" class="y_n_td text-center">';
                                    $content .= $y_n_na_dropdown[(isset($level_3['yn_value'])?$level_3['yn_value']:"")];
                                    $content .= '</td>';
                                    $content .= '<td class="review_td" width="17%;" style="border-left:1px solid black;border-right:1px solid black;text-align:left;">'.(isset($level_3['remark'])?$level_3['remark']:"").'</td>';
                                $content .= '</tr>';
                                

                                $l3_index++;

                        
                            
                            }

                            // $content .=    '</table>
                            //               </td>';
                            // $content .= '</tr>';
                        }
                    }
                }
            }

            $content .= '<tr>';
                    $content .= '<td width="6%;" class="text-left"></td>';
                    $content .= '<td width="58%;" colspan="3" style="text-align:left;"></td>';
                    $content .= '<td width="13%;" style="border-top:1px solid black;" class="text-center"></td>';
                    $content .= '<td width="17%;" style="border-top:1px solid black;text-align:left;"></td>';
            $content .= '</tr>';
        }

        $content .= '</table>';


        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black" nobr="true">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="62%">Prepared by: &nbsp;  ________________________________________</td>
                            <td width="33%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
    
                            <td width="62%">Reviewed by:  _________________________________________</td>
                            <td width="33%">Date:_______________________</td>
                        </tr>
                        
                    </table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_qa_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);


        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);
        $programme_question_lines  = $this->caf_model->get_question_lines($programme_master_id, $caf_id);
 

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 20);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">

                    .table-borderless > tbody > tr > td,
                    .table-borderless > tbody > tr > th,
                    .table-borderless > tfoot > tr > td,
                    .table-borderless > tfoot > tr > th,
                    .table-borderless > thead > tr > td,
                    .table-borderless > thead > tr > th 
                    {
                        /* border: none;*/
                        border: 1px solid black;
                    }

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
                        font-style: italic;
                        font-weight: bold; 
                    }

                    .first_level .y_n_td,
                    .first_level .review_td
                    {
                        border-top: 1px solid black;
                    }

                    </style>';

        $content .= '<table class="table" style="border-collapse: collapse;width: 95%; color:black">
                        <tr>
                            <td colspan="3"><b>AUDIT PROGRAMME - '.(isset($programme_master_detail->title)?strtoupper($programme_master_detail->title):'').'</b><
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>
                    </table>

                    <table class="table" cellpadding="4" style="border-collapse: collapse;width: 95%; color:black">';


                    if($programme_question_lines)
                    {
                        foreach($programme_question_lines as $key => $line)
                        {
                            $content .= '<tr>';
                                $content .= '<td class="text-left" width="6%">'.($key + 1).'. </td>';
                                $content .= '<td style="text-align:left;" width="88%">'.$line->question_text.'</td>';
                            $content .= '</tr>';
                            $content .= '<tr>';
                                $content .= '<td class="text-left" width="6%"></td>';
                                $content .= '<td style="text-align:left;border:1px solid black;" width="88%">'.nl2br((isset($line->answer_text)?$line->answer_text:"")).'</td>';
                            $content .= '</tr>';
                            $content .= '<tr>';
                                $content .= '<td class="text-left" width="6%"></td>';
                                $content .= '<td style="text-align:left;" width="88%"></td>';
                            $content .= '</tr>';
                        }
                    }
        

        $content .= '</table>';


        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="62%">Prepared by: &nbsp;  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
    
                            <td width="62%">Reviewed by:  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>
                        </tr>
                        
                    </table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_meeting_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);


        $data                      = $this->caf_model->get_meeting_master_detail($caf_id);
        $data['meeting_datetime']  = date('d/m/Y h:s a', strtotime($data['meeting_datetime']));
        $meeting_detail            = $data;

        $meeting_master_id         = $data['id'];
        $meeting_attendees         = $this->caf_model->get_meeting_attendees($meeting_master_id);
        $meeting_agenda            = $this->caf_model->get_meeting_agenda($meeting_master_id);
        $meeting_absent            = $this->caf_model->get_meeting_absent($meeting_master_id);

        foreach ($meeting_absent as $key => $value) {
            $meeting_absent[$key]['date_communicated'] = date('d/m/Y', strtotime($value['date_communicated']));
        }

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 20);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
                        font-style: italic;
                        font-weight: bold; 
                    }

                    .first_level .y_n_td,
                    .first_level .review_td
                    {
                        border-top: 1px solid black;
                    }

                    .header_table
                    {
                        font-size: 12px;
                    }

                    </style>';

        $content .= '<table class="table header_table" style="border-collapse: collapse;width: 95%; color:black">
                        <tr>
                            <td colspan="3"><b>AUDIT PROGRAMME - '.(isset($programme_master_detail->title)?strtoupper($programme_master_detail->title):'').'</b>
                            </td>
                        </tr>
                    </table>
                    <table class="table" style="border-collapse: collapse;width: 95%; color:black">
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>
                        <tr>
                            <td width="25%">Date and time of meeting:</td>
                            <td width="66%"colspan="2" style="border-bottom:1px solid black;">'.
                                (isset($meeting_detail['meeting_datetime'])?$meeting_detail['meeting_datetime']: "").'
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>
                         <tr>
                            <td width="25%">Location:</td>
                            <td width="66%"colspan="2" style="border-bottom:1px solid black;">'.
                                (isset($meeting_detail['location'])?$meeting_detail['location']: "").'
                            </td>
                        </tr>
                    </table>';

        $content .= '<table class="table" cellpadding="4" style="border-collapse: collapse;width: 95%; color:black">';

        $content .= '<tr>
                        <td colspan="3" style="padding-left:0;"></td>
                    </tr>
                    <tr>
                        <td colspan="3" style="padding-left:0;">Attendees at meeting:</td>
                    </tr>
                    <tr>
                        <td class="custom-header" width="45.5%">
                            Name
                        </td>
                        <td class="custom-header" width="45.5%">
                            Designation
                        </td>
          
                    </tr>';

                    if($meeting_attendees)
                    {
                        foreach($meeting_attendees as $key => $line)
                        {
                            $content .= '<tr>';
                                $content .= '<td class="bordered-cell">'.$line['attendees_name'].'</td>';
                                $content .= '<td class="bordered-cell">'.$line['attendees_designation'].'</td>';
                            $content .= '</tr>';
        
                        }
                    }

        $content .= '</table>';

        $content .= '<table class="table" cellpadding="4" style="border-collapse: collapse;width: 95%; color:black">';

        $content .= '<tr>
                        <td colspan="3" style="padding-left:0;"></td>
                    </tr>
                    <tr>
                        <td colspan="3" style="padding-left:0;">Suggested agenda topics for discussion with management and those charged with governance</td>
                    </tr>
                    <tr>
                        <td class="custom-header" width="45.5%">
                            Agenda
                        </td>
                        <td class="custom-header" width="45.5%">
                            Minutes of meeting
                        </td>
          
                    </tr>';

                    if($meeting_agenda)
                    {
                        foreach($meeting_agenda as $key => $line)
                        {
                            $content .= '<tr>';
                                $content .= '<td class="bordered-cell">'.$line['agenda_text'].'</td>';
                                $content .= '<td class="bordered-cell">'.$line['minutes_of_meeting'].'</td>';
                            $content .= '</tr>';
        
                        }
                    }

        $content .= '</table>';

        if($meeting_detail["absent_flag"] == 1)
        {
            $content .= '<table class="table" cellpadding="4" style="border-collapse: collapse;width: 95%; color:black">';

            $content .= '<tr>
                            <td colspan="3" style="padding-left:0;"></td>
                        </tr>
                        <tr>
                            <td width="91%" style="padding-left:0;">MATTERS TO BE COMMUNICATED TO OTHER MEMBERS ON THE ENGAGEMENT TEAM NOT INVOLVED IN THE DISCUSSION</td>
                        </tr>
                        <tr>
                            <td class="custom-header" width="23.5%">
                                Name
                            </td>
                            <td class="custom-header" width="22.5%">
                                Engagament role
                            </td>
                            <td class="custom-header" width="22.5%">
                                Subject
                            </td>
                            <td class="custom-header" width="22.5%">
                                Date subject has been communicated
                            </td>
              
                        </tr>';

                        if($meeting_absent)
                        {
                            foreach($meeting_absent as $key => $line)
                            {
                                $content .= '<tr>';
                                    $content .= '<td class="bordered-cell">'.$line['absent_name'].'</td>';
                                    $content .= '<td class="bordered-cell">'.$line['engagement_role'].'</td>';
                                    $content .= '<td class="bordered-cell">'.$line['absent_subject'].'</td>';
                                    $content .= '<td class="bordered-cell">'.$line['date_communicated'].'</td>';
                                $content .= '</tr>';
            
                            }
                        }

            $content .= '</table>';
        }

        


        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="62%">Prepared by: &nbsp;  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
    
                            <td width="62%">Reviewed by:  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>
                        </tr>
                        
                    </table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_opinion_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);

        $opinion_detail  = $this->caf_model->get_opinion_detail($caf_id);



        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 25, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 20);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
                        font-style: italic;
                        font-weight: bold; 
                    }

                    .alpha_index
                    {
                        width: 5%;
                        font-weight:bold;
                    }

                    .desc
                    {
                        width: 52%;
                        font-weight:bold;
                    }

                    .answer
                    {
                        width: 36%;
                        border: 1px solid black;
                        text-align:center;
                    }


                    </style>';

        $index_alpha = "A";

        $content .= '<table class="table" style="border-collapse: collapse;width: 95%; color:black" cellpadding="2">
                        <tr>
                            <td colspan="3">
                                <p style="color:black;font-size: 12px;"><b>AUDIT PROGRAMME - '.(isset($programme_master_detail->title)?strtoupper($programme_master_detail->title):'').'</b></p>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>
                        <tr>
                            <td class="alpha_index"><b>'.$index_alpha.'. </b></td>
                            <td width="24%"><b>Date of auditor&#39;s report:</b></td>
                            <td  style="border-bottom:1px solid black;width:64%">'.
                               (isset($opinion_detail['date_of_report'])?$opinion_detail['date_of_report']: "")
                            .'</td>

                        </tr>
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>';
        $index_alpha++;
        $content .=     '<tr>
                            <td class="alpha_index"><b>'.$index_alpha.'. </b></td>
                            <td class="desc"><b>Audit opinion for financial statements:</b></td>
                            <td class="answer">'.
                                (isset($opinion_detail['fs_opinion'])?$opinion_detail['fs_opinion']:"").'
                            </td>

                        </tr>
                        <tr>
                            <td colspan="3">
                            </td>
                        </tr>';
        $index_alpha++;

                        if(isset($opinion_detail['fs_opinion']) && $opinion_detail['fs_opinion'] != "Unqualified opinion")
                        {
                            $content .= '<tr>
                                            <td class="alpha_index"><b>'.$index_alpha.'. </b></td>
                                            <td class="desc"><b>Basis for modified opinion:</b></td>
                                            <td>
                                            </td>

                                        </tr>
                                        <tr>
                                            <td></td>
                                            <td colspan="2">Basis for modified opinion on financial statements.</td>
                                         

                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td class="bordered-cell" colspan="2" style="height:30px;">'.
                                                (isset($opinion_detail['fs_opinion_modified'])?$opinion_detail['fs_opinion_modified']: "").'
                                            </td>
                                         

                                        </tr>';

                            $index_alpha++;
                        } 

                        $content .=  '<tr>
                                        <td colspan="3">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="alpha_index">'.$index_alpha.'. </td>
                                        <td class="desc">Going concern assumption:</td>
                                        <td class="answer">'.
                                            (isset($opinion_detail['concern_assumption'])?$opinion_detail['concern_assumption']:"").'
                    
                                        </td>

                                    </tr>';
                        $index_alpha++;

                        if(isset($opinion_detail['concern_assumption']) && $opinion_detail['concern_assumption'] != "Appropriate")
                        {
                            $content .= '<tr>
                                            <td></td>
                                            <td colspan="2">Description of going concern paragraph.</td>
                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td class="bordered-cell" colspan="2" style="height:30px;">'.
                                                (isset($opinion_detail['concern_desc'])?$opinion_detail['concern_desc']: "").'
                                            </td>
                                         

                                        </tr>';
                        }

                        $content .=     '<tr>
                                            <td colspan="3">
                                            </td>
                                        </tr>

                                        <tr>
                                            <td class="alpha_index">'.$index_alpha.'. </td>
                                            <td class="desc">Emphasis of matter paragraph required?</td>
                                            <td class="answer">'.
                                                (isset($opinion_detail['emphasis_required'])?$opinion_detail['emphasis_required']:"").'
                                            </td>
                                        </tr>';
                        $index_alpha++;
                        if(isset($opinion_detail['emphasis_required']) && $opinion_detail['emphasis_required'] == "Yes")
                        {
                            $content .= '<tr>
                                            <td></td>
                                            <td colspan="2">Description of emphasis of matter paragraph.</td>
                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td class="bordered-cell" colspan="2" style="height:30px;">'.
                                                (isset($opinion_detail['emphasis_desc'])?$opinion_detail['emphasis_desc']: "").'
                                            </td>
                                        </tr>';
                        } 


                                        
                        

                        $content  .= '<tr>
                                        <td colspan="3">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="alpha_index">'.$index_alpha.'. </td>
                                        <td class="desc">Key Audit Matters paragraph required?</td>
                                        <td class="answer">'.
                                            (isset($opinion_detail['key_audit_required'])?$opinion_detail['key_audit_required']:"").'
                                        </td>

                                    </tr>';
                        $index_alpha++;

                        if(isset($opinion_detail['key_audit_required']) && $opinion_detail['key_audit_required'] == "Yes")
                        {
                            $content .= '<tr>
                                            <td></td>
                                            <td colspan="2">Description of each key audit matter.</td>
                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td class="bordered-cell" colspan="2" style="height:30px;">'.
                                                (isset($opinion_detail['key_audit_desc'])?$opinion_detail['key_audit_desc']: "").'
                                            </td>
                                        </tr>';
                        } 

                        $content  .= '<tr>
                                        <td colspan="3">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="alpha_index">'.$index_alpha.'. </td>
                                        <td class="desc">Other Matters paragraph required?</td>
                                        <td class="answer">'.
                                            (isset($opinion_detail['other_matters_required'])?$opinion_detail['other_matters_required']:"").'
                                        </td>

                                    </tr>';
                        $index_alpha++;

                        if(isset($opinion_detail['other_matters_required']) && $opinion_detail['other_matters_required'] == "Yes")
                        {
                            $content .= '<tr>
                                            <td></td>
                                            <td colspan="2">Description of other matters paragraph.</td>
                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td class="bordered-cell" colspan="2" style="height:30px;">'.
                                                (isset($opinion_detail['other_matters_desc'])?$opinion_detail['other_matters_desc']: "")
                                            .'</td>
                                        </tr>';
                        } 

                        $content  .= '<tr>
                                        <td colspan="3">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="alpha_index">'.$index_alpha.'. </td>
                                        <td class="desc">Audit opinion on other legal and regulatory requirements</td>
                                        <td class="answer">'.
                                            (isset($opinion_detail['audit_opinion'])?$opinion_detail['audit_opinion']:"").'
                                        </td>

                                    </tr>';
                        $index_alpha++;

                        if(isset($opinion_detail['audit_opinion']) && $opinion_detail['audit_opinion'] != "Unqualified opinion")
                        {
                            $content .= '<tr>
                                            <td colspan="3">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="alpha_index">'.$index_alpha.'. </td>
                                            <td class="desc">Basis for modified opinion:</td>
                                            <td >
                                            </td>

                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td colspan="2">Basis for modified opinion on other legal and regulatory requirements (if different from C above)</td>
                                         

                                        </tr>

                                        <tr>
                                            <td></td>
                                            <td class="bordered-cell" colspan="2" style="height:30px;">'.
                                                (isset($opinion_detail['audit_opinion_modified'])?$opinion_detail['audit_opinion_modified']: '').'
                                            </td>
                                        </tr>';
                        }

        $content .=  '</table>';
        


        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="62%">Prepared by: &nbsp;  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
    
                            <td width="62%">Reviewed by:  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>
                        </tr>
                        
                    </table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_currency_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);

        $currency_detail  = $this->caf_model->get_currency_detail($caf_id);

        // dropdown
        $currency_dropdown = $this->caf_model->get_currency_dropdown();
        $yn_dropdown = array(''      => '',
                           'Yes'   => 'Yes',
                           'No'    => 'No');
        $hl_dropdown = array(''       => '',
                           'High'   => 'High',
                           'Low'    => 'Low');

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">

                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
                        font-style: italic;
                        font-weight: bold; 
                    }

                    .side-border
                    {
                        border-left: 1px solid black;
                        border-right: 1px solid black;
                        text-align: center;
                    }

                    .divider-line
                    {
                        border-bottom: 1px solid black;
                    }



                    </style>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 94%; color:black" id="programme_content_table" cellpadding="3">
                        <tr>
                            <th width="75%" colspan="3"></th>
                
                            <th width="20%" class="custom-header">
                                Currency in use
                            </th>

                        </tr>

                        <tr>
                            <td width="75%" class="content_main_line" colspan="3">Primary indicators</td>
                
                            <td class="side-border">
                            </td>

                        </tr>

                        <tr>
                            <td width="5%" >1. </td>
                            <td width="70%" colspan="2">The currency: </td>
                
                            <td class="side-border">
                            </td>

                        </tr>';

        $content .= '<tr>
                        <td width="5%" ></td>
                        <td width="5%" >(a) </td>
                        <td width="65%">That mainly influences sales prices for goods and services; and </td>
            
                        <td class="side-border divider-line">'.
                            $currency_dropdown[(isset($currency_detail['curr_influence_sales_price'])?$currency_detail['curr_influence_sales_price']:"")].'
                        </td>

                    </tr>';
        $content .= '<tr>
                        <td width="5%" ></td>
                        <td width="5%" >(b) </td>
                        <td width="65%">Of the country whose competitive forces and regulations mainly determine the sales prices of its goods and services. </td>
            
                        <td class="side-border divider-line">'.
                            $currency_dropdown[(isset($currency_detail['curr_competitive_forces'])?$currency_detail['curr_competitive_forces']:"")].'
                        </td>

                    </tr>';
        $content .= '<tr>
                        <td width="5%" >2. </td>
                        <td width="70%" colspan="2">The currency that mainly influences labour, material and other costs of providing goods or services. </td>
            
                        <td class="side-border divider-line">'.
                            $currency_dropdown[(isset($currency_detail['curr_influence_labour'])?$currency_detail['curr_influence_labour']:"")].'
                        </td>

                    </tr>';

        $content .= '<tr>
                        <td width="75%" class="content_main_line" colspan="3">Other indicators </td>
            
                        <td class="side-border">
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >1. </td>
                        <td width="70%" colspan="2">What is the currency in which funds from financing activities are generated?  </td>
            
                        <td class="side-border divider-line">'.
                            $currency_dropdown[(isset($currency_detail['curr_financing_activities'])?$currency_detail['curr_financing_activities']:"")].'
                        </td>

                    </tr>
                    <tr>
                        <td width="5%" >2. </td>
                        <td width="70%" colspan="2">What is the currency in which receipts from operating activities are usually retained? </td>
            
                        <td class="side-border divider-line">'.
                            $currency_dropdown[(isset($currency_detail['curr_operating_activities'])?$currency_detail['curr_operating_activities']:"")].'
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >3. </td>
                        <td width="70%" colspan="2">Are activities of the foreign operation(s) an extension of reporting entity? </td>
            
                        <td class="side-border divider-line">'.
                            $yn_dropdown[(isset($currency_detail['yn_extension_report_entity'])?$currency_detail['yn_extension_report_entity']:"")].'
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >4. </td>
                        <td width="70%" colspan="2">Are transactions with the reporting entity a high or low proportion of the activities in the foreign operation(s)? </td>
            
                        <td class="side-border divider-line">'.
                            $hl_dropdown[(isset($currency_detail['high_low_proportion'])?$currency_detail['high_low_proportion']:"")].'
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >5. </td>
                        <td width="70%" colspan="2">Do the cash flows arising from the activities in the foreign operation(s) directly affect the cash flow of the reporting entity and are they readily available for remittance? </td>
            
                        <td class="side-border divider-line">'.
                            $yn_dropdown[(isset($currency_detail['yn_affect_cash_flow'])?$currency_detail['yn_affect_cash_flow']:"")].'
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >6. </td>
                        <td width="70%" colspan="2">Is the cash flow from the activities of the foreign operation(s) sufficient to service its own debt obligations? </td>
            
                        <td class="side-border divider-line">'.
                            $yn_dropdown[(isset($currency_detail['yn_cash_flow_sufficient'])?$currency_detail['yn_cash_flow_sufficient']:"")].'
                        </td>

                    </tr>

                    <tr>
                        <td width="75%" class="content_main_line" colspan="3">Conclusion </td>
            
                        <td class="side-border">
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >7. </td>
                        <td width="70%" colspan="2">Based on our assessment of the entitys business and records and corroborative procedures performed to evaluate managements assessment of the functional currency of the entity, we conclude that the functional currency is:  </td>
            
                        <td class="side-border divider-line">'.
                            $currency_dropdown[(isset($currency_detail['curr_functional'])?$currency_detail['curr_functional']:"")].'
                        </td>

                    </tr>

                    <tr>
                        <td width="5%" >8. </td>
                        <td width="70%" colspan="2">Management assessment appears reasonable  </td>
            
                        <td class="side-border divider-line">'.
                            $yn_dropdown[(isset($currency_detail['yn_reasonable'])?$currency_detail['yn_reasonable']:"")].'
                        </td>

                    </tr>
                    <tr>
                        <td colspan="4"></td>
                    </tr>';



        $content .=  '</table>';
        


        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="62%">Prepared by: &nbsp;  _________________________________________</td>
                            <td width="33%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
    
                            <td width="62%">Reviewed by:  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>
                        </tr>
                        
                    </table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_cdd_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);

        $cdd_detail  = $this->caf_model->get_cdd_detail($caf_id);
        // print_r($cdd_detail);


        $y_n_dropdown           = array('No', 'Yes');
        $y_n_dropdown[""]       = "";

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 25);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">


                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
        
                        font-weight: bold; 
                    }

                    .side-border
                    {
                        border-left: 1px solid black;
                        border-right: 1px solid black;
                    }


                    .text-center
                    {
                        text-align: center;
                    }

                    .divider-line
                    {
                        border-bottom: 1px solid black;
                        text-align: center;
                    }



                    </style>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 94%; color:black" cellpadding="4">
                        <tr>
                            <th width="80%" class="content_main_line" colspan="3">SECTION 1</th>
                
                            <th width="15%" class="custom-header">
                                Yes/No
                            </th>

                        </tr>
                        <tr class="check_answer check_s1">
                            <td width="80%" colspan="3">The client is unable to provide all the required information in the relevant forms.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s1_1'])?$cdd_detail['s1_1']:"")].
                            '</td>

                        </tr>
                         <tr class="check_answer check_s1">
                            <td width="80%" colspan="3">The required information obtained cannot be verified to independent and reliable documents.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s1_2'])?$cdd_detail['s1_2']:"")].
                            '</td>

                        </tr>
                        <tr>
                            <td width="80%" colspan="3">The client, beneficial owner of the client, person acting on behalf of the client, or connected party of the client matches the details in the following lists: </td>
                
                            <td width="15%" class="side-border">
                            </td>

                        </tr>
                        <tr>
                            <td width="5%" >(a) </td>
                            <td width="75%" colspan="2">The Lists of Designated Individuals and Entities on the MAS website; </td>
                
                            <td class="side-border">
                            </td>
                        </tr>
                        <tr>
                            <td width="5%" >(b) </td>
                            <td width="75%" colspan="2">The Terrorist Alert List on the ISCA website; or</td>
                
                            <td class="side-border">
                            </td>

                        </tr>
                        <tr>
                            <td width="5%" >(c) </td>
                            <td width="75%" colspan="2">Any other similar lists and information required of professional firms for screening purposes stipulated by relevant authorities in Singapore including the Accounting and Corporate Regulatory Authority;</td>
                
                            <td class="side-border">
                            </td>

                        </tr>
                        <tr class="check_answer check_s1">
                            <td width="80%" colspan="3">and the exceptions cannot be disposed of satisfactorily.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s1_3'])?$cdd_detail['s1_3']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer check_s1">
                            <td width="80%" colspan="3">There is suspicion of money laundering and/or terrorist financing.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s1_4'])?$cdd_detail['s1_4']:"")].
                            '</td>

                        </tr>
                        <tr>
                            <td colspan="4"></td>
                        </tr>';

    



        $content .=  '</table>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 94%; color:black" cellpadding="4">
                        <tr>
                            <th width="80%" class="content_main_line" colspan="3">SECTION 2</th>
                
                            <th width="15%" class="custom-header">
                                Yes/No
                            </th>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the client, any of the beneficial owner of the client or person acting on behalf of the client a Politically Exposed Person (PEP), family member of a PEP or close associate of a PEP?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_1'])?$cdd_detail['s2_1']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">The professional firm has performed further screening of details of client, beneficial owner of the client, person acting on behalf of the client, or connected party of the client against other information sources, for example, Google, the sanctions lists published by the Office of Foreign Assets Control of the US Department of the Treasury, and/or other third party screening database?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_2'])?$cdd_detail['s2_2']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Are there adverse news or information arising?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_3'])?$cdd_detail['s2_3']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the client in a high-risk industry?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_4'])?$cdd_detail['s2_4']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Does the client have nominee shareholder(s) in the ownership chain where there is no legitimate rationale?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_5'])?$cdd_detail['s2_5']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Where applicable, do the nominee shareholders represent majority ownership?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_6'])?$cdd_detail['s2_6']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the client a shell company?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_7'])?$cdd_detail['s2_7']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Does the client have unusual or complex shareholding structure (e.g. involving 3 layers or more of ownership structure, different jurisdictions, trusts), given the nature of its business?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_8'])?$cdd_detail['s2_8']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the client a charitable or non-profit organisation that is NOT registered in Singapore?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_9'])?$cdd_detail['s2_9']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the clients business cash-intensive?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_10'])?$cdd_detail['s2_10']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Does the client frequently make unaccounted cash transactions to similar recipients?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_11'])?$cdd_detail['s2_11']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Are the clients company accounts NOT updated?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_12'])?$cdd_detail['s2_12']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Does the clients shareholders and/or directors frequently change, and the changes are unaccounted for?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_13'])?$cdd_detail['s2_13']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the client, beneficial owner of the client or person acting on behalf of the client from or based in a country or jurisdiction in relation to which the FATF has called for countermeasures?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_14'])?$cdd_detail['s2_14']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">The following would be applicable: nationality, country of incorporation / registration, residential address, registered address, address of principal place of business.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_15'])?$cdd_detail['s2_15']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the client, beneficial owner of the client or person acting on behalf of the client from or based in a country or jurisdiction known to have inadequate AML/CFT measures?</td>
                
                            <td width="15%" class="side-border divider-line bordered-cell">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_16'])?$cdd_detail['s2_16']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">The following would be applicable: nationality, country of incorporation / registration, residential address, registered address, address of principal place of business.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_17'])?$cdd_detail['s2_17']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Does the client, beneficial owner or person acting on behalf of the client have dealings in high risk jurisdictions?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_18'])?$cdd_detail['s2_18']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is the business relationship with the client established through online, postal or telephone, where non face-to-face approach is used?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_19'])?$cdd_detail['s2_19']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Has the client given any instruction to perform a transaction (which may include cash) anonymously?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_20'])?$cdd_detail['s2_20']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Has the client transferred any funds without the provision of underlying services or transactions?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_21'])?$cdd_detail['s2_21']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Are there unusual patterns of transactions that have no apparent economic purpose or cash payments that are large in amount, in which disbursement would have been normally made by other modes of payment (such as cheque, bank drafts etc.)?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_22'])?$cdd_detail['s2_22']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">re there unaccounted payments received from unknown or un-associated third parties for services and/or transactions provided by the client?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_23'])?$cdd_detail['s2_23']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is there instruction from the client to incorporate shell companies with nominee shareholder(s) and/or director(s)?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_24'])?$cdd_detail['s2_24']:"")].
                            '</td>

                        </tr>
                        <tr>
                            <td width="80%" colspan="3">Does the client set-up or purchase companies or business entities that have no obvious commercial purpose such as: </td>
                
                            <td width="15%" class="side-border">
                            </td>

                        </tr>
                        <tr>
                            <td width="5%" >&bull;</td>
                            <td width="75%" colspan="2">Multi-layer, multi-country and complex group structures.</td>
                
                            <td class="side-border">
                            </td>
                        </tr>
                        <tr>
                            <td width="5%" >&bull;</td>
                            <td width="75%" colspan="2">Setting up entities in Singapore where there is no obvious commercial purpose, or any other personal or economic connection to the client.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_25'])?$cdd_detail['s2_25']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">and the exceptions cannot be disposed of satisfactorily.</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_26'])?$cdd_detail['s2_26']:"")].
                            '</td>

                        </tr>
                        <tr class="check_answer">
                            <td width="80%" colspan="3">Is there any divergence in the type, volume or frequency of services and/or transactions expected in the course of the business relationship with the client?</td>
                
                            <td width="15%" class="side-border divider-line">'
                                .$y_n_dropdown[(isset($cdd_detail['s2_27'])?$cdd_detail['s2_27']:"")].
                            '</td>

                        </tr>
                        <tr>
                            <td colspan="4"></td>
                        </tr>
                        ';

    



        $content .=  '</table>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 94%; color:black" cellpadding="4">
                        <tr>
                            <th class="content_main_line" width="19%">SECTION 3</th>
                            <th class="bordered-cell text-center" width="19%">
                                Risk
                            </th>
                    
                            <th class="custom-header" width="19%">
                                CDD
                            </th>
                            <th class="custom-header" width="38%">
                                Reasons
                            </th>
                        </tr>
                        <tr>
                            <td width="19%">Client risk rating</td>
                            <td width="19%" class="bordered-cell text-center s3_risk">'
                                .(isset($cdd_detail['s3_risk'])?$cdd_detail['s3_risk']:"").'
                  
                            </td>
                    
                            <td width="19%" class="bordered-cell text-center s3_cdd">'
                                .(isset($cdd_detail['s3_cdd'])?$cdd_detail['s3_cdd']:"").'

                            </td>
                            <td width="38%" class="bordered-cell">'
                                .(isset($cdd_detail['s3_reason'])?$cdd_detail['s3_reason']:"").'
                            
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4"></td>
                        </tr>';
        $content .=  '</table>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 94%; color:black" cellpadding="4">
                        <tr>
                            <th width="38%" class="content_main_line">SECTION 4</th>
                            <th width="19%"class="bordered-cell">
                            </th>
                    
                            <th width="38%" class="custom-header">
                                Remark
                            </th>
                        </tr>

                        <tr>
                            <td width="38%">Business relationship</td>
                            <td width="19%" class="bordered-cell text-center s4_relationship">'
                                .(isset($cdd_detail['s4_relationship'])?$cdd_detail['s4_relationship']:"").'
                            </td>
                    
                            <td width="38%" class="bordered-cell">'
                                .(isset($cdd_detail['s4_reason'])?$cdd_detail['s4_reason']:"").'
                            </td>
                        </tr>
                        <tr>
                            <td colspan="4"></td>
                        </tr>';
        $content .=  '</table>';
        


        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="62%">Prepared by: &nbsp;  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>

                        </tr>
                        <br/>
                        <tr>
    
                            <td width="62%">Reviewed by:  __________________________________________</td>
                            <td width="33%">Date:_______________________</td>
                        </tr>
                        
                    </table>';



        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);
                   
        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_fcm_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);

        $fcm_detail  = $this->caf_model->get_fcm_apm_detail($caf_id);

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 25);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">


                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
        
                        font-weight: bold; 
                    }

                    .side-border
                    {
                        border-left: 1px solid black;
                        border-right: 1px solid black;
                    }


                    .text-center
                    {
                        text-align: center;
                    }

                    .divider-line
                    {
                        border-bottom: 1px solid black;
                        text-align: center;
                    }



                    </style>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 94%; color:black" cellpadding="4">
                        <tr>
                            <th class="content_main_line" colspan="3">Approval for signing the audit report</th>

                        </tr>
                        <tr>
                    <td width="100%" colspan="3">I confirm that:</td>
        

                </tr>
                <tr>

                    <td width="5%" >1. </td>
                    <td width="90%" colspan="2">The audit complies with professional standards and the applicable legal and regulatory requirements.</td>
        

                </tr>
                <tr>

                    <td >2. </td>
                    <td colspan="2">In particular, the audit complies with all relevant requirements of the SSAs</td>
        

                </tr>
                <tr>

                    <td>3. </td>
                    <td colspan="2">A sufficient and appropriate record for the basis of the audit report has been documented.</td>
        

                </tr>
                <tr>

                    <td >4. </td>
                    <td colspan="2">There are no factors to indicate that the representations received from the directors cannot be relied upon.</td>
        

                </tr>
                <tr>

                    <td>5. </td>
                    <td colspan="2">All outstanding matters have been concluded.</td>
        

                </tr>
                <tr>

                    <td>6. </td>
                    <td colspan="2">Subsequent events review has been updated. We have performed the procedures required to cover the period from the date of the financial statements to the date of the auditors report, or as near as practicable thereto.</td>
        

                </tr>
                <tr>

                    <td>7. </td>
                    <td colspan="2">The auditor&#39;s report issued is appropriate in the circumstances. The auditor&#39;s report is dated no earlier than the date on which sufficient appropriate audit evidence to support the auditor&#39;s opinion on the financial statements has been obtained. The evidence include:</td>
        

                </tr>
                <tr>

                    <td width="5%" ></td>
                    <td width="5%" >(a)</td>
                    <td width="85%" colspan="2">All statements that comprise the financial statements, including the related notes, have been prepared; and</td>
        

                </tr>
                <tr>

                    <td></td>
                    <td>(b)</td>
                    <td colspan="2">Those with recognised authority have asserted that they have taken responsibility for those financial statements.</td>
        

                </tr>';

                if(isset($fcm_detail['require_flag']) && $fcm_detail['require_flag'] == 1)
                {
                    $content .= '<tr>
                                    <td width="5%">8. </td>
                                    <td colspan="2" width="90%">Where a second partner review is involved, the second partner review is completed on or before the date of the auditors report.</td>
                                </tr>';
                }

        $content .= '<tr>
                        <td colspan="3">I authorise the issue of the audit report.</td>

                    </tr>';


        $content .=  '</table>';

        

        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="65%">Audit engagement partner: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;___________________________</td>
                            <td width="30%">Date: &nbsp; ___________________</td>

                        </tr>
                        <br/>';

        if(isset($fcm_detail['require_flag']) && $fcm_detail['require_flag'] == 1)
        {
            $content .=     '<tr>
        
                                <td width="65%">Second partner (where applicable): &nbsp;  ___________________________</td>
                                <td width="30%">Date: &nbsp; ___________________</td>
                            </tr>';
        }
                        
        $content .=     '</table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_apm_pdf($caf_id, $assignment_id)
    {

        $array_link = [];
        
        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail        = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        $programme_master_id       = $caf_detail->programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);

        $apm_detail  = $this->caf_model->get_fcm_apm_detail($caf_id);

        // create new PDF document
        $obj_pdf= new MYPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = "Audit Programme";
        $obj_pdf->SetTitle($title);
        $working_paper_header = $this->write_working_paper_header_nosign($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(25, 33, 0);
        $obj_pdf->SetAutoPageBreak(TRUE, 25);
        $obj_pdf->SetFont('helvetica', '', 10);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('P');

        $content = '';

        $content .= '<style type="text/css">


                    .custom-header
                    {
                        background-color: #446687;
                        color: white;
                        text-align: center;
                        border:1px solid black;
                    }

                    .black-bg
                    {
                        background-color: black;
                        border: 1px solid gray;
                    }

                    .bordered-cell
                    {
                        border:1px solid black;
                    }

                    .content_main_line
                    {
        
                        font-weight: bold; 
                    }

                    .side-border
                    {
                        border-left: 1px solid black;
                        border-right: 1px solid black;
                    }


                    .text-center
                    {
                        text-align: center;
                    }

                    .divider-line
                    {
                        border-bottom: 1px solid black;
                        text-align: center;
                    }



                    </style>';

        $content .= '<table class="table table-borderless" style="border-collapse: collapse; margin: 2%; width: 95%; color:black" cellpadding="4">
                        <tr>
                            <th class="content_main_line" colspan="3">APPROVAL OF PLANNING</th>

                        </tr>
                        <tr>
                            <td width="100%" colspan="3">I confirm that:</td>
                

                        </tr>
                        <tr>

                            <td width="5%" >1. </td>
                            <td width="90%" colspan="2">The preconditions for an audit are present and the scope of the audit engagement has been agreed with management and those charged with governance.</td>
                

                        </tr>
                        <tr>

                            <td >2. </td>
                            <td colspan="2">An audit strategy has been established for the audit.</td>
                

                        </tr>
                        <tr>

                            <td>3. </td>
                            <td colspan="2">An audit plan, which includes the following, has been developed to reduce risk to an acceptable level:</td>
                        </tr>
                        <tr>

                            <td width="5%" ></td>
                            <td width="5%" >(a)</td>
                            <td width="85%" colspan="2">Assessment of the risks of material misstatement in the financial statements due to fraud;</td>
                

                        </tr>
                        <tr>

                            <td></td>
                            <td>(b)</td>
                            <td colspan="2">Design of audit procedures to obtain sufficient appropriate audit evidence in accordance with the requirements in the SSAs, relevant ethics code, laws and regulations, the terms of the audit engagement and financial reporting requirements; and</td>
                

                        </tr>
                        <tr>

                            <td></td>
                            <td>(c)</td>
                            <td colspan="2">Customised audit programmes to address the financial statement and assertion level risks in accordance with the SSAs.</td>
                

                        </tr>
                        <tr>

                            <td width="5%" >4. </td>
                            <td width="90%" colspan="2">Professional scepticism has been exercised to establish the audit strategy and design the audit procedures, taking into account the circumstances which may cause the financial statements to be materially misstated.</td>
                

                        </tr>
                        <tr>

                            <td>5. </td>
                            <td colspan="2">The engagement team collectively has the appropriate capabilities, competence and time to perform the audit engagement in accordance with professional standards and regulatory and legal requirements. The engagement team has been adequately briefed to perform the audit in order to issue an appropriate audit opinion.</td>
                

                        </tr>
                        <tr>
                            <th class="content_main_line" colspan="3">UPDATE AT COMPLETION STAGE</th>

                        </tr>
                        <tr>
                            <td width="95%" colspan="3">I confirm that:</td>
                

                        </tr>
                        <tr>
                            <td width="5%">1. </td>
                            <td width="90%" colspan="2">The overall strategy and audit plan were updated as necessary during the course of the audit.</td>
                        </tr>
                        <tr>
                            <td>2. </td>
                            <td colspan="2">All issues arising from the audit plan have been addressed and documented.</td>
                        </tr>
                        <tr>
                            <td>3. </td>
                            <td colspan="2">The audit plan has been cross-referenced to where the relevant work was performed.</td>
                        </tr>
                        <tr>
                            <td>4. </td>
                            <td colspan="2">The assessment of materiality and risk have been reviewed and amended where necessary.</td>
                        </tr>
                       <tr>
                            <th class="content_main_line" colspan="3">CONFIRMATION BY AUDIT TEAM</th>

                        </tr>
                        <tr>
                            <td width="95%" colspan="3">I confirm</td>
                

                        </tr>
                        <tr>

                            <td width="5%" >1. </td>
                            <td width="90%" colspan="2">that I have read and understood the audit plan (Section C); and</td>
                

                        </tr>
                        <tr>

                            <td >2. </td>
                            <td colspan="2">to the best of my knowledge and belief that I am independent in accordance with the independent requirements of Code of Professional Conduct and Ethics under the Forth Schedule of Accountants (Public Accountants) Rule / the firms statement of policy on independence*.</td>
                

                        </tr>
                        <tr>

                            <td>3. </td>
                            <td colspan="2">to the best of my knowledge and belief, the following matters might affect the independence of the firms provision of professional service to this client.  The matters which are required to be immediately notified to the firm are the following, but not limited to:  </td>
                        </tr>
                        <tr>

                            <td width="5%" ></td>
                            <td width="5%" >(a)</td>
                            <td width="85%" colspan="2">Financial interest in the client;</td>
                

                        </tr>
                        <tr>

                            <td></td>
                            <td>(b)</td>
                            <td colspan="2">Loans or guarantee obtained from the client;</td>
                

                        </tr>
                        <tr>
                            <td></td>
                            <td>(c)</td>
                            <td colspan="2">Gifts and hospitality received from the client;</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>(d)</td>
                            <td colspan="2">Family or personal relationships with the client;</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>(e)</td>
                            <td colspan="2">Employment with the client;</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>(f)</td>
                            <td colspan="2">Close business relationship with the client; and</td>
                        </tr>
                        <tr>
                            <td></td>
                            <td>(g)</td>
                            <td colspan="2">Others stated in the Code of Professional Conduct and Ethics under the Forth Schedule of Accountants (Public Accountants) Rules.</td>
                        </tr>';


        $content .=  '</table>';

        

        $content .= '<table class="table table-borderless" cellpadding="4" style="border-collapse: collapse; margin: 2%; width: 95%; color:black">';
   

        $content .= '   <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td colspan="2"></td>
                        </tr>
                        <tr>
                            <td width="65%">Audit engagement partner: &nbsp; _________________________________</td>
                            <td width="30%">Date: &nbsp; ___________________</td>

                        </tr>
                        <br/>';

        if(isset($apm_detail['require_flag']) && $apm_detail['require_flag'] == 1)
        {
            $content .=     '<tr>
        
                                <td width="65%">Second partner: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  _________________________________</td>
                                <td width="30%">Date: &nbsp; ___________________</td>
                            </tr>';
        }
                        
        $content .=     '</table>';



        // print_r($content);


       

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_programme_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
        
        
    }

    public function export_programme_gai_words($caf_id, $assignment_id)
    {
        
        $client = $this->caf_model->getAssignmentDetail($assignment_id);
        $caf_detail = $this->caf_model->getCafDetail($caf_id);
        $fye_text = date("d F Y", strtotime($client->FYE));
        $fye_text = strtoupper($fye_text);

        // print_r($client);

        $caf_id           = $caf_id;
        // $this->data['adjustment_caf_id'] = $this->caf_model->get_adjustment_caf_id($assignment_id);

        $assignment_id    = $assignment_id;

        $programme_master_id                     = $caf_detail->programme_master_id;
        // echo $programme_master_id;
        $programme_master_detail   = $this->setting_model->get_edit_programme($programme_master_id);

        $data_gai                  = $this->caf_model->get_gai_master_detail($caf_id);


        if($data_gai)
        {
            $data_gai['date']        = date('d F Y', strtotime($data_gai['date']));

            for ($i = 1; $i <= 10; $i++) {
                $deadline_index = "deadline".$i;
                $data_gai[$deadline_index]        = date('d F Y', strtotime($data_gai[$deadline_index]));
            }
        }
        
        $gai_detail             = $data_gai;

        $gai_master_id                        = $data_gai?$data_gai['id']:"";

        if($gai_master_id != "")
        {
            $gai_team         = $this->caf_model->get_gai_team($gai_master_id);
            $gai_component    = $this->caf_model->get_gai_component($gai_master_id);
        }

        

        for($i = 0; $i < count($gai_component); $i++)
        {
            //Microsoft Word
            $document = new \PhpOffice\PhpWord\TemplateProcessor($_SERVER['DOCUMENT_ROOT']."audit/Document Templates/Audit/Generate - LF-01 Group Audit Instruction (GAI).docx");

            $query = $this->db->query("select firm.*, firm_email.email, firm_telephone.telephone, firm_fax.fax from firm 
                                                JOIN firm_email ON firm_email.firm_id = firm.id AND firm_email.primary_email = 1 
                                                JOIN firm_telephone ON firm_telephone.firm_id = firm.id AND firm_telephone.primary_telephone = 1 
                                                JOIN firm_fax ON firm_fax.firm_id = firm.id AND firm_fax.primary_fax = 1
                                                where firm.id = '".$client->firm_id."'");
            $query = $query->result_array();
            $firm_address = $query[0]["street_name"] .', #'. $query[0]["unit_no1"] .'-'.$query[0]["unit_no2"].' '. $query[0]["building_name"] .', Singapore '. $query[0]["postal_code"];

            $document->setImageValue('CompanyLogo', "uploads/logo/". $query[0]["file_name"] ."");
            $document->setValue('UEN', $query[0]["registration_no"]);
            $document->setValue('firm_address', $firm_address);
            $document->setValue('firm_telephone', $query[0]["telephone"]);
            $document->setValue('firm_fax', $query[0]["fax"]);

            $document->setValue('client name', htmlspecialchars($client->client_name));
            $document->setValue('year end', $fye_text);
            $document->setValue('firm name', $client->firm_name);
            $document->setValue('date', $data_gai['date']);
            $document->setValue('deadline1', $data_gai['deadline1']);
            $document->setValue('deadline2', $data_gai['deadline2']);
            $document->setValue('deadline3', $data_gai['deadline3']);
            $document->setValue('deadline4', $data_gai['deadline4']);
            $document->setValue('deadline5', $data_gai['deadline5']);
            $document->setValue('deadline6', $data_gai['deadline6']);
            $document->setValue('deadline7', $data_gai['deadline7']);
            $document->setValue('deadline8', $data_gai['deadline8']);
            $document->setValue('deadline9', $data_gai['deadline9']);
            $document->setValue('deadline10', $data_gai['deadline10']);
            $document->setValue('partner', $client->partner);
            $document->setValue('this component name', $gai_component[$i]['component_name']);

            if(count($gai_team) > 0)
            {
                $document->cloneRow('team - name', count($gai_team));

                for($g = 0; $g < count($gai_team); $g++)
                {
                    $document->setValue('team - name#'.($g+1), $gai_team[$g]["member_name"]);
                    $document->setValue('team - position#'.($g+1), $gai_team[$g]["member_designation"]);
                    $document->setValue('team - contact_no#'.($g+1),  $gai_team[$g]["member_contact"]);
                    $document->setValue('team - email#'.($g+1),  $gai_team[$g]["member_email"]);
                }
            }
            else
            {
                $document->setValue('team - name', '');
                $document->setValue('team - position', '');
                $document->setValue('team  contact_no',  '');
                $document->setValue('team  email',  '');

            }  

            if(count($gai_component) > 0)
            {
                $document->cloneRow('component - auditor name', count($gai_component));

                for($g = 0; $g < count($gai_component); $g++)
                {
                    $document->setValue('no#'.($g+1), $g+1);
                    $document->setValue('component - name#'.($g+1), $gai_component[$g]["component_name"]);
                    $document->setValue('component - auditor name#'.($g+1), $gai_component[$g]["component_auditor"]);
                    $document->setValue('component - scope#'.($g+1),  $gai_component[$g]["component_relationship"]);
                    $document->setValue('component - type of work#'.($g+1),  $gai_component[$g]["component_relationship"]);
                }
            }
            else
            {
                $document->setValue('no', '1');
                $document->setValue('component - name', '');
                $document->setValue('component - auditor name', '');
                $document->setValue('component - scope',  '');
                $document->setValue('component  type of work',  '');

            } 

            if(count($gai_component) > 0)
            {
                $document->cloneRow('component - materiality', count($gai_component));

                for($g = 0; $g < count($gai_component); $g++)
                {
                    $document->setValue('no#'.($g+1), $g+1);
                    $document->setValue('component - name#'.($g+1), $gai_component[$g]["component_name"]);
                    $document->setValue('component - materiality#'.($g+1), $gai_component[$g]["overall_materiality"]);
                    $document->setValue('component - performance materiality#'.($g+1),  $gai_component[$g]["performance_materiality"]);
                    $document->setValue('component - clearly trival#'.($g+1),  $gai_component[$g]["clearly_trivial"]);
                }
            }
            else
            {
                $document->setValue('no', '1');
                $document->setValue('component - name', '');
                $document->setValue('component - materiality', '');
                $document->setValue('component - performance materiality',  '');
                $document->setValue('component  clearly trival',  '');

            }       


            //Microsoft Word Save
            $document->saveAs($_SERVER['DOCUMENT_ROOT'].'audit/document/audit_programme/'.$programme_master_detail->title.'-'.preg_replace('/[^a-zA-Z0-9 _\.-]/', '', $this->myUrlEncode($client->client_name)).'_'.($i+1).'.docx');

            $this->zip->read_file($_SERVER['DOCUMENT_ROOT'].'audit/document/audit_programme/'.$programme_master_detail->title.'-'.preg_replace('/[^a-zA-Z0-9 _\.-]/', '', $this->myUrlEncode($client->client_name)).'_'.($i+1).'.docx');

            $this->zip->archive($_SERVER['DOCUMENT_ROOT'].'audit/document/audit_programme/'.$programme_master_detail->title.'-'.preg_replace('/[^a-zA-Z0-9 _\.-]/', '', $this->myUrlEncode($client->client_name)).'.zip');

            unlink($_SERVER['DOCUMENT_ROOT'].'audit/document/audit_programme/'.$programme_master_detail->title.'-'.preg_replace('/[^a-zA-Z0-9 _\.-]/', '', $this->myUrlEncode($client->client_name)).'_'.($i+1).'.docx');
        }

        //Microsoft Word End

        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        $file_link = $protocol.$_SERVER['SERVER_NAME'].'/audit/document/audit_programme/'.$programme_master_detail->title.'-'.preg_replace('/[^a-zA-Z0-9 _\.-]/', '', $this->myUrlEncode($client->client_name)).'.zip';

        echo json_encode(array('file_link' => $file_link));

    }

    public function export_audit_leadsheet_pdf($caf_id, $assignment_id)
    {
        $form_data = $this->input->post();
        // print_r($form_data['styles']);

        $style = isset($form_data['styles'])?$form_data['styles']:"";
        $style_class = $this->process_webix_style_array($style);

        $array_link = [];

        // retrieving data
        $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);
        $fs_company_info       = $this->caf_model->get_fs_company_info($fs_company_info_id);
        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $caf_detail            = $this->caf_model->getCafDetail($caf_id);

          // create new PDF document
        $obj_pdf= new NO_MARGIN_PDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $obj_pdf->SetCreator(PDF_CREATOR);
        $title  = $caf_detail->index_no." - ".$caf_detail->name;
        $obj_pdf->SetTitle($title);


         $working_paper_header = $this->write_working_paper_header($fs_company_info, $caf_detail, true, $obj_pdf->getAliasNumPage());
        // print_r($working_paper_header);
        $obj_pdf->setHeaderData($ln='', $lw=0, $ht='', $hs=$working_paper_header, $tc=array(0,0,0), $lc=array(0,0,0));
        // $obj_pdf->setPrintHeader(false);
        $obj_pdf->setPrintFooter(false);
        $obj_pdf->SetDefaultMonospacedFont('helvetica');
        $obj_pdf->SetMargins(12, 33, 10);
        $obj_pdf->SetAutoPageBreak(TRUE, 10);
        $obj_pdf->SetFont('helvetica', '', 9);
        $obj_pdf->setFontSubsetting(false);
        $obj_pdf->AddPage('L');
        $fs_ntfs_list = $this->fs_model->get_fs_ntfs_json();

         // initialise

        $current_last_year_end = $this->fs_model->calculate_difference_dates($fs_company_info_id);
        $show_data_content     = $this->fs_model->is_saved_fs_categorized_account($assignment_id);

        $current_fye_end = '';
        $last_fye_end    = '';
        $display_restated = false;

        $show_third_col   = false;
        $current_fye_end  = $current_last_year_end['current_fye_end'];
        $last_fye_end     = $current_last_year_end['last_fye_end'];

        if($fs_company_info[0]['first_set'])
        {
            $current_fye_end  = date('Y', strtotime($fs_company_info[0]['current_fye_end']));    // this year end eg. 31/12/2019
            $last_fye_end     = '';       // end of previous year end
        }

        /* Setting for column width */
        $col_width = array(
                            'account_desc' => 40,
                            'value'        => 15,
                            'variance'     => 0
                        );

        if(!$fs_company_info[0]['first_set'])
        {
            $col_width = array(
                            'account_desc' => 20,
                            'value'        => 12.8,
                            'variance'        => 8

                        );

        }

        
        
        if($fs_company_info[0]['is_prior_year_amount_restated'])
        {
            if($fs_company_info[0]['effect_of_restatement_since'] == $fs_company_info[0]['last_fye_begin'])
            {
                $show_third_col   = true;

                $current_fye_end  = date('d.m.Y', strtotime($fs_company_info[0]['current_fye_end']));
                $last_fye_end     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_end']));
                $last_fye_beg     = date('d.m.Y', strtotime($fs_company_info[0]['last_fye_begin']));
            }
        }

        $width = array(
                            'account_desc' => $col_width['account_desc'],
                            // 'note'         => $col_width['note'],
                            'value'        => $col_width['value'],
                            'variance'     => $col_width['variance']
                        );

        $data = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, array($caf_detail->leadsheet_acc_id));
        // print_r($data);
        
        // $data = $this->fs_model->operate_account_value($data, array('Q103'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));

        /* ------------------ Sum up value to get "revenue reserve (Q103)" ------------------ */
        $fs_statement_list = $this->fs_statements_model->get_fs_statement_json();
        $fca_ids_for_revenue_reserve = $this->fs_model->get_fca_id($fs_company_info_id, $fs_statement_list->statement_financial_position[0]->for_revenue_reserve);
        $data_for_revenue_reserve = $this->fs_account_category_model->get_account_with_sub_ids($assignment_id, $fca_ids_for_revenue_reserve);

        $total_for_revenue_reserve = array(
                                        'total_c'           => 0.00,
                                        'total_c_adjusted'  => 0.00,
                                        'total_c_lye'       => 0.00,
                                        'total_g'           => 0.00,
                                        'total_g_lye'       => 0.00
                                    );

        foreach ($data_for_revenue_reserve as $rr_key => $rr_value) 
        {
            $total_for_revenue_reserve['total_c']               += $rr_value['parent_array'][0]['total_c'];
            $total_for_revenue_reserve['total_c_adjusted']      += $rr_value['parent_array'][0]['total_c_adjusted'];
            $total_for_revenue_reserve['total_c_lye']           += $rr_value['parent_array'][0]['total_c_lye'];
            $total_for_revenue_reserve['total_g']               += $rr_value['parent_array'][0]['total_g'];
            $total_for_revenue_reserve['total_g_lye']           += $rr_value['parent_array'][0]['total_g_lye'];
        }

        

        $data = $this->fs_model->operate_account_value($data, array('Q1030000'), array(array('operator' => '+', 'insert_values_arr' => $total_for_revenue_reserve)));
        /* ------------------ END OF Sum up value to get "revenue reserve (Q103)" ------------------ */
        // print_r($data);
        // $this->data['data'] = $data;
        $leadsheet_setup      = $this->caf_model->get_leadsheet_setup($caf_id);

        $temp_adjustment_data = $this->caf_model->get_adjustment_data($this->caf_model->get_adjustment_caf_id($assignment_id));
        $adjustment_data = $this->build_adjustment_data_arr($temp_adjustment_data);

        $content = '';

        $content .= '<style type="text/css">';

        $content .= $style_class;

        $content .= '</style>';

        if($show_data_content)
        {   

            if(isset($leadsheet_setup['leadsheet_flag'])?($leadsheet_setup['leadsheet_flag']==1?true:false):true)
            {
                $content .= '<table cellpadding="1" style="width: 100%; color:black;">
                        <thead>
                        <tr>
                            <th style="width:'.$width['account_desc'].'%;">&nbsp;</th>
                            <th style="width:'.$width['value'].'%; text-align: center;">';
                               
                                    if($show_third_col)
                                    {
                                        $content .= '<br/>';
                                    } 
                                    $content .= $current_fye_end ."<br/>". "Unadjusted"; 
                            
                            $content .= "</th>";
                            $content .= '<th style="width:'.($col_width['value']*2).'%; text-align: center;" colspan=2>';
                        
                                    if($show_third_col)
                                    {
                                        $content .= '<br/>';
                                    } 
                                    $content .= "<br/>Adjustments";
                    
                            $content .= '</th>';
                            $content .= '<th style="width:'.$width['value'].'%; text-align: center;">';
                                
                                    if($show_third_col)
                                    {
                                        $content .= '<br/>';
                                    } 
                                    $content .= $current_fye_end ."<br/>". "Final"; 
                            
                            $content .= '</th>';
                            

                    
                            if(!empty($last_fye_end))
                            {
                                $content .= 
                                '<th style="width: ' . $width['value'] . '%; text-align: center;">';
                                    if($show_third_col)
                                    {
                                        $content .= 'Restated<br/>';
                                    }
                                    $content .= $last_fye_end."<br/>". "Final"; 
                                $content .= '</th>';

                                if($show_third_col)
                                {
                                    $content .= '<th style="width: ' . $width['value'] . '%; text-align: center;">Restated<br/>' . $last_fye_beg . '</th>';
                                }

                                $content .= '<th style="width:'.($width['variance']*2) .'%;text-align: center;" colspan=2><br/>Variance</th>';

                            }

                            if($last_fye_end)
                            {
                                $last_fye_end_flag = true;
                            }
                            else
                            {
                                $last_fye_end_flag = false;
                            }
                
                            
                        $content .= '</tr>';

                        $content .=  '<tr>
                            <th style="width:'.$width['account_desc'].'%"></th>
                            <th style="width:'.$width['value'].'%; text-align: center; border-top: 1px solid #000;"><br/>$</th>
                            <th style="width:'.$width['value'].'%; text-align: center; border-top: 1px solid #000;">DR<br/>$</th>
                            <th style="width:'.$width['value'].'%; text-align: center; border-top: 1px solid #000;">CR<br/>$</th>
                            <th style="width:'.$width['value'].'%; text-align: center; border-top: 1px solid #000;"><br/>$</th>';

                
                                if(!empty($last_fye_end))
                                {
                                    $content .= '<th style="width:'.$width['value'].'%; text-align: center; border-top: 1px solid #000;"><br/>$</th>';

                                    if($show_third_col)
                                    {
                                        $content .= '<th style="width:'.$width['value'].'%; text-align: center; border-top: 1px solid #000;"><br/>$</th>';
                                    }
                                    
                                    $content .= '<th style="width:'.$width['variance'].'%;text-align: center;border-top: 1px solid #000;"><br/>$</th>
                                        <th style="width:'.$width['variance'] .'%;text-align: center;border-top: 1px solid #000;"><br/>%</th>';
                            
                                }
                        
                            

                        $content .= '</tr>;
                    </thead>
                    <tbody>';
                        

                        $grand_total_c          = 0.00;
                        $grand_total_c_adjusted = 0.00;
                        $grand_total_c_end      = 0.00;

                        foreach ($data[0]['child_array'] as $level_1_key => $level_1) 
                        {
                            // print_r($level_2);
                        
                            $check_l2_parent_counter = 0;
                            $temp_total_c          = 0.00;
                            $temp_total_c_adjusted = 0.00;
                            $temp_total_c_end      = 0.00;
                            $temp_total_c_beg      = 0.00;
                            
                            if(!empty($level_1['parent_array']))
                            {
                                $content .= 
                                '<tr>'.
                                    '<td style="width:'.$col_width['account_desc'].'%;"><strong><u>' . ucfirst(strtolower($level_1['parent_array'][0]['description'])) . '</u></strong></td>' .
                                    '<td style="width:'.$col_width['value'].'%;" align="center"></td>' .
                                    '<td style="width:'.$col_width['variance'].'%;">&nbsp;</td>' .
                                    '<td colspan="9"></td>' .
                                '</tr>';
                            
                            }

                            foreach ($level_1['child_array'] as $level_2_key => $level_2)
                            {
                                // echo '</br></br>';
                                // print_r($level_3);
                                /* DISPLAY LEVEL 3 THAT HAS SUBCATEGORY */
                                if(!empty($level_2['parent_array']))
                                {
                                    $check_l2_parent_counter++;

                                    


                                    $temp_c          = isset($level_2['parent_array'][0]['total_c'])?$level_2['parent_array'][0]['total_c']:0;
                                    $temp_c_adjusted = isset($level_2['parent_array'][0]['total_c_adjusted'])?$level_2['parent_array'][0]['total_c_adjusted']:0;
                                    $temp_c_lye      = isset($level_2['parent_array'][0]['total_c_lye'])?$level_2['parent_array'][0]['total_c_lye']:0;
                                    
                                    if(!empty($temp_c) && !empty($level_2['parent_array'][0]['account_code']))
                                    {

                                        if($level_2['parent_array'][0]['account_code'][0] == "Q" || $level_2['parent_array'][0]['account_code'][0] == "R" || $level_2['parent_array'][0]['account_code'][0] == "L" || $level_2['parent_array'][0]['account_code'][0] == "I" || $level_1['parent_array'][0]['account_code'][0] == "Q" || $level_1['parent_array'][0]['account_code'][0] == "R" || $level_1['parent_array'][0]['account_code'][0] == "L" || $level_1['parent_array'][0]['account_code'][0] == "I")
                                        {
                                            $temp_c = $temp_c * (-1);
                                        }
                                        
                                    }
                                    $temp_id         = $level_2['parent_array'][0]['id'];
                                    // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                    $temp_child_id = isset($level_2['parent_array'][0]['child_id'])?$level_2['parent_array'][0]['child_id']:"";
                                    $temp_adjustment_info = $this->get_adjustment_of_child($temp_child_id, $adjustment_data);
                                    $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                    $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                    $adjustment_for_rev_rsrve = 0.00;
                                    $adjustment_for_pl = 0.00;

                                    $variance_value  = $this->calculate_variance($temp_c_adjusted ,$temp_c_lye);

                                    

                                    // print_r($level_3['parent_array'][0]);
                                    // echo json_encode($level_3['fs_note_details']);
                                    $content .= 
                                    '<tr class="rows-for-'.$level_2['parent_array'][0]['id'].'">' .
                                        '<td style="width:'.$col_width['account_desc'].'%;">' .
                                            // hidden fields
                                            '<input type="hidden" name="FP_audit_categorized_account_id[]" class="SFP_audit_categorized_account_id" value="'. $level_2['parent_array'][0]['id'] .'">'.
                                            $level_2['parent_array'][0]['description'] . 
                                        '</td>';

                                        $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c) . '</td>';

                                        // adjustment detail for PL when no adjustment of retained earning
                                        if($level_2['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value == "")
                                        {
                                            //multiply with -1 because retained earning is opposite sign
                                            $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c);
                        
                                            if($adjustment_for_pl > 0)
                                            {
                                                $content .= 
                                                    '<td  style="width:'.$col_width['value'].'%;" align="right">
                                                        <table>
                                                            <tr>
                                                                <td style="width: 40%;"><strong>P/L</strong></td>
                                                                <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                            </tr>
                                                        </table>
                                                    </td>';
                                                $content .= 
                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                            }
                                            else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                            {
                                                $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';

                                                $content .= 
                                                '<td  style="width:'.$col_width['value'].'%;" align="right">
                                                        <table>
                                                            <tr>
                                                                <td style="width: 40%;"><strong>P/L</strong></td>
                                                                <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                            </tr>
                                                        </table>
                                                    </td>';
                                            }
                                        }

                                        if($level_2['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value != "")
                                        {
                                            $adjustment_for_rev_rsrve += $temp_adjust_value;
                                        }
                                        

                                        if($temp_adjust_value > 0)
                                        {
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                        }
                                        else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                        {
                                            $content .= 
                                                '<td align="right"></td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                        }
                                        else if($temp_adjust_value == "" && $adjustment_for_pl == 0)
                                        {
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                        }
                                        $content .= '<td align="right" style="width:'.$col_width['value'].'%;">' . $this->negative_bracket($temp_c_adjusted) . '</td>';
                                        
                                        if(!empty($last_fye_end))
                                        {

                                            $content .= 
                                            '<td align="right" style="width:'.$col_width['value'].'%;">' . $this->negative_bracket($temp_c_lye) . '</td>';
                                        
                                            if($show_third_col)
                                            {
                                                $content .= 
                                                '<td align="right">' . 
                                                    '<input type="number" name="' . $FP_lye_beg_value_name . '[' . $index . ']" class="form-control ' . $display_class_lye_beg . '_values_under_' . $level_1['parent_array'][0]['id'] . ' ' . $display_class_lye_beg .  '_account_code_' . $level_1_description . '" style="text-align:right;" value="' . $level_2['parent_array'][0]['company_beg_prev_ye_value'] . '" onchange="FP_calculation('. $level_1['parent_array'][0]['id'] .', \'' . $display_class_lye_beg . '\', \'' . $level_1_description . '\', \'' . "company" . '\')" min="0" pattern="[0-9]" onkeypress="return !(event.charCode == 46)" step="1">' .
                                                '</td>';
                                            }
                                            $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';
                                        
                                        }



                                        $temp_total_c          += (double)$temp_c;
                                        $temp_total_c_adjusted += (double)$temp_c_adjusted;
                                        $temp_total_c_end      += (double)$temp_c_lye;
                                        $temp_total_c_beg      += (double)$level_2['parent_array'][0]['company_beg_prev_ye_value'];
                                        // }
                                    $content .= '</tr>';

                                    //loop all adjustment info 
                                    if(count($temp_adjustment_info) > 1)
                                    {
                                        foreach ($temp_adjustment_info as $info_key => $each_info) {
                                            if($info_key != 0)
                                            {
                                                $temp_adjust_value = $each_info['adjusted_value'];
                                                $temp_je_no = $each_info['type_name'].$each_info['je_no'];

                                                if($temp_adjust_value != "")
                                                {
                                                    $adjustment_for_rev_rsrve += $temp_adjust_value;
                                                }

                                                $content .= '<tr>
                                                        <td style="width:'.$col_width['account_desc'].'%;"></td>
                                                        <td style="width:'.$col_width['value'].'%;"></td>';
                                                if($temp_adjust_value > 0)
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                }
                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                }
                                                else
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                }
                                                $content .=  '</tr>';
                                            }
                                        }
                                        
                                    }
                                }
                            }


                            if(!empty($level_1['parent_array']))
                            {
                                if($check_l2_parent_counter == 0)
                                {
                                    $temp_c          = isset($level_1['parent_array'][0]['total_c'])?$level_1['parent_array'][0]['total_c']:0;
                                    $temp_c_adjusted = isset($level_1['parent_array'][0]['total_c_adjusted'])?$level_1['parent_array'][0]['total_c_adjusted']:0;
                                    $temp_c_lye      = isset($level_1['parent_array'][0]['total_c_lye'])?$level_1['parent_array'][0]['total_c_lye']:0;
                                    
                                    if((!empty($temp_c) && !empty($level_1['parent_array'][0]['account_code'])) || (!empty($temp_c_lye) && !empty($level_1['parent_array'][0]['account_code'])))
                                    {
                                        // print_r($data[0]['parent_array'][0]);

                                        if($level_1['parent_array'][0]['account_code'][0] == "Q" || 
                                           $level_1['parent_array'][0]['account_code'][0] == "R" || 
                                           $level_1['parent_array'][0]['account_code'][0] == "L" || 
                                           $level_1['parent_array'][0]['account_code'][0] == "I")
                                        {
                                            $temp_c          = $temp_c * (-1);
                                            $temp_c_adjusted = $temp_c_adjusted * (-1);
                                            $temp_c_lye      = $temp_c_lye * (-1);
                                        } 
                                        
                                    }
                                    else if((!empty($temp_c) && !empty($data[0]['parent_array'][0]['account_code'])) || (!empty($temp_c_lye) && !empty($data[0]['parent_array'][0]['account_code'])))
                                    {

                                        if($data[0]['parent_array'][0]['account_code'][0] == "Q" || 
                                           $data[0]['parent_array'][0]['account_code'][0] == "R" || 
                                           $data[0]['parent_array'][0]['account_code'][0] == "L" || 
                                           $data[0]['parent_array'][0]['account_code'][0] == "I")
                                        {
                                            $temp_c          = $temp_c * (-1);
                                            $temp_c_adjusted = $temp_c_adjusted * (-1);
                                            $temp_c_lye      = $temp_c_lye * (-1);
                                        } 
                                        
                                    }

                                    $temp_id         = isset($level_1['parent_array'][0]['id'])?$level_1['parent_array'][0]['id']:"";
                                    // $temp_adjustment_info = isset($adjustment_data[$temp_id])?$adjustment_data[$temp_id][0]['adjust_value']:"";
                                    $temp_child_id = isset($level_1['parent_array'][0]['child_id'])?$level_1['parent_array'][0]['child_id']:"";
                                    $temp_adjustment_info = $this->get_adjustment_of_child($temp_child_id, $adjustment_data);
                                    $temp_adjust_value = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['adjusted_value']:"";
                                    $temp_je_no = count($temp_adjustment_info)>0?$temp_adjustment_info[0]['type_name'].$temp_adjustment_info[0]['je_no']:"";

                                    $adjustment_for_rev_rsrve = 0.00;
                                    $adjustment_for_pl = 0.00;

                                    $variance_value  = $this->calculate_variance($temp_c_adjusted ,$temp_c_lye);

                                    // print_r($level_3['parent_array'][0]);
                                    // echo json_encode($level_3['fs_note_details']);
                                    $content .= 
                                    '<tr class="rows-for-'.$temp_id.'">' .
                                        '<td style="width:'.$col_width['account_desc'].'%;">' .
                                            // hidden fields
                                            '<input type="hidden" name="FP_audit_categorized_account_id[]" class="SFP_audit_categorized_account_id" value="'. $temp_id .'">' .
                                            $level_1['parent_array'][0]['description'] . 
                                        '</td>';

                                        $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c) . '</td>';

                                        // adjustment detail for PL when no adjustment of retained earning
                                        if($level_1['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value == "")
                                        {
                                            // print_r(array($adjustment_for_pl, "hi"));
                                            //multiply with -1 because retained earning is opposite sign
                                            $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c);
                        
                                            if($adjustment_for_pl > 0)
                                            {
                                                $content .= 
                                                    '<td  style="width:'.$col_width['value'].'%;" align="right">
                                                        <table>
                                                            <tr>
                                                                <td style="width: 40%;"><strong>P/L</strong></td>
                                                                <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                            </tr>
                                                        </table>
                                                    </td>';
                                                $content .= 
                                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                            }
                                            else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                            {
                                                $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';

                                                $content .= 
                                                '<td  style="width:'.$col_width['value'].'%;" align="right">
                                                        <table>
                                                            <tr>
                                                                <td style="width: 40%;"><strong>P/L</strong></td>
                                                                <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                            </tr>
                                                        </table>
                                                    </td>';
                                            }
                                        }

                                        if($level_1['parent_array'][0]['account_code'] == 'Q1030000' && $temp_adjust_value != "")
                                        {
                                            $adjustment_for_rev_rsrve += $temp_adjust_value;
                                        }
                                        

                                        if($temp_adjust_value > 0)
                                        {
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                        }
                                        else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                        {
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                        }
                                        else if($temp_adjust_value == "" && $adjustment_for_pl == 0)
                                        {
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                            $content .= 
                                                '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                        }
                                        $content .= '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_adjusted) . '</td>';
                                        
                                        if(!empty($last_fye_end))
                                        {

                                            $content .= 
                                            '<td style="width:'.$col_width['value'].'%;" align="right">' . $this->negative_bracket($temp_c_lye) . '</td>';
                                        
                                         //     if($show_third_col)
                                            // {
                                            //  echo 
                                            //  '<td align="right">' . 
                                            //      '<input type="number" name="' . $FP_lye_beg_value_name . '[' . $index . ']" class="form-control ' . $display_class_lye_beg . '_values_under_' . $level_1['parent_array'][0]['id'] . ' ' . $display_class_lye_beg .  '_account_code_' . $level_1_description . '" style="text-align:right;" value="' . $level_2['parent_array'][0]['company_beg_prev_ye_value'] . '" onchange="FP_calculation('. $level_1['parent_array'][0]['id'] .', \'' . $display_class_lye_beg . '\', \'' . $level_1_description . '\', \'' . "company" . '\')" min="0" pattern="[0-9]" onkeypress="return !(event.charCode == 46)" step="1">' .
                                            //  '</td>';
                                            // }
                                            $content .= '<td align="right" style="width:'.$col_width['variance'].'%;">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td align="center" style="width:'.$col_width['variance'].'%;">'.number_format($variance_value['percentage'], 2).'%</td>';
                                        
                                        }



                                        $temp_total_c          += (double)$temp_c;
                                        $temp_total_c_adjusted += (double)$temp_c_adjusted;
                                        $temp_total_c_end      += (double)$temp_c_lye;
                                        $temp_total_c_beg      += (double)$level_1['parent_array'][0]['company_beg_prev_ye_value'];
                                        // }
                                    $content .= '</tr>';

                                    //loop all adjustment info 
                                    if(count($temp_adjustment_info) > 1)
                                    {
                                        foreach ($temp_adjustment_info as $info_key => $each_info) {
                                            if($info_key != 0)
                                            {
                                                $temp_adjust_value = $each_info['adjusted_value'];
                                                $temp_je_no = $each_info['type_name'].$each_info['je_no'];

                                                if($temp_adjust_value != "")
                                                {
                                                    $adjustment_for_rev_rsrve += $temp_adjust_value;
                                                }

                                                $content .= '<tr>
                                                        <td style="width:'.$col_width['account_desc'].'%;"></td>
                                                        <td style="width:'.$col_width['value'].'%;"></td>';
                                                if($temp_adjust_value > 0)
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket($temp_adjust_value).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                    $content .= 
                                                        '<td align="right"></td>';
                                                }
                                                else if($temp_adjust_value < 0 && $temp_adjust_value != "")
                                                {
                                                    $content .= 
                                                        '<td align="right"></td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right">
                                                            <table>
                                                                <tr>
                                                                    <td style="width: 40%;"><strong>'.$temp_je_no.'</strong></td>
                                                                    <td style="width: 60%;">'.$this->negative_bracket(abs($temp_adjust_value)).'</td>
                                                                </tr>
                                                            </table>
                                                        </td>';
                                                }
                                                else
                                                {
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                    $content .= 
                                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                                }
                                                $content .=  '</tr>';
                                            }
                                        }
                                        
                                    }

                                    // adjustment detail for PL when has adjustment of retained earning so that it will display below
                                    if($level_1['parent_array'][0]['account_code'] == 'Q1030000' && $adjustment_for_rev_rsrve != 0)
                                    {
                                        //multiply with -1 because retained earning is opposite sign
                                        $adjustment_for_pl = -1*($temp_c_adjusted - $temp_c) - $adjustment_for_rev_rsrve;
                    
                                        $content .= '<tr>
                                                <td style="width:'.$col_width['account_desc'].'%;"></td>
                                                <td style="width:'.$col_width['value'].'%;"></td>';
                                        if($adjustment_for_pl > 0)
                                        {
                                            $content .= 
                                                '<td  style="width:'.$col_width['value'].'%;" align="right">
                                                    <table>
                                                        <tr>
                                                            <td style="width: 40%;"><strong>P/L</strong></td>
                                                            <td style="width: 60%;">'.$this->negative_bracket($adjustment_for_pl).'</td>
                                                        </tr>
                                                    </table>
                                                </td>';
                                            $content .= 
                                                '<td align="right"></td>';
                                        }
                                        else if($adjustment_for_pl < 0 && $adjustment_for_pl != 0)
                                        {
                                            $content .= 
                                            '<td align="right"></td>';

                                            $content .= 
                                            '<td  style="width:'.$col_width['value'].'%;" align="right">
                                                <table>
                                                    <tr>
                                                        <td style="width: 40%;"><strong>P/L</strong></td>
                                                        <td style="width: 60%;">'.$this->negative_bracket(abs($adjustment_for_pl)).'</td>
                                                    </tr>
                                                </table>
                                            </td>';
                                        }
                                        $content .=  '</tr>';
                                    }
                                }


                                $variance_value  = $this->calculate_variance($temp_total_c_adjusted ,$temp_total_c_end);

                                $content .= 
                                    '<tr>' . 
                                        '<td style="width:'.$col_width['account_desc'].'%;"></td>' . 
                                        '<td align="right" style="width:'.$col_width['value'].'%;border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                            '<span>' . 
                                                $this->negative_bracket($temp_total_c) . 
                                            '</span>' . 
                                        '</td>';
                                        
                                    $content .= 
                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                    $content .= 
                                        '<td style="width:'.$col_width['value'].'%;" align="right"></td>';

                                    $content .= 
                                        '<td align="right" style="width:'.$col_width['value'].'%;border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                            '<span>' . 
                                                $this->negative_bracket($temp_total_c_adjusted) . 
                                            '</span>' . 
                                        '</td>';

                                        if(!empty($last_fye_end))
                                        {
                                            $content .= 
                                            '<td align="right" style="width:'.$col_width['value'].'%;border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                                '<span>' . 
                                                    $this->negative_bracket($temp_total_c_end) . 
                                                '</span>' . 
                                            '</td>';

                                         //     if($show_third_col)
                                            // {
                                            //  echo 
                                            //  '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                            //      '<span id="' . $display_class_lye_beg . '_subtotal_'. $level_2['parent_array'][0]['id'] .'">' . 
                                            //          negative_bracket($total_beg) . 
                                            //      '</span>' . 
                                            //  '</td>';
                                            // }

                                            $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                            $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';

                            
                                        }

                                        
                                        
                                    $content .= '</tr>';

                                    $grand_total_c          += $temp_total_c;
                                    $grand_total_c_adjusted += $temp_total_c_adjusted;
                                    $grand_total_c_end      += $temp_total_c_end;
                            
                            }


                        }

                        if(!empty($data[0]['parent_array']))
                        {
                

                            $variance_value  = $this->calculate_variance($grand_total_c_adjusted ,$grand_total_c_end);

                            $content .= 
                                '<tr>' . 
                                    '<td style="width:'.$col_width['account_desc'].'%;"></td>' . 
                                    '<td align="right" style="width:'.$col_width['value'].'%;border-top: 1px solid #000; border-bottom: 2px double #000;">' . 
                                        '<span>' . 
                                            $this->negative_bracket($grand_total_c) . 
                                        '</span>' . 
                                    '</td>';
                                    
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';
                                $content .= 
                                    '<td style="width:'.$col_width['value'].'%;" align="right"></td>';

                                $content .= 
                                    '<td align="right" style="width:'.$col_width['value'].'%;border-top: 1px solid #000; border-bottom: 2px double #000;">' . 
                                        '<span>' . 
                                            $this->negative_bracket($grand_total_c_adjusted) . 
                                        '</span>' . 
                                    '</td>';

                                    if(!empty($last_fye_end))
                                    {
                                        $content .= 
                                        '<td align="right" style="width:'.$col_width['value'].'%;border-top: 1px solid #000; border-bottom: 2px double #000;">' . 
                                            '<span>' . 
                                                $this->negative_bracket($grand_total_c_end) . 
                                            '</span>' . 
                                        '</td>';

                                     //     if($show_third_col)
                                        // {
                                        //  echo 
                                        //  '<td align="right" style="border-top: 1px solid #000; border-bottom: 1px solid #000;">' . 
                                        //      '<span id="' . $display_class_lye_beg . '_subtotal_'. $level_2['parent_array'][0]['id'] .'">' . 
                                        //          negative_bracket($total_beg) . 
                                        //      '</span>' . 
                                        //  '</td>';
                                        // }

                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="right">'.$this->negative_bracket($variance_value['dollar']).'</td>';
                                        $content .= '<td style="width:'.$col_width['variance'].'%;" align="center">'.number_format($variance_value['percentage'], 2).'%</td>';

                        
                                    }

                                    
                                    
                                $content .= '</tr>';
                        }


                $content .=
                    '</tbody>
                </table>
                <br/><br/>';
            }

            if(isset($leadsheet_setup['documentation_flag'])?($leadsheet_setup['documentation_flag']==1?true:false):true)
            {

                $content .= '<table border="0" style="width:50%;">';

                $content .= $form_data['doc_table'];

                $content .= '</table>';
            }

            // print_r($content);
        
        }

        $obj_pdf->writeHTML($content, true, false, true, false, '');

        $obj_pdf->Output($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_leadsheet_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf', 'F');
        chmod($_SERVER['DOCUMENT_ROOT'].'audit/pdf/document/'.$caf_detail->index_no.'_audit_leadsheet_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf',0644);


        $protocol = isset($_SERVER["HTTPS"]) ? 'https://' : 'http://';

        array_push($array_link,$protocol . $_SERVER['SERVER_NAME'] .'/audit/pdf/document/'.$caf_detail->index_no.'_audit_leadsheet_'.$caf_id.'_'.$this->encryption->decrypt($fs_company_info[0]['company_name']).'.pdf');

        echo json_encode(array("link" => $array_link));
    
    }


    public function process_webix_style_array($style)
    {
        $style_class = "";

        if(is_array($style))
        {
            foreach ($style as $key => $value) 
            {
                $style_rules = explode(";", $value[1]);
                $style_class .= ".".$value[0]. "{";

                foreach ($style_rules as $style_key => $style_value) 
                {
                    if($style_key == 0 && $style_value != "")
                    {
                        $style_class .= "color:".$style_value.";";
                    }

                    if($style_key == 1 && $style_value != "")
                    {
                        $style_class .= "background-color:".$style_value.";";
                    }

                    if($style_key == 2 && $style_value != "")
                    {
                        $style_class .= "text-align:".$style_value.";";
                    }

                    if($style_key == 3 && $style_value != "")
                    {
                        $style_class .= "font-family:".$style_value.";";
                    }

                    if($style_key == 4 && $style_value != "")
                    {
                        $style_class .= "font-size:".$style_value.";";
                    }

                    if($style_key == 5 && $style_value != "")
                    {
                        $style_class .= "font-style:".$style_value.";";
                    }
                    if($style_key == 6 && $style_value != "")
                    {
                        $style_class .= "text-decoration:".$style_value.";";
                    }
                    if($style_key == 7 && $style_value != "")
                    {
                        $style_class .= "font-weight:".$style_value.";";
                    }
                    if($style_key == 8 && $style_value != "")
                    {
                        $style_class .= "vertical-align:".$style_value.";";
                    }
                    if($style_key == 9 && $style_value != "")
                    {
                        $style_class .= "word-wrap:".$style_value.";";
                    }
                    if($style_key == 10 && $style_value != "")
                    {
                        $border_rule = explode(",", $style_value);
                        if($border_rule['1'] == "thin")
                        {
                            $border_text = "1px solid";
                        }
                        $style_class .= "border:".$border_text." ". $border_rule[0].";";
                    }
                    if($style_key == 12 && $style_value != "")
                    {
                        $border_rule = explode(",", $style_value);
                        if($border_rule['1'] == "thin")
                        {
                            $border_text = "1px solid";
                        }
                        $style_class .= "border-right:".$border_text." ". $border_rule[0].";";
                    }
                    if($style_key == 13 && $style_value != "")
                    {
                        $border_rule = explode(",", $style_value);
                        if($border_rule['1'] == "thin")
                        {
                            $border_text = "1px solid";
                        }
                        $style_class .= "border-bottom:".$border_text." ". $border_rule[0].";";
                    }
                    if($style_key == 14 && $style_value != "")
                    {
                        $border_rule = explode(",", $style_value);
                        if($border_rule['1'] == "thin")
                        {
                            $border_text = "1px solid";
                        }
                        $style_class .= "border-left:".$border_text." ". $border_rule[0].";";
                    }
                    if($style_key == 15 && $style_value != "")
                    {
                        $border_rule = explode(",", $style_value);
                        if($border_rule['1'] == "thin")
                        {
                            $border_text = "1px solid";
                        }
                        $style_class .= "border-top:".$border_text." ". $border_rule[0].";";
                    }
                }

                $style_class .= "}";


            }
        }

        return $style_class;
    }

    public function calculate_equity($data)
    {
        $total_c = 0.00;
        $total_ly = 0.00;

        foreach ($data as $level_1_key => $level_1) 
        {
            // print_r($level_1['parent_array']);
            $level_1_description = $level_1['parent_array'][0]['description'];
            if($level_1_description == "Equity")
            {
                foreach ($level_1['child_array'] as $level_2_key => $level_2) 
                {
                    if(isset($level_2['parent_array'][0]['total_c']))    
                    {
                        $total_c += (double)$level_2['parent_array'][0]['total_c'];
                    }

                    if(isset($level_2['parent_array'][0]['total_c_lye']))    
                    {
                        $total_ly += (double)$level_2['parent_array'][0]['total_c_lye'];
                    }

                }

                $data[$level_1_key]['parent_array'][0]['total_c'] = $total_c;
                $data[$level_1_key]['parent_array'][0]['total_c_lye'] = $total_ly;
                
            }
        }

        return $data;
    }

    public function calculate_assessment($benchmark_val, $percent_used)
    {
        $initial_assessment = 0.00;

        // alert(initial_benchmark_val);

        if($percent_used != "" && $benchmark_val != "")
        {
            
            $initial_assessment = ($percent_used/100) * (double)$benchmark_val;
            
            return $this->negative_bracket($this->roundUpToNearestMultiple($initial_assessment));
        }
    }

    public function retrieve_benchmark_value($data)
    {

        $benchmark_array = array();

        foreach ($data as $level_1_key => $level_1) 
        {
            $level_1_acc_code = $level_1['parent_array'][0]['account_code'];

            if($level_1_acc_code == "A0000000")
            {
                $benchmark_array['asset_benchmark'] = $level_1['parent_array'][0]['total_c'];
                $benchmark_array['asset_benchmark_adjusted'] = $level_1['parent_array'][0]['total_c_adjusted'];
                $benchmark_array['asset_benchmark_ly'] = $level_1['parent_array'][0]['total_c_lye'];
            }

            if($level_1_acc_code == "R0000000")
            {
                $benchmark_array['revenue_benchmark'] = $level_1['parent_array'][0]['total_c'];
                $benchmark_array['revenue_benchmark_adjusted'] = $level_1['parent_array'][0]['total_c_adjusted'];
                $benchmark_array['revenue_benchmark_ly'] = $level_1['parent_array'][0]['total_c_lye'];
            }

            if($level_1_acc_code == "E0000000")
            {
                $benchmark_array['expenses_benchmark'] = $level_1['parent_array'][0]['total_c'];
                $benchmark_array['expenses_benchmark_adjusted'] = $level_1['parent_array'][0]['total_c_adjusted'];
                $benchmark_array['expenses_benchmark_ly'] = $level_1['parent_array'][0]['total_c_lye'];
            }

            if($level_1_acc_code == "Q0000000")
            {
                $benchmark_array['equity_benchmark'] = $level_1['parent_array'][0]['total_c'];
                $benchmark_array['equity_benchmark_adjusted'] = $level_1['parent_array'][0]['total_c_adjusted'];
                $benchmark_array['equity_benchmark_ly'] = $level_1['parent_array'][0]['total_c_lye'];
            }

            if($level_1_acc_code == "C0000000")
            {
                $cost_of_sales_c  = $level_1['parent_array'][0]['total_c'];
                $cost_of_sales_c_adjusted  = $level_1['parent_array'][0]['total_c_adjusted'];
                $cost_of_sales_ly = $level_1['parent_array'][0]['total_c_lye'];
            }
            else
            {
                $cost_of_sales_c  = 0;
                $cost_of_sales_c_adjusted  = 0;
                $cost_of_sales_ly = 0;
            }

            if($level_1_acc_code == "I0000000")
            {
                $income_c  = $level_1['parent_array'][0]['total_c'];
                $income_c_adjusted  = $level_1['parent_array'][0]['total_c_adjusted'];
                $income_ly = $level_1['parent_array'][0]['total_c_lye'];
            }
        }

        $benchmark_array['profit_before_tax_c']  = $benchmark_array['revenue_benchmark'] + $income_c - $benchmark_array['expenses_benchmark'] - $cost_of_sales_c;
        $benchmark_array['profit_before_tax_c_adjusted']  = $benchmark_array['revenue_benchmark_adjusted'] + $income_c_adjusted - $benchmark_array['expenses_benchmark_adjusted'] - $cost_of_sales_c_adjusted;
        $benchmark_array['profit_before_tax_ly'] = $benchmark_array['revenue_benchmark_ly'] + $income_ly - $benchmark_array['expenses_benchmark_ly'] - $cost_of_sales_ly;

        

        return $benchmark_array;
        
    }

    public function numberToRomanRepresentation($number) {
        $map = array('M' => 1000, 'CM' => 900, 'D' => 500, 'CD' => 400, 'C' => 100, 'XC' => 90, 'L' => 50, 'XL' => 40, 'X' => 10, 'IX' => 9, 'V' => 5, 'IV' => 4, 'I' => 1);
        $returnValue = '';
        while ($number > 0) {
            foreach ($map as $roman => $int) {
                if($number >= $int) {
                    $number -= $int;
                    $returnValue .= $roman;
                    break;
                }
            }
        }
        return $returnValue;
    }

    public function check_retained_earning_with_bs($calculated_revenue_reserve, $bf_data)
    {
        // print_r($bf_data);
        if(count($bf_data) > 0){
            foreach($bf_data[0] as $key => $value)
            {
                if(!isset($calculated_revenue_reserve['total_c_lye']) && !$value['parent_array'][0]['total_c'])
                {
                    return true;

                }
                else if((string)(number_format($value['parent_array'][0]['total_c'], 2, '.', ',')) == (string)(number_format(($calculated_revenue_reserve['total_c_lye']*-1), 2, '.', ',')))
                {
                    // echo true;
                    return true;
                    
                }
                else
                {
                    // echo false;
                    return false;
                }

            }
        }
        else
        {
            return false;
        }
    }

    public function add_missing_default_caf()
    {
        $q = $this->db->query("SELECT caf.assignment_id,GROUP_CONCAT(DISTINCT type_id) as existing_type, assignment.status FROM audit_caf_master caf LEFT JOIN payroll_assignment assignment on caf.assignment_id = assignment.id GROUP BY assignment_id");

        $this->db->where(array('fixed' => 1));

        $existing_caf = $q->result_array();
            
        $type_q = $this->db->get("audit_caf_type");

        $fixed_caf_arr = $type_q->result_array();

        $programme_q = $this->db->query("SELECT * FROM audit_programme_master where deleted=0 and archived=0 ORDER BY programme_index");

        $programme_arr = $programme_q->result_array();

        if($q->num_rows() > 0)
        {
            foreach ($existing_caf as $key => $value) {
                if($value['status'] != 10){
                    foreach ($fixed_caf_arr as $fixed_key => $each) {
                        if (!in_array($each['id'], explode(',', $value['existing_type']))) {
                            $data   = array(
                                    'assignment_id'     => $value['assignment_id'],
                                    'created_by'    => $this->session->userdata('user_id'),
                                    'index_no'    => $each['index_no'],
                                    'name'         => $each['name'],
                                    'type_id'      => $each['id'],

                                  );

                            // print_r($data);

                            $this->db->insert('audit_caf_master', $data);
                        }


                        
                    }

                    // if (!in_array(7, explode(',', $value['existing_type']))) {
                    //     foreach ($programme_arr as $programme_key => $programme_each) {
                    //         $data   = array(
                    //                     'assignment_id'       => $value['assignment_id'],
                    //                     'created_by'          => $this->session->userdata('user_id'),
                    //                     'index_no'            => $programme_each['programme_index'],
                    //                     'name'                => $programme_each['title'],
                    //                     'programme_master_id' => $programme_each['id'],
                    //                     'type_id'             => 7,  // type id 7 is audit_programme

                    //                 );

                    //         $this->db->insert('audit_caf_master', $data);
                    //     }
                    // }
                    // else
                    // {
                    //     //for audit programme
                    //     $existing_programme_q = $this->db->query("SELECT audit_caf_master.assignment_id,GROUP_CONCAT(DISTINCT programme_index) as existing_index FROM audit_caf_master LEFT JOIN payroll_assignment assignment on audit_caf_master.assignment_id = assignment.id WHERE type_id = 7 and audit_caf_master.assignment_id = ".$value['assignment_id']." GROUP BY assignment_id");

                    //     $existing_programme = $existing_programme_q->result_array();

                    //     foreach ($programme_arr as $programme_key => $programme_each) {
                    //         if (!in_array($programme_each['programme_index'], explode(',', $value['existing_index']))) {
                    //             $data   = array(
                    //                     'assignment_id'       => $value['assignment_id'],
                    //                     'created_by'          => $this->session->userdata('user_id'),
                    //                     'index_no'            => $programme_each['programme_index'],
                    //                     'name'                => $programme_each['title'],
                    //                     'programme_master_id' => $programme_each['id'],
                    //                     'type_id'             => 7,  // type id 7 is audit_programme

                    //                   );

                    //             // print_r($data);

                    //             $this->db->insert('audit_caf_master', $data);
                    //         }


                            
                    //     }
                    // }
                }
            }
        }

        

        // $programme_q = $this->db->query("SELECT * FROM audit_programme_master where deleted=0 and archived=0 ORDER BY programme_index");

        // $programme_arr = $type_q->result_array();

        // if($q->num_rows() > 0 && $existing_programme_q->num_rows() < 1 && $programme_q->num_rows() > 0)
        // {
        //     foreach ($existing_caf as $key => $value) {
        //         if($value['status'] != 10){
        //             foreach ($programme_arr as $programme_key => $programme_each) {
        //                 $data   = array(
        //                             'assignment_id'       => $assg_id,
        //                             'created_by'          => $this->session->userdata('user_id'),
        //                             'index_no'            => $programme_each['programme_index'],
        //                             'name'                => $programme_each['title'],
        //                             'programme_master_id' => $programme_each['id'],
        //                             'type_id'             => 7,  // type id 7 is audit_programme

        //                         );

        //                 $this->db->insert('audit_caf_master', $data);
        //             }
        //         }
        //     }
        // }
        // else 

    }

 

    public function add_missing_fs_report_id()
    {
        $q = $this->db->query("SELECT *  FROM audit_categorized_account where deleted = 0");
        $existing_categorized_account = $q->result_array();

        // print_r($existing_categorized_account);

        if($q->num_rows() > 0)
        {
            foreach ($existing_categorized_account as $key => $value) {
                $assignment_id = $value['assignment_id'];

                if($assignment_id != null)
                {
                    $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

                    $categorized_account = array(
                                                'fs_company_info_id'  => $fs_company_info_id
                                            );
                    

                    $this->db->where('id', $value['id']);
                    $result = $this->db->update('audit_categorized_account', $categorized_account);
                }

            }
        }

        $q = $this->db->query("SELECT *  FROM audit_uncategorized_account");
        $existing_uncategorized_account = $q->result_array();

        if($q->num_rows() > 0)
        {
            foreach ($existing_uncategorized_account as $key => $value) {
                $assignment_id = $value['assignment_id'];

                if($assignment_id != null)
                {
                    $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

                    $uncategorized_account = array(
                                                'fs_company_info_id'  => $fs_company_info_id
                                            );
                    

                    $this->db->where('id', $value['id']);
                    $result = $this->db->update('audit_uncategorized_account', $uncategorized_account);
                }

            }
        }

        $q = $this->db->query("SELECT *  FROM audit_ly_trial_balance");
        $existing_ly_trial_balance = $q->result_array();

        if($q->num_rows() > 0)
        {
            foreach ($existing_ly_trial_balance as $key => $value) {
                $assignment_id = $value['assignment_id'];

                if($assignment_id != null)
                {
                    $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

                    $ly_trial_balance = array(
                                                'fs_company_info_id'  => $fs_company_info_id
                                            );
                    

                    $this->db->where('id', $value['id']);
                    $result = $this->db->update('audit_ly_trial_balance', $ly_trial_balance);
                }

            }
        }

        $q = $this->db->query("SELECT *  FROM audit_trial_balance");
        $existing_trial_balance = $q->result_array();

        if($q->num_rows() > 0)
        {
            foreach ($existing_trial_balance as $key => $value) {
                $assignment_id = $value['assignment_id'];

                if($assignment_id != null)
                {
                    $fs_company_info_id = $this->caf_model->getReportIdWithAssg($assignment_id);

                    $trial_balance = array(
                                            'fs_company_info_id'  => $fs_company_info_id
                                        );
                    

                    $this->db->where('id', $value['id']);
                    $result = $this->db->update('audit_trial_balance', $trial_balance);
                }

            }
        }
    }

    function roundUpToNearestMultiple($n, $increment = 1000)
    {
        return (int) ($increment * ceil($n / $increment));
    }

    function get_adjustment_of_child($ids, $adjustment_data)
    {
        $ids = explode(",", $ids);
        $temp_arr = array();

        foreach ($ids as $id_key => $id) {
            if(isset($adjustment_data[$id]))
            {
                array_push($temp_arr, $adjustment_data[$id]);
            }
        }

        $parent_total_adjustment = array();

        foreach ($temp_arr as $key => $level1_value) {
            foreach ($level1_value as $level2_key => $level2_value) {
                if(count($parent_total_adjustment) > 0)
                {
                    // print_r(array_search($value[0]['type'], array_column($parent_total_adjustment, 'type')));
                    // print_r(array_column($parent_total_adjustment, 'type'));
                    

                    if(array_search($level2_value['type'], array_column($parent_total_adjustment, 'type')) !== FALSE)
                    {
                        $arr_index = array_search($level2_value['type'], array_column($parent_total_adjustment, 'type'));
                        // echo ($parent_total_adjustment[$arr_index]['je_no']."-----");
                        // echo ($level2_value['je_no']);
                        if($parent_total_adjustment[$arr_index]['je_no'] != $level2_value['je_no'])
                        {
                            if ($level2_value['adjust_value'] > 0)
                            {
                                $temp_adjustment_total = array('type'  => $level2_value['type'],
                                                               'je_no' => $level2_value['je_no'],
                                                               'type_name' => $level2_value['type_name'],
                                                               'ntve_adjust_value' => 0,
                                                               'ptve_adjust_value' => $level2_value['adjust_value']);
                            }
                            else
                            {
                                $temp_adjustment_total = array('type'  => $level2_value['type'],
                                                               'je_no' => $level2_value['je_no'],
                                                               'type_name' => $level2_value['type_name'],
                                                               'ntve_adjust_value' => $level2_value['adjust_value'],
                                                               'ptve_adjust_value' => 0);
                            }

                            array_push($parent_total_adjustment, $temp_adjustment_total);
                        }
                        else
                        {
                            if ($level2_value['adjust_value'] > 0)
                            {
                            
                                $parent_total_adjustment[$arr_index]['ptve_adjust_value'] += $level2_value['adjust_value'];
                            }
                            else
                            {
                                $parent_total_adjustment[$arr_index]['ntve_adjust_value'] += $level2_value['adjust_value'];
                            }
    
                        }
                    }
                    else
                    {
                        if ($level2_value['adjust_value'] > 0)
                        {
                            $temp_adjustment_total = array('type'  => $level2_value['type'],
                                                           'je_no' => $level2_value['je_no'],
                                                           'type_name' => $level2_value['type_name'],
                                                           'ntve_adjust_value' => 0,
                                                           'ptve_adjust_value' => $level2_value['adjust_value']);
                        }
                        else
                        {
                            $temp_adjustment_total = array('type'  => $level2_value['type'],
                                                           'je_no' => $level2_value['je_no'],
                                                           'type_name' => $level2_value['type_name'],
                                                           'ntve_adjust_value' => $level2_value['adjust_value'],
                                                           'ptve_adjust_value' => 0);
                        }

                        array_push($parent_total_adjustment, $temp_adjustment_total);
                    }
                }
                else
                {

                    if ($level2_value['adjust_value'] > 0)
                    {
                        $temp_adjustment_total = array('type'  => $level2_value['type'],
                                                       'je_no' => $level2_value['je_no'],
                                                       'type_name' => $level2_value['type_name'],
                                                       'ntve_adjust_value' => 0,
                                                       'ptve_adjust_value' => $level2_value['adjust_value']);
                    }
                    else
                    {
                        $temp_adjustment_total = array('type'  => $level2_value['type'],
                                                       'je_no' => $level2_value['je_no'],
                                                       'type_name' => $level2_value['type_name'],
                                                       'ntve_adjust_value' => $level2_value['adjust_value'],
                                                       'ptve_adjust_value' => 0);
                    }

                    array_push($parent_total_adjustment, $temp_adjustment_total);
                }
            }
            
        }


        $final_total_adjustment = array();

        foreach ($parent_total_adjustment as $parent_key => $parent_value) {

            // print_r($parent_value);
            if($parent_value['ptve_adjust_value'] != 0)
            {
                $temp_adjustment_total = array('type'  => $parent_value['type'],
                                                   'je_no' => $parent_value['je_no'],
                                                   'type_name' => $parent_value['type_name'],
                                                   'adjusted_value' => $parent_value['ptve_adjust_value']);

                array_push($final_total_adjustment, $temp_adjustment_total);
            }
            

            if($parent_value['ntve_adjust_value'] != 0)
            {
                $temp_adjustment_total = array('type'  => $parent_value['type'],
                                                   'je_no' => $parent_value['je_no'],
                                                   'type_name' => $parent_value['type_name'],
                                                   'adjusted_value' => $parent_value['ntve_adjust_value']);

                array_push($final_total_adjustment, $temp_adjustment_total);
            }
            
            
                
        }


        return $final_total_adjustment;

    }

    public function write_working_paper_header($header_detail, $caf_detail, $single_page = true, $page_no = 1)
    {
        // print_r($header_detail);
        // print_r($caf_detail);
        // print_r($this->getAliasNbPages());

        // echo $header_detail[0]['company_name'];


        $header_detail[0]['company_name'] = $header_detail[0]['company_name'];
        $header_content = '<table style="width: 100%; border-collapse: collapse; height: 60px; font-family: arial, helvetica, sans-serif; font-size: 9pt;" border="0">
                            <tbody>
                                <tr>
                                    <td width="64%" align="left"><strong>'.$header_detail[0]['company_name'].'</strong></td>
                                    <td width="12%"><strong>'.$caf_detail->index_no.'</strong></td>
                                    <td width="12%" style="border:1px solid black;">Initials</td>
                                    <td width="12%" style="border:1px solid black;">Date</td>
                                </tr>
                                <tr>
                                    <td width="64%" align="left"><strong>'.strtoupper($caf_detail->name).'</strong></td>
                                    <td width="12%" style="border:1px solid black;">Prepared by:</td>
                                    <td width="12%" style="border:1px solid black;"></td>
                                    <td width="12%" style="border:1px solid black;"></td>
                                </tr>
                                <tr>
                                    <td width="64%" align="left"><strong>AS AT '.strtoupper($header_detail[0]['current_fye_end']).'</strong></td>
                                    <td width="12%" style="border:1px solid black;">Reviewed by:</td>
                                    <td width="12%" style="border:1px solid black;"></td>
                                    <td width="12%" style="border:1px solid black;"></td>
                                </tr>
                            </tbody>
                           </table>';
        // $header_content = '<table style="width: 100%; border-collapse: collapse; height: 60px; font-family: arial, helvetica, sans-serif; font-size: 9pt;" border="0">
        //                     <tbody>
        //                         <tr>
        //                             <td width="64%" align="left"><strong>'.$header_detail[0]['company_name'].'</strong></td>
        //                             <td width="12%"></td>
        //                             <td width="12%" style="border:1px solid black;">Initials</td>
        //                             <td width="12%" style="border:1px solid black;">Date</td>
        //                         </tr>
        //                         <tr>
        //                             <td width="64%" align="left"><strong>'.strtoupper($caf_detail->name).'</strong></td>
        //                             <td width="12%" style="border:1px solid black;">Prepared by:</td>
        //                             <td width="12%" style="border:1px solid black;"></td>
        //                             <td width="12%" style="border:1px solid black;"></td>
        //                         </tr>
        //                         <tr>
        //                             <td width="64%" align="left"><strong>AS AT '.strtoupper($header_detail[0]['current_fye_end']).'</strong></td>
        //                             <td width="12%" style="border:1px solid black;">Reviewed by:</td>
        //                             <td width="12%" style="border:1px solid black;"></td>
        //                             <td width="12%" style="border:1px solid black;"></td>
        //                         </tr>
        //                     </tbody>
        //                    </table>';

        return $header_content;


    }

    public function write_working_paper_header_nosign($header_detail, $caf_detail, $single_page = true, $page_no = 1)
    {
        // print_r($header_detail);
        // print_r($caf_detail);
        // print_r($this->getAliasNbPages());


        $header_detail[0]['company_name'] = $header_detail[0]['company_name'];
        $header_content = '<table style="width: 100%; border-collapse: collapse; height: 60px; font-family: arial, helvetica, sans-serif; font-size: 9pt;" border="0">
                            <tbody>
                                <tr>
                                    <td width="85%" align="left"><strong>'.$header_detail[0]['company_name'].'</strong></td>
                                    
                                    <td width="15%" valign="middle" style="border:1px solid black;font-size: 12pt;" rowspan="3"><div style="font-size:5pt">&nbsp;</div><strong>'.$caf_detail->index_no.'</strong></td>
                        
                                </tr>
                                <tr>
                                    <td width="85%" align="left"><strong>'.strtoupper($caf_detail->name).'</strong></td>
                                </tr>
                                <tr>
                                    <td width="85%" align="left"><strong>AS AT '.strtoupper($header_detail[0]['current_fye_end']).'</strong></td>
                                </tr>
                            </tbody>
                           </table>';

        // $header_content = '<table style="width: 100%; border-collapse: collapse; height: 60px; font-family: arial, helvetica, sans-serif; font-size: 9pt;" border="0">
        //                     <tbody>
        //                         <tr>
        //                             <td width="85%" align="left"><strong>'.$header_detail[0]['company_name'].'</strong></td>
                                    
        //                             <td width="15%" valign="middle" style="border:1px solid black;font-size: 12pt;" rowspan="3"><div style="font-size:5pt">&nbsp;</div></td>
                        
        //                         </tr>
        //                         <tr>
        //                             <td width="85%" align="left"><strong>'.strtoupper($caf_detail->name).'</strong></td>
        //                         </tr>
        //                         <tr>
        //                             <td width="85%" align="left"><strong>AS AT '.strtoupper($header_detail[0]['current_fye_end']).'</strong></td>
        //                         </tr>
        //                     </tbody>
        //                    </table>';

        return $header_content;


    }

    function getClient()
    {
        $client = new Google_Client();
        $client->setApplicationName('Quickstrart');
        $client->setScopes(Google_Service_Sheets::SPREADSHEETS_READONLY);
        $client->setAuthConfig('credentials.json');
        $client->setAccessType('offline');
        $client->setPrompt('select_account consent');

        // Load previously authorized token from a file, if it exists.
        // The file token.json stores the user's access and refresh tokens, and is
        // created automatically when the authorization flow completes for the first
        // time.
        $tokenPath = 'token.json';
        if (file_exists($tokenPath)) {
            $accessToken = json_decode(file_get_contents($tokenPath), true);
            $client->setAccessToken($accessToken);
        }

        // If there is no previous token or it's expired.
        if ($client->isAccessTokenExpired()) {
            // Refresh the token if possible, else fetch a new one.
            if ($client->getRefreshToken()) {
                $client->fetchAccessTokenWithRefreshToken($client->getRefreshToken());
            } else {
                // Request authorization from the user.
                $authUrl = $client->createAuthUrl();
                printf("Open the following link in your browser:\n%s\n", $authUrl);
                // print 'Enter verification code: ';
                // $stdin = fopen('php://stdin', 'r');
                // $authCode = trim(fgets(STDIN));
                $authCode = '';

                // Exchange authorization code for an access token.
                $accessToken = $client->fetchAccessTokenWithAuthCode($authCode);
                $client->setAccessToken($accessToken);

                // Check to see if there was an error.
                if (array_key_exists('error', $accessToken)) {
                    throw new Exception(join(', ', $accessToken));
                }
            }
            // Save the token to a file.
            if (!file_exists(dirname($tokenPath))) {
                mkdir(dirname($tokenPath), 0700, true);
            }
            file_put_contents($tokenPath, json_encode($client->getAccessToken()));
        }
        return $client;
    }

    public function test_api()
    {
        $client = $this->getClient();
 

        $service = new Google_Service_Sheets($client);
 
   
        $spreadsheet = new Google_Service_Sheets_Spreadsheet([
            'properties' => [
                'title' => 'API Sheet'
            ]
        ]);
        $spreadsheet = $service->spreadsheets->create($spreadsheet, [
            'fields' => 'spreadsheetId'
        ]);
        printf("Spreadsheet ID: %s\n", $spreadsheet->spreadsheetId);
    }

    public function myUrlEncode($string) {
        $replacements = array('');
        $entities = array('!', '*', "'", "(", ")", ";", ":", "@", "&", "=", "+", "$", ",", "/", "?", "%", "#", "[", "]");
        return str_replace($entities, $replacements, $string);
    }

}

class MYPDF extends TCPDF {
    public function Header() {
        $headerData = $this->getHeaderData();


        $this->SetFont('helvetica', '', 6);
        // $this->SetY(15);
        $this->SetRightMargin(20);
        $this->writeHTMLCell(0, 0, 25, 15, $headerData['string'], 0, 0, false, "C", true);
   }

   public function Footer() {
        $this->SetY(-23);

        $signature_content ='<table>
                                <tr><td colspan="3"><p><span style="font-family: "Calibri"; font-size: 11pt;">Approved by director:</span></p></td></tr>
                                <p>&nbsp;</p>
                                <tr><td></td></tr>
                                <tr><td colspan="2" style="border-bottom:1px solid black;"></td></tr>
                                <tr><td colspan="2"><br/>Name: </td></tr></table>';

        $this->SetFont('helvetica', '', 10);
        $this->writeHTMLCell(80, 0, 25, 246, $signature_content, 0, 0, false, "L", false);
        // $this->Cell(0, 15, $signature_content, 0, false, 'C', 0, '', 0, false, 'T', 'M');
   
    }
}



class NO_MARGIN_PDF extends TCPDF {
    public function Header() {
        $headerData = $this->getHeaderData();


        $this->SetFont('helvetica', '', 6);
        // $this->SetY(15);
        $this->SetRightMargin(10);
        $this->writeHTMLCell(0, 0, 10, 15, $headerData['string'], 0, 0, false, "C", true);
   }

   public function Footer() {
        $this->SetY(-23);

        if(empty($this->pagegroups))
        {
            $pagenumtxt = $this->getAliasNumPage();
        }
        else
        {
            $pagenumtxt = $this->getPageNumGroupAlias();
        }

        $pagenumtxt = 'Page '.$pagenumtxt.' | 19';

        $this->SetFont('helvetica', '', 8);
        $this->Cell(175, 0, $pagenumtxt, 0, false, 'C', 0, '', 0, false, 'T', 'M');

        if($this->page != "4")
        {
            $this->SetFont('helvetica', '', 11);
            $this->MultiCell(20, 5, 'Employer', 1, 'C', 0, 0, '155', '', true);
            $this->MultiCell(20, 5, 'Employee', 1, 'C', 0, 1, '', '', true);
            $this->MultiCell(20, 5, '', 1, 'C', 0, 0, '155', '', true);
            $this->MultiCell(20, 5, '', 1, 'C', 0, 2, '175' ,'', true);
            // MultiCell($w, $h, $txt, $border=0, $align='J', $fill=0, $ln=1, $x='', $y='', $reseth=true, $stretch=0, $ishtml=false, $autopadding=true, $maxh=0)

            $this->Ln(4);
        }
   
    }
}

class NOFOOTER_PDF extends TCPDF {
    public function Header() {
        $headerData = $this->getHeaderData();
        $this->writeHTMLCell(0, 0, 20, 12, $headerData['string'], 0, 0, false, "C", true);
   }

   public function Footer() {
        // Position at 25 mm from bottom
        // $this->SetY(-16);
        // $this->SetX(10);


        // // Set font
        // $this->SetFont('helvetica', 'B', 8);

        // $logoX = 20; // The logo will be displayed on the left side close to the border of the page
        // $logoFileName = base_url()."img/footer_img.png";
        // $logoWidth = 50; // 15mm
        // $logo = $this->Image($logoFileName, $logoX, $this->GetY(), $logoWidth);

        // $this->Cell(0,0, $logo, 0, 0, 'R');
        
        // $this->Cell(0, 0, '53 Ubi Ave 3 #01-01 Travelite Building, Singapore 408863', 0, 0, 'C');
        // $this->Ln();
        // $this->Cell(0, 0,'Tel:(65) 6785 8000      Fax:(65) 6785 7000      Email: jonfresh@singnet.com.sg', 0, false, 'C', 0, '', 0, false, 'T', 'M');
        
        // // Page number
        // if (empty($this->pagegroups)) {
        //     $pagenumtxt = 'Page '.' '.$this->getAliasNumPage().' / '.$this->getAliasNbPages();
        // } else {
        //     $pagenumtxt = 'Page '.' '.$this->getPageNumGroupAlias().' / '.$this->getPageGroupAlias();
        // }
        // $this->SetFont('helvetica', 'B', 10);
        // $this->Cell(0, 5, $pagenumtxt, 0, false, 'C', 0, '', 0, false, 'T', 'M');
        // $this->Ln(1);
        // $this->SetFont('helvetica', 'B', 8);
        // $this->Cell(170, 15, 'Powered by ', 0, false, 'C', 0, '', 0, false, 'T', 'M');


  //       $logoX = 110; // 186mm. The logo will be displayed on the right side close to the border of the page
        // $logoFileName = base_url()."/assets/uploads/logos/Audit_logo.png";
        // $logoWidth = 10; // 15mm
        // // $logo = $this->Image($logoFileName, $logoX, $this->GetY() + 5, $logoWidth);

        // $this->Ln(4);
  //       $this->SetFont('helvetica', 'B', 8);
  //       $this->Cell(0, 15, 'enquiry@acumenbizcorp.com.sg', 0, false, 'C', 0, '', 0, false, 'T', 'M');
        //$this->GetY()
   }
   
}


